{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"themes/next/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"themes/next/source/images/alipay.jpg","path":"images/alipay.jpg","modified":0,"renderable":1},{"_id":"themes/next/source/images/apple-touch-icon-next.png","path":"images/apple-touch-icon-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.gif","path":"images/avatar.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/algolia_logo.svg","path":"images/algolia_logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by.svg","path":"images/cc-by.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-16x16-next.png","path":"images/favicon-16x16-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/loading.gif","path":"images/loading.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-32x32-next.png","path":"images/favicon-32x32-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/logo.svg","path":"images/logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/searchicon.png","path":"images/searchicon.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/quote-r.svg","path":"images/quote-r.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/placeholder.gif","path":"images/placeholder.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/quote-l.svg","path":"images/quote-l.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.jpeg","path":"images/avatar.jpeg","modified":0,"renderable":1},{"_id":"themes/next/source/images/wechatpay.jpg","path":"images/wechatpay.jpg","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/bootstrap.js","path":"js/src/bootstrap.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/affix.js","path":"js/src/affix.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/algolia-search.js","path":"js/src/algolia-search.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/hook-duoshuo.js","path":"js/src/hook-duoshuo.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/js.cookie.js","path":"js/src/js.cookie.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/motion.js","path":"js/src/motion.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/exturl.js","path":"js/src/exturl.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/scroll-cookie.js","path":"js/src/scroll-cookie.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/post-details.js","path":"js/src/post-details.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/scrollspy.js","path":"js/src/scrollspy.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/utils.js","path":"js/src/utils.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/canvas-ribbon/canvas-ribbon.js","path":"lib/canvas-ribbon/canvas-ribbon.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.css","path":"lib/algolia-instant-search/instantsearch.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/canvas-nest/canvas-nest.min.js","path":"lib/canvas-nest/canvas-nest.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/LICENSE","path":"lib/fastclick/LICENSE","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/README.md","path":"lib/fastclick/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/bower.json","path":"lib/fastclick/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/HELP-US-OUT.txt","path":"lib/font-awesome/HELP-US-OUT.txt","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/bower.json","path":"lib/font-awesome/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/needsharebutton/needsharebutton.js","path":"lib/needsharebutton/needsharebutton.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/needsharebutton/needsharebutton.css","path":"lib/needsharebutton/needsharebutton.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/needsharebutton/font-embedded.css","path":"lib/needsharebutton/font-embedded.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.lazyload.js","path":"lib/jquery_lazyload/jquery.lazyload.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/README.md","path":"lib/jquery_lazyload/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/bower.json","path":"lib/jquery_lazyload/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/CONTRIBUTING.md","path":"lib/jquery_lazyload/CONTRIBUTING.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.scrollstop.js","path":"lib/jquery_lazyload/jquery.scrollstop.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/canvas_sphere.min.js","path":"lib/three/canvas_sphere.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/three-waves.min.js","path":"lib/three/three-waves.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/canvas_lines.min.js","path":"lib/three/canvas_lines.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-atom.min.css","path":"lib/pace/pace-theme-center-atom.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-bounce.min.css","path":"lib/pace/pace-theme-bounce.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-barber-shop.min.css","path":"lib/pace/pace-theme-barber-shop.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-big-counter.min.css","path":"lib/pace/pace-theme-big-counter.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-simple.min.css","path":"lib/pace/pace-theme-center-simple.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-circle.min.css","path":"lib/pace/pace-theme-center-circle.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-radar.min.css","path":"lib/pace/pace-theme-center-radar.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-flash.min.css","path":"lib/pace/pace-theme-flash.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-fill-left.min.css","path":"lib/pace/pace-theme-fill-left.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-mac-osx.min.css","path":"lib/pace/pace-theme-mac-osx.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-loading-bar.min.css","path":"lib/pace/pace-theme-loading-bar.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-minimal.min.css","path":"lib/pace/pace-theme-minimal.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace.min.js","path":"lib/pace/pace.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.js","path":"lib/velocity/velocity.ui.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-corner-indicator.min.css","path":"lib/pace/pace-theme-corner-indicator.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.min.js","path":"lib/velocity/velocity.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/bower.json","path":"lib/velocity/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","path":"lib/velocity/velocity.ui.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery/index.js","path":"lib/jquery/index.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/schemes/pisces.js","path":"js/src/schemes/pisces.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.css","path":"lib/Han/dist/han.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.min.css","path":"lib/Han/dist/han.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.min.js","path":"lib/Han/dist/han.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/blank.gif","path":"lib/fancybox/source/blank.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading@2x.gif","path":"lib/fancybox/source/fancybox_loading@2x.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading.gif","path":"lib/fancybox/source/fancybox_loading.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","path":"lib/fancybox/source/jquery.fancybox.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_overlay.png","path":"lib/fancybox/source/fancybox_overlay.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite@2x.png","path":"lib/fancybox/source/fancybox_sprite@2x.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.js","path":"lib/fancybox/source/jquery.fancybox.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite.png","path":"lib/fancybox/source/fancybox_sprite.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.js","path":"lib/fastclick/lib/fastclick.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","path":"lib/fancybox/source/jquery.fancybox.pack.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.min.css","path":"lib/font-awesome/css/font-awesome.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.min.js","path":"lib/fastclick/lib/fastclick.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css","path":"lib/font-awesome/css/font-awesome.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css.map","path":"lib/font-awesome/css/font-awesome.css.map","modified":0,"renderable":1},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.pack.js","path":"lib/ua-parser-js/dist/ua-parser.pack.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.min.js","path":"lib/ua-parser-js/dist/ua-parser.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.js","path":"lib/Han/dist/han.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff","path":"lib/font-awesome/fonts/fontawesome-webfont.woff","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.js","path":"lib/velocity/velocity.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","path":"lib/font-awesome/fonts/fontawesome-webfont.woff2","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han-space.otf","path":"lib/Han/dist/font/han-space.otf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han-space.woff","path":"lib/Han/dist/font/han-space.woff","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han.woff","path":"lib/Han/dist/font/han.woff","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han.woff2","path":"lib/Han/dist/font/han.woff2","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","path":"lib/fancybox/source/helpers/jquery.fancybox-buttons.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/fancybox_buttons.png","path":"lib/fancybox/source/helpers/fancybox_buttons.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","path":"lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","path":"lib/fancybox/source/helpers/jquery.fancybox-buttons.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.ttf","path":"lib/font-awesome/fonts/fontawesome-webfont.ttf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","path":"lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-media.js","path":"lib/fancybox/source/helpers/jquery.fancybox-media.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han.otf","path":"lib/Han/dist/font/han.otf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/FontAwesome.otf","path":"lib/font-awesome/fonts/FontAwesome.otf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.eot","path":"lib/font-awesome/fonts/fontawesome-webfont.eot","modified":0,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.js","path":"lib/algolia-instant-search/instantsearch.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.svg","path":"lib/font-awesome/fonts/fontawesome-webfont.svg","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/three.min.js","path":"lib/three/three.min.js","modified":0,"renderable":1}],"Cache":[{"_id":"source/.DS_Store","hash":"72628a42d13eeb8beb93dc38d47432fa6cc862aa","modified":1599902715000},{"_id":"themes/next/.gitattributes","hash":"8454b9313cb1a97b63fb87e2d29daee497ce6249","modified":1585406140000},{"_id":"themes/next/.editorconfig","hash":"211d2c92bfdddb3e81ea946f4ca7a539f150f4da","modified":1585406140000},{"_id":"themes/next/.bowerrc","hash":"334da94ca6f024d60d012cc26ea655681e724ad8","modified":1585406140000},{"_id":"themes/next/.hound.yml","hash":"289dcf5bfe92dbd680d54d6e0668f41c9c9c0c78","modified":1585406140000},{"_id":"themes/next/.gitignore","hash":"ee0b13c268cc8695d3883a5da84930af02d4ed08","modified":1585406140000},{"_id":"themes/next/.jshintrc","hash":"b7d23f2ce8d99fa073f22f9960605f318acd7710","modified":1585406140000},{"_id":"themes/next/.stylintrc","hash":"3b7f9785e9ad0dab764e1c535b40df02f4ff5fd6","modified":1585406140000},{"_id":"themes/next/.travis.yml","hash":"6674fbdfe0d0c03b8a04527ffb8ab66a94253acd","modified":1585406140000},{"_id":"themes/next/.javascript_ignore","hash":"cd250ad74ca22bd2c054476456a73d9687f05f87","modified":1585406140000},{"_id":"themes/next/LICENSE","hash":"ec44503d7e617144909e54533754f0147845f0c5","modified":1585406140000},{"_id":"themes/next/README.cn.md","hash":"23e92a2599725db2f8dbd524fbef2087c6d11c7b","modified":1585406140000},{"_id":"themes/next/README.md","hash":"50abff86ffe4113051a409c1ed9261195d2aead0","modified":1585406140000},{"_id":"themes/next/gulpfile.coffee","hash":"412defab3d93d404b7c26aaa0279e2e586e97454","modified":1585406140000},{"_id":"themes/next/package.json","hash":"3963ad558a24c78a3fd4ef23cf5f73f421854627","modified":1585406140000},{"_id":"themes/next/_config.yml","hash":"ff0566251496c2191719027c43a124179a8514e6","modified":1585406140000},{"_id":"themes/next/bower.json","hash":"486ebd72068848c97def75f36b71cbec9bb359c5","modified":1585406140000},{"_id":"source/_posts/.DS_Store","hash":"d3bd684e2e08be2bb4ccc367b3d7ff0b50d8c69e","modified":1599903125000},{"_id":"source/_drafts/draft-file.md","hash":"af1aca1581def8249e90b995ad0503d20ffd3edc","modified":1585406140000},{"_id":"source/about/index.md","hash":"2b958cce6b377e26f44a2a0f71e2f33157b789ec","modified":1585406140000},{"_id":"source/_posts/2018-11-25-flask服务端推送.md","hash":"79b6520a36b7a599ccd2c7600563b84d6439aee6","modified":1585406140000},{"_id":"source/_posts/2018-12-30-python代码加密部署.md","hash":"b8698d5ff32a5ed120edeb3e48afd0798acc9253","modified":1585406140000},{"_id":"source/_posts/2019-01-22-sqlalchemy数据库连接数异常.md","hash":"60cad9211f18c1b3fc26670d86760b7fd9092e46","modified":1585406140000},{"_id":"source/_posts/2018-11-04-win10docker使用填坑.md","hash":"ff5ef779480eb8b721d9fbddbeaaac2b9c10946b","modified":1585406140000},{"_id":"source/_posts/2019-04-27-pycharm远程调试.md","hash":"400986cf18531a842e4267f75873a221c71951b4","modified":1585406140000},{"_id":"source/_posts/2019-06-09-python程序员开发规范.md","hash":"04875f8423883b7745a58d9a1103ce97b1eed3ca","modified":1585406140000},{"_id":"source/_posts/2019-03-25-flask分布式部署及flask-session.md","hash":"5f02e8a8c39d047610feff6243f077b19cb8aa38","modified":1585406140000},{"_id":"source/_posts/2019-03-10-webserver异常-TooManyOpenFiles.md","hash":"89e7beaf4477c54ff78fb97a99f864c86bd3f4f1","modified":1585406140000},{"_id":"source/_posts/2019-06-16-数据结构与算法总结.md","hash":"5902c9f5047f8a407d757d068f15b28477bf1c09","modified":1585406140000},{"_id":"source/_posts/2019-07-14-flask-caching源码浅析.md","hash":"4b16fe5510f7c3c0e5e29423f3c3a8141745e0d3","modified":1585406140000},{"_id":"source/_posts/2019-12-23-fabric使用总结.md","hash":"14614f706e3f7a4e186d91f4e6abfa707e3d1069","modified":1585406140000},{"_id":"source/_posts/2019-12-22-hexo容器化部署.md","hash":"d3c55f6170fe04589b8d5fd0725717f9a5a09f13","modified":1585406140000},{"_id":"source/_posts/2019-12-27-兼职运维之ulimit-u.md","hash":"601ac3dad2af65d67d8cd0f7a80ad0b654b320fd","modified":1585406140000},{"_id":"source/_posts/2020-03-31-python-pandas-to-csv的使用记录.md","hash":"9984aa70d018ef1a68d5ce93dafc119097661ab5","modified":1585658465000},{"_id":"source/_posts/2020-01-13-shell编码整理.md","hash":"74077c87d74b84af1d673279790f513ea8c9b429","modified":1585406140000},{"_id":"source/_posts/2020-03-27-关于pyspark-dataframe与pandas-dataframe的那些事.md","hash":"845df401fe015d3147241ae4b1f69b00396e223f","modified":1585406140000},{"_id":"source/_posts/2020-08-14-记一次spring事务问题排查.md","hash":"3ff17e97a6a5e550ca8431c0c93bb77fba1aa2f8","modified":1599905340000},{"_id":"source/_posts/2020-09-12-设计模式学习总结.md","hash":"b7164192c8cfcee43f4728c4df322455f3abba02","modified":1599905528000},{"_id":"source/_posts/2020-07-19-破解安卓机nfc功能模拟卡限制.md","hash":"68d614d028799549e41139c357cc3ae7c4d77039","modified":1595166180000},{"_id":"source/_posts/2020-04-09-jenkins前后端分离部署.md","hash":"417a3c4431c43815b38e13d0020bd6abb8c786e5","modified":1595660808000},{"_id":"source/categories/index.md","hash":"14c5ea719245f4dca43c9a99a57fc41b325b4834","modified":1585406140000},{"_id":"themes/next/.github/browserstack_logo.png","hash":"a6c43887f64a7f48a2814e3714eaa1215e542037","modified":1585406140000},{"_id":"source/tags/index.md","hash":"24bbf92a1375f4719e42de71c25b2bfb34e4d834","modified":1585406140000},{"_id":"themes/next/.github/ISSUE_TEMPLATE.md","hash":"a0a82dbfabdef9a9d7c17a08ceebfb4052d98d81","modified":1585406140000},{"_id":"themes/next/.github/CONTRIBUTING.md","hash":"5adfad3ef1b870063e621bc0838268eb2c7c697a","modified":1585406140000},{"_id":"themes/next/.github/PULL_REQUEST_TEMPLATE.md","hash":"1228506a940114288d61812bfe60c045a0abeac1","modified":1585406140000},{"_id":"themes/next/layout/_layout.swig","hash":"2164570bb05db11ee4bcfbbb5d183a759afe9d07","modified":1585406140000},{"_id":"themes/next/layout/archive.swig","hash":"9a2c14874a75c7085d2bada5e39201d3fc4fd2b4","modified":1585406140000},{"_id":"themes/next/layout/category.swig","hash":"3cbb3f72429647411f9e85f2544bdf0e3ad2e6b2","modified":1585406140000},{"_id":"themes/next/layout/index.swig","hash":"555a357ecf17128db4e29346c92bb6298e66547a","modified":1585406140000},{"_id":"themes/next/layout/page.swig","hash":"e8fcaa641d46930237675d2ad4b56964d9e262e9","modified":1585406140000},{"_id":"themes/next/layout/post.swig","hash":"7a6ce102ca82c3a80f776e555dddae1a9981e1ed","modified":1585406140000},{"_id":"themes/next/scripts/merge.js","hash":"39b84b937b2a9608b94e5872349a47200e1800ff","modified":1585406140000},{"_id":"themes/next/layout/schedule.swig","hash":"87ad6055df01fa2e63e51887d34a2d8f0fbd2f5a","modified":1585406140000},{"_id":"themes/next/scripts/merge-configs.js","hash":"38d86aab4fc12fb741ae52099be475196b9db972","modified":1585406140000},{"_id":"themes/next/layout/tag.swig","hash":"34e1c016cbdf94a31f9c5d494854ff46b2a182e9","modified":1585406140000},{"_id":"themes/next/languages/de.yml","hash":"fd02d9c2035798d5dc7c1a96b4c3e24b05b31a47","modified":1585406140000},{"_id":"themes/next/languages/default.yml","hash":"b3bcd8934327448a43d9bfada5dd11b1b8c1402e","modified":1585406140000},{"_id":"themes/next/languages/en.yml","hash":"2f4b4776ca1a08cc266a19afb0d1350a3926f42c","modified":1585406140000},{"_id":"themes/next/languages/id.yml","hash":"dccae33e2a5b3c9f11c0e05ec4a7201af1b25745","modified":1585406140000},{"_id":"themes/next/languages/fr-FR.yml","hash":"efeeb55d5c4add54ad59a612fc0630ee1300388c","modified":1585406140000},{"_id":"themes/next/languages/it.yml","hash":"a215d016146b1bd92cef046042081cbe0c7f976f","modified":1585406140000},{"_id":"themes/next/languages/ko.yml","hash":"dc8f3e8c64eb7c4bb2385025b3006b8efec8b31d","modified":1585406140000},{"_id":"themes/next/languages/ja.yml","hash":"37f954e47a3bc669620ca559e3edb3b0072a4be5","modified":1585406140000},{"_id":"themes/next/languages/nl-NL.yml","hash":"213e7a002b82fb265f69dabafbbc382cfd460030","modified":1585406140000},{"_id":"themes/next/languages/pt-BR.yml","hash":"568d494a1f37726a5375b11452a45c71c3e2852d","modified":1585406140000},{"_id":"themes/next/languages/ru.yml","hash":"e33ee44e80f82e329900fc41eb0bb6823397a4d6","modified":1585406140000},{"_id":"themes/next/languages/vi.yml","hash":"a9b89ebd3e5933033d1386c7c56b66c44aca299a","modified":1585406140000},{"_id":"themes/next/languages/zh-hk.yml","hash":"fe0d45807d015082049f05b54714988c244888da","modified":1585406140000},{"_id":"themes/next/languages/zh-tw.yml","hash":"432463b481e105073accda16c3e590e54c8e7b74","modified":1585406140000},{"_id":"themes/next/languages/zh-Hans.yml","hash":"66b9b42f143c3cb2f782a94abd4c4cbd5fd7f55f","modified":1585406140000},{"_id":"themes/next/languages/pt.yml","hash":"2efcd240c66ab1a122f061505ca0fb1e8819877b","modified":1585406140000},{"_id":"themes/next/test/helpers.js","hash":"f25e7f3265eb5a6e1ccbb5e5012fa9bebf134105","modified":1585406140000},{"_id":"themes/next/test/.jshintrc","hash":"c9fca43ae0d99718e45a6f5ce736a18ba5fc8fb6","modified":1585406140000},{"_id":"themes/next/test/intern.js","hash":"db90b1063356727d72be0d77054fdc32fa882a66","modified":1585406140000},{"_id":"themes/next/source/fonts/.gitkeep","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1585406140000},{"_id":"themes/next/layout/_custom/header.swig","hash":"ba8ab5a0280b953aa97435ff8946cbcbb2755a27","modified":1585406140000},{"_id":"themes/next/layout/_partials/comments.swig","hash":"4adc65a602d1276615da3b887dcbf2ac68e7382b","modified":1585406140000},{"_id":"themes/next/layout/_custom/sidebar.swig","hash":"ba8ab5a0280b953aa97435ff8946cbcbb2755a27","modified":1585406140000},{"_id":"themes/next/layout/_partials/footer.swig","hash":"5f155ea8a9d792dba84727141859d0a4c1705582","modified":1585406140000},{"_id":"themes/next/layout/_partials/header.swig","hash":"c54b32263bc8d75918688fb21f795103b3f57f03","modified":1585406140000},{"_id":"themes/next/layout/_partials/head.swig","hash":"f14a39dad1ddd98e6d3ceb25dda092ba80d391b5","modified":1585406140000},{"_id":"themes/next/layout/_partials/page-header.swig","hash":"77c61e0baea3544df361b7338c3cd13dc84dde22","modified":1585406140000},{"_id":"themes/next/layout/_partials/pagination.swig","hash":"1634fb887842698e01ff6e632597fe03c75d2d01","modified":1585406140000},{"_id":"themes/next/layout/_partials/search.swig","hash":"b4ebe4a52a3b51efe549dd1cdee846103664f5eb","modified":1585406140000},{"_id":"themes/next/layout/_macro/passage-end-tag.swig","hash":"b811a3cd64ecc90533048d12e0d96cec2515d262","modified":1585406140000},{"_id":"themes/next/layout/_macro/post-collapse.swig","hash":"8c56dd26157cbc580ae41d97ac34b90ab48ced3f","modified":1585406140000},{"_id":"themes/next/layout/_macro/post-copyright.swig","hash":"f83befdc740beb8dc88805efd7fbb0fef9ed19be","modified":1585406140000},{"_id":"themes/next/layout/_macro/wechat-subscriber.swig","hash":"e2e4eae391476da994045ed4c7faf5e05aca2cd7","modified":1585406140000},{"_id":"themes/next/layout/_macro/reward.swig","hash":"357d86ec9586705bfbb2c40a8c7d247a407db21a","modified":1585406140000},{"_id":"themes/next/layout/_macro/post.swig","hash":"a4901c488c36c1349948b4486545fbd9355c6834","modified":1585406140000},{"_id":"themes/next/layout/_scripts/boostrap.swig","hash":"c0f5a0955f69ca4ed9ee64a2d5f8aa75064935ad","modified":1585406140000},{"_id":"themes/next/layout/_scripts/vendors.swig","hash":"9be624634703be496a5d2535228bc568a8373af9","modified":1585406140000},{"_id":"themes/next/layout/_scripts/commons.swig","hash":"931808ad9b8d8390c0dcf9bdeb0954eeb9185d68","modified":1585406140000},{"_id":"themes/next/layout/_macro/sidebar.swig","hash":"9c7343fd470e0943ebd75f227a083a980816290b","modified":1585406140000},{"_id":"themes/next/layout/_third-party/exturl.swig","hash":"8301c9600bb3e47f7fb98b0e0332ef3c51bb1688","modified":1585406140000},{"_id":"themes/next/layout/_third-party/duoshuo-hot-articles.swig","hash":"ba75672183d94f1de7c8bd0eeee497a58c70e889","modified":1585406140000},{"_id":"themes/next/layout/_third-party/rating.swig","hash":"554ec568e9d2c71e4a624a8de3cb5929050811d6","modified":1585406140000},{"_id":"themes/next/layout/_third-party/needsharebutton.swig","hash":"fa882641da3bd83d9a58a8a97f9d4c62a9ee7b5c","modified":1585406140000},{"_id":"themes/next/layout/_third-party/mathjax.swig","hash":"a0bd3388587fd943baae0d84ca779a707fbcad89","modified":1585406140000},{"_id":"themes/next/layout/_third-party/scroll-cookie.swig","hash":"9a188938d46931d5f3882a140aa1c48b3a893f0c","modified":1585406140000},{"_id":"themes/next/layout/_third-party/schedule.swig","hash":"db15d7e1552aa2d2386a6b8a33b3b3a40bf9e43d","modified":1585406140000},{"_id":"themes/next/scripts/tags/exturl.js","hash":"5022c0ba9f1d13192677cf1fd66005c57c3d0f53","modified":1585406140000},{"_id":"themes/next/scripts/tags/center-quote.js","hash":"99b66949f18398689b904907af23c013be1b978f","modified":1585406140000},{"_id":"themes/next/scripts/tags/button.js","hash":"eddbb612c15ac27faf11c59c019ce188f33dec2c","modified":1585406140000},{"_id":"themes/next/scripts/tags/full-image.js","hash":"c9f833158c66bd72f627a0559cf96550e867aa72","modified":1585406140000},{"_id":"themes/next/scripts/tags/group-pictures.js","hash":"ac681b0d0d8d39ba3817336c0270c6787c2b6b70","modified":1585406140000},{"_id":"themes/next/scripts/tags/lazy-image.js","hash":"bcba2ff25cd7850ce6da322d8bd85a8dd00b5ceb","modified":1585406140000},{"_id":"themes/next/scripts/tags/note.js","hash":"f7eae135f35cdab23728e9d0d88b76e00715faa0","modified":1585406140000},{"_id":"themes/next/scripts/tags/label.js","hash":"6f00952d70aadece844ce7fd27adc52816cc7374","modified":1585406140000},{"_id":"themes/next/scripts/tags/tabs.js","hash":"aa7fc94a5ec27737458d9fe1a75c0db7593352fd","modified":1585406140000},{"_id":"themes/next/source/css/main.styl","hash":"a91dbb7ef799f0a171b5e726c801139efe545176","modified":1585406140000},{"_id":"themes/next/source/images/alipay.jpg","hash":"30f5cded3686ee70d56144f06b8547e3ace3cd8d","modified":1585406140000},{"_id":"themes/next/source/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1585406140000},{"_id":"themes/next/source/images/avatar.gif","hash":"264082bb3a1af70d5499c7d22b0902cb454b6d12","modified":1585406140000},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","hash":"bc3588c9b2d7c68830524783120ff6cf957cf668","modified":1585406140000},{"_id":"themes/next/source/images/cc-by-sa.svg","hash":"70c1535f43e54e5ff35ca81419e77e4c0c301398","modified":1585406140000},{"_id":"themes/next/source/images/algolia_logo.svg","hash":"45eeea0b5fba833e21e38ea10ed5ab385ceb4f01","modified":1585406140000},{"_id":"themes/next/source/images/cc-by-nc.svg","hash":"6f076713fb9bf934aa2c1046bdf2cf2e37bc1eab","modified":1585406140000},{"_id":"themes/next/source/images/cc-by.svg","hash":"e92a33c32d1dac8ed94849b2b4e6456e887efe70","modified":1585406140000},{"_id":"themes/next/source/images/cc-by-nd.svg","hash":"42cd73da328077ccc92f859bb8f3cf621b3484f8","modified":1585406140000},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","hash":"6f55543d1fb9cbc436c101d24f802dec7b41efc3","modified":1585406140000},{"_id":"themes/next/source/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1585406140000},{"_id":"themes/next/source/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1585406140000},{"_id":"themes/next/source/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1585406140000},{"_id":"themes/next/source/images/logo.svg","hash":"169f56fd82941591dad3abd734a50ec7259be950","modified":1585406140000},{"_id":"themes/next/source/images/cc-zero.svg","hash":"9bfb52b2f63527a7049247bf00d44e6dc1170e7d","modified":1585406140000},{"_id":"themes/next/source/images/searchicon.png","hash":"67727a6a969be0b2659b908518fa6706eed307b8","modified":1585406140000},{"_id":"themes/next/source/images/quote-r.svg","hash":"2a2a250b32a87c69dcc1b1976c74b747bedbfb41","modified":1585406140000},{"_id":"themes/next/source/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1585406140000},{"_id":"themes/next/source/images/quote-l.svg","hash":"cd108d6f44351cadf8e6742565217f88818a0458","modified":1585406140000},{"_id":"themes/next/layout/_scripts/schemes/mist.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1585406140000},{"_id":"themes/next/layout/_scripts/schemes/muse.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1585406140000},{"_id":"themes/next/source/css/_mixins/Mist.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1585406140000},{"_id":"themes/next/source/css/_mixins/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1585406140000},{"_id":"themes/next/source/css/_mixins/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1585406140000},{"_id":"themes/next/source/css/_variables/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1585406140000},{"_id":"themes/next/source/images/avatar.jpeg","hash":"48414fbdb4a202ee77595083a0a00cdcb3a99fbc","modified":1585406140000},{"_id":"themes/next/source/css/_variables/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1585406140000},{"_id":"themes/next/source/images/wechatpay.jpg","hash":"3e223daecbb37196edbbeb937ce23063d305aa7b","modified":1585406140000},{"_id":"themes/next/layout/_partials/head/custom-head.swig","hash":"a223919d2e1bf17ca4d6abb2c86f2efca9883dc1","modified":1585406140000},{"_id":"themes/next/layout/_partials/search/swiftype.swig","hash":"a8c7f9ca7c605d039a1f3bf4e4d3183700a3dd62","modified":1585406140000},{"_id":"themes/next/layout/_partials/head/external-fonts.swig","hash":"f5e487b0d213ca0bd94aa30bc23b240d65081627","modified":1585406140000},{"_id":"themes/next/layout/_partials/search/tinysou.swig","hash":"b25002a83cbd2ca0c4a5df87ad5bff26477c0457","modified":1585406140000},{"_id":"themes/next/layout/_partials/search/localsearch.swig","hash":"b2f0d247b213e4cf8de47af6a304d98070cc7256","modified":1585406140000},{"_id":"themes/next/layout/_partials/share/add-this.swig","hash":"9e3d133ac5bcc6cb51702c83b2611a49811abad1","modified":1585406140000},{"_id":"themes/next/layout/_partials/share/baidushare.swig","hash":"d9e2d9282f9be6e04eae105964abb81e512bffed","modified":1585406140000},{"_id":"themes/next/layout/_partials/share/duoshuo_share.swig","hash":"d4fbffd7fa8f2090eb32a871872665d90a885fac","modified":1585406140000},{"_id":"themes/next/layout/_partials/share/jiathis.swig","hash":"0a9cdd6958395fcdffc80ab60f0c6301b63664a5","modified":1585406140000},{"_id":"themes/next/layout/_third-party/analytics/application-insights.swig","hash":"71397a5823e8ec8aad3b68aace13150623b3e19d","modified":1585406140000},{"_id":"themes/next/layout/_scripts/schemes/gemini.swig","hash":"a9a3995b9615adfb8d6b127c78c6771627bee19a","modified":1585406140000},{"_id":"themes/next/layout/_scripts/schemes/pisces.swig","hash":"a9a3995b9615adfb8d6b127c78c6771627bee19a","modified":1585406140000},{"_id":"themes/next/layout/_scripts/pages/post-details.swig","hash":"9b84ab576982b2c3bb0291da49143bc77fba3cc6","modified":1585406140000},{"_id":"themes/next/layout/_third-party/analytics/analytics-with-widget.swig","hash":"ff947f3561b229bc528cb1837d4ca19612219411","modified":1585406140000},{"_id":"themes/next/layout/_third-party/analytics/cnzz-analytics.swig","hash":"a10b7f19d7b5725527514622899df413a34a89db","modified":1585406140000},{"_id":"themes/next/layout/_third-party/analytics/baidu-analytics.swig","hash":"753d262911c27baf663fcaf199267133528656af","modified":1585406140000},{"_id":"themes/next/layout/_third-party/analytics/busuanzi-counter.swig","hash":"7b11eac3a0685fa1ab2ab6ecff60afc4f15f0d16","modified":1585406140000},{"_id":"themes/next/layout/_third-party/analytics/google-analytics.swig","hash":"b1e13df83fb2b1d5d513b30b7aa6158b0837daab","modified":1585406140000},{"_id":"themes/next/layout/_third-party/analytics/facebook-sdk.swig","hash":"7d94845f96197d9d84a405fa5d4ede75fb81b225","modified":1585406140000},{"_id":"themes/next/layout/_third-party/analytics/firestore.swig","hash":"ccc443b22bd4f8c7ac4145664686c756395b90e0","modified":1585406140000},{"_id":"themes/next/layout/_third-party/analytics/index.swig","hash":"45f3f629c2aacc381095750e1c8649041a71a84b","modified":1585406140000},{"_id":"themes/next/layout/_third-party/analytics/tencent-mta.swig","hash":"5a8027328f060f965b3014060bebec1d7cf149c1","modified":1585406140000},{"_id":"themes/next/layout/_third-party/analytics/lean-analytics.swig","hash":"e6d10ee4fb70b3ae1cd37e9e36e000306734aa2e","modified":1585406140000},{"_id":"themes/next/layout/_third-party/analytics/tencent-analytics.swig","hash":"8a399df90dadba5ad4e781445b58f4765aeb701e","modified":1585406140000},{"_id":"themes/next/layout/_third-party/analytics/vkontakte-api.swig","hash":"f9a1647a8f1866deeb94052d1f87a5df99cb1e70","modified":1585406140000},{"_id":"themes/next/layout/_third-party/comments/changyan.swig","hash":"4c501ea0b9c494181eb3c607c5526a5754e7fbd8","modified":1585406140000},{"_id":"themes/next/layout/_third-party/comments/duoshuo.swig","hash":"1600f340e0225361580c44890568dc07dbcf2c89","modified":1585406140000},{"_id":"themes/next/layout/_third-party/comments/gitment.swig","hash":"4dcc3213c033994d342d02b800b6229295433d30","modified":1585406140000},{"_id":"themes/next/layout/_third-party/comments/disqus.swig","hash":"b83a51bbe0f1e2ded9819070840b0ea145f003a6","modified":1585406140000},{"_id":"themes/next/layout/_third-party/comments/hypercomments.swig","hash":"af7f3e43cbdc4f88c13f101f0f341af96ace3383","modified":1585406140000},{"_id":"themes/next/layout/_third-party/comments/valine.swig","hash":"4050553d44ba1396174161c9a6bb0f89fa779eca","modified":1585406140000},{"_id":"themes/next/layout/_third-party/comments/livere.swig","hash":"9246162d4bc7e949ce1d12d135cbbaf5dc3024ec","modified":1585406140000},{"_id":"themes/next/layout/_third-party/comments/index.swig","hash":"493bd5999a1061b981922be92d8277a0f9152447","modified":1585406140000},{"_id":"themes/next/layout/_third-party/comments/youyan.swig","hash":"7e65ff8fe586cd655b0e9d1ad2912663ff9bd36c","modified":1585406140000},{"_id":"themes/next/layout/_third-party/search/tinysou.swig","hash":"fe95dd3d166634c466e19aa756e65ad6e8254d3e","modified":1585406140000},{"_id":"themes/next/layout/_third-party/search/localsearch.swig","hash":"93479642fd076a1257fecc25fcf5d20ccdefe509","modified":1585406140000},{"_id":"themes/next/layout/_third-party/search/index.swig","hash":"34599633658f3b0ffb487728b7766e1c7b551f5a","modified":1585406140000},{"_id":"themes/next/layout/_third-party/seo/baidu-push.swig","hash":"d8c98938719284fa06492c114d99a1904652a555","modified":1585406140000},{"_id":"themes/next/source/js/src/bootstrap.js","hash":"0289031200c3d4c2bdd801ee10fff13bb2c353e4","modified":1585406140000},{"_id":"themes/next/source/js/src/affix.js","hash":"1b509c3b5b290a6f4607f0f06461a0c33acb69b1","modified":1585406140000},{"_id":"themes/next/source/js/src/algolia-search.js","hash":"cb431b54ba9c692165a1f5a12e4c564a560f8058","modified":1585406140000},{"_id":"themes/next/source/js/src/hook-duoshuo.js","hash":"b35a7dc47b634197b93487cea8671a40a9fdffce","modified":1585406140000},{"_id":"themes/next/source/js/src/js.cookie.js","hash":"1512c751d219577d338ac0780fb2bbd9075d5298","modified":1585406140000},{"_id":"themes/next/source/js/src/motion.js","hash":"885176ed51d468f662fbf0fc09611f45c7e5a3b1","modified":1585406140000},{"_id":"themes/next/source/js/src/exturl.js","hash":"a2a0f0de07e46211f74942a468f42ee270aa555c","modified":1585406140000},{"_id":"themes/next/source/js/src/scroll-cookie.js","hash":"02cf91514e41200bc9df5d8bdbeb58575ec06074","modified":1585406140000},{"_id":"themes/next/source/js/src/post-details.js","hash":"93a18271b4123dd8f94f09d1439b47c3c19a8712","modified":1585406140000},{"_id":"themes/next/source/js/src/scrollspy.js","hash":"b7657be25fc52ec67c75ab5481bdcb483573338b","modified":1585406140000},{"_id":"themes/next/source/js/src/utils.js","hash":"b3e9eca64aba59403334f3fa821f100d98d40337","modified":1585406140000},{"_id":"themes/next/source/css/_mixins/Gemini.styl","hash":"07f7da320689f828f6e36a6123807964a45157a0","modified":1585406140000},{"_id":"themes/next/source/css/_custom/custom.styl","hash":"5b1805ccffe7a6cc42050f77b0078d02c30b1853","modified":1585406140000},{"_id":"themes/next/source/css/_mixins/base.styl","hash":"0e55cbd93852dc3f8ccb44df74d35d9918f847e0","modified":1585406140000},{"_id":"themes/next/source/css/_mixins/Pisces.styl","hash":"7896c3ee107e1a8b9108b6019f1c070600a1e8cc","modified":1585406140000},{"_id":"themes/next/source/css/_variables/Gemini.styl","hash":"58e7dd5947817d9fc30770712fc39b2f52230d1e","modified":1585406140000},{"_id":"themes/next/source/css/_variables/base.styl","hash":"b1f6ea881a4938a54603d68282b0f8efb4d7915d","modified":1585406140000},{"_id":"themes/next/source/css/_variables/Mist.styl","hash":"a25408534f8fe6e321db4bbf9dd03335d648fe17","modified":1585406140000},{"_id":"themes/next/source/lib/canvas-ribbon/canvas-ribbon.js","hash":"b02737510e9b89aeed6b54f89f602a9c24b06ff2","modified":1585406140000},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.css","hash":"90ef19edc982645b118b095615838d9c5eaba0de","modified":1585406140000},{"_id":"themes/next/source/lib/canvas-nest/canvas-nest.min.js","hash":"0387e75e23b1db108a755073fe52a0d03eb391a7","modified":1585406140000},{"_id":"themes/next/source/lib/fastclick/LICENSE","hash":"6f474ea75c42442da7bbcf2e9143ce98258efd8d","modified":1585406140000},{"_id":"themes/next/source/lib/fastclick/.bower.json","hash":"bf3eef9d647cd7c9b62feda3bc708c6cdd7c0877","modified":1585406140000},{"_id":"themes/next/source/lib/font-awesome/.gitignore","hash":"03ddbf76c1dd1afb93eed0b670d2eee747472ef1","modified":1585406140000},{"_id":"themes/next/source/lib/fastclick/README.md","hash":"68a9b9d53126405b0fa5f3324f1fb96dbcc547aa","modified":1585406140000},{"_id":"themes/next/source/lib/fastclick/bower.json","hash":"a9b3ee1e4db71a0e4ea6d5bed292d176dd68b261","modified":1585406140000},{"_id":"themes/next/source/lib/font-awesome/.bower.json","hash":"b4aefc910578d76b267e86dfffdd5121c8db9aec","modified":1585406140000},{"_id":"themes/next/source/lib/font-awesome/HELP-US-OUT.txt","hash":"ee33b2798b1e714b904d663436c6b3521011d1fa","modified":1585406140000},{"_id":"themes/next/source/lib/font-awesome/.npmignore","hash":"c31ff06a740955e44edd4403902e653ccabfd4db","modified":1585406140000},{"_id":"themes/next/source/lib/font-awesome/bower.json","hash":"71e7183634dc1b9449f590f15ebd7201add22ca7","modified":1585406140000},{"_id":"themes/next/source/lib/jquery/.bower.json","hash":"865d6c1328ab209a4376b9d2b7a7824369565f28","modified":1585406140000},{"_id":"themes/next/source/lib/needsharebutton/needsharebutton.js","hash":"2ce5f3bf15c523b9bfc97720d8884bb22602a454","modified":1585406140000},{"_id":"themes/next/source/lib/needsharebutton/needsharebutton.css","hash":"e33aa8fa48b6639d8d8b937d13261597dd473b3a","modified":1585406140000},{"_id":"themes/next/source/lib/jquery_lazyload/.bower.json","hash":"90fa628f156d8045357ff11eaf32e61abacf10e8","modified":1585406140000},{"_id":"themes/next/source/lib/needsharebutton/font-embedded.css","hash":"14264a210bf94232d58d7599ea2ba93bfa4fb458","modified":1585406140000},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.lazyload.js","hash":"f4a570908f6c89c6edfb1c74959e733eaadea4f2","modified":1585406140000},{"_id":"themes/next/source/lib/jquery_lazyload/README.md","hash":"b930297cb98b8e1dbd5abe9bc1ed9d5935d18ce8","modified":1585406140000},{"_id":"themes/next/source/lib/jquery_lazyload/bower.json","hash":"e0acf1db27b0cc16128a59c46db1db406b5c4c58","modified":1585406140000},{"_id":"themes/next/source/lib/jquery_lazyload/CONTRIBUTING.md","hash":"4ded6fee668544778e97e38c2b211fc56c848e77","modified":1585406140000},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.scrollstop.js","hash":"bf773ad48a0b9aa77681a89d7569eefc0f7b7b18","modified":1585406140000},{"_id":"themes/next/source/lib/three/canvas_sphere.min.js","hash":"46a50b91c98b639c9a2b9265c5a1e66a5c656881","modified":1585406140000},{"_id":"themes/next/source/lib/three/three-waves.min.js","hash":"8148492dd49aa876d32bb7d5b728d3f5bf6f5074","modified":1585406140000},{"_id":"themes/next/source/lib/three/canvas_lines.min.js","hash":"2d9a9f38c493fdf7c0b833bb9184b6a1645c11b2","modified":1585406140000},{"_id":"themes/next/source/lib/pace/pace-theme-center-atom.min.css","hash":"dcf79c24fe5350fb73d8038573a104e73639e9d3","modified":1585406140000},{"_id":"themes/next/source/lib/pace/pace-theme-bounce.min.css","hash":"f6bdb9a785b7979dd8ec5c60e278af955ef1e585","modified":1585406140000},{"_id":"themes/next/source/lib/pace/pace-theme-barber-shop.min.css","hash":"ee0d51446cb4ffe1bb96bd7bc8c8e046dddfcf46","modified":1585406140000},{"_id":"themes/next/source/lib/pace/pace-theme-big-counter.min.css","hash":"5b561dc328af4c4d512e20a76fe964d113a32ba8","modified":1585406140000},{"_id":"themes/next/source/lib/pace/pace-theme-center-simple.min.css","hash":"67f44c947548bd4d77e7590d3f59e236cbf9e98a","modified":1585406140000},{"_id":"themes/next/source/lib/pace/pace-theme-center-circle.min.css","hash":"a4066769c78affbfbc5e30a600e2c7862cd532e0","modified":1585406140000},{"_id":"themes/next/source/lib/pace/pace-theme-center-radar.min.css","hash":"ab7cba998bf4c03b13df342bf43647fa4f419783","modified":1585406140000},{"_id":"themes/next/source/lib/pace/pace-theme-flash.min.css","hash":"13ace22c40312d7bbd8d9c1e50eff897a7a497d8","modified":1585406140000},{"_id":"themes/next/source/lib/pace/pace-theme-fill-left.min.css","hash":"0bec1e235a4a2cccda3f993b205424e1441a44ae","modified":1585406140000},{"_id":"themes/next/source/lib/pace/pace-theme-mac-osx.min.css","hash":"9f2e7b51b084da407863826b25265b31150b3821","modified":1585406140000},{"_id":"themes/next/source/lib/pace/pace-theme-loading-bar.min.css","hash":"7ee28875dfc1230d76c537f6605766e8d4011e9f","modified":1585406140000},{"_id":"themes/next/source/lib/pace/pace-theme-minimal.min.css","hash":"9cd783cceb8a191f3c8b5d81f7a430ecc3e489d3","modified":1585406140000},{"_id":"themes/next/source/lib/pace/pace.min.js","hash":"8aaa675f577d5501f5f22d5ccb07c2b76310b690","modified":1585406140000},{"_id":"themes/next/source/lib/velocity/.bower.json","hash":"63da5e80ebb61bb66a2794d5936315ca44231f0c","modified":1585406140000},{"_id":"themes/next/source/lib/velocity/velocity.ui.js","hash":"dbbfb50f6502f6b81dcc9fee7b31f1e812da3464","modified":1585406140000},{"_id":"themes/next/source/lib/pace/pace-theme-corner-indicator.min.css","hash":"b3c64c973f31884e3d8145989476707333406b9a","modified":1585406140000},{"_id":"themes/next/source/lib/velocity/velocity.min.js","hash":"bf172816a9c57f9040e3d19c24e181a142daf92b","modified":1585406140000},{"_id":"themes/next/source/lib/velocity/bower.json","hash":"92d92860418c4216aa59eb4cb4a556290a7ad9c3","modified":1585406140000},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","hash":"dde584994ac13dc601836e86f4cf490e418d9723","modified":1585406140000},{"_id":"themes/next/source/css/_variables/Pisces.styl","hash":"4069f918ccc312da86db6c51205fc6c6eaabb116","modified":1585406140000},{"_id":"themes/next/source/lib/jquery/index.js","hash":"17a740d68a1c330876c198b6a4d9319f379f3af2","modified":1585406140000},{"_id":"themes/next/layout/_third-party/search/algolia-search/dom.swig","hash":"2530de0f3125a912756f6c0e9090cd012134a4c5","modified":1585406140000},{"_id":"themes/next/layout/_third-party/search/algolia-search/assets.swig","hash":"218cc936ba3518a3591b2c9eda46bc701edf7710","modified":1585406140000},{"_id":"themes/next/source/css/_common/scaffolding/base.styl","hash":"24ee4b356ff55fc6e58f26a929fa07750002cf29","modified":1585406140000},{"_id":"themes/next/source/css/_common/outline/outline.styl","hash":"12662536c7a07fff548abe94171f34b768dd610f","modified":1585406140000},{"_id":"themes/next/source/css/_common/scaffolding/helpers.styl","hash":"1da5c800d025345f212a3bf1be035060f4e5e6ed","modified":1585406140000},{"_id":"themes/next/source/css/_common/scaffolding/normalize.styl","hash":"3f40e8a9fe8e7bd5cfc4cf4cbbbcb9539462e973","modified":1585406140000},{"_id":"themes/next/source/js/src/schemes/pisces.js","hash":"f1d0b5d7af32c423eaa8bb93ab6a0b45655645dc","modified":1585406140000},{"_id":"themes/next/source/css/_common/scaffolding/scaffolding.styl","hash":"a17e2b871a335f290afb392a08f94fd35f59c715","modified":1585406140000},{"_id":"themes/next/source/css/_common/scaffolding/mobile.styl","hash":"91ca75492cd51f2553f4d294ed2f48239fcd55eb","modified":1585406140000},{"_id":"themes/next/source/css/_common/scaffolding/tables.styl","hash":"ea9069645696f86c5df64208490876fe150c8cae","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/buttons.styl","hash":"8b32928686c327151e13d3ab100157f9a03cd59f","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/components.styl","hash":"7ad4081466b397e2a6204141bb7768b7c01bd93c","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/comments.styl","hash":"ff4489cd582f518bba6909a301ac1292a38b4e96","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/back-to-top.styl","hash":"237d185ac62ec9877e300947fa0109c44fb8db19","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/back-to-top-sidebar.styl","hash":"8f86f694c0749a18ab3ad6f6df75466ca137a4bc","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/pagination.styl","hash":"4f2801fc4cf3f31bf2069f41db8c6ce0e3da9e39","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/tag-cloud.styl","hash":"6eb4bcc3056bd279d000607e8b4dad50d368ca69","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Mist/_base.styl","hash":"25d5e45a355ee2093f3b8b8eeac125ebf3905026","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Mist/_header.styl","hash":"d0bfd1bef988c76f7d7dd72d88af6f0908a8b0db","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Mist/_logo.styl","hash":"b1025c421406d2c24cc92a02ae28c1915b01e240","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Gemini/index.styl","hash":"60fa84aa7731760f05f52dd7d8f79b5f74ac478d","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Mist/_menu.styl","hash":"26666c1f472bf5f3fb9bc62081cca22b4de15ccb","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Mist/_posts-expanded.styl","hash":"9c99034f8e00d47e978b3959f51eb4a9ded0fcc8","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Mist/_search.styl","hash":"09c965022c13b84ed8a661fee8ac2a6d550495ae","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Pisces/_layout.styl","hash":"416988dca389e6e2fdfa51fa7f4ee07eb53f82fb","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Mist/index.styl","hash":"9b913b73d31d21f057f97115ffab93cfa578b884","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Pisces/_sidebar.styl","hash":"ad2dcedf393ed1f3f5afd2508d24969c916d02fc","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Pisces/_menu.styl","hash":"4642e30010af8b2b037f5b43146b10a934941958","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Muse/_layout.styl","hash":"31127dcbf4c7b4ada53ffbf1638b5fe325b7cbc0","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Pisces/_brand.styl","hash":"bce344d3a665b4c55230d2a91eac2ad16d6f32fd","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Pisces/_posts.styl","hash":"1f6e2ce674735269599acc6d77b3ea18d31967fc","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Muse/_logo.styl","hash":"748dbfbf9c08e719ddc775958003c64b00d39dab","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Muse/_menu.styl","hash":"e695e58f714129ca292c2e54cd62c251aca7f7fe","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Muse/_search.styl","hash":"09c965022c13b84ed8a661fee8ac2a6d550495ae","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Muse/index.styl","hash":"5dbc0d0c897e46760e5dbee416530d485c747bba","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Pisces/index.styl","hash":"86197902dfd3bededba10ba62b8f9f22e0420bde","modified":1585406140000},{"_id":"themes/next/source/lib/Han/dist/han.css","hash":"6c26cdb36687d4f0a11dabf5290a909c3506be5c","modified":1585406140000},{"_id":"themes/next/source/lib/Han/dist/han.min.css","hash":"6d586bfcfb7ae48f1b12f76eec82d3ad31947501","modified":1585406140000},{"_id":"themes/next/source/lib/Han/dist/han.min.js","hash":"16b03db23a52623348f37c04544f2792032c1fb6","modified":1585406140000},{"_id":"themes/next/source/lib/fancybox/source/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1585406140000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1585406140000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1585406140000},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","hash":"5f163444617b6cf267342f06ac166a237bb62df9","modified":1585406140000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1585406140000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1585406140000},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.js","hash":"1cf3d47b5ccb7cb6e9019c64f2a88d03a64853e4","modified":1585406140000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1585406140000},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.js","hash":"1d6aeda0480d0e4cb6198edf7719d601d4ae2ccc","modified":1585406140000},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","hash":"53360764b429c212f424399384417ccc233bb3be","modified":1585406140000},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.min.css","hash":"88af80502c44cd52ca81ffe7dc7276b7eccb06cf","modified":1585406140000},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.min.js","hash":"2cae0f5a6c5d6f3cb993015e6863f9483fc4de18","modified":1585406140000},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css","hash":"3655f1fdf1e584c4d8e8d39026093ca306a5a341","modified":1585406140000},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css.map","hash":"1573904b82807abbb32c97a3632c6c6808eaac50","modified":1585406140000},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.pack.js","hash":"a817b6c158cbc5bab3582713de9fe18a18a80552","modified":1585406140000},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.min.js","hash":"41ea797c68dbcff2f6fb3aba1d1043a22e7cc0f6","modified":1585406140000},{"_id":"themes/next/source/lib/Han/dist/han.js","hash":"4ac683b2bc8531c84d98f51b86957be0e6f830f3","modified":1585406140000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1585406140000},{"_id":"themes/next/source/lib/velocity/velocity.js","hash":"4237c6e9d59da349639de20e559e87c2c0218cfd","modified":1585406140000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/highlight/theme.styl","hash":"7fe4d4d656e86276c17cb4e48a560cb6a4def703","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/footer/footer.styl","hash":"9f73c4696f0907aa451a855444f88fc0698fa472","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/highlight/highlight.styl","hash":"50450d9fdc8a2b2be8cfca51e3e1a01ffd636c0b","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/highlight/diff.styl","hash":"167986d0f649516671ddf7193eebba7b421cd115","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/header/headerband.styl","hash":"d63e0cacc53dd375fcc113465a4328c59ff5f2c1","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/header/site-meta.styl","hash":"0656e753f182c9f47fef7304c847b7587a85ef0d","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/header/menu.styl","hash":"1a0d059799a298fe17c49a44298d32cebde93785","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/header/header.styl","hash":"53cde051e0337f4bf42fb8d6d7a79fa3fa6d4ef2","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/pages/categories.styl","hash":"7fb593f90d74a99c21840679933b9ef6fdc16a61","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/header/site-nav.styl","hash":"1727702eac5d326b5c81a667944a245016668231","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/pages/pages.styl","hash":"f9760ecf186954cee3ba4a149be334e9ba296b89","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/pages/post-detail.styl","hash":"4e3838d7ac81d9ad133960f0f7ed58a44a015285","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/pages/archive.styl","hash":"b6f3a06a94a6ee5470c956663164d58eda818a64","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/pages/schedule.styl","hash":"8cf318644acc8b4978537c263290363e21c7f5af","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author-links.styl","hash":"39f04c4c7237a4e10acd3002331992b79945d241","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-blogroll.styl","hash":"8dd9a1c6f4f6baa00c2cf01837e7617120cf9660","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author.styl","hash":"51f70ba4e2dd1c2bc5ff1f8f16ddf93a286c3e4f","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-nav.styl","hash":"1153bb71edf253765145559674390e16dd67c633","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toc.styl","hash":"c8fe49a4bc014c24dead05b782a7082411a4abc5","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-feed-link.styl","hash":"61f8cea3c01acd600e90e1bc2a07def405503748","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-dimmer.styl","hash":"11c22f0fb3f6beb13e5a425ec064a4ff974c13b7","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toggle.styl","hash":"a1521d48bb06d8d703753f52a198baa197af7da2","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar.styl","hash":"5ef6343835f484a2c0770bd1eb9cc443609e4c39","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/post/post-button.styl","hash":"62fbbd32cf5a99ae550c45c763a2c4813a138d01","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/post/post-eof.styl","hash":"a200c0a1c5a895ac9dc41e0641a5dfcd766be99b","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/sidebar/site-state.styl","hash":"e71652d3216e289c8548b1ea2357822c1476a425","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/post/post-collapse.styl","hash":"875cbe88d5c7f6248990e2beb97c9828920e7e24","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/post/post-expand.styl","hash":"a6c6eb8adba0a090ad1f4b9124e866887f20d10d","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/post/post-gallery.styl","hash":"cd9e214e502697f2f2db84eb721bac57a49b0fce","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/post/post-meta.styl","hash":"d0d7a5c90d62b685520d2b47fea8ba6019ff5402","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/post/post-copyright.styl","hash":"caf263d1928496688c0e1419801eafd7e6919ce5","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/post/post-nav.styl","hash":"27deb3d3a243d30022055dac7dad851024099a8b","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/post/post-tags.styl","hash":"5a982d8ef3b3623ea5f59e63728990f5623c1b57","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/post/post-title.styl","hash":"ccb34c52be8adba5996c6b94f9e723bd07d34c16","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/post/post.styl","hash":"89d6c3b697efc63de42afd2e89194b1be14152af","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/post/post-type.styl","hash":"01567edaea6978628aa5521a122a85434c418bfd","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/post/post-reward.styl","hash":"bdcd8e4acbc6e51f28fa95d8a02f65fd1c80f242","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/post/post-rtl.styl","hash":"b2495ae5e04dcca610aacadc47881d9e716cd440","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/third-party/baidushare.styl","hash":"5dbeed535d63a50265d96b396a5440f9bb31e4ba","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/third-party/busuanzi-counter.styl","hash":"a6e7d698702c2e383dde3fde2abde27951679084","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/post/post-widgets.styl","hash":"7968343e41f8b94b318c36289dff1196c3eb1791","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/third-party/gitment.styl","hash":"874278147115601d2abf15987f5f7a84ada1ac6b","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/third-party/localsearch.styl","hash":"16087276945fa038f199692e3eabb1c52b8ea633","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/third-party/han.styl","hash":"10599e16414a8b7a76c4e79e6617b5fe3d4d1adf","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/third-party/duoshuo.styl","hash":"717cc7f82be9cc151e23a7678601ff2fd3a7fa1d","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/third-party/jiathis.styl","hash":"15975ba7456b96916b1dbac448a1a0d2c38b8f3d","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/third-party/third-party.styl","hash":"9c8196394a89dfa40b87bf0019e80144365a9c93","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/third-party/algolia-search.styl","hash":"bba4f3bdb7517cd85376df3e1209b570c0548c69","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/tags/blockquote-center.styl","hash":"2fe76476432b31993338cb45cdb3b29a518b6379","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/tags/group-pictures.styl","hash":"2ad1a2a9bbf6742d1b0762c4c623b68113d1e0fe","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/third-party/needsharebutton.styl","hash":"28825ae15fa20ae3942cdaa7bcc1f3523ce59acc","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/tags/exturl.styl","hash":"a3bdd71237afc112b2aa255f278cab6baeb25351","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/tags/note.styl","hash":"9a409b798decdefdaf7a23f0b11004a8c27e82f3","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/tags/tags.styl","hash":"b80604868e4f5cf20fccafd7ee415c20c804f700","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/tags/note-modern.styl","hash":"b7076e58d647265ee0ad2b461fe8ce72c9373bc5","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/tags/label.styl","hash":"2ab1322fe52ab5aafd49e68f5bd890e8380ee927","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/tags/tabs.styl","hash":"154a87a32d2fead480d5e909c37f6c476671c5e6","modified":1585406140000},{"_id":"themes/next/source/css/_common/components/tags/full-image.styl","hash":"f825da191816eef69ea8efb498a7f756d5ebb498","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Mist/outline/outline.styl","hash":"a07aa12cc36ac5c819670c2a3c17d07ed7a08986","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Mist/sidebar/sidebar-blogroll.styl","hash":"1f09be9bb38411f0629b58c3b23873589a6dbcaa","modified":1585406140000},{"_id":"themes/next/source/css/_schemes/Muse/sidebar/sidebar-blogroll.styl","hash":"1f09be9bb38411f0629b58c3b23873589a6dbcaa","modified":1585406140000},{"_id":"themes/next/source/lib/Han/dist/font/han-space.otf","hash":"07436f011b44051f61b8329c99de4bec64e86f4b","modified":1585406140000},{"_id":"themes/next/source/lib/Han/dist/font/han-space.woff","hash":"7a635062b10bf5662ae1d218ba0980171005d060","modified":1585406140000},{"_id":"themes/next/source/lib/Han/dist/font/han.woff","hash":"f38ff9b2eecaa17b50b66aa2dae87e9e7436d195","modified":1585406140000},{"_id":"themes/next/source/lib/Han/dist/font/han.woff2","hash":"623af3ed5423371ac136a4fe0e8cc7bb7396037a","modified":1585406140000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","hash":"1a9d8e5c22b371fcc69d4dbbb823d9c39f04c0c8","modified":1585406140000},{"_id":"themes/next/source/lib/fancybox/source/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1585406140000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","hash":"53e194f4a72e649c04fb586dd57762b8c022800b","modified":1585406140000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","hash":"91e41741c2e93f732c82aaacec4cfc6e3f3ec876","modified":1585406140000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.ttf","hash":"13b1eab65a983c7a73bc7997c479d66943f7c6cb","modified":1585406140000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1585406140000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-media.js","hash":"3bdf69ed2469e4fb57f5a95f17300eef891ff90d","modified":1585406140000},{"_id":"themes/next/source/lib/Han/dist/font/han.otf","hash":"f1f6bb8f461f5672e000380195d3d2358a28494c","modified":1585406140000},{"_id":"themes/next/source/lib/font-awesome/fonts/FontAwesome.otf","hash":"048707bc52ac4b6563aaa383bfe8660a0ddc908c","modified":1585406140000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1585406140000},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.js","hash":"90a1b22129efc172e2dfcceeeb76bff58bc3192f","modified":1585406140000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.svg","hash":"b5483b11f8ba213e733b5b8af9927a04fec996f6","modified":1585406140000},{"_id":"themes/next/source/lib/three/three.min.js","hash":"26273b1cb4914850a89529b48091dc584f2c57b8","modified":1585406140000},{"_id":"public/atom.xml","hash":"281997dc24d8393ef7061f382edc4eff994616dc","modified":1599905593300},{"_id":"public/about/index.html","hash":"ae821661f0e2d9baf3b81f3c2b52f8fdbcaee562","modified":1599905594439},{"_id":"public/categories/index.html","hash":"0ca24703772e1bd071571dbaea50077a3e45e8d0","modified":1599905594448},{"_id":"public/tags/index.html","hash":"e110549ff4d008ca08c7ebfc87d4aba8f01b499b","modified":1599905594449},{"_id":"public/categories/flask/index.html","hash":"79c8f1e42f1ac7e8d229b62c040e6c60f0a52124","modified":1599905594452},{"_id":"public/categories/问题分析/index.html","hash":"8e97562c7952949c8a0f027f25be3eb1f951e671","modified":1599905594452},{"_id":"public/categories/python/index.html","hash":"91186a67c06c020c41e996c10466fa7b80ed4fbe","modified":1599905594453},{"_id":"public/categories/docker/index.html","hash":"83a6a7c0e19cd71b1fd7db0957d9eec069631c72","modified":1599905594453},{"_id":"public/categories/algorithm-datastructure/index.html","hash":"e1cfc1ed465e977d77d0d507346b511f5ea02ce0","modified":1599905594453},{"_id":"public/categories/coding-tools/index.html","hash":"e35331b9f9d15ed5ccf59ffb779f97beb121d878","modified":1599905594453},{"_id":"public/categories/linux/index.html","hash":"9f9bf28486d90683aa7afa58699763ede95c772f","modified":1599905594453},{"_id":"public/categories/手机/index.html","hash":"bc78a8d76991a32922f31a2fe62d72122a8e749c","modified":1599905594453},{"_id":"public/categories/部署/index.html","hash":"f982437ab48a84d37e1eb2d1a77f8752ee6c4d10","modified":1599905594454},{"_id":"public/categories/shell/index.html","hash":"a6d9ec74c81b4a83f568aa8fdae7b914fffabd56","modified":1599905594454},{"_id":"public/categories/spring/index.html","hash":"341170e335f1ce5e24cfdd6afde6b6871e8a85db","modified":1599905594454},{"_id":"public/archives/2018/index.html","hash":"6a03a16d352e9dabe782fa38b40655aa55512d9e","modified":1599905594455},{"_id":"public/archives/2018/11/index.html","hash":"f9634ffadef9615fc01f0efc608216a9ff272beb","modified":1599905594455},{"_id":"public/archives/2018/12/index.html","hash":"1f14d63a64ef359d12aae9099b5e09c580af1d25","modified":1599905594455},{"_id":"public/archives/2019/01/index.html","hash":"6e2453aed3bc24b681e3fe2e829eef8c0f575d62","modified":1599905594456},{"_id":"public/archives/2019/03/index.html","hash":"9c056a5f567b94aa0fbe1c187c36940b5eadaf89","modified":1599905594456},{"_id":"public/archives/2019/04/index.html","hash":"f0c162854e1191767f4c9ca34c39b021559c2cf4","modified":1599905594456},{"_id":"public/archives/2019/06/index.html","hash":"89c4e059e6d4d29a024e4b2be59e6b80e9d36423","modified":1599905594464},{"_id":"public/archives/2020/index.html","hash":"a741d0c5ebbde0c22245c24c080354c5c6569a8f","modified":1599905594466},{"_id":"public/archives/2019/12/index.html","hash":"e5d3314a927613a422668bf4e075d050b6ed2007","modified":1599905594467},{"_id":"public/archives/2019/07/index.html","hash":"f400d2d66631b99697947fb66f9f9cd1977a8d2b","modified":1599905594467},{"_id":"public/archives/2020/01/index.html","hash":"1b5af13d8bc92cdd71461e4345bff0e05f755222","modified":1599905594467},{"_id":"public/archives/2020/03/index.html","hash":"627bf0a2b1b1947e2faa92488e0d859290d2710d","modified":1599905594467},{"_id":"public/archives/2020/04/index.html","hash":"82e2990e2d8e9c013477d585416ff156f3d4c775","modified":1599905594467},{"_id":"public/archives/2020/07/index.html","hash":"cd6423bad1cca222f2e8eef127e7cb875e543bfd","modified":1599905594467},{"_id":"public/archives/2020/08/index.html","hash":"e7294feb97411426c3d2614a23248f5df1c14c52","modified":1599905594468},{"_id":"public/tags/flask/index.html","hash":"d082b26d21082292c35e4e181cd03f65b2467802","modified":1599905594469},{"_id":"public/tags/mysql/index.html","hash":"2da206415737fba5758960a5ceb76422b0f26ef0","modified":1599905594469},{"_id":"public/tags/sse/index.html","hash":"b0066f4a2de8b292b9fb8ed1a9399f2c07a9493f","modified":1599905594469},{"_id":"public/tags/问题分析/index.html","hash":"75003d7e3c382f31c3e3b92070789aefb4afc590","modified":1599905594469},{"_id":"public/tags/python/index.html","hash":"addb08ae8b97074b10c634fae0775d3d22482c45","modified":1599905594469},{"_id":"public/tags/docker/index.html","hash":"3bd3e4392f560432470cafd89f9b9e09181efa8e","modified":1599905594469},{"_id":"public/tags/wins10/index.html","hash":"2f68fcb95a3ef7496fc14cd614943a3198232ddd","modified":1599905594469},{"_id":"public/tags/session/index.html","hash":"79886722bd1e08666aa993e78cb55240863513ad","modified":1599905594469},{"_id":"public/tags/分布式/index.html","hash":"ef02ce471112748d8257673b5d2d17abd6be7011","modified":1599905594470},{"_id":"public/tags/coding-tools/index.html","hash":"7a70e74ab7928633dce7bb94ecb89ea096eb4242","modified":1599905594470},{"_id":"public/tags/linux/index.html","hash":"aea6c811c3ed2a66bded541d41fdd667a2a0845b","modified":1599905594470},{"_id":"public/tags/源码浅析/index.html","hash":"d6e5d6c5565adf6badd004c229464fc7a6ffb3bc","modified":1599905594470},{"_id":"public/tags/algorithm/index.html","hash":"01c57757c2c55bbbbd5a2064abb3d769c4a389db","modified":1599905594470},{"_id":"public/tags/hexo/index.html","hash":"f18955eaae487a5c6ac692c1abbf4b8c47956a6e","modified":1599905594471},{"_id":"public/tags/pysqark/index.html","hash":"f8e39c46024473e3b6bcbbd83bbd490d67178f03","modified":1599905594472},{"_id":"public/tags/datastructure/index.html","hash":"6ccd9e7b09ced4b39e9e701d2776303e1adf5f53","modified":1599905594473},{"_id":"public/tags/部署/index.html","hash":"d8bbd040d35cfb25e342cfdcdd843fca358682df","modified":1599905594499},{"_id":"public/tags/nfc/index.html","hash":"8f26e8261dfd15209c22bc9908aac4ef5338ee47","modified":1599905594499},{"_id":"public/tags/兼职运维/index.html","hash":"41399baa87a5c38e0bdf3eff4a25d9c03a14085b","modified":1599905594500},{"_id":"public/tags/pandas/index.html","hash":"617b123ea7ee2bb079bad5cebb5928ff380ca442","modified":1599905594501},{"_id":"public/tags/shell/index.html","hash":"8f1e0a2d998f08677760c3a2017557d8a997db88","modified":1599905594503},{"_id":"public/tags/运维/index.html","hash":"65d938aa71d702e2badb372ec3ac338679c0db21","modified":1599905594503},{"_id":"public/tags/jenkins/index.html","hash":"81eeea9921313693b49cf9e11110160d4f36750c","modified":1599905594504},{"_id":"public/tags/事务/index.html","hash":"8253b2e48d0e133bd751e8d585b50fca2cc9cdd0","modified":1599905594506},{"_id":"public/2020/04/09/jenkins前后端分离部署/index.html","hash":"b19c4413b5b6993cc11ac8bb83aed9f91a4621fe","modified":1599905594513},{"_id":"public/2020/07/19/破解安卓机nfc功能模拟卡限制/index.html","hash":"6d24cb7d6d3a611a2b66509a744d7aef8fd07aad","modified":1599905594514},{"_id":"public/2020/03/31/python-pandas-to-csv的使用记录/index.html","hash":"99eec9d5d1931815ef7f9b8c1b3d2227c4547187","modified":1599905594515},{"_id":"public/2020/08/14/记一次spring事务问题排查/index.html","hash":"51b5d70c0cf2e53dc88c284bfa4be9f0b3727fb5","modified":1599905594516},{"_id":"public/2020/03/27/关于pyspark-dataframe与pandas-dataframe的那些事/index.html","hash":"e5a0c1cd11dcdb78ecd1ca9b6c9d6920ae3f3854","modified":1599905594516},{"_id":"public/2019/12/27/兼职运维之ulimit-u/index.html","hash":"e379b8949b5afc35a2093ed8aeefa035d33c7e7e","modified":1599905594516},{"_id":"public/2020/01/13/shell编码整理/index.html","hash":"c87a0f80749e4dcb57e1ea6c0259c4a83f88951c","modified":1599905594517},{"_id":"public/2019/12/23/fabric使用总结/index.html","hash":"21443c9f832b7fa791d019016b2b0c22c06f88a2","modified":1599905594517},{"_id":"public/2019/12/22/hexo容器化部署/index.html","hash":"96215d338c4068ade20a1311b1571d76b1915666","modified":1599905594517},{"_id":"public/2019/07/14/flask-caching源码浅析/index.html","hash":"ef39580831645ed5892b8bfb560cae8f8783db84","modified":1599905594517},{"_id":"public/2019/06/16/数据结构与算法总结/index.html","hash":"ee0b112d1b3333d264ad1c533f9522e1991f6720","modified":1599905594518},{"_id":"public/2019/06/09/python程序员开发规范/index.html","hash":"2822881108db3acc1ff6d68311264b5c561f5a41","modified":1599905594518},{"_id":"public/2019/03/25/flask分布式部署及flask-session/index.html","hash":"ef18300fb26c3dad95326a4cf79e822818786d3e","modified":1599905594518},{"_id":"public/2019/04/27/pycharm远程调试/index.html","hash":"58c0051e0c9b513449a99f8f97261c3008c8b035","modified":1599905594518},{"_id":"public/2019/03/10/webserver异常-TooManyOpenFiles/index.html","hash":"86f3966ff2e7c4f4f3cabe6c005b5b352e111cfb","modified":1599905594519},{"_id":"public/2019/01/22/sqlalchemy数据库连接数异常/index.html","hash":"9598c36241e2a6f6da965285d688faaf25ecaff0","modified":1599905594519},{"_id":"public/2018/12/30/python代码加密部署/index.html","hash":"c2278577160d02b71ce250e0e6438d12eef316d2","modified":1599905594519},{"_id":"public/2018/11/25/flask服务端推送/index.html","hash":"4c68483a78a4abb2cb5df8c14bbaa54fb296e358","modified":1599905594520},{"_id":"public/2018/11/04/win10docker使用填坑/index.html","hash":"2648729e39340cd706e6ad2d377a01f20bcd8e76","modified":1599905594520},{"_id":"public/archives/index.html","hash":"7f266bc19130cc112be940c10e2dc51bd28037ee","modified":1599905594520},{"_id":"public/archives/page/2/index.html","hash":"0cdd69d563fd04d41f26b70ea4fc15ea1a639d48","modified":1599905594521},{"_id":"public/archives/2019/index.html","hash":"a17a3022bf829e1cb8f777f451c0fd75f431c05c","modified":1599905594521},{"_id":"public/index.html","hash":"39f7742c9adb0386ce9c38ec95c4b83b746ffefc","modified":1599905594521},{"_id":"public/page/2/index.html","hash":"2933425694eb8f8340f20437dd6cd0a8e09285fd","modified":1599905594521},{"_id":"public/categories/设计模式/index.html","hash":"85361d54ff60b9b47d758600274b15d14c6e9b0d","modified":1599905594554},{"_id":"public/archives/2020/09/index.html","hash":"7735b7a961f3f0b5b668bfb5b229db48b72ad9b8","modified":1599905594554},{"_id":"public/2020/09/12/设计模式学习总结/index.html","hash":"bf1828907d5f431676603d590c308a49d35ff3ce","modified":1599905594554},{"_id":"public/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1599905594554},{"_id":"public/images/avatar.gif","hash":"264082bb3a1af70d5499c7d22b0902cb454b6d12","modified":1599905594555},{"_id":"public/images/cc-by-nc.svg","hash":"6f076713fb9bf934aa2c1046bdf2cf2e37bc1eab","modified":1599905594555},{"_id":"public/images/algolia_logo.svg","hash":"45eeea0b5fba833e21e38ea10ed5ab385ceb4f01","modified":1599905594555},{"_id":"public/images/cc-by-nc-nd.svg","hash":"bc3588c9b2d7c68830524783120ff6cf957cf668","modified":1599905594556},{"_id":"public/images/cc-by-sa.svg","hash":"70c1535f43e54e5ff35ca81419e77e4c0c301398","modified":1599905594556},{"_id":"public/images/cc-by-nc-sa.svg","hash":"6f55543d1fb9cbc436c101d24f802dec7b41efc3","modified":1599905594572},{"_id":"public/images/cc-by.svg","hash":"e92a33c32d1dac8ed94849b2b4e6456e887efe70","modified":1599905594572},{"_id":"public/images/logo.svg","hash":"169f56fd82941591dad3abd734a50ec7259be950","modified":1599905594573},{"_id":"public/images/cc-by-nd.svg","hash":"42cd73da328077ccc92f859bb8f3cf621b3484f8","modified":1599905594573},{"_id":"public/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1599905594573},{"_id":"public/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1599905594580},{"_id":"public/images/cc-zero.svg","hash":"9bfb52b2f63527a7049247bf00d44e6dc1170e7d","modified":1599905594581},{"_id":"public/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1599905594581},{"_id":"public/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1599905594581},{"_id":"public/images/quote-r.svg","hash":"2a2a250b32a87c69dcc1b1976c74b747bedbfb41","modified":1599905594582},{"_id":"public/images/searchicon.png","hash":"67727a6a969be0b2659b908518fa6706eed307b8","modified":1599905594582},{"_id":"public/images/quote-l.svg","hash":"cd108d6f44351cadf8e6742565217f88818a0458","modified":1599905594582},{"_id":"public/lib/fastclick/LICENSE","hash":"6f474ea75c42442da7bbcf2e9143ce98258efd8d","modified":1599905594582},{"_id":"public/lib/font-awesome/HELP-US-OUT.txt","hash":"ee33b2798b1e714b904d663436c6b3521011d1fa","modified":1599905594582},{"_id":"public/lib/fancybox/source/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1599905598642},{"_id":"public/lib/fancybox/source/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1599905598642},{"_id":"public/lib/fancybox/source/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1599905598648},{"_id":"public/lib/fancybox/source/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1599905598649},{"_id":"public/lib/fancybox/source/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1599905598651},{"_id":"public/lib/fancybox/source/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1599905598652},{"_id":"public/lib/Han/dist/font/han-space.woff","hash":"7a635062b10bf5662ae1d218ba0980171005d060","modified":1599905598652},{"_id":"public/lib/font-awesome/css/font-awesome.css.map","hash":"1573904b82807abbb32c97a3632c6c6808eaac50","modified":1599905598653},{"_id":"public/lib/Han/dist/font/han-space.otf","hash":"07436f011b44051f61b8329c99de4bec64e86f4b","modified":1599905598653},{"_id":"public/lib/Han/dist/font/han.woff","hash":"f38ff9b2eecaa17b50b66aa2dae87e9e7436d195","modified":1599905598654},{"_id":"public/lib/Han/dist/font/han.woff2","hash":"623af3ed5423371ac136a4fe0e8cc7bb7396037a","modified":1599905598655},{"_id":"public/lib/fancybox/source/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1599905598656},{"_id":"public/images/alipay.jpg","hash":"30f5cded3686ee70d56144f06b8547e3ace3cd8d","modified":1599905598656},{"_id":"public/css/main.css","hash":"cd95693e8dfa937e30e702ab5a549bf837b3c2f2","modified":1599905598809},{"_id":"public/images/avatar.jpeg","hash":"48414fbdb4a202ee77595083a0a00cdcb3a99fbc","modified":1599905598809},{"_id":"public/images/wechatpay.jpg","hash":"3e223daecbb37196edbbeb937ce23063d305aa7b","modified":1599905598820},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1599905598820},{"_id":"public/lib/Han/dist/font/han.otf","hash":"f1f6bb8f461f5672e000380195d3d2358a28494c","modified":1599905598820},{"_id":"public/js/src/bootstrap.js","hash":"034bc8113e0966fe2096ba5b56061bbf10ef0512","modified":1599905598957},{"_id":"public/js/src/hook-duoshuo.js","hash":"a6119070c0119f33e08b29da7d2cce2635eb40a0","modified":1599905598957},{"_id":"public/js/src/affix.js","hash":"978e0422b5bf1b560236d8d10ebc1adcf66392e3","modified":1599905598959},{"_id":"public/js/src/algolia-search.js","hash":"b172f697ed339a24b1e80261075232978d164c35","modified":1599905598965},{"_id":"public/js/src/js.cookie.js","hash":"9b37973a90fd50e71ea91682265715e45ae82c75","modified":1599905598966},{"_id":"public/js/src/exturl.js","hash":"e42e2aaab7bf4c19a0c8e779140e079c6aa5c0b1","modified":1599905598966},{"_id":"public/js/src/scroll-cookie.js","hash":"09dc828cbf5f31158ff6250d2bf7c3cde6365c67","modified":1599905598966},{"_id":"public/js/src/post-details.js","hash":"a13f45f7aa8291cf7244ec5ba93907d119c5dbdd","modified":1599905598966},{"_id":"public/lib/fastclick/bower.json","hash":"4dcecf83afddba148464d5339c93f6d0aa9f42e9","modified":1599905598966},{"_id":"public/lib/algolia-instant-search/instantsearch.min.css","hash":"90ef19edc982645b118b095615838d9c5eaba0de","modified":1599905598967},{"_id":"public/js/src/scrollspy.js","hash":"fe4da1b9fe73518226446f5f27d2831e4426fc35","modified":1599905598967},{"_id":"public/lib/canvas-ribbon/canvas-ribbon.js","hash":"ff5915eb2596e890a2fc6697c864f861a1995ec0","modified":1599905598969},{"_id":"public/lib/fastclick/README.html","hash":"da3c74d484c73cc7df565e8abbfa4d6a5a18d4da","modified":1599905598969},{"_id":"public/lib/canvas-nest/canvas-nest.min.js","hash":"0387e75e23b1db108a755073fe52a0d03eb391a7","modified":1599905598969},{"_id":"public/lib/needsharebutton/needsharebutton.css","hash":"3ef0020a1815ca6151ea4886cd0d37421ae3695c","modified":1599905598969},{"_id":"public/lib/font-awesome/bower.json","hash":"64394a2a9aa00f8e321d8daa5e51a420f0e96dad","modified":1599905598969},{"_id":"public/lib/jquery_lazyload/README.html","hash":"bde24335f6bc09d8801c0dcd7274f71b466552bd","modified":1599905598971},{"_id":"public/lib/jquery_lazyload/CONTRIBUTING.html","hash":"a6358170d346af13b1452ac157b60505bec7015c","modified":1599905598972},{"_id":"public/lib/jquery_lazyload/bower.json","hash":"ae3c3b61e6e7f9e1d7e3585ad854380ecc04cf53","modified":1599905598972},{"_id":"public/lib/jquery_lazyload/jquery.scrollstop.js","hash":"0e9a81785a011c98be5ea821a8ed7d411818cfd1","modified":1599905598972},{"_id":"public/lib/pace/pace-theme-center-atom.min.css","hash":"dcf79c24fe5350fb73d8038573a104e73639e9d3","modified":1599905598973},{"_id":"public/lib/pace/pace-theme-bounce.min.css","hash":"f6bdb9a785b7979dd8ec5c60e278af955ef1e585","modified":1599905598973},{"_id":"public/lib/pace/pace-theme-big-counter.min.css","hash":"5b561dc328af4c4d512e20a76fe964d113a32ba8","modified":1599905598973},{"_id":"public/lib/pace/pace-theme-flash.min.css","hash":"13ace22c40312d7bbd8d9c1e50eff897a7a497d8","modified":1599905598973},{"_id":"public/lib/pace/pace-theme-center-circle.min.css","hash":"a4066769c78affbfbc5e30a600e2c7862cd532e0","modified":1599905598973},{"_id":"public/lib/pace/pace-theme-mac-osx.min.css","hash":"9f2e7b51b084da407863826b25265b31150b3821","modified":1599905598973},{"_id":"public/lib/pace/pace-theme-corner-indicator.min.css","hash":"b3c64c973f31884e3d8145989476707333406b9a","modified":1599905598974},{"_id":"public/lib/pace/pace-theme-center-radar.min.css","hash":"ab7cba998bf4c03b13df342bf43647fa4f419783","modified":1599905598974},{"_id":"public/lib/pace/pace-theme-fill-left.min.css","hash":"0bec1e235a4a2cccda3f993b205424e1441a44ae","modified":1599905598974},{"_id":"public/lib/pace/pace-theme-barber-shop.min.css","hash":"ee0d51446cb4ffe1bb96bd7bc8c8e046dddfcf46","modified":1599905598974},{"_id":"public/lib/pace/pace-theme-center-simple.min.css","hash":"67f44c947548bd4d77e7590d3f59e236cbf9e98a","modified":1599905598974},{"_id":"public/lib/pace/pace-theme-minimal.min.css","hash":"9cd783cceb8a191f3c8b5d81f7a430ecc3e489d3","modified":1599905598974},{"_id":"public/js/src/schemes/pisces.js","hash":"8050a5b2683d1d77238c5762b6bd89c543daed6e","modified":1599905598974},{"_id":"public/lib/velocity/bower.json","hash":"0ef14e7ccdfba5db6eb3f8fc6aa3b47282c36409","modified":1599905598974},{"_id":"public/lib/fancybox/source/jquery.fancybox.css","hash":"5f163444617b6cf267342f06ac166a237bb62df9","modified":1599905598975},{"_id":"public/lib/fastclick/lib/fastclick.min.js","hash":"2cae0f5a6c5d6f3cb993015e6863f9483fc4de18","modified":1599905598975},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","hash":"1a9d8e5c22b371fcc69d4dbbb823d9c39f04c0c8","modified":1599905598975},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","hash":"53e194f4a72e649c04fb586dd57762b8c022800b","modified":1599905598975},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","hash":"91e41741c2e93f732c82aaacec4cfc6e3f3ec876","modified":1599905598975},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1599905598975},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-media.js","hash":"3bdf69ed2469e4fb57f5a95f17300eef891ff90d","modified":1599905598976},{"_id":"public/lib/font-awesome/fonts/FontAwesome.otf","hash":"048707bc52ac4b6563aaa383bfe8660a0ddc908c","modified":1599905598976},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1599905598976},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1599905598976},{"_id":"public/js/src/motion.js","hash":"754b294394f102c8fd9423a1789ddb1201677898","modified":1599905599109},{"_id":"public/js/src/utils.js","hash":"9b1325801d27213083d1487a12b1a62b539ab6f8","modified":1599905599109},{"_id":"public/lib/jquery_lazyload/jquery.lazyload.js","hash":"481fd478650e12b67c201a0ea41e92743f8b45a3","modified":1599905599109},{"_id":"public/lib/pace/pace-theme-loading-bar.min.css","hash":"7ee28875dfc1230d76c537f6605766e8d4011e9f","modified":1599905599109},{"_id":"public/lib/pace/pace.min.js","hash":"9944dfb7814b911090e96446cea4d36e2b487234","modified":1599905599109},{"_id":"public/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1599905599109},{"_id":"public/lib/ua-parser-js/dist/ua-parser.pack.js","hash":"214dad442a92d36af77ed0ca1d9092b16687f02f","modified":1599905599109},{"_id":"public/lib/ua-parser-js/dist/ua-parser.min.js","hash":"38628e75e4412cc6f11074e03e1c6d257aae495b","modified":1599905599109},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.ttf","hash":"13b1eab65a983c7a73bc7997c479d66943f7c6cb","modified":1599905599109},{"_id":"public/lib/needsharebutton/needsharebutton.js","hash":"9885fd9bea5e7ebafc5b1de9d17be5e106248d96","modified":1599905599121},{"_id":"public/lib/fancybox/source/jquery.fancybox.pack.js","hash":"53360764b429c212f424399384417ccc233bb3be","modified":1599905599121},{"_id":"public/lib/fastclick/lib/fastclick.js","hash":"06cef196733a710e77ad7e386ced6963f092dc55","modified":1599905599207},{"_id":"public/lib/font-awesome/css/font-awesome.min.css","hash":"512c7d79033e3028a9be61b540cf1a6870c896f8","modified":1599905599207},{"_id":"public/lib/three/canvas_lines.min.js","hash":"dce4a3b65f8bf958f973690caa7ec4952f353b0c","modified":1599905599327},{"_id":"public/lib/three/three-waves.min.js","hash":"d968cba6b3a50b3626a02d67b544f349d83b147c","modified":1599905599327},{"_id":"public/lib/three/canvas_sphere.min.js","hash":"d8ea241a53c135a650f7335d2b6982b899fd58a9","modified":1599905599338},{"_id":"public/lib/velocity/velocity.ui.js","hash":"6a1d101eab3de87527bb54fcc8c7b36b79d8f0df","modified":1599905599339},{"_id":"public/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1599905599342},{"_id":"public/lib/font-awesome/css/font-awesome.css","hash":"0140952c64e3f2b74ef64e050f2fe86eab6624c8","modified":1599905599342},{"_id":"public/lib/Han/dist/han.min.js","hash":"f559c68a25065a14f47da954a7617d87263e409d","modified":1599905599343},{"_id":"public/lib/needsharebutton/font-embedded.css","hash":"c39d37278c1e178838732af21bd26cd0baeddfe0","modified":1599905599560},{"_id":"public/lib/fancybox/source/jquery.fancybox.js","hash":"1cf3d47b5ccb7cb6e9019c64f2a88d03a64853e4","modified":1599905599679},{"_id":"public/lib/Han/dist/han.min.css","hash":"a0c9e32549a8b8cf327ab9227b037f323cdb60ee","modified":1599905599682},{"_id":"public/lib/Han/dist/han.css","hash":"bd40da3fba8735df5850956814e312bd7b3193d7","modified":1599905599838},{"_id":"public/lib/jquery/index.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1599905599942},{"_id":"public/lib/Han/dist/han.js","hash":"e345397e0585c9fed1449e614ec13e0224acf2ab","modified":1599905599942},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.svg","hash":"b5483b11f8ba213e733b5b8af9927a04fec996f6","modified":1599905599954},{"_id":"public/lib/velocity/velocity.js","hash":"9f08181baea0cc0e906703b7e5df9111b9ef3373","modified":1599905599995},{"_id":"public/lib/algolia-instant-search/instantsearch.min.js","hash":"9ccc6f8144f54e86df9a3fd33a18368d81cf3a4f","modified":1599905600068},{"_id":"public/lib/three/three.min.js","hash":"73f4cdc17e51a72b9bf5b9291f65386d615c483b","modified":1599905600090}],"Category":[{"name":"flask","_id":"ckezigl4w00051gp7gk6a5p9t"},{"name":"问题分析","_id":"ckezigl5h000b1gp72w6c73gy"},{"name":"python","_id":"ckezigl5x000g1gp7p0f296ay"},{"name":"docker","_id":"ckezigl6h000o1gp72iho6jmu"},{"name":"coding-tools","_id":"ckezigl6u000u1gp7r7jz79yr"},{"name":"algorithm&datastructure","_id":"ckezigl7900121gp7hfiadlyk"},{"name":"linux","_id":"ckezigl7n00191gp792eksav7"},{"name":"设计模式","_id":"ckezigl85001e1gp71n6lmmfv"},{"name":"手机","_id":"ckezigl8b001l1gp7u7hkqduy"},{"name":"shell","_id":"ckezigl8d001o1gp71xqiq3m4"},{"name":"部署","_id":"ckezigl8p001u1gp7cx1assaw"},{"name":"spring","_id":"ckeziglqv00331gp7yxjzyn63"}],"Data":[],"Page":[{"title":"about","date":"2018-09-16T09:18:34.000Z","_content":"","source":"about/index.md","raw":"---\ntitle: about\ndate: 2018-09-16 17:18:34\n---\n","updated":"2020-03-28T14:35:40.000Z","path":"about/index.html","comments":1,"layout":"page","_id":"ckezigl4j00011gp77ea0bvp3","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"categories","date":"2018-09-16T09:17:00.000Z","type":"categories","comments":0,"_content":"","source":"categories/index.md","raw":"---\ntitle: categories\ndate: 2018-09-16 17:17:00\ntype: \"categories\"\ncomments: false\n---\n","updated":"2020-03-28T14:35:40.000Z","path":"categories/index.html","layout":"page","_id":"ckezigl4n00031gp7otiuph87","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"tags","date":"2018-09-16T09:16:53.000Z","type":"tags","comments":0,"_content":"","source":"tags/index.md","raw":"---\ntitle: tags\ndate: 2018-09-16 17:16:53\ntype: \"tags\"\ncomments: false\n---\n","updated":"2020-03-28T14:35:40.000Z","path":"tags/index.html","layout":"page","_id":"ckezigl4z00071gp7pkeivhtb","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"draft_file","_content":"","source":"_drafts/draft-file.md","raw":"---\ntitle: draft_file\ntags:\n---\n","slug":"draft-file","published":0,"date":"2020-03-28T14:35:40.000Z","updated":"2020-03-28T14:35:40.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckezigkx200001gp7iszhznse","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"flask服务端推送","date":"2018-11-25T07:09:26.000Z","_content":"{%note info%}\n本文用以记录在`flask-sse`使用中踩到的坑及解决方案。\n{%endnote%}\n<!--more-->\n\n### 当前主流的服务端推送方案\n1. 客户端短连接轮询\n2. websocket\n3. Server Send Event（SSE）\n\n相较于轮询的方式，websocket和sse会稍显高级而不是无脑的轮询浪费网络资源。\n在最近一次的方案选型中，我选择了sse，理由是websocket是双工，且需要单独的服务，而项目的需求仅是向客户端进行简单的推送信息，对比之下sse更显轻量且开发量更少。\n***\n\n### 使用过程中遇到的困难\n- **`flask-sse` redis连接释放问题**\n该库目前存在缺陷，当浏览器刷新或者网关断开重连时会重新`new EventSource`，然而服务端并无法得知连接的断开，导致redis连接数会一直增加。\n唯一释放的机会在于当再次收到推送信息，协程被唤醒并产生`GeneratorExit`异常\n因此代码中未对异常捕获，将错过最后一次释放reids连接的机会：\n```python\n@stream_with_context\ndef generator():\n    for message in self.messages(channel=channel):\n        yield str(message)\n        self.redis.connection_pool.disconnect()\n```\n\t修改的代码已上传github，并提交merge，但是由于没有通过python2的测试用例导致未被合并（懒得适配），有兴趣的童鞋可以直接查看我fork提交的代码。\n\n\t`redis连接数查看`\n```\nredis-cli -a pwd -h *.*.*.* info | grep client\n```\n\n- **程序阻塞问题**\n由于最开始使用之前未仔细看官方的实用说明和源码，发现uwsgi实用进程线程的启动模式，程序运行几次之后就阻塞了，最后发现正确的打开方式是使用协程的方式驱动http服务。\n\n\t另外还有一点现象，当使用flask自带的http服务器进行多线程`threaded=True`调试时redis连接能一次性释放掉，而当使用gunicorn+gevent方式运行时却没有一步到位的效果，原因是协程是异步的，一次`最多`能唤醒对应进程数量的协程，所以redis的释放问题最终还是需要通过定时推送心跳包的方式解决，推荐使用`celery`。\n\n- **网关超时问题**\n网关基本都会有超时设置，而浏览器的断线重连貌似对于504的异常并不起作用。\n\t因此需要针对超时异常进行特殊处理。\n\t这里给出[nginx配置](https://github.com/BotBotMe/botbot-web/issues/2)\n```\t\nlocation /eventsource {\ninclude uwsgi_params;\nuwsgi_pass eventsource-botbot-backend;\nuwsgi_buffering off;\nchunked_transfer_encoding off;\nproxy_cache off;\naccess_log  /var/log/nginx/eventsource_botbot.access.log;\nerror_page 504 =200 @eventsource-close-graceful;\n}\n\nlocation @eventsource-close-graceful {\nadd_header Content-Type text/event-stream;\nreturn 200;\n}\n```\n\t`注意`每个nginx网关就需要配置\n\n***\n\n### 参考资料\n- [官方用例](https://github.com/singingwolfboy/flask-sse)","source":"_posts/2018-11-25-flask服务端推送.md","raw":"---\ntitle: flask服务端推送\ndate: 2018-11-25 15:09:26\ntags:\n- flask\n- sse\ncategories:\n- flask\n---\n{%note info%}\n本文用以记录在`flask-sse`使用中踩到的坑及解决方案。\n{%endnote%}\n<!--more-->\n\n### 当前主流的服务端推送方案\n1. 客户端短连接轮询\n2. websocket\n3. Server Send Event（SSE）\n\n相较于轮询的方式，websocket和sse会稍显高级而不是无脑的轮询浪费网络资源。\n在最近一次的方案选型中，我选择了sse，理由是websocket是双工，且需要单独的服务，而项目的需求仅是向客户端进行简单的推送信息，对比之下sse更显轻量且开发量更少。\n***\n\n### 使用过程中遇到的困难\n- **`flask-sse` redis连接释放问题**\n该库目前存在缺陷，当浏览器刷新或者网关断开重连时会重新`new EventSource`，然而服务端并无法得知连接的断开，导致redis连接数会一直增加。\n唯一释放的机会在于当再次收到推送信息，协程被唤醒并产生`GeneratorExit`异常\n因此代码中未对异常捕获，将错过最后一次释放reids连接的机会：\n```python\n@stream_with_context\ndef generator():\n    for message in self.messages(channel=channel):\n        yield str(message)\n        self.redis.connection_pool.disconnect()\n```\n\t修改的代码已上传github，并提交merge，但是由于没有通过python2的测试用例导致未被合并（懒得适配），有兴趣的童鞋可以直接查看我fork提交的代码。\n\n\t`redis连接数查看`\n```\nredis-cli -a pwd -h *.*.*.* info | grep client\n```\n\n- **程序阻塞问题**\n由于最开始使用之前未仔细看官方的实用说明和源码，发现uwsgi实用进程线程的启动模式，程序运行几次之后就阻塞了，最后发现正确的打开方式是使用协程的方式驱动http服务。\n\n\t另外还有一点现象，当使用flask自带的http服务器进行多线程`threaded=True`调试时redis连接能一次性释放掉，而当使用gunicorn+gevent方式运行时却没有一步到位的效果，原因是协程是异步的，一次`最多`能唤醒对应进程数量的协程，所以redis的释放问题最终还是需要通过定时推送心跳包的方式解决，推荐使用`celery`。\n\n- **网关超时问题**\n网关基本都会有超时设置，而浏览器的断线重连貌似对于504的异常并不起作用。\n\t因此需要针对超时异常进行特殊处理。\n\t这里给出[nginx配置](https://github.com/BotBotMe/botbot-web/issues/2)\n```\t\nlocation /eventsource {\ninclude uwsgi_params;\nuwsgi_pass eventsource-botbot-backend;\nuwsgi_buffering off;\nchunked_transfer_encoding off;\nproxy_cache off;\naccess_log  /var/log/nginx/eventsource_botbot.access.log;\nerror_page 504 =200 @eventsource-close-graceful;\n}\n\nlocation @eventsource-close-graceful {\nadd_header Content-Type text/event-stream;\nreturn 200;\n}\n```\n\t`注意`每个nginx网关就需要配置\n\n***\n\n### 参考资料\n- [官方用例](https://github.com/singingwolfboy/flask-sse)","slug":"flask服务端推送","published":1,"updated":"2020-03-28T14:35:40.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckezigl4l00021gp7gnjnp59o","content":"<div class=\"note info\"><p>本文用以记录在<code>flask-sse</code>使用中踩到的坑及解决方案。</p></div>\n<a id=\"more\"></a>\n<h3 id=\"当前主流的服务端推送方案\"><a href=\"#当前主流的服务端推送方案\" class=\"headerlink\" title=\"当前主流的服务端推送方案\"></a>当前主流的服务端推送方案</h3><ol>\n<li>客户端短连接轮询</li>\n<li>websocket</li>\n<li>Server Send Event（SSE）</li>\n</ol>\n<p>相较于轮询的方式，websocket和sse会稍显高级而不是无脑的轮询浪费网络资源。<br>在最近一次的方案选型中，我选择了sse，理由是websocket是双工，且需要单独的服务，而项目的需求仅是向客户端进行简单的推送信息，对比之下sse更显轻量且开发量更少。</p>\n<hr>\n<h3 id=\"使用过程中遇到的困难\"><a href=\"#使用过程中遇到的困难\" class=\"headerlink\" title=\"使用过程中遇到的困难\"></a>使用过程中遇到的困难</h3><ul>\n<li><p><strong><code>flask-sse</code> redis连接释放问题</strong><br>该库目前存在缺陷，当浏览器刷新或者网关断开重连时会重新<code>new EventSource</code>，然而服务端并无法得知连接的断开，导致redis连接数会一直增加。<br>唯一释放的机会在于当再次收到推送信息，协程被唤醒并产生<code>GeneratorExit</code>异常<br>因此代码中未对异常捕获，将错过最后一次释放reids连接的机会：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@stream_with_context</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">generator</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> message <span class=\"keyword\">in</span> self.messages(channel=channel):</span><br><span class=\"line\">        <span class=\"keyword\">yield</span> str(message)</span><br><span class=\"line\">        self.redis.connection_pool.disconnect()</span><br></pre></td></tr></table></figure>\n<p>  修改的代码已上传github，并提交merge，但是由于没有通过python2的测试用例导致未被合并（懒得适配），有兴趣的童鞋可以直接查看我fork提交的代码。</p>\n<p>  <code>redis连接数查看</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">redis-cli -a pwd -h *.*.*.* info | grep client</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>程序阻塞问题</strong><br>由于最开始使用之前未仔细看官方的实用说明和源码，发现uwsgi实用进程线程的启动模式，程序运行几次之后就阻塞了，最后发现正确的打开方式是使用协程的方式驱动http服务。</p>\n<p>  另外还有一点现象，当使用flask自带的http服务器进行多线程<code>threaded=True</code>调试时redis连接能一次性释放掉，而当使用gunicorn+gevent方式运行时却没有一步到位的效果，原因是协程是异步的，一次<code>最多</code>能唤醒对应进程数量的协程，所以redis的释放问题最终还是需要通过定时推送心跳包的方式解决，推荐使用<code>celery</code>。</p>\n</li>\n<li><p><strong>网关超时问题</strong><br>网关基本都会有超时设置，而浏览器的断线重连貌似对于504的异常并不起作用。<br>  因此需要针对超时异常进行特殊处理。<br>  这里给出<a href=\"https://github.com/BotBotMe/botbot-web/issues/2\" target=\"_blank\" rel=\"noopener\">nginx配置</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location /eventsource &#123;</span><br><span class=\"line\">include uwsgi_params;</span><br><span class=\"line\">uwsgi_pass eventsource-botbot-backend;</span><br><span class=\"line\">uwsgi_buffering off;</span><br><span class=\"line\">chunked_transfer_encoding off;</span><br><span class=\"line\">proxy_cache off;</span><br><span class=\"line\">access_log  /var/log/nginx/eventsource_botbot.access.log;</span><br><span class=\"line\">error_page 504 =200 @eventsource-close-graceful;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">location @eventsource-close-graceful &#123;</span><br><span class=\"line\">add_header Content-Type text/event-stream;</span><br><span class=\"line\">return 200;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>  <code>注意</code>每个nginx网关就需要配置</p>\n</li>\n</ul>\n<hr>\n<h3 id=\"参考资料\"><a href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"></a>参考资料</h3><ul>\n<li><a href=\"https://github.com/singingwolfboy/flask-sse\" target=\"_blank\" rel=\"noopener\">官方用例</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"<div class=\"note info\"><p>本文用以记录在<code>flask-sse</code>使用中踩到的坑及解决方案。</p></div>","more":"<h3 id=\"当前主流的服务端推送方案\"><a href=\"#当前主流的服务端推送方案\" class=\"headerlink\" title=\"当前主流的服务端推送方案\"></a>当前主流的服务端推送方案</h3><ol>\n<li>客户端短连接轮询</li>\n<li>websocket</li>\n<li>Server Send Event（SSE）</li>\n</ol>\n<p>相较于轮询的方式，websocket和sse会稍显高级而不是无脑的轮询浪费网络资源。<br>在最近一次的方案选型中，我选择了sse，理由是websocket是双工，且需要单独的服务，而项目的需求仅是向客户端进行简单的推送信息，对比之下sse更显轻量且开发量更少。</p>\n<hr>\n<h3 id=\"使用过程中遇到的困难\"><a href=\"#使用过程中遇到的困难\" class=\"headerlink\" title=\"使用过程中遇到的困难\"></a>使用过程中遇到的困难</h3><ul>\n<li><p><strong><code>flask-sse</code> redis连接释放问题</strong><br>该库目前存在缺陷，当浏览器刷新或者网关断开重连时会重新<code>new EventSource</code>，然而服务端并无法得知连接的断开，导致redis连接数会一直增加。<br>唯一释放的机会在于当再次收到推送信息，协程被唤醒并产生<code>GeneratorExit</code>异常<br>因此代码中未对异常捕获，将错过最后一次释放reids连接的机会：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@stream_with_context</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">generator</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> message <span class=\"keyword\">in</span> self.messages(channel=channel):</span><br><span class=\"line\">        <span class=\"keyword\">yield</span> str(message)</span><br><span class=\"line\">        self.redis.connection_pool.disconnect()</span><br></pre></td></tr></table></figure>\n<p>  修改的代码已上传github，并提交merge，但是由于没有通过python2的测试用例导致未被合并（懒得适配），有兴趣的童鞋可以直接查看我fork提交的代码。</p>\n<p>  <code>redis连接数查看</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">redis-cli -a pwd -h *.*.*.* info | grep client</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>程序阻塞问题</strong><br>由于最开始使用之前未仔细看官方的实用说明和源码，发现uwsgi实用进程线程的启动模式，程序运行几次之后就阻塞了，最后发现正确的打开方式是使用协程的方式驱动http服务。</p>\n<p>  另外还有一点现象，当使用flask自带的http服务器进行多线程<code>threaded=True</code>调试时redis连接能一次性释放掉，而当使用gunicorn+gevent方式运行时却没有一步到位的效果，原因是协程是异步的，一次<code>最多</code>能唤醒对应进程数量的协程，所以redis的释放问题最终还是需要通过定时推送心跳包的方式解决，推荐使用<code>celery</code>。</p>\n</li>\n<li><p><strong>网关超时问题</strong><br>网关基本都会有超时设置，而浏览器的断线重连貌似对于504的异常并不起作用。<br>  因此需要针对超时异常进行特殊处理。<br>  这里给出<a href=\"https://github.com/BotBotMe/botbot-web/issues/2\" target=\"_blank\" rel=\"noopener\">nginx配置</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location /eventsource &#123;</span><br><span class=\"line\">include uwsgi_params;</span><br><span class=\"line\">uwsgi_pass eventsource-botbot-backend;</span><br><span class=\"line\">uwsgi_buffering off;</span><br><span class=\"line\">chunked_transfer_encoding off;</span><br><span class=\"line\">proxy_cache off;</span><br><span class=\"line\">access_log  /var/log/nginx/eventsource_botbot.access.log;</span><br><span class=\"line\">error_page 504 =200 @eventsource-close-graceful;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">location @eventsource-close-graceful &#123;</span><br><span class=\"line\">add_header Content-Type text/event-stream;</span><br><span class=\"line\">return 200;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>  <code>注意</code>每个nginx网关就需要配置</p>\n</li>\n</ul>\n<hr>\n<h3 id=\"参考资料\"><a href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"></a>参考资料</h3><ul>\n<li><a href=\"https://github.com/singingwolfboy/flask-sse\" target=\"_blank\" rel=\"noopener\">官方用例</a></li>\n</ul>"},{"title":"sqlalchemy数据库连接数异常","date":"2019-01-22T13:03:19.000Z","_content":"\n### 问题现象：\n{%note warning%}\n- web端调用flask接口阻塞，最终超时返回系统异常\n- 查询日志得知具体异常为超出数据库最大连接数\n- 重新flask webserver后数据库连接数正常释放\n- 持续使用系统一段时间后数据库连接数再次封顶\n- 环境操作用户寥寥无几\n{%endnote%}\n\n\n<!--more-->\n***\n### 问题环境：\n{%note info%}\n- 使用flask搭建webserver的运行环境\n- 使用flask-sqlalchemy连接数据库并进行相关业务操作，SQLALCHEMY_POOL_SIZE = 64， SQLALCHEMY_POOL_RECYCLE = 30\n- mysql设置最大连接数200\n- 宿主机CPU 2核心\n- 通过进程数2*2+1 = 5\n{%endnote%}\n***\n\n### 问题分析：\n\n1. 怀疑对flask-sqlalchemy使用不当导致\n  - 问题原因明显是数据库连接使用后没有释放\n  - 数据库操作业务层均使用封装的方法，不存在操作对数据库的连接和释放\n  - flask-sqlalchemy的连接释放由`teardown_appcontext`钩子统一处理\n  ```python\n\t@app.teardown_appcontext\n\tdef shutdown_session(response_or_exc):\n\t    if app.config['SQLALCHEMY_COMMIT_ON_TEARDOWN']:\n\t        if response_or_exc is None:\n\t            self.session.commit()\n\t\n\t    self.session.remove()\n\t    return response_or_exc\n\t```\n2. mysql数据库连接超出首因\n\t- (2\\*2+1) * 64 > 200 \n\t- 困惑连接数回收已经指定`SQLALCHEMY_POOL_RECYCLE=30`但未生效\n\t- 对`SQLALCHEMY_POOL_RECYCLE`理解错误，该项真实含义为queue_pool可用连接的回收时间\n\t- 当前问题为连接未释放，顾与`SQLALCHEMY_POOL_RECYCLE`无关\n3. 若(2\\*2+1) * 64 < 200 会不会好点？\n\t- 异常改为`QueuePool limit of size <x> overflow <y> reached, connection timed out, timeout <z>\n`\n\t- 达到queue_pool的最大限制后同样是无法连接数据库，只是换了种“死法”\n\t\n**分析到这里仍旧没有头绪...**\n\n***\n\n### 问题排查：\n- **查询数据库连接数** \n  ```shell\n\tSELECT * FROM INFORMATION_SCHEMA. PROCESSLIST\n\t```\n- **linux下查询连接端口对应的进程**\n\t```shell\n\tlsof -i:48057|grep celery|awk   '{print$2}'|xargs -I{} echo 'ps -ef|grep {}'|bash\n\t```\n- **windows下查询连接端口对应的进程**\n  ```shell\n\tnetstat -ano|findstr \"8080\"\n\ttasklist|findstr [进程号]\n\t```\n***\n\n### 问题解决：\n- 问题调试发现单接口调用连接数并未按预期增长\n- 通过页面使用操作连接数会不规则的增长\n- 逐个接口比对，最终发现在调用sse长连接接口后，连接数会稳定增长1\n- 分析sse仅操作了redis，并未存在对mysql的相关操作\n- 调试发现调用sse会进入@after_request请求钩子中，而在该钩子处理函数中使用了current_user，即调用了数据库\n- 到此真相大白，代码修改很简单过滤该url既可，但问题的思考排查真实饶了一大圈\n***\n\n### 问题总结：\n- 最后反思，其实在确定flask-sqlalchemy框架层在正常api逻辑处理中会自动释放连接后，就应该直接猜测是非业务短连接接口导致，但这其中的盲点主要在sse正常情况下是与mysql毫不相干的，顾很容易忽略sse的长连接问题\n***\n","source":"_posts/2019-01-22-sqlalchemy数据库连接数异常.md","raw":"---\ntitle: sqlalchemy数据库连接数异常\ndate: 2019-01-22 21:03:19\ntags:\n- mysql\n- 问题分析\ncategories:\n- 问题分析\n---\n\n### 问题现象：\n{%note warning%}\n- web端调用flask接口阻塞，最终超时返回系统异常\n- 查询日志得知具体异常为超出数据库最大连接数\n- 重新flask webserver后数据库连接数正常释放\n- 持续使用系统一段时间后数据库连接数再次封顶\n- 环境操作用户寥寥无几\n{%endnote%}\n\n\n<!--more-->\n***\n### 问题环境：\n{%note info%}\n- 使用flask搭建webserver的运行环境\n- 使用flask-sqlalchemy连接数据库并进行相关业务操作，SQLALCHEMY_POOL_SIZE = 64， SQLALCHEMY_POOL_RECYCLE = 30\n- mysql设置最大连接数200\n- 宿主机CPU 2核心\n- 通过进程数2*2+1 = 5\n{%endnote%}\n***\n\n### 问题分析：\n\n1. 怀疑对flask-sqlalchemy使用不当导致\n  - 问题原因明显是数据库连接使用后没有释放\n  - 数据库操作业务层均使用封装的方法，不存在操作对数据库的连接和释放\n  - flask-sqlalchemy的连接释放由`teardown_appcontext`钩子统一处理\n  ```python\n\t@app.teardown_appcontext\n\tdef shutdown_session(response_or_exc):\n\t    if app.config['SQLALCHEMY_COMMIT_ON_TEARDOWN']:\n\t        if response_or_exc is None:\n\t            self.session.commit()\n\t\n\t    self.session.remove()\n\t    return response_or_exc\n\t```\n2. mysql数据库连接超出首因\n\t- (2\\*2+1) * 64 > 200 \n\t- 困惑连接数回收已经指定`SQLALCHEMY_POOL_RECYCLE=30`但未生效\n\t- 对`SQLALCHEMY_POOL_RECYCLE`理解错误，该项真实含义为queue_pool可用连接的回收时间\n\t- 当前问题为连接未释放，顾与`SQLALCHEMY_POOL_RECYCLE`无关\n3. 若(2\\*2+1) * 64 < 200 会不会好点？\n\t- 异常改为`QueuePool limit of size <x> overflow <y> reached, connection timed out, timeout <z>\n`\n\t- 达到queue_pool的最大限制后同样是无法连接数据库，只是换了种“死法”\n\t\n**分析到这里仍旧没有头绪...**\n\n***\n\n### 问题排查：\n- **查询数据库连接数** \n  ```shell\n\tSELECT * FROM INFORMATION_SCHEMA. PROCESSLIST\n\t```\n- **linux下查询连接端口对应的进程**\n\t```shell\n\tlsof -i:48057|grep celery|awk   '{print$2}'|xargs -I{} echo 'ps -ef|grep {}'|bash\n\t```\n- **windows下查询连接端口对应的进程**\n  ```shell\n\tnetstat -ano|findstr \"8080\"\n\ttasklist|findstr [进程号]\n\t```\n***\n\n### 问题解决：\n- 问题调试发现单接口调用连接数并未按预期增长\n- 通过页面使用操作连接数会不规则的增长\n- 逐个接口比对，最终发现在调用sse长连接接口后，连接数会稳定增长1\n- 分析sse仅操作了redis，并未存在对mysql的相关操作\n- 调试发现调用sse会进入@after_request请求钩子中，而在该钩子处理函数中使用了current_user，即调用了数据库\n- 到此真相大白，代码修改很简单过滤该url既可，但问题的思考排查真实饶了一大圈\n***\n\n### 问题总结：\n- 最后反思，其实在确定flask-sqlalchemy框架层在正常api逻辑处理中会自动释放连接后，就应该直接猜测是非业务短连接接口导致，但这其中的盲点主要在sse正常情况下是与mysql毫不相干的，顾很容易忽略sse的长连接问题\n***\n","slug":"sqlalchemy数据库连接数异常","published":1,"updated":"2020-03-28T14:35:40.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckezigl4p00041gp7w2693uok","content":"<h3 id=\"问题现象：\"><a href=\"#问题现象：\" class=\"headerlink\" title=\"问题现象：\"></a>问题现象：</h3><div class=\"note warning\"><ul>\n<li>web端调用flask接口阻塞，最终超时返回系统异常</li>\n<li>查询日志得知具体异常为超出数据库最大连接数</li>\n<li>重新flask webserver后数据库连接数正常释放</li>\n<li>持续使用系统一段时间后数据库连接数再次封顶</li>\n<li>环境操作用户寥寥无几</li>\n</ul></div>\n<a id=\"more\"></a>\n<hr>\n<h3 id=\"问题环境：\"><a href=\"#问题环境：\" class=\"headerlink\" title=\"问题环境：\"></a>问题环境：</h3><div class=\"note info\"><ul>\n<li>使用flask搭建webserver的运行环境</li>\n<li>使用flask-sqlalchemy连接数据库并进行相关业务操作，SQLALCHEMY_POOL_SIZE = 64， SQLALCHEMY_POOL_RECYCLE = 30</li>\n<li>mysql设置最大连接数200</li>\n<li>宿主机CPU 2核心</li>\n<li>通过进程数2*2+1 = 5</li>\n</ul></div>\n<hr>\n<h3 id=\"问题分析：\"><a href=\"#问题分析：\" class=\"headerlink\" title=\"问题分析：\"></a>问题分析：</h3><ol>\n<li><p>怀疑对flask-sqlalchemy使用不当导致</p>\n<ul>\n<li>问题原因明显是数据库连接使用后没有释放</li>\n<li>数据库操作业务层均使用封装的方法，不存在操作对数据库的连接和释放</li>\n<li>flask-sqlalchemy的连接释放由<code>teardown_appcontext</code>钩子统一处理<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@app.teardown_appcontext</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">shutdown_session</span><span class=\"params\">(response_or_exc)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> app.config[<span class=\"string\">'SQLALCHEMY_COMMIT_ON_TEARDOWN'</span>]:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> response_or_exc <span class=\"keyword\">is</span> <span class=\"keyword\">None</span>:</span><br><span class=\"line\">            self.session.commit()</span><br><span class=\"line\"></span><br><span class=\"line\">    self.session.remove()</span><br><span class=\"line\">    <span class=\"keyword\">return</span> response_or_exc</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li><p>mysql数据库连接超出首因</p>\n<ul>\n<li>(2*2+1) * 64 &gt; 200 </li>\n<li>困惑连接数回收已经指定<code>SQLALCHEMY_POOL_RECYCLE=30</code>但未生效</li>\n<li>对<code>SQLALCHEMY_POOL_RECYCLE</code>理解错误，该项真实含义为queue_pool可用连接的回收时间</li>\n<li>当前问题为连接未释放，顾与<code>SQLALCHEMY_POOL_RECYCLE</code>无关</li>\n</ul>\n</li>\n<li>若(2*2+1) * 64 &lt; 200 会不会好点？<ul>\n<li>异常改为<code>QueuePool limit of size &lt;x&gt; overflow &lt;y&gt; reached, connection timed out, timeout &lt;z&gt;</code></li>\n<li>达到queue_pool的最大限制后同样是无法连接数据库，只是换了种“死法”</li>\n</ul>\n</li>\n</ol>\n<p><strong>分析到这里仍旧没有头绪…</strong></p>\n<hr>\n<h3 id=\"问题排查：\"><a href=\"#问题排查：\" class=\"headerlink\" title=\"问题排查：\"></a>问题排查：</h3><ul>\n<li><p><strong>查询数据库连接数</strong> </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SELECT * FROM INFORMATION_SCHEMA. PROCESSLIST</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>linux下查询连接端口对应的进程</strong></p>\n  <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lsof -i:48057|grep celery|awk   '&#123;print$2&#125;'|xargs -I&#123;&#125; echo 'ps -ef|grep &#123;&#125;'|bash</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>windows下查询连接端口对应的进程</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netstat -ano|findstr \"8080\"</span><br><span class=\"line\">tasklist|findstr [进程号]</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<h3 id=\"问题解决：\"><a href=\"#问题解决：\" class=\"headerlink\" title=\"问题解决：\"></a>问题解决：</h3><ul>\n<li>问题调试发现单接口调用连接数并未按预期增长</li>\n<li>通过页面使用操作连接数会不规则的增长</li>\n<li>逐个接口比对，最终发现在调用sse长连接接口后，连接数会稳定增长1</li>\n<li>分析sse仅操作了redis，并未存在对mysql的相关操作</li>\n<li>调试发现调用sse会进入@after_request请求钩子中，而在该钩子处理函数中使用了current_user，即调用了数据库</li>\n<li>到此真相大白，代码修改很简单过滤该url既可，但问题的思考排查真实饶了一大圈</li>\n</ul>\n<hr>\n<h3 id=\"问题总结：\"><a href=\"#问题总结：\" class=\"headerlink\" title=\"问题总结：\"></a>问题总结：</h3><ul>\n<li>最后反思，其实在确定flask-sqlalchemy框架层在正常api逻辑处理中会自动释放连接后，就应该直接猜测是非业务短连接接口导致，但这其中的盲点主要在sse正常情况下是与mysql毫不相干的，顾很容易忽略sse的长连接问题</li>\n</ul>\n<hr>\n","site":{"data":{}},"excerpt":"<h3 id=\"问题现象：\"><a href=\"#问题现象：\" class=\"headerlink\" title=\"问题现象：\"></a>问题现象：</h3><div class=\"note warning\"><ul>\n<li>web端调用flask接口阻塞，最终超时返回系统异常</li>\n<li>查询日志得知具体异常为超出数据库最大连接数</li>\n<li>重新flask webserver后数据库连接数正常释放</li>\n<li>持续使用系统一段时间后数据库连接数再次封顶</li>\n<li>环境操作用户寥寥无几</li>\n</ul></div>","more":"<hr>\n<h3 id=\"问题环境：\"><a href=\"#问题环境：\" class=\"headerlink\" title=\"问题环境：\"></a>问题环境：</h3><div class=\"note info\"><ul>\n<li>使用flask搭建webserver的运行环境</li>\n<li>使用flask-sqlalchemy连接数据库并进行相关业务操作，SQLALCHEMY_POOL_SIZE = 64， SQLALCHEMY_POOL_RECYCLE = 30</li>\n<li>mysql设置最大连接数200</li>\n<li>宿主机CPU 2核心</li>\n<li>通过进程数2*2+1 = 5</li>\n</ul></div>\n<hr>\n<h3 id=\"问题分析：\"><a href=\"#问题分析：\" class=\"headerlink\" title=\"问题分析：\"></a>问题分析：</h3><ol>\n<li><p>怀疑对flask-sqlalchemy使用不当导致</p>\n<ul>\n<li>问题原因明显是数据库连接使用后没有释放</li>\n<li>数据库操作业务层均使用封装的方法，不存在操作对数据库的连接和释放</li>\n<li>flask-sqlalchemy的连接释放由<code>teardown_appcontext</code>钩子统一处理<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@app.teardown_appcontext</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">shutdown_session</span><span class=\"params\">(response_or_exc)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> app.config[<span class=\"string\">'SQLALCHEMY_COMMIT_ON_TEARDOWN'</span>]:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> response_or_exc <span class=\"keyword\">is</span> <span class=\"keyword\">None</span>:</span><br><span class=\"line\">            self.session.commit()</span><br><span class=\"line\"></span><br><span class=\"line\">    self.session.remove()</span><br><span class=\"line\">    <span class=\"keyword\">return</span> response_or_exc</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li><p>mysql数据库连接超出首因</p>\n<ul>\n<li>(2*2+1) * 64 &gt; 200 </li>\n<li>困惑连接数回收已经指定<code>SQLALCHEMY_POOL_RECYCLE=30</code>但未生效</li>\n<li>对<code>SQLALCHEMY_POOL_RECYCLE</code>理解错误，该项真实含义为queue_pool可用连接的回收时间</li>\n<li>当前问题为连接未释放，顾与<code>SQLALCHEMY_POOL_RECYCLE</code>无关</li>\n</ul>\n</li>\n<li>若(2*2+1) * 64 &lt; 200 会不会好点？<ul>\n<li>异常改为<code>QueuePool limit of size &lt;x&gt; overflow &lt;y&gt; reached, connection timed out, timeout &lt;z&gt;</code></li>\n<li>达到queue_pool的最大限制后同样是无法连接数据库，只是换了种“死法”</li>\n</ul>\n</li>\n</ol>\n<p><strong>分析到这里仍旧没有头绪…</strong></p>\n<hr>\n<h3 id=\"问题排查：\"><a href=\"#问题排查：\" class=\"headerlink\" title=\"问题排查：\"></a>问题排查：</h3><ul>\n<li><p><strong>查询数据库连接数</strong> </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SELECT * FROM INFORMATION_SCHEMA. PROCESSLIST</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>linux下查询连接端口对应的进程</strong></p>\n  <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lsof -i:48057|grep celery|awk   '&#123;print$2&#125;'|xargs -I&#123;&#125; echo 'ps -ef|grep &#123;&#125;'|bash</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>windows下查询连接端口对应的进程</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netstat -ano|findstr \"8080\"</span><br><span class=\"line\">tasklist|findstr [进程号]</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<h3 id=\"问题解决：\"><a href=\"#问题解决：\" class=\"headerlink\" title=\"问题解决：\"></a>问题解决：</h3><ul>\n<li>问题调试发现单接口调用连接数并未按预期增长</li>\n<li>通过页面使用操作连接数会不规则的增长</li>\n<li>逐个接口比对，最终发现在调用sse长连接接口后，连接数会稳定增长1</li>\n<li>分析sse仅操作了redis，并未存在对mysql的相关操作</li>\n<li>调试发现调用sse会进入@after_request请求钩子中，而在该钩子处理函数中使用了current_user，即调用了数据库</li>\n<li>到此真相大白，代码修改很简单过滤该url既可，但问题的思考排查真实饶了一大圈</li>\n</ul>\n<hr>\n<h3 id=\"问题总结：\"><a href=\"#问题总结：\" class=\"headerlink\" title=\"问题总结：\"></a>问题总结：</h3><ul>\n<li>最后反思，其实在确定flask-sqlalchemy框架层在正常api逻辑处理中会自动释放连接后，就应该直接猜测是非业务短连接接口导致，但这其中的盲点主要在sse正常情况下是与mysql毫不相干的，顾很容易忽略sse的长连接问题</li>\n</ul>\n<hr>"},{"title":"python代码pyc化加密部署","date":"2018-12-30T08:45:56.000Z","_content":"\n{%note info%}\npython不像c，java等编译型语言（编译后发布机器码），解释型则必须把源码发布出去，但仍存在一些交付场景希望能够将python代码加密。\n{%endnote%}\n<!--more-->\n\n### 为什么转换为pyc？\n- pyc官方的解释还请自行google\n- 简而言之，pyc文件为字节码文件，单个.py生成.pyc文件后运行效果相同\n- pyc文件运行效率高于py文件（少了解释器对源码的转换）\n- pyc虽然可以进行逆向转换，但不一定可靠（没试过），不过已经满足了简单加密的需求，毕竟源码裸奔交付是心理上不能接收的\n\n### 如何转换为pyc？\n```shell\npython -m compileall (file or dir) -b\n```\n- -b 支持生成pyc文件于当前目录而非`__pycache__`\n\n### 配合jenkins进行自动集成发布\n- 基于flask开发目录\n\n```\n/app\n/conf\n/tests\n...\n```\n\n```shell\n# /bin/sh\n\nfunction timeoutController(){\n    cmd=$1\n    timeout=$2\n    mod=$3\n    count=1\n    while [ $count -le 3 ]; do\n        timeout $timeout $cmd\n        exitCode=$?\n        if [[ $exitCode == 0 ]] || [[ $exitCode -ne 124 ]]; then\n            break\n        fi\n\n        if [ $exitCode == 124 ]; then\n            echo \"module: {$mod} timeout {$timeout} s and start to {$count} time retry\"\n        fi\n        count=`expr $count + 1`\n    done\n\n    if [ $exitCode -ne 0 ]; then\n        echo $mod \"=====================>unittest failed\"\n        exit 1\n    fi\n}\n\nfunction code_encrypt(){\n    release_dir=$1\n    pyc_dir=$2\n\n    # release svn del .svn\n    find $release_dir -name \".svn\" | xargs rm -rf\n\n    # svn del pyc\n    cd $pyc_dir\n    svn rm * --force\n    svn ci -m \"pyc delete\"\n\n    # cp release code to pyc && encrypt code\n    cp $release_dir/* $pyc_dir -R\n    python -m compileall . -b\n    find . -name \"*.py\" | xargs rm\n    rm tests/report -rf\n    # replace gunicorn.pyc with gunicorn.py\n    rm $pyc_dir/conf/gunicorn.pyc\n    cp $release_dir/conf/gunicorn.py $pyc_dir/conf/\n\n    # pyc svn commit\n    svn add . --no-ignore --force\n    svn ci -m \"pyc commit\"\n}\n\nfunction main(){\n    echo \"========================== init env =============\"\n    source /root/anaconda3/bin/activate py3\n    release_dir=\"/home/pro/pro_release\"\n    pyc_dir=\"/home/pro/pro_pyc\"\n    release_svn_dir=\"http://*.*.*.*/\"\n\n    # update tag:release code\n    rm $release_dir -rf\n    svn co $release_svn_dir\n\n    echo \"========================== flake8 ===============\"\n    cd $release_dir\n    timeoutController \"flake8 --config=${release_dir}/.config/flake8 ${release_dir}\" 60 \"flake8\"\n\n    echo \"========================== pytest ===============\"\n    cd $release_dir/tests\n    timeoutController \"pytest .\"\n\n    echo \"========================== code encrypt =============\"\n    code_encrypt $release_dir $pyc_dir\n}\n\nmain\n```\n\n{%note warning%}\n- 以上脚本基于svn代码管理，如使用git，则flake8，pytest测试可通过git hook，而单单保留代码加密\n- gunicorn 貌似不支持指定pyc为配置文件，但这不影响整体的加密效果，后续可以在研究研究，毕竟对于我这种重度洁癖患者，留这一个.py文件就像一个小疙瘩，总想给它挠掉\n{%endnote%}","source":"_posts/2018-12-30-python代码加密部署.md","raw":"---\ntitle: python代码pyc化加密部署\ndate: 2018-12-30 16:45:56\ntags:\n- python\ncategories:\n- python\n---\n\n{%note info%}\npython不像c，java等编译型语言（编译后发布机器码），解释型则必须把源码发布出去，但仍存在一些交付场景希望能够将python代码加密。\n{%endnote%}\n<!--more-->\n\n### 为什么转换为pyc？\n- pyc官方的解释还请自行google\n- 简而言之，pyc文件为字节码文件，单个.py生成.pyc文件后运行效果相同\n- pyc文件运行效率高于py文件（少了解释器对源码的转换）\n- pyc虽然可以进行逆向转换，但不一定可靠（没试过），不过已经满足了简单加密的需求，毕竟源码裸奔交付是心理上不能接收的\n\n### 如何转换为pyc？\n```shell\npython -m compileall (file or dir) -b\n```\n- -b 支持生成pyc文件于当前目录而非`__pycache__`\n\n### 配合jenkins进行自动集成发布\n- 基于flask开发目录\n\n```\n/app\n/conf\n/tests\n...\n```\n\n```shell\n# /bin/sh\n\nfunction timeoutController(){\n    cmd=$1\n    timeout=$2\n    mod=$3\n    count=1\n    while [ $count -le 3 ]; do\n        timeout $timeout $cmd\n        exitCode=$?\n        if [[ $exitCode == 0 ]] || [[ $exitCode -ne 124 ]]; then\n            break\n        fi\n\n        if [ $exitCode == 124 ]; then\n            echo \"module: {$mod} timeout {$timeout} s and start to {$count} time retry\"\n        fi\n        count=`expr $count + 1`\n    done\n\n    if [ $exitCode -ne 0 ]; then\n        echo $mod \"=====================>unittest failed\"\n        exit 1\n    fi\n}\n\nfunction code_encrypt(){\n    release_dir=$1\n    pyc_dir=$2\n\n    # release svn del .svn\n    find $release_dir -name \".svn\" | xargs rm -rf\n\n    # svn del pyc\n    cd $pyc_dir\n    svn rm * --force\n    svn ci -m \"pyc delete\"\n\n    # cp release code to pyc && encrypt code\n    cp $release_dir/* $pyc_dir -R\n    python -m compileall . -b\n    find . -name \"*.py\" | xargs rm\n    rm tests/report -rf\n    # replace gunicorn.pyc with gunicorn.py\n    rm $pyc_dir/conf/gunicorn.pyc\n    cp $release_dir/conf/gunicorn.py $pyc_dir/conf/\n\n    # pyc svn commit\n    svn add . --no-ignore --force\n    svn ci -m \"pyc commit\"\n}\n\nfunction main(){\n    echo \"========================== init env =============\"\n    source /root/anaconda3/bin/activate py3\n    release_dir=\"/home/pro/pro_release\"\n    pyc_dir=\"/home/pro/pro_pyc\"\n    release_svn_dir=\"http://*.*.*.*/\"\n\n    # update tag:release code\n    rm $release_dir -rf\n    svn co $release_svn_dir\n\n    echo \"========================== flake8 ===============\"\n    cd $release_dir\n    timeoutController \"flake8 --config=${release_dir}/.config/flake8 ${release_dir}\" 60 \"flake8\"\n\n    echo \"========================== pytest ===============\"\n    cd $release_dir/tests\n    timeoutController \"pytest .\"\n\n    echo \"========================== code encrypt =============\"\n    code_encrypt $release_dir $pyc_dir\n}\n\nmain\n```\n\n{%note warning%}\n- 以上脚本基于svn代码管理，如使用git，则flake8，pytest测试可通过git hook，而单单保留代码加密\n- gunicorn 貌似不支持指定pyc为配置文件，但这不影响整体的加密效果，后续可以在研究研究，毕竟对于我这种重度洁癖患者，留这一个.py文件就像一个小疙瘩，总想给它挠掉\n{%endnote%}","slug":"python代码加密部署","published":1,"updated":"2020-03-28T14:35:40.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckezigl5100081gp7ntyr4rgr","content":"<div class=\"note info\"><p>python不像c，java等编译型语言（编译后发布机器码），解释型则必须把源码发布出去，但仍存在一些交付场景希望能够将python代码加密。</p></div>\n<a id=\"more\"></a>\n<h3 id=\"为什么转换为pyc？\"><a href=\"#为什么转换为pyc？\" class=\"headerlink\" title=\"为什么转换为pyc？\"></a>为什么转换为pyc？</h3><ul>\n<li>pyc官方的解释还请自行google</li>\n<li>简而言之，pyc文件为字节码文件，单个.py生成.pyc文件后运行效果相同</li>\n<li>pyc文件运行效率高于py文件（少了解释器对源码的转换）</li>\n<li>pyc虽然可以进行逆向转换，但不一定可靠（没试过），不过已经满足了简单加密的需求，毕竟源码裸奔交付是心理上不能接收的</li>\n</ul>\n<h3 id=\"如何转换为pyc？\"><a href=\"#如何转换为pyc？\" class=\"headerlink\" title=\"如何转换为pyc？\"></a>如何转换为pyc？</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python -m compileall (file or dir) -b</span><br></pre></td></tr></table></figure>\n<ul>\n<li>-b 支持生成pyc文件于当前目录而非<code>__pycache__</code></li>\n</ul>\n<h3 id=\"配合jenkins进行自动集成发布\"><a href=\"#配合jenkins进行自动集成发布\" class=\"headerlink\" title=\"配合jenkins进行自动集成发布\"></a>配合jenkins进行自动集成发布</h3><ul>\n<li>基于flask开发目录</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/app</span><br><span class=\"line\">/conf</span><br><span class=\"line\">/tests</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span> /bin/sh</span><br><span class=\"line\"></span><br><span class=\"line\">function timeoutController()&#123;</span><br><span class=\"line\">    cmd=$1</span><br><span class=\"line\">    timeout=$2</span><br><span class=\"line\">    mod=$3</span><br><span class=\"line\">    count=1</span><br><span class=\"line\">    while [ $count -le 3 ]; do</span><br><span class=\"line\">        timeout $timeout $cmd</span><br><span class=\"line\">        exitCode=$?</span><br><span class=\"line\">        if [[ $exitCode == 0 ]] || [[ $exitCode -ne 124 ]]; then</span><br><span class=\"line\">            break</span><br><span class=\"line\">        fi</span><br><span class=\"line\"></span><br><span class=\"line\">        if [ $exitCode == 124 ]; then</span><br><span class=\"line\">            echo \"module: &#123;$mod&#125; timeout &#123;$timeout&#125; s and start to &#123;$count&#125; time retry\"</span><br><span class=\"line\">        fi</span><br><span class=\"line\">        count=`expr $count + 1`</span><br><span class=\"line\">    done</span><br><span class=\"line\"></span><br><span class=\"line\">    if [ $exitCode -ne 0 ]; then</span><br><span class=\"line\">        echo $mod \"=====================&gt;unittest failed\"</span><br><span class=\"line\">        exit 1</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function code_encrypt()&#123;</span><br><span class=\"line\">    release_dir=$1</span><br><span class=\"line\">    pyc_dir=$2</span><br><span class=\"line\"></span><br><span class=\"line\">    # release svn del .svn</span><br><span class=\"line\">    find $release_dir -name \".svn\" | xargs rm -rf</span><br><span class=\"line\"></span><br><span class=\"line\">    # svn del pyc</span><br><span class=\"line\">    cd $pyc_dir</span><br><span class=\"line\">    svn rm * --force</span><br><span class=\"line\">    svn ci -m \"pyc delete\"</span><br><span class=\"line\"></span><br><span class=\"line\">    # cp release code to pyc &amp;&amp; encrypt code</span><br><span class=\"line\">    cp $release_dir/* $pyc_dir -R</span><br><span class=\"line\">    python -m compileall . -b</span><br><span class=\"line\">    find . -name \"*.py\" | xargs rm</span><br><span class=\"line\">    rm tests/report -rf</span><br><span class=\"line\">    # replace gunicorn.pyc with gunicorn.py</span><br><span class=\"line\">    rm $pyc_dir/conf/gunicorn.pyc</span><br><span class=\"line\">    cp $release_dir/conf/gunicorn.py $pyc_dir/conf/</span><br><span class=\"line\"></span><br><span class=\"line\">    # pyc svn commit</span><br><span class=\"line\">    svn add . --no-ignore --force</span><br><span class=\"line\">    svn ci -m \"pyc commit\"</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function main()&#123;</span><br><span class=\"line\">    echo \"========================== init env =============\"</span><br><span class=\"line\">    source /root/anaconda3/bin/activate py3</span><br><span class=\"line\">    release_dir=\"/home/pro/pro_release\"</span><br><span class=\"line\">    pyc_dir=\"/home/pro/pro_pyc\"</span><br><span class=\"line\">    release_svn_dir=\"http://*.*.*.*/\"</span><br><span class=\"line\"></span><br><span class=\"line\">    # update tag:release code</span><br><span class=\"line\">    rm $release_dir -rf</span><br><span class=\"line\">    svn co $release_svn_dir</span><br><span class=\"line\"></span><br><span class=\"line\">    echo \"========================== flake8 ===============\"</span><br><span class=\"line\">    cd $release_dir</span><br><span class=\"line\">    timeoutController \"flake8 --config=$&#123;release_dir&#125;/.config/flake8 $&#123;release_dir&#125;\" 60 \"flake8\"</span><br><span class=\"line\"></span><br><span class=\"line\">    echo \"========================== pytest ===============\"</span><br><span class=\"line\">    cd $release_dir/tests</span><br><span class=\"line\">    timeoutController \"pytest .\"</span><br><span class=\"line\"></span><br><span class=\"line\">    echo \"========================== code encrypt =============\"</span><br><span class=\"line\">    code_encrypt $release_dir $pyc_dir</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">main</span><br></pre></td></tr></table></figure>\n<div class=\"note warning\"><ul>\n<li>以上脚本基于svn代码管理，如使用git，则flake8，pytest测试可通过git hook，而单单保留代码加密</li>\n<li>gunicorn 貌似不支持指定pyc为配置文件，但这不影响整体的加密效果，后续可以在研究研究，毕竟对于我这种重度洁癖患者，留这一个.py文件就像一个小疙瘩，总想给它挠掉</li>\n</ul></div>","site":{"data":{}},"excerpt":"<div class=\"note info\"><p>python不像c，java等编译型语言（编译后发布机器码），解释型则必须把源码发布出去，但仍存在一些交付场景希望能够将python代码加密。</p></div>","more":"<h3 id=\"为什么转换为pyc？\"><a href=\"#为什么转换为pyc？\" class=\"headerlink\" title=\"为什么转换为pyc？\"></a>为什么转换为pyc？</h3><ul>\n<li>pyc官方的解释还请自行google</li>\n<li>简而言之，pyc文件为字节码文件，单个.py生成.pyc文件后运行效果相同</li>\n<li>pyc文件运行效率高于py文件（少了解释器对源码的转换）</li>\n<li>pyc虽然可以进行逆向转换，但不一定可靠（没试过），不过已经满足了简单加密的需求，毕竟源码裸奔交付是心理上不能接收的</li>\n</ul>\n<h3 id=\"如何转换为pyc？\"><a href=\"#如何转换为pyc？\" class=\"headerlink\" title=\"如何转换为pyc？\"></a>如何转换为pyc？</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python -m compileall (file or dir) -b</span><br></pre></td></tr></table></figure>\n<ul>\n<li>-b 支持生成pyc文件于当前目录而非<code>__pycache__</code></li>\n</ul>\n<h3 id=\"配合jenkins进行自动集成发布\"><a href=\"#配合jenkins进行自动集成发布\" class=\"headerlink\" title=\"配合jenkins进行自动集成发布\"></a>配合jenkins进行自动集成发布</h3><ul>\n<li>基于flask开发目录</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/app</span><br><span class=\"line\">/conf</span><br><span class=\"line\">/tests</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span> /bin/sh</span><br><span class=\"line\"></span><br><span class=\"line\">function timeoutController()&#123;</span><br><span class=\"line\">    cmd=$1</span><br><span class=\"line\">    timeout=$2</span><br><span class=\"line\">    mod=$3</span><br><span class=\"line\">    count=1</span><br><span class=\"line\">    while [ $count -le 3 ]; do</span><br><span class=\"line\">        timeout $timeout $cmd</span><br><span class=\"line\">        exitCode=$?</span><br><span class=\"line\">        if [[ $exitCode == 0 ]] || [[ $exitCode -ne 124 ]]; then</span><br><span class=\"line\">            break</span><br><span class=\"line\">        fi</span><br><span class=\"line\"></span><br><span class=\"line\">        if [ $exitCode == 124 ]; then</span><br><span class=\"line\">            echo \"module: &#123;$mod&#125; timeout &#123;$timeout&#125; s and start to &#123;$count&#125; time retry\"</span><br><span class=\"line\">        fi</span><br><span class=\"line\">        count=`expr $count + 1`</span><br><span class=\"line\">    done</span><br><span class=\"line\"></span><br><span class=\"line\">    if [ $exitCode -ne 0 ]; then</span><br><span class=\"line\">        echo $mod \"=====================&gt;unittest failed\"</span><br><span class=\"line\">        exit 1</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function code_encrypt()&#123;</span><br><span class=\"line\">    release_dir=$1</span><br><span class=\"line\">    pyc_dir=$2</span><br><span class=\"line\"></span><br><span class=\"line\">    # release svn del .svn</span><br><span class=\"line\">    find $release_dir -name \".svn\" | xargs rm -rf</span><br><span class=\"line\"></span><br><span class=\"line\">    # svn del pyc</span><br><span class=\"line\">    cd $pyc_dir</span><br><span class=\"line\">    svn rm * --force</span><br><span class=\"line\">    svn ci -m \"pyc delete\"</span><br><span class=\"line\"></span><br><span class=\"line\">    # cp release code to pyc &amp;&amp; encrypt code</span><br><span class=\"line\">    cp $release_dir/* $pyc_dir -R</span><br><span class=\"line\">    python -m compileall . -b</span><br><span class=\"line\">    find . -name \"*.py\" | xargs rm</span><br><span class=\"line\">    rm tests/report -rf</span><br><span class=\"line\">    # replace gunicorn.pyc with gunicorn.py</span><br><span class=\"line\">    rm $pyc_dir/conf/gunicorn.pyc</span><br><span class=\"line\">    cp $release_dir/conf/gunicorn.py $pyc_dir/conf/</span><br><span class=\"line\"></span><br><span class=\"line\">    # pyc svn commit</span><br><span class=\"line\">    svn add . --no-ignore --force</span><br><span class=\"line\">    svn ci -m \"pyc commit\"</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function main()&#123;</span><br><span class=\"line\">    echo \"========================== init env =============\"</span><br><span class=\"line\">    source /root/anaconda3/bin/activate py3</span><br><span class=\"line\">    release_dir=\"/home/pro/pro_release\"</span><br><span class=\"line\">    pyc_dir=\"/home/pro/pro_pyc\"</span><br><span class=\"line\">    release_svn_dir=\"http://*.*.*.*/\"</span><br><span class=\"line\"></span><br><span class=\"line\">    # update tag:release code</span><br><span class=\"line\">    rm $release_dir -rf</span><br><span class=\"line\">    svn co $release_svn_dir</span><br><span class=\"line\"></span><br><span class=\"line\">    echo \"========================== flake8 ===============\"</span><br><span class=\"line\">    cd $release_dir</span><br><span class=\"line\">    timeoutController \"flake8 --config=$&#123;release_dir&#125;/.config/flake8 $&#123;release_dir&#125;\" 60 \"flake8\"</span><br><span class=\"line\"></span><br><span class=\"line\">    echo \"========================== pytest ===============\"</span><br><span class=\"line\">    cd $release_dir/tests</span><br><span class=\"line\">    timeoutController \"pytest .\"</span><br><span class=\"line\"></span><br><span class=\"line\">    echo \"========================== code encrypt =============\"</span><br><span class=\"line\">    code_encrypt $release_dir $pyc_dir</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">main</span><br></pre></td></tr></table></figure>\n<div class=\"note warning\"><ul>\n<li>以上脚本基于svn代码管理，如使用git，则flake8，pytest测试可通过git hook，而单单保留代码加密</li>\n<li>gunicorn 貌似不支持指定pyc为配置文件，但这不影响整体的加密效果，后续可以在研究研究，毕竟对于我这种重度洁癖患者，留这一个.py文件就像一个小疙瘩，总想给它挠掉</li>\n</ul></div>"},{"title":"win10docker使用填坑","date":"2018-11-04T05:17:09.000Z","_content":"{%note info%}\n本文用以记录在`docker win10`环境使用中踩到的坑及解决方案。\n{%endnote%}\n\n<!--more-->\n\n## 问题一：docker修改配置或者镜像的存储位置后启动异常\n### *解决方案*：\n{%note warning%}\n- 移动|剪切 C:\\Users\\Public\\Documents\\Hyper-V\\Virtual hard disks\\MobyLinuxVM.vhdx 再重启电脑\n{%endnote%}\n***\n\n\n\n## 问题二：修改镜像存储位置\n### *解决方案*：\n{%note warning%}\n- 默认位置：C:\\Users\\Public\\Documents\\Hyper-V\\Virtual hard disks\\MobyLinuxVM.vhdx\n- 修改：Hyper-V管理器**Hyper-v设置**虚拟硬盘修改路径\n{%endnote%}\n\n\n***\n\n## 问题三：docker安装mysql8.0容器后，是用navicat连接报client does not support authentication protocol requested by server consider upgrading mysql client\n### *解决方案*：\n{%note warning%}\n- 进入容器\ndocker exec -it mysql bash\n- 进入mysql\nmysql -u root -p\n- 创建root用户\n CREATE USER 'root'@'%' IDENTIFIED IDENTIFIED WITH `mysql_native_password` BY '123456';\n- 设置root用户访问权限\nGRANT ALL PRIVILEGES ON *.* TO 'root'@'%' WITH GRANT OPTION;\n- 重置密码\nALTER USER 'root'@'%' IDENTIFIED WITH `mysql_native_password` BY '123456';\nALTER USER 'root'@'localhost' IDENTIFIED WITH `mysql_native_password` BY '123456';\n- 提交修改\nFLUSH PRIVILEGES;\n{%endnote%}","source":"_posts/2018-11-04-win10docker使用填坑.md","raw":"---\ntitle: win10docker使用填坑\ndate: 2018-11-04 13:17:09\ntags:\n- docker\n- wins10\ncategories:\n- docker\n---\n{%note info%}\n本文用以记录在`docker win10`环境使用中踩到的坑及解决方案。\n{%endnote%}\n\n<!--more-->\n\n## 问题一：docker修改配置或者镜像的存储位置后启动异常\n### *解决方案*：\n{%note warning%}\n- 移动|剪切 C:\\Users\\Public\\Documents\\Hyper-V\\Virtual hard disks\\MobyLinuxVM.vhdx 再重启电脑\n{%endnote%}\n***\n\n\n\n## 问题二：修改镜像存储位置\n### *解决方案*：\n{%note warning%}\n- 默认位置：C:\\Users\\Public\\Documents\\Hyper-V\\Virtual hard disks\\MobyLinuxVM.vhdx\n- 修改：Hyper-V管理器**Hyper-v设置**虚拟硬盘修改路径\n{%endnote%}\n\n\n***\n\n## 问题三：docker安装mysql8.0容器后，是用navicat连接报client does not support authentication protocol requested by server consider upgrading mysql client\n### *解决方案*：\n{%note warning%}\n- 进入容器\ndocker exec -it mysql bash\n- 进入mysql\nmysql -u root -p\n- 创建root用户\n CREATE USER 'root'@'%' IDENTIFIED IDENTIFIED WITH `mysql_native_password` BY '123456';\n- 设置root用户访问权限\nGRANT ALL PRIVILEGES ON *.* TO 'root'@'%' WITH GRANT OPTION;\n- 重置密码\nALTER USER 'root'@'%' IDENTIFIED WITH `mysql_native_password` BY '123456';\nALTER USER 'root'@'localhost' IDENTIFIED WITH `mysql_native_password` BY '123456';\n- 提交修改\nFLUSH PRIVILEGES;\n{%endnote%}","slug":"win10docker使用填坑","published":1,"updated":"2020-03-28T14:35:40.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckezigl5300091gp7zep618in","content":"<div class=\"note info\"><p>本文用以记录在<code>docker win10</code>环境使用中踩到的坑及解决方案。</p></div>\n<a id=\"more\"></a>\n<h2 id=\"问题一：docker修改配置或者镜像的存储位置后启动异常\"><a href=\"#问题一：docker修改配置或者镜像的存储位置后启动异常\" class=\"headerlink\" title=\"问题一：docker修改配置或者镜像的存储位置后启动异常\"></a>问题一：docker修改配置或者镜像的存储位置后启动异常</h2><h3 id=\"解决方案：\"><a href=\"#解决方案：\" class=\"headerlink\" title=\"解决方案：\"></a><em>解决方案</em>：</h3><div class=\"note warning\"><ul>\n<li>移动|剪切 C:\\Users\\Public\\Documents\\Hyper-V\\Virtual hard disks\\MobyLinuxVM.vhdx 再重启电脑</li>\n</ul></div>\n<hr>\n<h2 id=\"问题二：修改镜像存储位置\"><a href=\"#问题二：修改镜像存储位置\" class=\"headerlink\" title=\"问题二：修改镜像存储位置\"></a>问题二：修改镜像存储位置</h2><h3 id=\"解决方案：-1\"><a href=\"#解决方案：-1\" class=\"headerlink\" title=\"解决方案：\"></a><em>解决方案</em>：</h3><div class=\"note warning\"><ul>\n<li>默认位置：C:\\Users\\Public\\Documents\\Hyper-V\\Virtual hard disks\\MobyLinuxVM.vhdx</li>\n<li>修改：Hyper-V管理器<strong>Hyper-v设置</strong>虚拟硬盘修改路径</li>\n</ul></div>\n<hr>\n<h2 id=\"问题三：docker安装mysql8-0容器后，是用navicat连接报client-does-not-support-authentication-protocol-requested-by-server-consider-upgrading-mysql-client\"><a href=\"#问题三：docker安装mysql8-0容器后，是用navicat连接报client-does-not-support-authentication-protocol-requested-by-server-consider-upgrading-mysql-client\" class=\"headerlink\" title=\"问题三：docker安装mysql8.0容器后，是用navicat连接报client does not support authentication protocol requested by server consider upgrading mysql client\"></a>问题三：docker安装mysql8.0容器后，是用navicat连接报client does not support authentication protocol requested by server consider upgrading mysql client</h2><h3 id=\"解决方案：-2\"><a href=\"#解决方案：-2\" class=\"headerlink\" title=\"解决方案：\"></a><em>解决方案</em>：</h3><div class=\"note warning\"><ul>\n<li>进入容器<br>docker exec -it mysql bash</li>\n<li>进入mysql<br>mysql -u root -p</li>\n<li>创建root用户<br>CREATE USER ‘root‘@’%’ IDENTIFIED IDENTIFIED WITH <code>mysql_native_password</code> BY ‘123456’;</li>\n<li>设置root用户访问权限<br>GRANT ALL PRIVILEGES ON <em>.</em> TO ‘root‘@’%’ WITH GRANT OPTION;</li>\n<li>重置密码<br>ALTER USER ‘root‘@’%’ IDENTIFIED WITH <code>mysql_native_password</code> BY ‘123456’;<br>ALTER USER ‘root‘@’localhost’ IDENTIFIED WITH <code>mysql_native_password</code> BY ‘123456’;</li>\n<li>提交修改<br>FLUSH PRIVILEGES;</li>\n</ul></div>","site":{"data":{}},"excerpt":"<div class=\"note info\"><p>本文用以记录在<code>docker win10</code>环境使用中踩到的坑及解决方案。</p></div>","more":"<h2 id=\"问题一：docker修改配置或者镜像的存储位置后启动异常\"><a href=\"#问题一：docker修改配置或者镜像的存储位置后启动异常\" class=\"headerlink\" title=\"问题一：docker修改配置或者镜像的存储位置后启动异常\"></a>问题一：docker修改配置或者镜像的存储位置后启动异常</h2><h3 id=\"解决方案：\"><a href=\"#解决方案：\" class=\"headerlink\" title=\"解决方案：\"></a><em>解决方案</em>：</h3><div class=\"note warning\"><ul>\n<li>移动|剪切 C:\\Users\\Public\\Documents\\Hyper-V\\Virtual hard disks\\MobyLinuxVM.vhdx 再重启电脑</li>\n</ul></div>\n<hr>\n<h2 id=\"问题二：修改镜像存储位置\"><a href=\"#问题二：修改镜像存储位置\" class=\"headerlink\" title=\"问题二：修改镜像存储位置\"></a>问题二：修改镜像存储位置</h2><h3 id=\"解决方案：-1\"><a href=\"#解决方案：-1\" class=\"headerlink\" title=\"解决方案：\"></a><em>解决方案</em>：</h3><div class=\"note warning\"><ul>\n<li>默认位置：C:\\Users\\Public\\Documents\\Hyper-V\\Virtual hard disks\\MobyLinuxVM.vhdx</li>\n<li>修改：Hyper-V管理器<strong>Hyper-v设置</strong>虚拟硬盘修改路径</li>\n</ul></div>\n<hr>\n<h2 id=\"问题三：docker安装mysql8-0容器后，是用navicat连接报client-does-not-support-authentication-protocol-requested-by-server-consider-upgrading-mysql-client\"><a href=\"#问题三：docker安装mysql8-0容器后，是用navicat连接报client-does-not-support-authentication-protocol-requested-by-server-consider-upgrading-mysql-client\" class=\"headerlink\" title=\"问题三：docker安装mysql8.0容器后，是用navicat连接报client does not support authentication protocol requested by server consider upgrading mysql client\"></a>问题三：docker安装mysql8.0容器后，是用navicat连接报client does not support authentication protocol requested by server consider upgrading mysql client</h2><h3 id=\"解决方案：-2\"><a href=\"#解决方案：-2\" class=\"headerlink\" title=\"解决方案：\"></a><em>解决方案</em>：</h3><div class=\"note warning\"><ul>\n<li>进入容器<br>docker exec -it mysql bash</li>\n<li>进入mysql<br>mysql -u root -p</li>\n<li>创建root用户<br>CREATE USER ‘root‘@’%’ IDENTIFIED IDENTIFIED WITH <code>mysql_native_password</code> BY ‘123456’;</li>\n<li>设置root用户访问权限<br>GRANT ALL PRIVILEGES ON <em>.</em> TO ‘root‘@’%’ WITH GRANT OPTION;</li>\n<li>重置密码<br>ALTER USER ‘root‘@’%’ IDENTIFIED WITH <code>mysql_native_password</code> BY ‘123456’;<br>ALTER USER ‘root‘@’localhost’ IDENTIFIED WITH <code>mysql_native_password</code> BY ‘123456’;</li>\n<li>提交修改<br>FLUSH PRIVILEGES;</li>\n</ul></div>"},{"title":"flask分布式部署及flask-session","date":"2019-03-25T13:12:52.000Z","_content":"\n{%note info%}\n随着业务系统访问量的增长，多机部署成了必然，下面来聊聊flask的分布式部署以及原理。\n{%endnote%}\n<!--more-->\n\n### flask默认的session做了什么\nflask作为web应用框架若多机部署，第一个问题是需要一个请求接入网关，通常我们使用nginx统一进行流量的分发。\n但随之而来会有一个新的问题，即flask的session多机之间会共享吗？带着这个问题，我们看看flask关于session的源码：\n```python\nclass SecureCookieSession(CallbackDict, SessionMixin):\n\t...\nclass SecureCookieSessionInterface(SessionInterface):\n\tdef open_session(self, app, request):\n\t\t...\n\tdef save_session(self, app, session, response):\n\t\t...\n```\n以上是flask.sessions.py实现的主要框架：\n- SecureCookieSession即flask的session类，可以简单的理解成一个dict对象。\n- SecureCookieSessionInterface即flask的session接口类，open_session方法用于创建session，save_session方法用于将session加密并存放在response的cookie中。所以flask是默认将用户的session存储在客户端的cookie中，这样请求-应答的数据中就有了用户操作的上下文了，至于这么做的优劣将在下文分析。\n\n### 常见的分布式部署session解决方案\n\n- 服务器间session复制\nsession复制是早期的企业级的使用比较多的一种服务器集群session管理机制。应用服务器开启web容器的session复制功能，在集群中的几台  服务器之间同步session对象，使得每台服务器上都保存所有的session信息，这样任何一台宕机都不会导致session的数据丢失，服务器使用session时，直接从本地获取。\n像java的一些应用服务器，如tomcat等自带次功能。在python-web不常见，`缺点`是session同步会暂用内网网络带宽，且服务器水平扩展存在明显上线。\n- session与服务器绑定\n通过请求网关，如nginx，将负载均衡的策略改成ip-hash的模式，即用户的每次请求都会分发到同一台服务器，那么sesison则能够正常的被解析。\n`优点`：无需修改业务代码\n`缺点`：缺乏高可用性，当其中一台服务器宕机，该机器上用户需要重新登录到其他服务器\n- 客户端session存储\n即flask默认的session存储方案，可见什么都不需要改动，flask已经支持水平扩展，细心的童鞋想想当flask通过gunicorn启动时多进程为啥能够共享session，即不难想到多个服务间共享应该也问题不大。这里注意的是多服务器间的secret_key必须相同。\n`优点`：无需改造，flask默认支持\n`缺点`：\n\t- session数据存储在客户端，即使加密也还是一件存在泄露风险的事情\n\t- session数据占用外网带宽\n\t- 受cookie的大小限制，session能记录的数据有限\n- 服务端session统一存储\n对session进行统一的存储，所有服务器共享该存储服务上的数据\n`优点`：服务水平扩展性良好，服务端存储，安全\n`缺点`：\n\t- 每次请求至少需要一次内部网络请求，占用网络带宽\n\t- 需要侵入业务代码\n\n### flask-session服务端session存储\n通过比较不难发现，服务端session统一存储是最合适的解决方案。\n那么我们来谈谈怎么实现，幸运的是已经有前任实现了flask对应的扩展包`flask-session`，我们一起看看它的实现：\n代码大概500+行，但我们实际用到的可能就几十行。\n- 首先我们需要选择session寄存的服务，flask-session支持`redis`,`memcached`,`filesystem`,`mongodb`,`sqlalchemy`作为存储介质\n- 以redis举例，再看代码：\n```python\nclass RedisSessionInterface(SessionInterface):\n    serializer = pickle\n    session_class = RedisSession\n\n    def __init__(self, redis, key_prefix, use_signer=False, permanent=True):\n        if redis is None:\n            from redis import Redis\n            redis = Redis()\n        self.redis = redis\n        self.key_prefix = key_prefix\n        self.use_signer = use_signer\n        self.permanent = permanent\n\tdef open_session(self, app, request):\n\t\t...\n\tdef save_session(self, app, session, response):\n\t\t...\n```\n重写`open_session，save_session`，将session（dict）存储在redis并将session_id（key）返回给客户端\n\n\n### flask http请求-应答完整的数据流\n客户端http请求 \n-> 服务端负载均衡至随机服务器 \n-> 应用上下文入栈(app_ctx) \n-> 请求上下文入栈(request_ctx),同时生成session \n-> 通过request_ctx中的路由信息找到视图函数(view_func) \n-> view_func进行业务处理 \n-> 应用上下文出栈(app_ctx)\n-> 请求上下文出栈(request_ctx) \n-> 保存session或sessino_id进cookie \n-> 返回应答 \n-> 数据写入对应的文件描述符并刷新\n其实flask的源码阅读起来并不吃力，看下来会发现flask框架代码的思路结构非常的清晰，并惊叹于这个框架的可扩展性，flask的源码非常值得学习和借鉴。","source":"_posts/2019-03-25-flask分布式部署及flask-session.md","raw":"---\ntitle: flask分布式部署及flask-session\ndate: 2019-03-25 21:12:52\ntags:\n- flask \n- session\n- 分布式\ncategories:\n- flask\n---\n\n{%note info%}\n随着业务系统访问量的增长，多机部署成了必然，下面来聊聊flask的分布式部署以及原理。\n{%endnote%}\n<!--more-->\n\n### flask默认的session做了什么\nflask作为web应用框架若多机部署，第一个问题是需要一个请求接入网关，通常我们使用nginx统一进行流量的分发。\n但随之而来会有一个新的问题，即flask的session多机之间会共享吗？带着这个问题，我们看看flask关于session的源码：\n```python\nclass SecureCookieSession(CallbackDict, SessionMixin):\n\t...\nclass SecureCookieSessionInterface(SessionInterface):\n\tdef open_session(self, app, request):\n\t\t...\n\tdef save_session(self, app, session, response):\n\t\t...\n```\n以上是flask.sessions.py实现的主要框架：\n- SecureCookieSession即flask的session类，可以简单的理解成一个dict对象。\n- SecureCookieSessionInterface即flask的session接口类，open_session方法用于创建session，save_session方法用于将session加密并存放在response的cookie中。所以flask是默认将用户的session存储在客户端的cookie中，这样请求-应答的数据中就有了用户操作的上下文了，至于这么做的优劣将在下文分析。\n\n### 常见的分布式部署session解决方案\n\n- 服务器间session复制\nsession复制是早期的企业级的使用比较多的一种服务器集群session管理机制。应用服务器开启web容器的session复制功能，在集群中的几台  服务器之间同步session对象，使得每台服务器上都保存所有的session信息，这样任何一台宕机都不会导致session的数据丢失，服务器使用session时，直接从本地获取。\n像java的一些应用服务器，如tomcat等自带次功能。在python-web不常见，`缺点`是session同步会暂用内网网络带宽，且服务器水平扩展存在明显上线。\n- session与服务器绑定\n通过请求网关，如nginx，将负载均衡的策略改成ip-hash的模式，即用户的每次请求都会分发到同一台服务器，那么sesison则能够正常的被解析。\n`优点`：无需修改业务代码\n`缺点`：缺乏高可用性，当其中一台服务器宕机，该机器上用户需要重新登录到其他服务器\n- 客户端session存储\n即flask默认的session存储方案，可见什么都不需要改动，flask已经支持水平扩展，细心的童鞋想想当flask通过gunicorn启动时多进程为啥能够共享session，即不难想到多个服务间共享应该也问题不大。这里注意的是多服务器间的secret_key必须相同。\n`优点`：无需改造，flask默认支持\n`缺点`：\n\t- session数据存储在客户端，即使加密也还是一件存在泄露风险的事情\n\t- session数据占用外网带宽\n\t- 受cookie的大小限制，session能记录的数据有限\n- 服务端session统一存储\n对session进行统一的存储，所有服务器共享该存储服务上的数据\n`优点`：服务水平扩展性良好，服务端存储，安全\n`缺点`：\n\t- 每次请求至少需要一次内部网络请求，占用网络带宽\n\t- 需要侵入业务代码\n\n### flask-session服务端session存储\n通过比较不难发现，服务端session统一存储是最合适的解决方案。\n那么我们来谈谈怎么实现，幸运的是已经有前任实现了flask对应的扩展包`flask-session`，我们一起看看它的实现：\n代码大概500+行，但我们实际用到的可能就几十行。\n- 首先我们需要选择session寄存的服务，flask-session支持`redis`,`memcached`,`filesystem`,`mongodb`,`sqlalchemy`作为存储介质\n- 以redis举例，再看代码：\n```python\nclass RedisSessionInterface(SessionInterface):\n    serializer = pickle\n    session_class = RedisSession\n\n    def __init__(self, redis, key_prefix, use_signer=False, permanent=True):\n        if redis is None:\n            from redis import Redis\n            redis = Redis()\n        self.redis = redis\n        self.key_prefix = key_prefix\n        self.use_signer = use_signer\n        self.permanent = permanent\n\tdef open_session(self, app, request):\n\t\t...\n\tdef save_session(self, app, session, response):\n\t\t...\n```\n重写`open_session，save_session`，将session（dict）存储在redis并将session_id（key）返回给客户端\n\n\n### flask http请求-应答完整的数据流\n客户端http请求 \n-> 服务端负载均衡至随机服务器 \n-> 应用上下文入栈(app_ctx) \n-> 请求上下文入栈(request_ctx),同时生成session \n-> 通过request_ctx中的路由信息找到视图函数(view_func) \n-> view_func进行业务处理 \n-> 应用上下文出栈(app_ctx)\n-> 请求上下文出栈(request_ctx) \n-> 保存session或sessino_id进cookie \n-> 返回应答 \n-> 数据写入对应的文件描述符并刷新\n其实flask的源码阅读起来并不吃力，看下来会发现flask框架代码的思路结构非常的清晰，并惊叹于这个框架的可扩展性，flask的源码非常值得学习和借鉴。","slug":"flask分布式部署及flask-session","published":1,"updated":"2020-03-28T14:35:40.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckezigl5d000a1gp79zptwpo4","content":"<div class=\"note info\"><p>随着业务系统访问量的增长，多机部署成了必然，下面来聊聊flask的分布式部署以及原理。</p></div>\n<a id=\"more\"></a>\n<h3 id=\"flask默认的session做了什么\"><a href=\"#flask默认的session做了什么\" class=\"headerlink\" title=\"flask默认的session做了什么\"></a>flask默认的session做了什么</h3><p>flask作为web应用框架若多机部署，第一个问题是需要一个请求接入网关，通常我们使用nginx统一进行流量的分发。<br>但随之而来会有一个新的问题，即flask的session多机之间会共享吗？带着这个问题，我们看看flask关于session的源码：<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SecureCookieSession</span><span class=\"params\">(CallbackDict, SessionMixin)</span>:</span></span><br><span class=\"line\">\t...</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SecureCookieSessionInterface</span><span class=\"params\">(SessionInterface)</span>:</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">open_session</span><span class=\"params\">(self, app, request)</span>:</span></span><br><span class=\"line\">\t\t...</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">save_session</span><span class=\"params\">(self, app, session, response)</span>:</span></span><br><span class=\"line\">\t\t...</span><br></pre></td></tr></table></figure></p>\n<p>以上是flask.sessions.py实现的主要框架：</p>\n<ul>\n<li>SecureCookieSession即flask的session类，可以简单的理解成一个dict对象。</li>\n<li>SecureCookieSessionInterface即flask的session接口类，open_session方法用于创建session，save_session方法用于将session加密并存放在response的cookie中。所以flask是默认将用户的session存储在客户端的cookie中，这样请求-应答的数据中就有了用户操作的上下文了，至于这么做的优劣将在下文分析。</li>\n</ul>\n<h3 id=\"常见的分布式部署session解决方案\"><a href=\"#常见的分布式部署session解决方案\" class=\"headerlink\" title=\"常见的分布式部署session解决方案\"></a>常见的分布式部署session解决方案</h3><ul>\n<li>服务器间session复制<br>session复制是早期的企业级的使用比较多的一种服务器集群session管理机制。应用服务器开启web容器的session复制功能，在集群中的几台  服务器之间同步session对象，使得每台服务器上都保存所有的session信息，这样任何一台宕机都不会导致session的数据丢失，服务器使用session时，直接从本地获取。<br>像java的一些应用服务器，如tomcat等自带次功能。在python-web不常见，<code>缺点</code>是session同步会暂用内网网络带宽，且服务器水平扩展存在明显上线。</li>\n<li>session与服务器绑定<br>通过请求网关，如nginx，将负载均衡的策略改成ip-hash的模式，即用户的每次请求都会分发到同一台服务器，那么sesison则能够正常的被解析。<br><code>优点</code>：无需修改业务代码<br><code>缺点</code>：缺乏高可用性，当其中一台服务器宕机，该机器上用户需要重新登录到其他服务器</li>\n<li>客户端session存储<br>即flask默认的session存储方案，可见什么都不需要改动，flask已经支持水平扩展，细心的童鞋想想当flask通过gunicorn启动时多进程为啥能够共享session，即不难想到多个服务间共享应该也问题不大。这里注意的是多服务器间的secret_key必须相同。<br><code>优点</code>：无需改造，flask默认支持<br><code>缺点</code>：<ul>\n<li>session数据存储在客户端，即使加密也还是一件存在泄露风险的事情</li>\n<li>session数据占用外网带宽</li>\n<li>受cookie的大小限制，session能记录的数据有限</li>\n</ul>\n</li>\n<li>服务端session统一存储<br>对session进行统一的存储，所有服务器共享该存储服务上的数据<br><code>优点</code>：服务水平扩展性良好，服务端存储，安全<br><code>缺点</code>：<ul>\n<li>每次请求至少需要一次内部网络请求，占用网络带宽</li>\n<li>需要侵入业务代码</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"flask-session服务端session存储\"><a href=\"#flask-session服务端session存储\" class=\"headerlink\" title=\"flask-session服务端session存储\"></a>flask-session服务端session存储</h3><p>通过比较不难发现，服务端session统一存储是最合适的解决方案。<br>那么我们来谈谈怎么实现，幸运的是已经有前任实现了flask对应的扩展包<code>flask-session</code>，我们一起看看它的实现：<br>代码大概500+行，但我们实际用到的可能就几十行。</p>\n<ul>\n<li>首先我们需要选择session寄存的服务，flask-session支持<code>redis</code>,<code>memcached</code>,<code>filesystem</code>,<code>mongodb</code>,<code>sqlalchemy</code>作为存储介质</li>\n<li>以redis举例，再看代码：<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RedisSessionInterface</span><span class=\"params\">(SessionInterface)</span>:</span></span><br><span class=\"line\">    serializer = pickle</span><br><span class=\"line\">    session_class = RedisSession</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__init__</span><span class=\"params\">(self, redis, key_prefix, use_signer=False, permanent=True)</span>:</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> redis <span class=\"keyword\">is</span> <span class=\"keyword\">None</span>:</span><br><span class=\"line\">            <span class=\"keyword\">from</span> redis <span class=\"keyword\">import</span> Redis</span><br><span class=\"line\">            redis = Redis()</span><br><span class=\"line\">        self.redis = redis</span><br><span class=\"line\">        self.key_prefix = key_prefix</span><br><span class=\"line\">        self.use_signer = use_signer</span><br><span class=\"line\">        self.permanent = permanent</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">open_session</span><span class=\"params\">(self, app, request)</span>:</span></span><br><span class=\"line\">\t\t...</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">save_session</span><span class=\"params\">(self, app, session, response)</span>:</span></span><br><span class=\"line\">\t\t...</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>重写<code>open_session，save_session</code>，将session（dict）存储在redis并将session_id（key）返回给客户端</p>\n<h3 id=\"flask-http请求-应答完整的数据流\"><a href=\"#flask-http请求-应答完整的数据流\" class=\"headerlink\" title=\"flask http请求-应答完整的数据流\"></a>flask http请求-应答完整的数据流</h3><p>客户端http请求<br>-&gt; 服务端负载均衡至随机服务器<br>-&gt; 应用上下文入栈(app_ctx)<br>-&gt; 请求上下文入栈(request_ctx),同时生成session<br>-&gt; 通过request_ctx中的路由信息找到视图函数(view_func)<br>-&gt; view_func进行业务处理<br>-&gt; 应用上下文出栈(app_ctx)<br>-&gt; 请求上下文出栈(request_ctx)<br>-&gt; 保存session或sessino_id进cookie<br>-&gt; 返回应答<br>-&gt; 数据写入对应的文件描述符并刷新<br>其实flask的源码阅读起来并不吃力，看下来会发现flask框架代码的思路结构非常的清晰，并惊叹于这个框架的可扩展性，flask的源码非常值得学习和借鉴。</p>\n","site":{"data":{}},"excerpt":"<div class=\"note info\"><p>随着业务系统访问量的增长，多机部署成了必然，下面来聊聊flask的分布式部署以及原理。</p></div>","more":"<h3 id=\"flask默认的session做了什么\"><a href=\"#flask默认的session做了什么\" class=\"headerlink\" title=\"flask默认的session做了什么\"></a>flask默认的session做了什么</h3><p>flask作为web应用框架若多机部署，第一个问题是需要一个请求接入网关，通常我们使用nginx统一进行流量的分发。<br>但随之而来会有一个新的问题，即flask的session多机之间会共享吗？带着这个问题，我们看看flask关于session的源码：<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SecureCookieSession</span><span class=\"params\">(CallbackDict, SessionMixin)</span>:</span></span><br><span class=\"line\">\t...</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SecureCookieSessionInterface</span><span class=\"params\">(SessionInterface)</span>:</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">open_session</span><span class=\"params\">(self, app, request)</span>:</span></span><br><span class=\"line\">\t\t...</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">save_session</span><span class=\"params\">(self, app, session, response)</span>:</span></span><br><span class=\"line\">\t\t...</span><br></pre></td></tr></table></figure></p>\n<p>以上是flask.sessions.py实现的主要框架：</p>\n<ul>\n<li>SecureCookieSession即flask的session类，可以简单的理解成一个dict对象。</li>\n<li>SecureCookieSessionInterface即flask的session接口类，open_session方法用于创建session，save_session方法用于将session加密并存放在response的cookie中。所以flask是默认将用户的session存储在客户端的cookie中，这样请求-应答的数据中就有了用户操作的上下文了，至于这么做的优劣将在下文分析。</li>\n</ul>\n<h3 id=\"常见的分布式部署session解决方案\"><a href=\"#常见的分布式部署session解决方案\" class=\"headerlink\" title=\"常见的分布式部署session解决方案\"></a>常见的分布式部署session解决方案</h3><ul>\n<li>服务器间session复制<br>session复制是早期的企业级的使用比较多的一种服务器集群session管理机制。应用服务器开启web容器的session复制功能，在集群中的几台  服务器之间同步session对象，使得每台服务器上都保存所有的session信息，这样任何一台宕机都不会导致session的数据丢失，服务器使用session时，直接从本地获取。<br>像java的一些应用服务器，如tomcat等自带次功能。在python-web不常见，<code>缺点</code>是session同步会暂用内网网络带宽，且服务器水平扩展存在明显上线。</li>\n<li>session与服务器绑定<br>通过请求网关，如nginx，将负载均衡的策略改成ip-hash的模式，即用户的每次请求都会分发到同一台服务器，那么sesison则能够正常的被解析。<br><code>优点</code>：无需修改业务代码<br><code>缺点</code>：缺乏高可用性，当其中一台服务器宕机，该机器上用户需要重新登录到其他服务器</li>\n<li>客户端session存储<br>即flask默认的session存储方案，可见什么都不需要改动，flask已经支持水平扩展，细心的童鞋想想当flask通过gunicorn启动时多进程为啥能够共享session，即不难想到多个服务间共享应该也问题不大。这里注意的是多服务器间的secret_key必须相同。<br><code>优点</code>：无需改造，flask默认支持<br><code>缺点</code>：<ul>\n<li>session数据存储在客户端，即使加密也还是一件存在泄露风险的事情</li>\n<li>session数据占用外网带宽</li>\n<li>受cookie的大小限制，session能记录的数据有限</li>\n</ul>\n</li>\n<li>服务端session统一存储<br>对session进行统一的存储，所有服务器共享该存储服务上的数据<br><code>优点</code>：服务水平扩展性良好，服务端存储，安全<br><code>缺点</code>：<ul>\n<li>每次请求至少需要一次内部网络请求，占用网络带宽</li>\n<li>需要侵入业务代码</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"flask-session服务端session存储\"><a href=\"#flask-session服务端session存储\" class=\"headerlink\" title=\"flask-session服务端session存储\"></a>flask-session服务端session存储</h3><p>通过比较不难发现，服务端session统一存储是最合适的解决方案。<br>那么我们来谈谈怎么实现，幸运的是已经有前任实现了flask对应的扩展包<code>flask-session</code>，我们一起看看它的实现：<br>代码大概500+行，但我们实际用到的可能就几十行。</p>\n<ul>\n<li>首先我们需要选择session寄存的服务，flask-session支持<code>redis</code>,<code>memcached</code>,<code>filesystem</code>,<code>mongodb</code>,<code>sqlalchemy</code>作为存储介质</li>\n<li>以redis举例，再看代码：<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RedisSessionInterface</span><span class=\"params\">(SessionInterface)</span>:</span></span><br><span class=\"line\">    serializer = pickle</span><br><span class=\"line\">    session_class = RedisSession</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__init__</span><span class=\"params\">(self, redis, key_prefix, use_signer=False, permanent=True)</span>:</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> redis <span class=\"keyword\">is</span> <span class=\"keyword\">None</span>:</span><br><span class=\"line\">            <span class=\"keyword\">from</span> redis <span class=\"keyword\">import</span> Redis</span><br><span class=\"line\">            redis = Redis()</span><br><span class=\"line\">        self.redis = redis</span><br><span class=\"line\">        self.key_prefix = key_prefix</span><br><span class=\"line\">        self.use_signer = use_signer</span><br><span class=\"line\">        self.permanent = permanent</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">open_session</span><span class=\"params\">(self, app, request)</span>:</span></span><br><span class=\"line\">\t\t...</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">save_session</span><span class=\"params\">(self, app, session, response)</span>:</span></span><br><span class=\"line\">\t\t...</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>重写<code>open_session，save_session</code>，将session（dict）存储在redis并将session_id（key）返回给客户端</p>\n<h3 id=\"flask-http请求-应答完整的数据流\"><a href=\"#flask-http请求-应答完整的数据流\" class=\"headerlink\" title=\"flask http请求-应答完整的数据流\"></a>flask http请求-应答完整的数据流</h3><p>客户端http请求<br>-&gt; 服务端负载均衡至随机服务器<br>-&gt; 应用上下文入栈(app_ctx)<br>-&gt; 请求上下文入栈(request_ctx),同时生成session<br>-&gt; 通过request_ctx中的路由信息找到视图函数(view_func)<br>-&gt; view_func进行业务处理<br>-&gt; 应用上下文出栈(app_ctx)<br>-&gt; 请求上下文出栈(request_ctx)<br>-&gt; 保存session或sessino_id进cookie<br>-&gt; 返回应答<br>-&gt; 数据写入对应的文件描述符并刷新<br>其实flask的源码阅读起来并不吃力，看下来会发现flask框架代码的思路结构非常的清晰，并惊叹于这个框架的可扩展性，flask的源码非常值得学习和借鉴。</p>"},{"title":"pycharm远程调试","date":"2019-04-27T00:00:34.000Z","_content":"\n{%note info%}\npycharm是目前python开发者中最受欢迎的IDE，今天来介绍它的远程调试功能。\n请注意文中介绍的所有功能仅出现在pycharm专业版版中。\n{%endnote%}\n<!--more-->\n\n## 前置\n- `File`->`Settings`->`Project`->`Project Interpreter`->`add`\n- 配置mapping，本地代码与远程代码的映射，`此步骤是必须的`，方式可以通过挂载或者Tool->Configure->SFTP\n- Interpreter设置完后请确认`External Libraries`->`Remote Libraries`生成，若未出现，重启pycharm或许有奇迹\n\n## SSL Interpreter\n![pycharm.ssh.png](https://i.loli.net/2019/05/04/5ccd05b56616c.png)\n\n这里需要注意远程的运行环境必须是venv|virtualenv，若使用conda将导致无法获取`Remote Libraries`，从而无法远程debug\n## Docker\n- 开启docker守护进程的API调用\n- mapping需要另外挂载\n![pycharm.docker.png](https://i.loli.net/2019/05/04/5ccd06162dfdb.png)\n\n## Docker Compose（推荐）\n- mapping挂载可以直接在compose文件中指定\n- 镜像建议通过image，若为build将会每次都重新构建\n![pycharm.docker-compose.png](https://i.loli.net/2019/05/04/5ccd0605cbe19.png)\n\n```\nversion: \"3\"\nservices:\n\n  centos:\n    # build:\n    #   context: .\n    #   dockerfile: Dockerfile.centos\n    image: zipee/centos:latest\n    command: sh\n    volumes:\n      - E:\\code\\python3\\:/var/www/\n    ports:\n      - \"5000:5000\"\n    links:\n      - redis\n\n  redis:\n    image: \"redis:alpine\"\n    ports:\n      - \"6379:6379\"\n\n```\n\n## celery remote-debug\n\n由于celery将不再支持windows，所以celery的调试就比较麻烦，有了远程调试后这个问题就迎刃而解\n\n简单的celery代码如下：\n```\nfrom celery import Celery\n\napp = Celery('simple', broker='redis://redis:6379/0')\n\n@app.task()\ndef add(x, y):\n    return x + y\n```\n\n配置celery的启动命令：\n![pycharm.celery.png](https://i.loli.net/2019/05/04/5ccd0ebb7816c.png)\n\n使用了docker作为python远程解释器，甚至本地都无需安装python，使用起来简直不要太优雅！","source":"_posts/2019-04-27-pycharm远程调试.md","raw":"---\ntitle: pycharm远程调试\ndate: 2019-04-27 08:00:34\ntags:\n- python \n- coding-tools\ncategories:\n- coding-tools\n---\n\n{%note info%}\npycharm是目前python开发者中最受欢迎的IDE，今天来介绍它的远程调试功能。\n请注意文中介绍的所有功能仅出现在pycharm专业版版中。\n{%endnote%}\n<!--more-->\n\n## 前置\n- `File`->`Settings`->`Project`->`Project Interpreter`->`add`\n- 配置mapping，本地代码与远程代码的映射，`此步骤是必须的`，方式可以通过挂载或者Tool->Configure->SFTP\n- Interpreter设置完后请确认`External Libraries`->`Remote Libraries`生成，若未出现，重启pycharm或许有奇迹\n\n## SSL Interpreter\n![pycharm.ssh.png](https://i.loli.net/2019/05/04/5ccd05b56616c.png)\n\n这里需要注意远程的运行环境必须是venv|virtualenv，若使用conda将导致无法获取`Remote Libraries`，从而无法远程debug\n## Docker\n- 开启docker守护进程的API调用\n- mapping需要另外挂载\n![pycharm.docker.png](https://i.loli.net/2019/05/04/5ccd06162dfdb.png)\n\n## Docker Compose（推荐）\n- mapping挂载可以直接在compose文件中指定\n- 镜像建议通过image，若为build将会每次都重新构建\n![pycharm.docker-compose.png](https://i.loli.net/2019/05/04/5ccd0605cbe19.png)\n\n```\nversion: \"3\"\nservices:\n\n  centos:\n    # build:\n    #   context: .\n    #   dockerfile: Dockerfile.centos\n    image: zipee/centos:latest\n    command: sh\n    volumes:\n      - E:\\code\\python3\\:/var/www/\n    ports:\n      - \"5000:5000\"\n    links:\n      - redis\n\n  redis:\n    image: \"redis:alpine\"\n    ports:\n      - \"6379:6379\"\n\n```\n\n## celery remote-debug\n\n由于celery将不再支持windows，所以celery的调试就比较麻烦，有了远程调试后这个问题就迎刃而解\n\n简单的celery代码如下：\n```\nfrom celery import Celery\n\napp = Celery('simple', broker='redis://redis:6379/0')\n\n@app.task()\ndef add(x, y):\n    return x + y\n```\n\n配置celery的启动命令：\n![pycharm.celery.png](https://i.loli.net/2019/05/04/5ccd0ebb7816c.png)\n\n使用了docker作为python远程解释器，甚至本地都无需安装python，使用起来简直不要太优雅！","slug":"pycharm远程调试","published":1,"updated":"2020-03-28T14:35:40.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckezigl5j000d1gp7gl9jyohe","content":"<div class=\"note info\"><p>pycharm是目前python开发者中最受欢迎的IDE，今天来介绍它的远程调试功能。<br>请注意文中介绍的所有功能仅出现在pycharm专业版版中。</p></div>\n<a id=\"more\"></a>\n<h2 id=\"前置\"><a href=\"#前置\" class=\"headerlink\" title=\"前置\"></a>前置</h2><ul>\n<li><code>File</code>-&gt;<code>Settings</code>-&gt;<code>Project</code>-&gt;<code>Project Interpreter</code>-&gt;<code>add</code></li>\n<li>配置mapping，本地代码与远程代码的映射，<code>此步骤是必须的</code>，方式可以通过挂载或者Tool-&gt;Configure-&gt;SFTP</li>\n<li>Interpreter设置完后请确认<code>External Libraries</code>-&gt;<code>Remote Libraries</code>生成，若未出现，重启pycharm或许有奇迹</li>\n</ul>\n<h2 id=\"SSL-Interpreter\"><a href=\"#SSL-Interpreter\" class=\"headerlink\" title=\"SSL Interpreter\"></a>SSL Interpreter</h2><p><img src=\"https://i.loli.net/2019/05/04/5ccd05b56616c.png\" alt=\"pycharm.ssh.png\"></p>\n<p>这里需要注意远程的运行环境必须是venv|virtualenv，若使用conda将导致无法获取<code>Remote Libraries</code>，从而无法远程debug</p>\n<h2 id=\"Docker\"><a href=\"#Docker\" class=\"headerlink\" title=\"Docker\"></a>Docker</h2><ul>\n<li>开启docker守护进程的API调用</li>\n<li>mapping需要另外挂载<br><img src=\"https://i.loli.net/2019/05/04/5ccd06162dfdb.png\" alt=\"pycharm.docker.png\"></li>\n</ul>\n<h2 id=\"Docker-Compose（推荐）\"><a href=\"#Docker-Compose（推荐）\" class=\"headerlink\" title=\"Docker Compose（推荐）\"></a>Docker Compose（推荐）</h2><ul>\n<li>mapping挂载可以直接在compose文件中指定</li>\n<li>镜像建议通过image，若为build将会每次都重新构建<br><img src=\"https://i.loli.net/2019/05/04/5ccd0605cbe19.png\" alt=\"pycharm.docker-compose.png\"></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">version: &quot;3&quot;</span><br><span class=\"line\">services:</span><br><span class=\"line\"></span><br><span class=\"line\">  centos:</span><br><span class=\"line\">    # build:</span><br><span class=\"line\">    #   context: .</span><br><span class=\"line\">    #   dockerfile: Dockerfile.centos</span><br><span class=\"line\">    image: zipee/centos:latest</span><br><span class=\"line\">    command: sh</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - E:\\code\\python3\\:/var/www/</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">      - &quot;5000:5000&quot;</span><br><span class=\"line\">    links:</span><br><span class=\"line\">      - redis</span><br><span class=\"line\"></span><br><span class=\"line\">  redis:</span><br><span class=\"line\">    image: &quot;redis:alpine&quot;</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">      - &quot;6379:6379&quot;</span><br></pre></td></tr></table></figure>\n<h2 id=\"celery-remote-debug\"><a href=\"#celery-remote-debug\" class=\"headerlink\" title=\"celery remote-debug\"></a>celery remote-debug</h2><p>由于celery将不再支持windows，所以celery的调试就比较麻烦，有了远程调试后这个问题就迎刃而解</p>\n<p>简单的celery代码如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from celery import Celery</span><br><span class=\"line\"></span><br><span class=\"line\">app = Celery(&apos;simple&apos;, broker=&apos;redis://redis:6379/0&apos;)</span><br><span class=\"line\"></span><br><span class=\"line\">@app.task()</span><br><span class=\"line\">def add(x, y):</span><br><span class=\"line\">    return x + y</span><br></pre></td></tr></table></figure></p>\n<p>配置celery的启动命令：<br><img src=\"https://i.loli.net/2019/05/04/5ccd0ebb7816c.png\" alt=\"pycharm.celery.png\"></p>\n<p>使用了docker作为python远程解释器，甚至本地都无需安装python，使用起来简直不要太优雅！</p>\n","site":{"data":{}},"excerpt":"<div class=\"note info\"><p>pycharm是目前python开发者中最受欢迎的IDE，今天来介绍它的远程调试功能。<br>请注意文中介绍的所有功能仅出现在pycharm专业版版中。</p></div>","more":"<h2 id=\"前置\"><a href=\"#前置\" class=\"headerlink\" title=\"前置\"></a>前置</h2><ul>\n<li><code>File</code>-&gt;<code>Settings</code>-&gt;<code>Project</code>-&gt;<code>Project Interpreter</code>-&gt;<code>add</code></li>\n<li>配置mapping，本地代码与远程代码的映射，<code>此步骤是必须的</code>，方式可以通过挂载或者Tool-&gt;Configure-&gt;SFTP</li>\n<li>Interpreter设置完后请确认<code>External Libraries</code>-&gt;<code>Remote Libraries</code>生成，若未出现，重启pycharm或许有奇迹</li>\n</ul>\n<h2 id=\"SSL-Interpreter\"><a href=\"#SSL-Interpreter\" class=\"headerlink\" title=\"SSL Interpreter\"></a>SSL Interpreter</h2><p><img src=\"https://i.loli.net/2019/05/04/5ccd05b56616c.png\" alt=\"pycharm.ssh.png\"></p>\n<p>这里需要注意远程的运行环境必须是venv|virtualenv，若使用conda将导致无法获取<code>Remote Libraries</code>，从而无法远程debug</p>\n<h2 id=\"Docker\"><a href=\"#Docker\" class=\"headerlink\" title=\"Docker\"></a>Docker</h2><ul>\n<li>开启docker守护进程的API调用</li>\n<li>mapping需要另外挂载<br><img src=\"https://i.loli.net/2019/05/04/5ccd06162dfdb.png\" alt=\"pycharm.docker.png\"></li>\n</ul>\n<h2 id=\"Docker-Compose（推荐）\"><a href=\"#Docker-Compose（推荐）\" class=\"headerlink\" title=\"Docker Compose（推荐）\"></a>Docker Compose（推荐）</h2><ul>\n<li>mapping挂载可以直接在compose文件中指定</li>\n<li>镜像建议通过image，若为build将会每次都重新构建<br><img src=\"https://i.loli.net/2019/05/04/5ccd0605cbe19.png\" alt=\"pycharm.docker-compose.png\"></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">version: &quot;3&quot;</span><br><span class=\"line\">services:</span><br><span class=\"line\"></span><br><span class=\"line\">  centos:</span><br><span class=\"line\">    # build:</span><br><span class=\"line\">    #   context: .</span><br><span class=\"line\">    #   dockerfile: Dockerfile.centos</span><br><span class=\"line\">    image: zipee/centos:latest</span><br><span class=\"line\">    command: sh</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - E:\\code\\python3\\:/var/www/</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">      - &quot;5000:5000&quot;</span><br><span class=\"line\">    links:</span><br><span class=\"line\">      - redis</span><br><span class=\"line\"></span><br><span class=\"line\">  redis:</span><br><span class=\"line\">    image: &quot;redis:alpine&quot;</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">      - &quot;6379:6379&quot;</span><br></pre></td></tr></table></figure>\n<h2 id=\"celery-remote-debug\"><a href=\"#celery-remote-debug\" class=\"headerlink\" title=\"celery remote-debug\"></a>celery remote-debug</h2><p>由于celery将不再支持windows，所以celery的调试就比较麻烦，有了远程调试后这个问题就迎刃而解</p>\n<p>简单的celery代码如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from celery import Celery</span><br><span class=\"line\"></span><br><span class=\"line\">app = Celery(&apos;simple&apos;, broker=&apos;redis://redis:6379/0&apos;)</span><br><span class=\"line\"></span><br><span class=\"line\">@app.task()</span><br><span class=\"line\">def add(x, y):</span><br><span class=\"line\">    return x + y</span><br></pre></td></tr></table></figure></p>\n<p>配置celery的启动命令：<br><img src=\"https://i.loli.net/2019/05/04/5ccd0ebb7816c.png\" alt=\"pycharm.celery.png\"></p>\n<p>使用了docker作为python远程解释器，甚至本地都无需安装python，使用起来简直不要太优雅！</p>"},{"title":"webserver异常-TooManyOpenFiles","date":"2019-03-10T09:32:36.000Z","_content":"\n\n### 问题现象：\n{%note warning%}\n- webserver服务不可用\n- 查询日志得知异常为\"... Too Many Open Files\"\n- 重启webserver后服务正常可用\n{%endnote%}\n\n\n<!--more-->\n***\n### 问题环境：\n{%note info%}\n- 使用nginx+gunicorn+flask搭建webserver的运行环境\n- 环境进程文件句柄使用数上线未设置过为1024\n- gunicorn max-connections=2048 workers=9\n{%endnote%}\n***\n\n### 问题分析：\n\n1. ulimit -n 设置过小\n  - 问题原因比较好定位，google一下大概就确定了\n  - 调大open files应该就可以了\n2. gunicorn max-connections指单个workers还是gunicorn整体的最大连接数？\n\t- 找了官方文档和google的博客均没细说，如果是前者那是有文件句柄不够用的可能性，而后者则可能性不大，最后还是自己看了源码并通过siege进行性能测试得出结论，`gunicorn max-connections指单个workers`。\n\n***\n\n### 问题解决：\n- 根据性能测试调大open files，并对数据数值添加监控。\n\n***\n\n### 问题总结：\n- **linux open files**\n```\n\t1. 查看系统最大可打开文件数\n\t\tcat /proc/sys/fs/file-max\n\t2. 查看进程最大可打开文件数\n\t\tcat /etc/security/limits.conf\n\t3. 查看指定进程文件打开数\n\t\tlsof -p pid | wc -l \n\t4. 查看gunicorn fork出所有进程的文件打开数\n\t\tlsof -n|awk '{print $1}'|sort|uniq -c|sort -nr|grep gunicorn\n\t5. 进程 fork() 出来的子进程，会继承父进程的 limits 设定\n```\n- **gunicorn**\n```\n\t1. work_connections指gunicorn单进程并发数\n\t2. 若gunicorn worker_connections < 当前并发数，请求至多会超时，而不会报连接文件句柄异常\n\t3、当worker_connections > 1 时 且程序可异步操作越久（sleep），gevent作用越明显\n```\n- **异常再次发生处理步骤**\n```\n\t1. ps -ef |grep gunicorn -> pid\n\t2. cat /proc/pid/limits.conf\n\t3. lsof -p pid |wc -l\n\t4. sudo vi  /etc/security/limits.conf\n\t\tasset soft nofile 10240\n\t\tasset hard nofile 10240\n\t5. restart program && cat /proc/pid/limits.conf\n```\n- **性能测试**\n\t1. 性能测试主要使用了siege和locust，siege通过创建线程进行并发对测试机的影响较大，而locust通过协程并发请求，测试并发数能更高，该部分的具体内容会另起篇幅进行总结梳理。","source":"_posts/2019-03-10-webserver异常-TooManyOpenFiles.md","raw":"---\ntitle: webserver异常-TooManyOpenFiles\ndate: 2019-03-10 17:32:36\ntags:\n- flask\n- 问题分析\n- linux\ncategories:\n- 问题分析\n---\n\n\n### 问题现象：\n{%note warning%}\n- webserver服务不可用\n- 查询日志得知异常为\"... Too Many Open Files\"\n- 重启webserver后服务正常可用\n{%endnote%}\n\n\n<!--more-->\n***\n### 问题环境：\n{%note info%}\n- 使用nginx+gunicorn+flask搭建webserver的运行环境\n- 环境进程文件句柄使用数上线未设置过为1024\n- gunicorn max-connections=2048 workers=9\n{%endnote%}\n***\n\n### 问题分析：\n\n1. ulimit -n 设置过小\n  - 问题原因比较好定位，google一下大概就确定了\n  - 调大open files应该就可以了\n2. gunicorn max-connections指单个workers还是gunicorn整体的最大连接数？\n\t- 找了官方文档和google的博客均没细说，如果是前者那是有文件句柄不够用的可能性，而后者则可能性不大，最后还是自己看了源码并通过siege进行性能测试得出结论，`gunicorn max-connections指单个workers`。\n\n***\n\n### 问题解决：\n- 根据性能测试调大open files，并对数据数值添加监控。\n\n***\n\n### 问题总结：\n- **linux open files**\n```\n\t1. 查看系统最大可打开文件数\n\t\tcat /proc/sys/fs/file-max\n\t2. 查看进程最大可打开文件数\n\t\tcat /etc/security/limits.conf\n\t3. 查看指定进程文件打开数\n\t\tlsof -p pid | wc -l \n\t4. 查看gunicorn fork出所有进程的文件打开数\n\t\tlsof -n|awk '{print $1}'|sort|uniq -c|sort -nr|grep gunicorn\n\t5. 进程 fork() 出来的子进程，会继承父进程的 limits 设定\n```\n- **gunicorn**\n```\n\t1. work_connections指gunicorn单进程并发数\n\t2. 若gunicorn worker_connections < 当前并发数，请求至多会超时，而不会报连接文件句柄异常\n\t3、当worker_connections > 1 时 且程序可异步操作越久（sleep），gevent作用越明显\n```\n- **异常再次发生处理步骤**\n```\n\t1. ps -ef |grep gunicorn -> pid\n\t2. cat /proc/pid/limits.conf\n\t3. lsof -p pid |wc -l\n\t4. sudo vi  /etc/security/limits.conf\n\t\tasset soft nofile 10240\n\t\tasset hard nofile 10240\n\t5. restart program && cat /proc/pid/limits.conf\n```\n- **性能测试**\n\t1. 性能测试主要使用了siege和locust，siege通过创建线程进行并发对测试机的影响较大，而locust通过协程并发请求，测试并发数能更高，该部分的具体内容会另起篇幅进行总结梳理。","slug":"webserver异常-TooManyOpenFiles","published":1,"updated":"2020-03-28T14:35:40.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckezigl5v000e1gp76815mgqy","content":"<h3 id=\"问题现象：\"><a href=\"#问题现象：\" class=\"headerlink\" title=\"问题现象：\"></a>问题现象：</h3><div class=\"note warning\"><ul>\n<li>webserver服务不可用</li>\n<li>查询日志得知异常为”… Too Many Open Files”</li>\n<li>重启webserver后服务正常可用</li>\n</ul></div>\n<a id=\"more\"></a>\n<hr>\n<h3 id=\"问题环境：\"><a href=\"#问题环境：\" class=\"headerlink\" title=\"问题环境：\"></a>问题环境：</h3><div class=\"note info\"><ul>\n<li>使用nginx+gunicorn+flask搭建webserver的运行环境</li>\n<li>环境进程文件句柄使用数上线未设置过为1024</li>\n<li>gunicorn max-connections=2048 workers=9</li>\n</ul></div>\n<hr>\n<h3 id=\"问题分析：\"><a href=\"#问题分析：\" class=\"headerlink\" title=\"问题分析：\"></a>问题分析：</h3><ol>\n<li>ulimit -n 设置过小<ul>\n<li>问题原因比较好定位，google一下大概就确定了</li>\n<li>调大open files应该就可以了</li>\n</ul>\n</li>\n<li>gunicorn max-connections指单个workers还是gunicorn整体的最大连接数？<ul>\n<li>找了官方文档和google的博客均没细说，如果是前者那是有文件句柄不够用的可能性，而后者则可能性不大，最后还是自己看了源码并通过siege进行性能测试得出结论，<code>gunicorn max-connections指单个workers</code>。</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h3 id=\"问题解决：\"><a href=\"#问题解决：\" class=\"headerlink\" title=\"问题解决：\"></a>问题解决：</h3><ul>\n<li>根据性能测试调大open files，并对数据数值添加监控。</li>\n</ul>\n<hr>\n<h3 id=\"问题总结：\"><a href=\"#问题总结：\" class=\"headerlink\" title=\"问题总结：\"></a>问题总结：</h3><ul>\n<li><p><strong>linux open files</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. 查看系统最大可打开文件数</span><br><span class=\"line\">\tcat /proc/sys/fs/file-max</span><br><span class=\"line\">2. 查看进程最大可打开文件数</span><br><span class=\"line\">\tcat /etc/security/limits.conf</span><br><span class=\"line\">3. 查看指定进程文件打开数</span><br><span class=\"line\">\tlsof -p pid | wc -l </span><br><span class=\"line\">4. 查看gunicorn fork出所有进程的文件打开数</span><br><span class=\"line\">\tlsof -n|awk &apos;&#123;print $1&#125;&apos;|sort|uniq -c|sort -nr|grep gunicorn</span><br><span class=\"line\">5. 进程 fork() 出来的子进程，会继承父进程的 limits 设定</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>gunicorn</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. work_connections指gunicorn单进程并发数</span><br><span class=\"line\">2. 若gunicorn worker_connections &lt; 当前并发数，请求至多会超时，而不会报连接文件句柄异常</span><br><span class=\"line\">3、当worker_connections &gt; 1 时 且程序可异步操作越久（sleep），gevent作用越明显</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>异常再次发生处理步骤</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. ps -ef |grep gunicorn -&gt; pid</span><br><span class=\"line\">2. cat /proc/pid/limits.conf</span><br><span class=\"line\">3. lsof -p pid |wc -l</span><br><span class=\"line\">4. sudo vi  /etc/security/limits.conf</span><br><span class=\"line\">\tasset soft nofile 10240</span><br><span class=\"line\">\tasset hard nofile 10240</span><br><span class=\"line\">5. restart program &amp;&amp; cat /proc/pid/limits.conf</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>性能测试</strong></p>\n<ol>\n<li>性能测试主要使用了siege和locust，siege通过创建线程进行并发对测试机的影响较大，而locust通过协程并发请求，测试并发数能更高，该部分的具体内容会另起篇幅进行总结梳理。</li>\n</ol>\n</li>\n</ul>\n","site":{"data":{}},"excerpt":"<h3 id=\"问题现象：\"><a href=\"#问题现象：\" class=\"headerlink\" title=\"问题现象：\"></a>问题现象：</h3><div class=\"note warning\"><ul>\n<li>webserver服务不可用</li>\n<li>查询日志得知异常为”… Too Many Open Files”</li>\n<li>重启webserver后服务正常可用</li>\n</ul></div>","more":"<hr>\n<h3 id=\"问题环境：\"><a href=\"#问题环境：\" class=\"headerlink\" title=\"问题环境：\"></a>问题环境：</h3><div class=\"note info\"><ul>\n<li>使用nginx+gunicorn+flask搭建webserver的运行环境</li>\n<li>环境进程文件句柄使用数上线未设置过为1024</li>\n<li>gunicorn max-connections=2048 workers=9</li>\n</ul></div>\n<hr>\n<h3 id=\"问题分析：\"><a href=\"#问题分析：\" class=\"headerlink\" title=\"问题分析：\"></a>问题分析：</h3><ol>\n<li>ulimit -n 设置过小<ul>\n<li>问题原因比较好定位，google一下大概就确定了</li>\n<li>调大open files应该就可以了</li>\n</ul>\n</li>\n<li>gunicorn max-connections指单个workers还是gunicorn整体的最大连接数？<ul>\n<li>找了官方文档和google的博客均没细说，如果是前者那是有文件句柄不够用的可能性，而后者则可能性不大，最后还是自己看了源码并通过siege进行性能测试得出结论，<code>gunicorn max-connections指单个workers</code>。</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h3 id=\"问题解决：\"><a href=\"#问题解决：\" class=\"headerlink\" title=\"问题解决：\"></a>问题解决：</h3><ul>\n<li>根据性能测试调大open files，并对数据数值添加监控。</li>\n</ul>\n<hr>\n<h3 id=\"问题总结：\"><a href=\"#问题总结：\" class=\"headerlink\" title=\"问题总结：\"></a>问题总结：</h3><ul>\n<li><p><strong>linux open files</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. 查看系统最大可打开文件数</span><br><span class=\"line\">\tcat /proc/sys/fs/file-max</span><br><span class=\"line\">2. 查看进程最大可打开文件数</span><br><span class=\"line\">\tcat /etc/security/limits.conf</span><br><span class=\"line\">3. 查看指定进程文件打开数</span><br><span class=\"line\">\tlsof -p pid | wc -l </span><br><span class=\"line\">4. 查看gunicorn fork出所有进程的文件打开数</span><br><span class=\"line\">\tlsof -n|awk &apos;&#123;print $1&#125;&apos;|sort|uniq -c|sort -nr|grep gunicorn</span><br><span class=\"line\">5. 进程 fork() 出来的子进程，会继承父进程的 limits 设定</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>gunicorn</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. work_connections指gunicorn单进程并发数</span><br><span class=\"line\">2. 若gunicorn worker_connections &lt; 当前并发数，请求至多会超时，而不会报连接文件句柄异常</span><br><span class=\"line\">3、当worker_connections &gt; 1 时 且程序可异步操作越久（sleep），gevent作用越明显</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>异常再次发生处理步骤</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. ps -ef |grep gunicorn -&gt; pid</span><br><span class=\"line\">2. cat /proc/pid/limits.conf</span><br><span class=\"line\">3. lsof -p pid |wc -l</span><br><span class=\"line\">4. sudo vi  /etc/security/limits.conf</span><br><span class=\"line\">\tasset soft nofile 10240</span><br><span class=\"line\">\tasset hard nofile 10240</span><br><span class=\"line\">5. restart program &amp;&amp; cat /proc/pid/limits.conf</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>性能测试</strong></p>\n<ol>\n<li>性能测试主要使用了siege和locust，siege通过创建线程进行并发对测试机的影响较大，而locust通过协程并发请求，测试并发数能更高，该部分的具体内容会另起篇幅进行总结梳理。</li>\n</ol>\n</li>\n</ul>"},{"title":"python程序员开发规范","date":"2019-06-09T07:12:51.000Z","_content":"\n\n{%note info%}\n本文介绍两个python开发工具（flake8，black），并结合pycharm，pre-commit进行使用。\n{%endnote%}\n<!--more-->\n\n## flake8\n- 基于PEP8的静态代码检查工具。有助于约束团队使用统一的代码规范。\n- 安装 `pip install flake8`\n- 指定文件检查 `flake8 path/code.py`\n- 指定目录检查 `flake8 path`\n- 忽略指定错误 `flake8 --ignore E24,W504 path`\n- 指定配置文件 `flake8 --config path1/.flake8 path2 （linux下默认查找用户目录）`\n- 代码指定行忽略检查 `# noqa`\n- [异常快速定位](https://lintlyci.github.io/Flake8Rules/)\n\n**配置文件模版**：\n```\n[flake8]\nignore =\n    E203 # whitespace before ':'\n    E741 # ambiguous variable name 'l'\nfilename =\nexclude =\nmax-line-length = 89\nmax-complexity = 10  # 指定代码最高复杂度\n\n```\n\n**windows下配合pycharm使用**：\n`File->Settings->Tools->External Tools->add`\n![pycharm.flake8.png](https://i.loli.net/2019/06/09/5cfcc0aac588786191.png)\n\n## black\n- flake8经常会检查出代码格式上的异常，手动修改实在烦人，这时候推荐使用这款自动格式化代码神器，从此团队code review只需要关注代码业务逻辑\n- 基本不需要自定义配置文件（虽然支持），相较于pylint需要各种自定义设置，black的极简哲学让我想到了iphone，\"产品来告诉你你真正想要的\"（产品决定需求）\n- 安装 `pip install black`\n- black --diff path/code.py `输出格式化差异`\n- black path/code.py `自动格式代码`（简单暴力）\n\n**windows下配合pycharm使用**：\n`File->Settings->Tools->External Tools->add`\n![pycharm.black.png](https://i.loli.net/2019/06/09/5cfcc0aac58b837834.png)\n\n\n## 配合使用pre-commit\n- 安装 `pip install pre_commit`\n- 创建配置文件 `touch .pre-commit-config.yaml`\n- 初始化 `pre-commit install`\n- 垃圾回收 `pre-commit gc`\n\n**配置模版**：\n```\nrepos:\n-   repo: https://github.com/ambv/black\n    rev: stable\n    hooks:\n    - id: black\n      language_version: python3.6\n-   repo: https://github.com/pre-commit/pre-commit-hooks\n    rev: v2.2.3\n    hooks:\n    - id: flake8\n\n```","source":"_posts/2019-06-09-python程序员开发规范.md","raw":"---\ntitle: python程序员开发规范\ndate: 2019-06-09 15:12:51\ntags:\n- python\ncategories:\n---\n\n\n{%note info%}\n本文介绍两个python开发工具（flake8，black），并结合pycharm，pre-commit进行使用。\n{%endnote%}\n<!--more-->\n\n## flake8\n- 基于PEP8的静态代码检查工具。有助于约束团队使用统一的代码规范。\n- 安装 `pip install flake8`\n- 指定文件检查 `flake8 path/code.py`\n- 指定目录检查 `flake8 path`\n- 忽略指定错误 `flake8 --ignore E24,W504 path`\n- 指定配置文件 `flake8 --config path1/.flake8 path2 （linux下默认查找用户目录）`\n- 代码指定行忽略检查 `# noqa`\n- [异常快速定位](https://lintlyci.github.io/Flake8Rules/)\n\n**配置文件模版**：\n```\n[flake8]\nignore =\n    E203 # whitespace before ':'\n    E741 # ambiguous variable name 'l'\nfilename =\nexclude =\nmax-line-length = 89\nmax-complexity = 10  # 指定代码最高复杂度\n\n```\n\n**windows下配合pycharm使用**：\n`File->Settings->Tools->External Tools->add`\n![pycharm.flake8.png](https://i.loli.net/2019/06/09/5cfcc0aac588786191.png)\n\n## black\n- flake8经常会检查出代码格式上的异常，手动修改实在烦人，这时候推荐使用这款自动格式化代码神器，从此团队code review只需要关注代码业务逻辑\n- 基本不需要自定义配置文件（虽然支持），相较于pylint需要各种自定义设置，black的极简哲学让我想到了iphone，\"产品来告诉你你真正想要的\"（产品决定需求）\n- 安装 `pip install black`\n- black --diff path/code.py `输出格式化差异`\n- black path/code.py `自动格式代码`（简单暴力）\n\n**windows下配合pycharm使用**：\n`File->Settings->Tools->External Tools->add`\n![pycharm.black.png](https://i.loli.net/2019/06/09/5cfcc0aac58b837834.png)\n\n\n## 配合使用pre-commit\n- 安装 `pip install pre_commit`\n- 创建配置文件 `touch .pre-commit-config.yaml`\n- 初始化 `pre-commit install`\n- 垃圾回收 `pre-commit gc`\n\n**配置模版**：\n```\nrepos:\n-   repo: https://github.com/ambv/black\n    rev: stable\n    hooks:\n    - id: black\n      language_version: python3.6\n-   repo: https://github.com/pre-commit/pre-commit-hooks\n    rev: v2.2.3\n    hooks:\n    - id: flake8\n\n```","slug":"python程序员开发规范","published":1,"updated":"2020-03-28T14:35:40.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckezigl5y000i1gp73uapahiv","content":"<div class=\"note info\"><p>本文介绍两个python开发工具（flake8，black），并结合pycharm，pre-commit进行使用。</p></div>\n<a id=\"more\"></a>\n<h2 id=\"flake8\"><a href=\"#flake8\" class=\"headerlink\" title=\"flake8\"></a>flake8</h2><ul>\n<li>基于PEP8的静态代码检查工具。有助于约束团队使用统一的代码规范。</li>\n<li>安装 <code>pip install flake8</code></li>\n<li>指定文件检查 <code>flake8 path/code.py</code></li>\n<li>指定目录检查 <code>flake8 path</code></li>\n<li>忽略指定错误 <code>flake8 --ignore E24,W504 path</code></li>\n<li>指定配置文件 <code>flake8 --config path1/.flake8 path2 （linux下默认查找用户目录）</code></li>\n<li>代码指定行忽略检查 <code># noqa</code></li>\n<li><a href=\"https://lintlyci.github.io/Flake8Rules/\" target=\"_blank\" rel=\"noopener\">异常快速定位</a></li>\n</ul>\n<p><strong>配置文件模版</strong>：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[flake8]</span><br><span class=\"line\">ignore =</span><br><span class=\"line\">    E203 # whitespace before &apos;:&apos;</span><br><span class=\"line\">    E741 # ambiguous variable name &apos;l&apos;</span><br><span class=\"line\">filename =</span><br><span class=\"line\">exclude =</span><br><span class=\"line\">max-line-length = 89</span><br><span class=\"line\">max-complexity = 10  # 指定代码最高复杂度</span><br></pre></td></tr></table></figure></p>\n<p><strong>windows下配合pycharm使用</strong>：<br><code>File-&gt;Settings-&gt;Tools-&gt;External Tools-&gt;add</code><br><img src=\"https://i.loli.net/2019/06/09/5cfcc0aac588786191.png\" alt=\"pycharm.flake8.png\"></p>\n<h2 id=\"black\"><a href=\"#black\" class=\"headerlink\" title=\"black\"></a>black</h2><ul>\n<li>flake8经常会检查出代码格式上的异常，手动修改实在烦人，这时候推荐使用这款自动格式化代码神器，从此团队code review只需要关注代码业务逻辑</li>\n<li>基本不需要自定义配置文件（虽然支持），相较于pylint需要各种自定义设置，black的极简哲学让我想到了iphone，”产品来告诉你你真正想要的”（产品决定需求）</li>\n<li>安装 <code>pip install black</code></li>\n<li>black –diff path/code.py <code>输出格式化差异</code></li>\n<li>black path/code.py <code>自动格式代码</code>（简单暴力）</li>\n</ul>\n<p><strong>windows下配合pycharm使用</strong>：<br><code>File-&gt;Settings-&gt;Tools-&gt;External Tools-&gt;add</code><br><img src=\"https://i.loli.net/2019/06/09/5cfcc0aac58b837834.png\" alt=\"pycharm.black.png\"></p>\n<h2 id=\"配合使用pre-commit\"><a href=\"#配合使用pre-commit\" class=\"headerlink\" title=\"配合使用pre-commit\"></a>配合使用pre-commit</h2><ul>\n<li>安装 <code>pip install pre_commit</code></li>\n<li>创建配置文件 <code>touch .pre-commit-config.yaml</code></li>\n<li>初始化 <code>pre-commit install</code></li>\n<li>垃圾回收 <code>pre-commit gc</code></li>\n</ul>\n<p><strong>配置模版</strong>：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">repos:</span><br><span class=\"line\">-   repo: https://github.com/ambv/black</span><br><span class=\"line\">    rev: stable</span><br><span class=\"line\">    hooks:</span><br><span class=\"line\">    - id: black</span><br><span class=\"line\">      language_version: python3.6</span><br><span class=\"line\">-   repo: https://github.com/pre-commit/pre-commit-hooks</span><br><span class=\"line\">    rev: v2.2.3</span><br><span class=\"line\">    hooks:</span><br><span class=\"line\">    - id: flake8</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"<div class=\"note info\"><p>本文介绍两个python开发工具（flake8，black），并结合pycharm，pre-commit进行使用。</p></div>","more":"<h2 id=\"flake8\"><a href=\"#flake8\" class=\"headerlink\" title=\"flake8\"></a>flake8</h2><ul>\n<li>基于PEP8的静态代码检查工具。有助于约束团队使用统一的代码规范。</li>\n<li>安装 <code>pip install flake8</code></li>\n<li>指定文件检查 <code>flake8 path/code.py</code></li>\n<li>指定目录检查 <code>flake8 path</code></li>\n<li>忽略指定错误 <code>flake8 --ignore E24,W504 path</code></li>\n<li>指定配置文件 <code>flake8 --config path1/.flake8 path2 （linux下默认查找用户目录）</code></li>\n<li>代码指定行忽略检查 <code># noqa</code></li>\n<li><a href=\"https://lintlyci.github.io/Flake8Rules/\" target=\"_blank\" rel=\"noopener\">异常快速定位</a></li>\n</ul>\n<p><strong>配置文件模版</strong>：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[flake8]</span><br><span class=\"line\">ignore =</span><br><span class=\"line\">    E203 # whitespace before &apos;:&apos;</span><br><span class=\"line\">    E741 # ambiguous variable name &apos;l&apos;</span><br><span class=\"line\">filename =</span><br><span class=\"line\">exclude =</span><br><span class=\"line\">max-line-length = 89</span><br><span class=\"line\">max-complexity = 10  # 指定代码最高复杂度</span><br></pre></td></tr></table></figure></p>\n<p><strong>windows下配合pycharm使用</strong>：<br><code>File-&gt;Settings-&gt;Tools-&gt;External Tools-&gt;add</code><br><img src=\"https://i.loli.net/2019/06/09/5cfcc0aac588786191.png\" alt=\"pycharm.flake8.png\"></p>\n<h2 id=\"black\"><a href=\"#black\" class=\"headerlink\" title=\"black\"></a>black</h2><ul>\n<li>flake8经常会检查出代码格式上的异常，手动修改实在烦人，这时候推荐使用这款自动格式化代码神器，从此团队code review只需要关注代码业务逻辑</li>\n<li>基本不需要自定义配置文件（虽然支持），相较于pylint需要各种自定义设置，black的极简哲学让我想到了iphone，”产品来告诉你你真正想要的”（产品决定需求）</li>\n<li>安装 <code>pip install black</code></li>\n<li>black –diff path/code.py <code>输出格式化差异</code></li>\n<li>black path/code.py <code>自动格式代码</code>（简单暴力）</li>\n</ul>\n<p><strong>windows下配合pycharm使用</strong>：<br><code>File-&gt;Settings-&gt;Tools-&gt;External Tools-&gt;add</code><br><img src=\"https://i.loli.net/2019/06/09/5cfcc0aac58b837834.png\" alt=\"pycharm.black.png\"></p>\n<h2 id=\"配合使用pre-commit\"><a href=\"#配合使用pre-commit\" class=\"headerlink\" title=\"配合使用pre-commit\"></a>配合使用pre-commit</h2><ul>\n<li>安装 <code>pip install pre_commit</code></li>\n<li>创建配置文件 <code>touch .pre-commit-config.yaml</code></li>\n<li>初始化 <code>pre-commit install</code></li>\n<li>垃圾回收 <code>pre-commit gc</code></li>\n</ul>\n<p><strong>配置模版</strong>：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">repos:</span><br><span class=\"line\">-   repo: https://github.com/ambv/black</span><br><span class=\"line\">    rev: stable</span><br><span class=\"line\">    hooks:</span><br><span class=\"line\">    - id: black</span><br><span class=\"line\">      language_version: python3.6</span><br><span class=\"line\">-   repo: https://github.com/pre-commit/pre-commit-hooks</span><br><span class=\"line\">    rev: v2.2.3</span><br><span class=\"line\">    hooks:</span><br><span class=\"line\">    - id: flake8</span><br></pre></td></tr></table></figure></p>"},{"title":"flask-caching源码浅析","date":"2019-07-14T11:49:26.000Z","_content":"\n{%note info%}\nflask-caching源码浅析。\n{%endnote%}\n<!--more-->\n\n## 简介\n- flash-caching是一款flask开发技术栈中使用频率非常高的一款插件，起初的名称为“flask-cache”，由于原作者不再维护，后由其他人在其基础上开发维护了flask-caching。\n- flask-caching支持后端存储类型（本文主要围绕使用redis的源码展开）：\n\t- simple 程序内部缓存\n\t- filesystem 系统文件缓存\n\t- redis\n\t- redissentinel\n\t- uwsgi\n\t- memcached\n\t- gaememcached\n\t- saslmemcached\n\t- spreadsaslmemcached\n\n## 简单使用\n```python\nfrom flask_caching import Cache\ncache = Cache()\n\nconfig = {\"CACHE_TYPE\": \"redis\", \"CACHE_REDIS_URL\": app.config[\"CACHE_REDIS_URL\"]}\n    cache.init_app(app, config=config)\n\n@app.route('/cache_test/<int:id>')\n@cache.cached(timeout=60 * 5)\ndef cache_test(id):\n    from flask import request\n    got_data = request.get_json()\n    import time\n\n    return f\"{got_data}.{id}.{time.time()}\"\n\n@cache.memoize(timeout=60 * 5)\ndef f_cache(a):\n    return a\n\n@app.route('/cache_test2/<int:id>')\ndef cache_test2(id):\n    return f\"{f_cache(id)}\"\n\n```\n\n\n## cache memoize源码解析\n### **cached**\n\n```python\n    def cached(\n        self,\n        timeout=None,\n        key_prefix=\"view/%s\",\n        unless=None,\n        forced_update=None,\n        response_filter=None,\n        query_string=False,\n        hash_method=hashlib.md5,\n    ):\n        \"\"\"...\"\"\"\n\n        def decorator(f):\n            @functools.wraps(f)\n            def decorated_function(*args, **kwargs):...\n\n                if not found:\n                    rv = f(*args, **kwargs)\n\n                    if response_filter is None or response_filter(rv):\n                        try:\n                            self.cache.set(\n                                cache_key,\n                                rv,\n                                timeout=decorated_function.cache_timeout,\n                            )\n                        except Exception:\n                            if self.app.debug:\n                                raise\n                            logger.exception(\n                                \"Exception possibly due to cache backend.\"\n                            )\n                return rv\n\n            def make_cache_key(*args, **kwargs):...\n\n            def _make_cache_key_query_string():...\n\n            def _make_cache_key(args, kwargs, use_request):...\n\n            decorated_function.uncached = f\n            decorated_function.cache_timeout = timeout\n            decorated_function.make_cache_key = make_cache_key\n\n            return decorated_function\n\n        return decorator\n```\n\n\n- cached是针对flask视图函数的缓存，使用过程中，我们主要关注以下几个参数：\n\t- timeout用于指定缓存失效的时间，设置0或-1则不失效\n\t- unless是一个函数，用于判断是否需要跳过缓存，可自定义实现\n\t\t\n\n```python\ndef _make_cache_key(args, kwargs, use_request):\n    if callable(key_prefix):\n        cache_key = key_prefix()\n    elif \"%s\" in key_prefix:\n        if use_request:\n            cache_key = key_prefix % request.path\n        else:\n            cache_key = key_prefix % url_for(f.__name__, **kwargs)\n    else:\n        cache_key = key_prefix\n\n    return cache_key\n\n# ```\n\n- 默认情况下进入逻辑\"elif \"%s\" in key_prefix:\", 因此cached缓存只与requesturl相关，与视图函数的传参无关，`这里不太了解作者的实现意图，为什么不结合请求参数，且不太方便扩展或重写_make_cache_key`，若需要结合请求参数进行缓存，则就要对整个cached方便重写，存在大量冗余代码。具体的实现大概为通过flask.request.get_json()获取request_body，并结合业务对影响缓存的参数设置缓存。\n\n\n```python\ndef _make_cache_key(args, kwargs, use_request):\n    if callable(key_prefix):\n        cache_key = key_prefix()\n    elif \"%s\" in key_prefix:\n        if use_request:\n            cache_key = key_prefix % request.path\n        else:\n            cache_key = key_prefix % url_for(f.__name__, **kwargs)\n    else:\n        cache_key = key_prefix\n\n    return cache_key\n```\n- 另外值得学习的是装饰器最后一层的写法，结合了面向对象的思想，设置关键的属性到函数对象，结合后续删除等操作，非常优雅非常pythonic。\n\n### **memoize**\n- memoize相较于cached的区别\n\t- cache_key实现不同，memoize对key进行了加密\n\t- 针对普通函数缓存结果使用\n\t- 支持区分函数参数的缓存，索引cached基于参数的缓存改造，可以参考memoize的实现\n\n## 总结-如何写一个缓存框架\n从flask-caching的实现看出，实现缓存，逻辑还是很清晰的：`判断是否跳过缓存，生成查询key，获取缓存数据`。\n我们如果要实现缓存框架，大体需要考虑一下几方面：\n- 支持使用不同的存储实例，**抽象缓存对象接口**，如`get，has，set`\n- 支持区分参数缓存\n- 支持缓存时效性\n- 支持缓存数据加密\n- 如果要结合业务，则最好再额外添加业务层，统一对缓存调用进行管理\n\n\n## 使用缓存的注意事项（待补充）\n- 缓存穿透\n- 缓存雪崩\n- 缓存集群","source":"_posts/2019-07-14-flask-caching源码浅析.md","raw":"---\ntitle: flask-caching源码浅析\ndate: 2019-07-14 19:49:26\ntags:\n- flask\n- python\n- 源码浅析\ncategories:\n---\n\n{%note info%}\nflask-caching源码浅析。\n{%endnote%}\n<!--more-->\n\n## 简介\n- flash-caching是一款flask开发技术栈中使用频率非常高的一款插件，起初的名称为“flask-cache”，由于原作者不再维护，后由其他人在其基础上开发维护了flask-caching。\n- flask-caching支持后端存储类型（本文主要围绕使用redis的源码展开）：\n\t- simple 程序内部缓存\n\t- filesystem 系统文件缓存\n\t- redis\n\t- redissentinel\n\t- uwsgi\n\t- memcached\n\t- gaememcached\n\t- saslmemcached\n\t- spreadsaslmemcached\n\n## 简单使用\n```python\nfrom flask_caching import Cache\ncache = Cache()\n\nconfig = {\"CACHE_TYPE\": \"redis\", \"CACHE_REDIS_URL\": app.config[\"CACHE_REDIS_URL\"]}\n    cache.init_app(app, config=config)\n\n@app.route('/cache_test/<int:id>')\n@cache.cached(timeout=60 * 5)\ndef cache_test(id):\n    from flask import request\n    got_data = request.get_json()\n    import time\n\n    return f\"{got_data}.{id}.{time.time()}\"\n\n@cache.memoize(timeout=60 * 5)\ndef f_cache(a):\n    return a\n\n@app.route('/cache_test2/<int:id>')\ndef cache_test2(id):\n    return f\"{f_cache(id)}\"\n\n```\n\n\n## cache memoize源码解析\n### **cached**\n\n```python\n    def cached(\n        self,\n        timeout=None,\n        key_prefix=\"view/%s\",\n        unless=None,\n        forced_update=None,\n        response_filter=None,\n        query_string=False,\n        hash_method=hashlib.md5,\n    ):\n        \"\"\"...\"\"\"\n\n        def decorator(f):\n            @functools.wraps(f)\n            def decorated_function(*args, **kwargs):...\n\n                if not found:\n                    rv = f(*args, **kwargs)\n\n                    if response_filter is None or response_filter(rv):\n                        try:\n                            self.cache.set(\n                                cache_key,\n                                rv,\n                                timeout=decorated_function.cache_timeout,\n                            )\n                        except Exception:\n                            if self.app.debug:\n                                raise\n                            logger.exception(\n                                \"Exception possibly due to cache backend.\"\n                            )\n                return rv\n\n            def make_cache_key(*args, **kwargs):...\n\n            def _make_cache_key_query_string():...\n\n            def _make_cache_key(args, kwargs, use_request):...\n\n            decorated_function.uncached = f\n            decorated_function.cache_timeout = timeout\n            decorated_function.make_cache_key = make_cache_key\n\n            return decorated_function\n\n        return decorator\n```\n\n\n- cached是针对flask视图函数的缓存，使用过程中，我们主要关注以下几个参数：\n\t- timeout用于指定缓存失效的时间，设置0或-1则不失效\n\t- unless是一个函数，用于判断是否需要跳过缓存，可自定义实现\n\t\t\n\n```python\ndef _make_cache_key(args, kwargs, use_request):\n    if callable(key_prefix):\n        cache_key = key_prefix()\n    elif \"%s\" in key_prefix:\n        if use_request:\n            cache_key = key_prefix % request.path\n        else:\n            cache_key = key_prefix % url_for(f.__name__, **kwargs)\n    else:\n        cache_key = key_prefix\n\n    return cache_key\n\n# ```\n\n- 默认情况下进入逻辑\"elif \"%s\" in key_prefix:\", 因此cached缓存只与requesturl相关，与视图函数的传参无关，`这里不太了解作者的实现意图，为什么不结合请求参数，且不太方便扩展或重写_make_cache_key`，若需要结合请求参数进行缓存，则就要对整个cached方便重写，存在大量冗余代码。具体的实现大概为通过flask.request.get_json()获取request_body，并结合业务对影响缓存的参数设置缓存。\n\n\n```python\ndef _make_cache_key(args, kwargs, use_request):\n    if callable(key_prefix):\n        cache_key = key_prefix()\n    elif \"%s\" in key_prefix:\n        if use_request:\n            cache_key = key_prefix % request.path\n        else:\n            cache_key = key_prefix % url_for(f.__name__, **kwargs)\n    else:\n        cache_key = key_prefix\n\n    return cache_key\n```\n- 另外值得学习的是装饰器最后一层的写法，结合了面向对象的思想，设置关键的属性到函数对象，结合后续删除等操作，非常优雅非常pythonic。\n\n### **memoize**\n- memoize相较于cached的区别\n\t- cache_key实现不同，memoize对key进行了加密\n\t- 针对普通函数缓存结果使用\n\t- 支持区分函数参数的缓存，索引cached基于参数的缓存改造，可以参考memoize的实现\n\n## 总结-如何写一个缓存框架\n从flask-caching的实现看出，实现缓存，逻辑还是很清晰的：`判断是否跳过缓存，生成查询key，获取缓存数据`。\n我们如果要实现缓存框架，大体需要考虑一下几方面：\n- 支持使用不同的存储实例，**抽象缓存对象接口**，如`get，has，set`\n- 支持区分参数缓存\n- 支持缓存时效性\n- 支持缓存数据加密\n- 如果要结合业务，则最好再额外添加业务层，统一对缓存调用进行管理\n\n\n## 使用缓存的注意事项（待补充）\n- 缓存穿透\n- 缓存雪崩\n- 缓存集群","slug":"flask-caching源码浅析","published":1,"updated":"2020-03-28T14:35:40.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckezigl6d000l1gp7jr7loy55","content":"<div class=\"note info\"><p>flask-caching源码浅析。</p></div>\n<a id=\"more\"></a>\n<h2 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h2><ul>\n<li>flash-caching是一款flask开发技术栈中使用频率非常高的一款插件，起初的名称为“flask-cache”，由于原作者不再维护，后由其他人在其基础上开发维护了flask-caching。</li>\n<li>flask-caching支持后端存储类型（本文主要围绕使用redis的源码展开）：<ul>\n<li>simple 程序内部缓存</li>\n<li>filesystem 系统文件缓存</li>\n<li>redis</li>\n<li>redissentinel</li>\n<li>uwsgi</li>\n<li>memcached</li>\n<li>gaememcached</li>\n<li>saslmemcached</li>\n<li>spreadsaslmemcached</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"简单使用\"><a href=\"#简单使用\" class=\"headerlink\" title=\"简单使用\"></a>简单使用</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> flask_caching <span class=\"keyword\">import</span> Cache</span><br><span class=\"line\">cache = Cache()</span><br><span class=\"line\"></span><br><span class=\"line\">config = &#123;<span class=\"string\">\"CACHE_TYPE\"</span>: <span class=\"string\">\"redis\"</span>, <span class=\"string\">\"CACHE_REDIS_URL\"</span>: app.config[<span class=\"string\">\"CACHE_REDIS_URL\"</span>]&#125;</span><br><span class=\"line\">    cache.init_app(app, config=config)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@app.route('/cache_test/&lt;int:id&gt;')</span></span><br><span class=\"line\"><span class=\"meta\">@cache.cached(timeout=60 * 5)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">cache_test</span><span class=\"params\">(id)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">from</span> flask <span class=\"keyword\">import</span> request</span><br><span class=\"line\">    got_data = request.get_json()</span><br><span class=\"line\">    <span class=\"keyword\">import</span> time</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">f\"<span class=\"subst\">&#123;got_data&#125;</span>.<span class=\"subst\">&#123;id&#125;</span>.<span class=\"subst\">&#123;time.time()&#125;</span>\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@cache.memoize(timeout=60 * 5)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">f_cache</span><span class=\"params\">(a)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> a</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@app.route('/cache_test2/&lt;int:id&gt;')</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">cache_test2</span><span class=\"params\">(id)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">f\"<span class=\"subst\">&#123;f_cache(id)&#125;</span>\"</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"cache-memoize源码解析\"><a href=\"#cache-memoize源码解析\" class=\"headerlink\" title=\"cache memoize源码解析\"></a>cache memoize源码解析</h2><h3 id=\"cached\"><a href=\"#cached\" class=\"headerlink\" title=\"cached\"></a><strong>cached</strong></h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">cached</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    self,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    timeout=None,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    key_prefix=<span class=\"string\">\"view/%s\"</span>,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    unless=None,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    forced_update=None,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    response_filter=None,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    query_string=False,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    hash_method=hashlib.md5,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">)</span>:</span></span><br><span class=\"line\">    <span class=\"string\">\"\"\"...\"\"\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">decorator</span><span class=\"params\">(f)</span>:</span></span><br><span class=\"line\"><span class=\"meta\">        @functools.wraps(f)</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">decorated_function</span><span class=\"params\">(*args, **kwargs)</span>:</span>...</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> found:</span><br><span class=\"line\">                rv = f(*args, **kwargs)</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> response_filter <span class=\"keyword\">is</span> <span class=\"keyword\">None</span> <span class=\"keyword\">or</span> response_filter(rv):</span><br><span class=\"line\">                    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">                        self.cache.set(</span><br><span class=\"line\">                            cache_key,</span><br><span class=\"line\">                            rv,</span><br><span class=\"line\">                            timeout=decorated_function.cache_timeout,</span><br><span class=\"line\">                        )</span><br><span class=\"line\">                    <span class=\"keyword\">except</span> Exception:</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> self.app.debug:</span><br><span class=\"line\">                            <span class=\"keyword\">raise</span></span><br><span class=\"line\">                        logger.exception(</span><br><span class=\"line\">                            <span class=\"string\">\"Exception possibly due to cache backend.\"</span></span><br><span class=\"line\">                        )</span><br><span class=\"line\">            <span class=\"keyword\">return</span> rv</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">make_cache_key</span><span class=\"params\">(*args, **kwargs)</span>:</span>...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">_make_cache_key_query_string</span><span class=\"params\">()</span>:</span>...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">_make_cache_key</span><span class=\"params\">(args, kwargs, use_request)</span>:</span>...</span><br><span class=\"line\"></span><br><span class=\"line\">        decorated_function.uncached = f</span><br><span class=\"line\">        decorated_function.cache_timeout = timeout</span><br><span class=\"line\">        decorated_function.make_cache_key = make_cache_key</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> decorated_function</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> decorator</span><br></pre></td></tr></table></figure>\n<ul>\n<li>cached是针对flask视图函数的缓存，使用过程中，我们主要关注以下几个参数：<ul>\n<li>timeout用于指定缓存失效的时间，设置0或-1则不失效</li>\n<li>unless是一个函数，用于判断是否需要跳过缓存，可自定义实现</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">_make_cache_key</span><span class=\"params\">(args, kwargs, use_request)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> callable(key_prefix):</span><br><span class=\"line\">        cache_key = key_prefix()</span><br><span class=\"line\">    <span class=\"keyword\">elif</span> <span class=\"string\">\"%s\"</span> <span class=\"keyword\">in</span> key_prefix:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> use_request:</span><br><span class=\"line\">            cache_key = key_prefix % request.path</span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            cache_key = key_prefix % url_for(f.__name__, **kwargs)</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        cache_key = key_prefix</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> cache_key</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>默认情况下进入逻辑”elif “%s” in key_prefix:”, 因此cached缓存只与requesturl相关，与视图函数的传参无关，<code>这里不太了解作者的实现意图，为什么不结合请求参数，且不太方便扩展或重写_make_cache_key</code>，若需要结合请求参数进行缓存，则就要对整个cached方便重写，存在大量冗余代码。具体的实现大概为通过flask.request.get_json()获取request_body，并结合业务对影响缓存的参数设置缓存。</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">_make_cache_key</span><span class=\"params\">(args, kwargs, use_request)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> callable(key_prefix):</span><br><span class=\"line\">        cache_key = key_prefix()</span><br><span class=\"line\">    <span class=\"keyword\">elif</span> <span class=\"string\">\"%s\"</span> <span class=\"keyword\">in</span> key_prefix:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> use_request:</span><br><span class=\"line\">            cache_key = key_prefix % request.path</span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            cache_key = key_prefix % url_for(f.__name__, **kwargs)</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        cache_key = key_prefix</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> cache_key</span><br></pre></td></tr></table></figure>\n<ul>\n<li>另外值得学习的是装饰器最后一层的写法，结合了面向对象的思想，设置关键的属性到函数对象，结合后续删除等操作，非常优雅非常pythonic。</li>\n</ul>\n<h3 id=\"memoize\"><a href=\"#memoize\" class=\"headerlink\" title=\"memoize\"></a><strong>memoize</strong></h3><ul>\n<li>memoize相较于cached的区别<ul>\n<li>cache_key实现不同，memoize对key进行了加密</li>\n<li>针对普通函数缓存结果使用</li>\n<li>支持区分函数参数的缓存，索引cached基于参数的缓存改造，可以参考memoize的实现</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"总结-如何写一个缓存框架\"><a href=\"#总结-如何写一个缓存框架\" class=\"headerlink\" title=\"总结-如何写一个缓存框架\"></a>总结-如何写一个缓存框架</h2><p>从flask-caching的实现看出，实现缓存，逻辑还是很清晰的：<code>判断是否跳过缓存，生成查询key，获取缓存数据</code>。<br>我们如果要实现缓存框架，大体需要考虑一下几方面：</p>\n<ul>\n<li>支持使用不同的存储实例，<strong>抽象缓存对象接口</strong>，如<code>get，has，set</code></li>\n<li>支持区分参数缓存</li>\n<li>支持缓存时效性</li>\n<li>支持缓存数据加密</li>\n<li>如果要结合业务，则最好再额外添加业务层，统一对缓存调用进行管理</li>\n</ul>\n<h2 id=\"使用缓存的注意事项（待补充）\"><a href=\"#使用缓存的注意事项（待补充）\" class=\"headerlink\" title=\"使用缓存的注意事项（待补充）\"></a>使用缓存的注意事项（待补充）</h2><ul>\n<li>缓存穿透</li>\n<li>缓存雪崩</li>\n<li>缓存集群</li>\n</ul>\n","site":{"data":{}},"excerpt":"<div class=\"note info\"><p>flask-caching源码浅析。</p></div>","more":"<h2 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h2><ul>\n<li>flash-caching是一款flask开发技术栈中使用频率非常高的一款插件，起初的名称为“flask-cache”，由于原作者不再维护，后由其他人在其基础上开发维护了flask-caching。</li>\n<li>flask-caching支持后端存储类型（本文主要围绕使用redis的源码展开）：<ul>\n<li>simple 程序内部缓存</li>\n<li>filesystem 系统文件缓存</li>\n<li>redis</li>\n<li>redissentinel</li>\n<li>uwsgi</li>\n<li>memcached</li>\n<li>gaememcached</li>\n<li>saslmemcached</li>\n<li>spreadsaslmemcached</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"简单使用\"><a href=\"#简单使用\" class=\"headerlink\" title=\"简单使用\"></a>简单使用</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> flask_caching <span class=\"keyword\">import</span> Cache</span><br><span class=\"line\">cache = Cache()</span><br><span class=\"line\"></span><br><span class=\"line\">config = &#123;<span class=\"string\">\"CACHE_TYPE\"</span>: <span class=\"string\">\"redis\"</span>, <span class=\"string\">\"CACHE_REDIS_URL\"</span>: app.config[<span class=\"string\">\"CACHE_REDIS_URL\"</span>]&#125;</span><br><span class=\"line\">    cache.init_app(app, config=config)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@app.route('/cache_test/&lt;int:id&gt;')</span></span><br><span class=\"line\"><span class=\"meta\">@cache.cached(timeout=60 * 5)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">cache_test</span><span class=\"params\">(id)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">from</span> flask <span class=\"keyword\">import</span> request</span><br><span class=\"line\">    got_data = request.get_json()</span><br><span class=\"line\">    <span class=\"keyword\">import</span> time</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">f\"<span class=\"subst\">&#123;got_data&#125;</span>.<span class=\"subst\">&#123;id&#125;</span>.<span class=\"subst\">&#123;time.time()&#125;</span>\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@cache.memoize(timeout=60 * 5)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">f_cache</span><span class=\"params\">(a)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> a</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@app.route('/cache_test2/&lt;int:id&gt;')</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">cache_test2</span><span class=\"params\">(id)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">f\"<span class=\"subst\">&#123;f_cache(id)&#125;</span>\"</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"cache-memoize源码解析\"><a href=\"#cache-memoize源码解析\" class=\"headerlink\" title=\"cache memoize源码解析\"></a>cache memoize源码解析</h2><h3 id=\"cached\"><a href=\"#cached\" class=\"headerlink\" title=\"cached\"></a><strong>cached</strong></h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">cached</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    self,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    timeout=None,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    key_prefix=<span class=\"string\">\"view/%s\"</span>,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    unless=None,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    forced_update=None,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    response_filter=None,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    query_string=False,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    hash_method=hashlib.md5,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">)</span>:</span></span><br><span class=\"line\">    <span class=\"string\">\"\"\"...\"\"\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">decorator</span><span class=\"params\">(f)</span>:</span></span><br><span class=\"line\"><span class=\"meta\">        @functools.wraps(f)</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">decorated_function</span><span class=\"params\">(*args, **kwargs)</span>:</span>...</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> found:</span><br><span class=\"line\">                rv = f(*args, **kwargs)</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> response_filter <span class=\"keyword\">is</span> <span class=\"keyword\">None</span> <span class=\"keyword\">or</span> response_filter(rv):</span><br><span class=\"line\">                    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">                        self.cache.set(</span><br><span class=\"line\">                            cache_key,</span><br><span class=\"line\">                            rv,</span><br><span class=\"line\">                            timeout=decorated_function.cache_timeout,</span><br><span class=\"line\">                        )</span><br><span class=\"line\">                    <span class=\"keyword\">except</span> Exception:</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> self.app.debug:</span><br><span class=\"line\">                            <span class=\"keyword\">raise</span></span><br><span class=\"line\">                        logger.exception(</span><br><span class=\"line\">                            <span class=\"string\">\"Exception possibly due to cache backend.\"</span></span><br><span class=\"line\">                        )</span><br><span class=\"line\">            <span class=\"keyword\">return</span> rv</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">make_cache_key</span><span class=\"params\">(*args, **kwargs)</span>:</span>...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">_make_cache_key_query_string</span><span class=\"params\">()</span>:</span>...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">_make_cache_key</span><span class=\"params\">(args, kwargs, use_request)</span>:</span>...</span><br><span class=\"line\"></span><br><span class=\"line\">        decorated_function.uncached = f</span><br><span class=\"line\">        decorated_function.cache_timeout = timeout</span><br><span class=\"line\">        decorated_function.make_cache_key = make_cache_key</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> decorated_function</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> decorator</span><br></pre></td></tr></table></figure>\n<ul>\n<li>cached是针对flask视图函数的缓存，使用过程中，我们主要关注以下几个参数：<ul>\n<li>timeout用于指定缓存失效的时间，设置0或-1则不失效</li>\n<li>unless是一个函数，用于判断是否需要跳过缓存，可自定义实现</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">_make_cache_key</span><span class=\"params\">(args, kwargs, use_request)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> callable(key_prefix):</span><br><span class=\"line\">        cache_key = key_prefix()</span><br><span class=\"line\">    <span class=\"keyword\">elif</span> <span class=\"string\">\"%s\"</span> <span class=\"keyword\">in</span> key_prefix:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> use_request:</span><br><span class=\"line\">            cache_key = key_prefix % request.path</span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            cache_key = key_prefix % url_for(f.__name__, **kwargs)</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        cache_key = key_prefix</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> cache_key</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>默认情况下进入逻辑”elif “%s” in key_prefix:”, 因此cached缓存只与requesturl相关，与视图函数的传参无关，<code>这里不太了解作者的实现意图，为什么不结合请求参数，且不太方便扩展或重写_make_cache_key</code>，若需要结合请求参数进行缓存，则就要对整个cached方便重写，存在大量冗余代码。具体的实现大概为通过flask.request.get_json()获取request_body，并结合业务对影响缓存的参数设置缓存。</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">_make_cache_key</span><span class=\"params\">(args, kwargs, use_request)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> callable(key_prefix):</span><br><span class=\"line\">        cache_key = key_prefix()</span><br><span class=\"line\">    <span class=\"keyword\">elif</span> <span class=\"string\">\"%s\"</span> <span class=\"keyword\">in</span> key_prefix:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> use_request:</span><br><span class=\"line\">            cache_key = key_prefix % request.path</span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            cache_key = key_prefix % url_for(f.__name__, **kwargs)</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        cache_key = key_prefix</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> cache_key</span><br></pre></td></tr></table></figure>\n<ul>\n<li>另外值得学习的是装饰器最后一层的写法，结合了面向对象的思想，设置关键的属性到函数对象，结合后续删除等操作，非常优雅非常pythonic。</li>\n</ul>\n<h3 id=\"memoize\"><a href=\"#memoize\" class=\"headerlink\" title=\"memoize\"></a><strong>memoize</strong></h3><ul>\n<li>memoize相较于cached的区别<ul>\n<li>cache_key实现不同，memoize对key进行了加密</li>\n<li>针对普通函数缓存结果使用</li>\n<li>支持区分函数参数的缓存，索引cached基于参数的缓存改造，可以参考memoize的实现</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"总结-如何写一个缓存框架\"><a href=\"#总结-如何写一个缓存框架\" class=\"headerlink\" title=\"总结-如何写一个缓存框架\"></a>总结-如何写一个缓存框架</h2><p>从flask-caching的实现看出，实现缓存，逻辑还是很清晰的：<code>判断是否跳过缓存，生成查询key，获取缓存数据</code>。<br>我们如果要实现缓存框架，大体需要考虑一下几方面：</p>\n<ul>\n<li>支持使用不同的存储实例，<strong>抽象缓存对象接口</strong>，如<code>get，has，set</code></li>\n<li>支持区分参数缓存</li>\n<li>支持缓存时效性</li>\n<li>支持缓存数据加密</li>\n<li>如果要结合业务，则最好再额外添加业务层，统一对缓存调用进行管理</li>\n</ul>\n<h2 id=\"使用缓存的注意事项（待补充）\"><a href=\"#使用缓存的注意事项（待补充）\" class=\"headerlink\" title=\"使用缓存的注意事项（待补充）\"></a>使用缓存的注意事项（待补充）</h2><ul>\n<li>缓存穿透</li>\n<li>缓存雪崩</li>\n<li>缓存集群</li>\n</ul>"},{"title":"hexo容器化部署","date":"2019-12-22T14:09:24.000Z","_content":"\n{%note info%}\nhexo容器化部署，从此再无系统环境迁移的烦恼。\n{%endnote%}\n<!--more-->\n\n## 简介\n- 本文介绍从hexo windows环境改造为docker容器化运行环境。\n\n## 改造过程\nhexo宿主机环境部署和docker的使用就不再赘述了，google大法既可。\n- 本着一切从简原则，直接搜了[dockerhub](https://hub.docker.com/search?q=hexo&type=image)，选了个最多下载的[ipple1986/hexo\n](https://hub.docker.com/r/ipple1986/hexo/dockerfile)，发现直接拉取镜像是可以用的：\n\n```bash\ndocker pull ipple1986/hexo\n```\n- 但我往往更倾向于对dockerfile重新定制，毕竟直接FROM第三方库多少会有点不透明性\n- 于是拿着对方的dockerfile尝试重新构建镜像\n\n```\nFROM centos:7\nENV LANG C.UTF-8\nLABEL author=ipple1986 email=ipple1986@gmail.com site=https://zhaozhiwen.net.cn\nWORKDIR /opt/hexo\nRUN yum install -y  epel-release && \\\nyum install -y nodejs && npm config set registry https://registry.npm.taobao.org \\\n&& npm install hexo-cli -g  && hexo init ipple1986 && cd ipple1986 && npm install\nWORKDIR ipple1986\nEXPOSE 4000\nENTRYPOINT [\"hexo\",\"server\"]\n\n```\n- 结果hexo使用直接报错\n\n![nodejs版本过低异常.png](https://i.loli.net/2019/12/22/4N2AI7PvGl9Ep1C.png)\n- google分析不难看出是nodejs版本过低，通过yum指定安装node版本即可\n\n```\ncurl --location https://rpm.nodesource.com/setup_10.x | bash\n```\n- 于是，最终的dockerfile为：\n\n```\nFROM centos:7\nENV LC_ALL en_US.UTF-8\nENV TZ=Asia/Shanghai\n\nLABEL maintainer=\"liwei <839728919@qq.com>\"\n\nWORKDIR /opt/hexo\nRUN curl --location https://rpm.nodesource.com/setup_10.x | bash && \\\nyum install -y epel-release nodejs git && \\\nnpm config set registry https://registry.npm.taobao.org && \\\nnpm install hexo-cli -g\n\nEXPOSE 4000\nCMD [\"hexo\", \"server\"]\n```\n\n- 使用指令如下：\n\n```bash\n# 编译镜像\ndocker build -t blog .\n\n# 运行容器\ndocker run -it -v your-code-path:/opt/hexo --name blog blog:latest\n\n# 进入容器\ndocker exec -it blog bash\n\n# hexo部署\nhexo d # 注意需要配置git，亦可手动输入账号密码\n```\n\n## 其他问题\n- hexo在其他主机上的docker容器中`hexo d`部署失败（gitpage bulid failed），已比对发现是.deploy_git没有同步更新，手动删除并`hexo g -d`，成功修复\n","source":"_posts/2019-12-22-hexo容器化部署.md","raw":"---\ntitle: hexo容器化部署\ndate: 2019-12-22 22:09:24\ntags:\n- hexo\ncategories:\n---\n\n{%note info%}\nhexo容器化部署，从此再无系统环境迁移的烦恼。\n{%endnote%}\n<!--more-->\n\n## 简介\n- 本文介绍从hexo windows环境改造为docker容器化运行环境。\n\n## 改造过程\nhexo宿主机环境部署和docker的使用就不再赘述了，google大法既可。\n- 本着一切从简原则，直接搜了[dockerhub](https://hub.docker.com/search?q=hexo&type=image)，选了个最多下载的[ipple1986/hexo\n](https://hub.docker.com/r/ipple1986/hexo/dockerfile)，发现直接拉取镜像是可以用的：\n\n```bash\ndocker pull ipple1986/hexo\n```\n- 但我往往更倾向于对dockerfile重新定制，毕竟直接FROM第三方库多少会有点不透明性\n- 于是拿着对方的dockerfile尝试重新构建镜像\n\n```\nFROM centos:7\nENV LANG C.UTF-8\nLABEL author=ipple1986 email=ipple1986@gmail.com site=https://zhaozhiwen.net.cn\nWORKDIR /opt/hexo\nRUN yum install -y  epel-release && \\\nyum install -y nodejs && npm config set registry https://registry.npm.taobao.org \\\n&& npm install hexo-cli -g  && hexo init ipple1986 && cd ipple1986 && npm install\nWORKDIR ipple1986\nEXPOSE 4000\nENTRYPOINT [\"hexo\",\"server\"]\n\n```\n- 结果hexo使用直接报错\n\n![nodejs版本过低异常.png](https://i.loli.net/2019/12/22/4N2AI7PvGl9Ep1C.png)\n- google分析不难看出是nodejs版本过低，通过yum指定安装node版本即可\n\n```\ncurl --location https://rpm.nodesource.com/setup_10.x | bash\n```\n- 于是，最终的dockerfile为：\n\n```\nFROM centos:7\nENV LC_ALL en_US.UTF-8\nENV TZ=Asia/Shanghai\n\nLABEL maintainer=\"liwei <839728919@qq.com>\"\n\nWORKDIR /opt/hexo\nRUN curl --location https://rpm.nodesource.com/setup_10.x | bash && \\\nyum install -y epel-release nodejs git && \\\nnpm config set registry https://registry.npm.taobao.org && \\\nnpm install hexo-cli -g\n\nEXPOSE 4000\nCMD [\"hexo\", \"server\"]\n```\n\n- 使用指令如下：\n\n```bash\n# 编译镜像\ndocker build -t blog .\n\n# 运行容器\ndocker run -it -v your-code-path:/opt/hexo --name blog blog:latest\n\n# 进入容器\ndocker exec -it blog bash\n\n# hexo部署\nhexo d # 注意需要配置git，亦可手动输入账号密码\n```\n\n## 其他问题\n- hexo在其他主机上的docker容器中`hexo d`部署失败（gitpage bulid failed），已比对发现是.deploy_git没有同步更新，手动删除并`hexo g -d`，成功修复\n","slug":"hexo容器化部署","published":1,"updated":"2020-03-28T14:35:40.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckezigl6i000q1gp7mgkaaeps","content":"<div class=\"note info\"><p>hexo容器化部署，从此再无系统环境迁移的烦恼。</p></div>\n<a id=\"more\"></a>\n<h2 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h2><ul>\n<li>本文介绍从hexo windows环境改造为docker容器化运行环境。</li>\n</ul>\n<h2 id=\"改造过程\"><a href=\"#改造过程\" class=\"headerlink\" title=\"改造过程\"></a>改造过程</h2><p>hexo宿主机环境部署和docker的使用就不再赘述了，google大法既可。</p>\n<ul>\n<li>本着一切从简原则，直接搜了<a href=\"https://hub.docker.com/search?q=hexo&amp;type=image\" target=\"_blank\" rel=\"noopener\">dockerhub</a>，选了个最多下载的<a href=\"https://hub.docker.com/r/ipple1986/hexo/dockerfile\" target=\"_blank\" rel=\"noopener\">ipple1986/hexo\n</a>，发现直接拉取镜像是可以用的：</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull ipple1986/hexo</span><br></pre></td></tr></table></figure>\n<ul>\n<li>但我往往更倾向于对dockerfile重新定制，毕竟直接FROM第三方库多少会有点不透明性</li>\n<li>于是拿着对方的dockerfile尝试重新构建镜像</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM centos:7</span><br><span class=\"line\">ENV LANG C.UTF-8</span><br><span class=\"line\">LABEL author=ipple1986 email=ipple1986@gmail.com site=https://zhaozhiwen.net.cn</span><br><span class=\"line\">WORKDIR /opt/hexo</span><br><span class=\"line\">RUN yum install -y  epel-release &amp;&amp; \\</span><br><span class=\"line\">yum install -y nodejs &amp;&amp; npm config set registry https://registry.npm.taobao.org \\</span><br><span class=\"line\">&amp;&amp; npm install hexo-cli -g  &amp;&amp; hexo init ipple1986 &amp;&amp; cd ipple1986 &amp;&amp; npm install</span><br><span class=\"line\">WORKDIR ipple1986</span><br><span class=\"line\">EXPOSE 4000</span><br><span class=\"line\">ENTRYPOINT [&quot;hexo&quot;,&quot;server&quot;]</span><br></pre></td></tr></table></figure>\n<ul>\n<li>结果hexo使用直接报错</li>\n</ul>\n<p><img src=\"https://i.loli.net/2019/12/22/4N2AI7PvGl9Ep1C.png\" alt=\"nodejs版本过低异常.png\"></p>\n<ul>\n<li>google分析不难看出是nodejs版本过低，通过yum指定安装node版本即可</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl --location https://rpm.nodesource.com/setup_10.x | bash</span><br></pre></td></tr></table></figure>\n<ul>\n<li>于是，最终的dockerfile为：</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM centos:7</span><br><span class=\"line\">ENV LC_ALL en_US.UTF-8</span><br><span class=\"line\">ENV TZ=Asia/Shanghai</span><br><span class=\"line\"></span><br><span class=\"line\">LABEL maintainer=&quot;liwei &lt;839728919@qq.com&gt;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">WORKDIR /opt/hexo</span><br><span class=\"line\">RUN curl --location https://rpm.nodesource.com/setup_10.x | bash &amp;&amp; \\</span><br><span class=\"line\">yum install -y epel-release nodejs git &amp;&amp; \\</span><br><span class=\"line\">npm config set registry https://registry.npm.taobao.org &amp;&amp; \\</span><br><span class=\"line\">npm install hexo-cli -g</span><br><span class=\"line\"></span><br><span class=\"line\">EXPOSE 4000</span><br><span class=\"line\">CMD [&quot;hexo&quot;, &quot;server&quot;]</span><br></pre></td></tr></table></figure>\n<ul>\n<li>使用指令如下：</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 编译镜像</span></span><br><span class=\"line\">docker build -t blog .</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 运行容器</span></span><br><span class=\"line\">docker run -it -v your-code-path:/opt/hexo --name blog blog:latest</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 进入容器</span></span><br><span class=\"line\">docker <span class=\"built_in\">exec</span> -it blog bash</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># hexo部署</span></span><br><span class=\"line\">hexo d <span class=\"comment\"># 注意需要配置git，亦可手动输入账号密码</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"其他问题\"><a href=\"#其他问题\" class=\"headerlink\" title=\"其他问题\"></a>其他问题</h2><ul>\n<li>hexo在其他主机上的docker容器中<code>hexo d</code>部署失败（gitpage bulid failed），已比对发现是.deploy_git没有同步更新，手动删除并<code>hexo g -d</code>，成功修复</li>\n</ul>\n","site":{"data":{}},"excerpt":"<div class=\"note info\"><p>hexo容器化部署，从此再无系统环境迁移的烦恼。</p></div>","more":"<h2 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h2><ul>\n<li>本文介绍从hexo windows环境改造为docker容器化运行环境。</li>\n</ul>\n<h2 id=\"改造过程\"><a href=\"#改造过程\" class=\"headerlink\" title=\"改造过程\"></a>改造过程</h2><p>hexo宿主机环境部署和docker的使用就不再赘述了，google大法既可。</p>\n<ul>\n<li>本着一切从简原则，直接搜了<a href=\"https://hub.docker.com/search?q=hexo&amp;type=image\" target=\"_blank\" rel=\"noopener\">dockerhub</a>，选了个最多下载的<a href=\"https://hub.docker.com/r/ipple1986/hexo/dockerfile\" target=\"_blank\" rel=\"noopener\">ipple1986/hexo\n</a>，发现直接拉取镜像是可以用的：</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull ipple1986/hexo</span><br></pre></td></tr></table></figure>\n<ul>\n<li>但我往往更倾向于对dockerfile重新定制，毕竟直接FROM第三方库多少会有点不透明性</li>\n<li>于是拿着对方的dockerfile尝试重新构建镜像</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM centos:7</span><br><span class=\"line\">ENV LANG C.UTF-8</span><br><span class=\"line\">LABEL author=ipple1986 email=ipple1986@gmail.com site=https://zhaozhiwen.net.cn</span><br><span class=\"line\">WORKDIR /opt/hexo</span><br><span class=\"line\">RUN yum install -y  epel-release &amp;&amp; \\</span><br><span class=\"line\">yum install -y nodejs &amp;&amp; npm config set registry https://registry.npm.taobao.org \\</span><br><span class=\"line\">&amp;&amp; npm install hexo-cli -g  &amp;&amp; hexo init ipple1986 &amp;&amp; cd ipple1986 &amp;&amp; npm install</span><br><span class=\"line\">WORKDIR ipple1986</span><br><span class=\"line\">EXPOSE 4000</span><br><span class=\"line\">ENTRYPOINT [&quot;hexo&quot;,&quot;server&quot;]</span><br></pre></td></tr></table></figure>\n<ul>\n<li>结果hexo使用直接报错</li>\n</ul>\n<p><img src=\"https://i.loli.net/2019/12/22/4N2AI7PvGl9Ep1C.png\" alt=\"nodejs版本过低异常.png\"></p>\n<ul>\n<li>google分析不难看出是nodejs版本过低，通过yum指定安装node版本即可</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl --location https://rpm.nodesource.com/setup_10.x | bash</span><br></pre></td></tr></table></figure>\n<ul>\n<li>于是，最终的dockerfile为：</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM centos:7</span><br><span class=\"line\">ENV LC_ALL en_US.UTF-8</span><br><span class=\"line\">ENV TZ=Asia/Shanghai</span><br><span class=\"line\"></span><br><span class=\"line\">LABEL maintainer=&quot;liwei &lt;839728919@qq.com&gt;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">WORKDIR /opt/hexo</span><br><span class=\"line\">RUN curl --location https://rpm.nodesource.com/setup_10.x | bash &amp;&amp; \\</span><br><span class=\"line\">yum install -y epel-release nodejs git &amp;&amp; \\</span><br><span class=\"line\">npm config set registry https://registry.npm.taobao.org &amp;&amp; \\</span><br><span class=\"line\">npm install hexo-cli -g</span><br><span class=\"line\"></span><br><span class=\"line\">EXPOSE 4000</span><br><span class=\"line\">CMD [&quot;hexo&quot;, &quot;server&quot;]</span><br></pre></td></tr></table></figure>\n<ul>\n<li>使用指令如下：</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 编译镜像</span></span><br><span class=\"line\">docker build -t blog .</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 运行容器</span></span><br><span class=\"line\">docker run -it -v your-code-path:/opt/hexo --name blog blog:latest</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 进入容器</span></span><br><span class=\"line\">docker <span class=\"built_in\">exec</span> -it blog bash</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># hexo部署</span></span><br><span class=\"line\">hexo d <span class=\"comment\"># 注意需要配置git，亦可手动输入账号密码</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"其他问题\"><a href=\"#其他问题\" class=\"headerlink\" title=\"其他问题\"></a>其他问题</h2><ul>\n<li>hexo在其他主机上的docker容器中<code>hexo d</code>部署失败（gitpage bulid failed），已比对发现是.deploy_git没有同步更新，手动删除并<code>hexo g -d</code>，成功修复</li>\n</ul>"},{"title":"数据结构与算法总结","date":"2019-06-16T08:02:18.000Z","_content":"\n{%note info%}\n总结下算法与数据结构的基础知识，虽然网络上有现成的总结，但拿来主义不是学习编程该走的捷径。\n{%endnote%}\n<!--more-->\n\n## 图例\n![优劣示意图.png](https://i.loli.net/2019/06/16/5d05fac1bcc8e83459.png)\n\n## 数据结构\n![数据结构复杂度.png](https://i.loli.net/2019/06/16/5d05fac1e674389225.png)\n\n## 排序算法\n![排序复杂度.png](https://i.loli.net/2019/06/16/5d05fac1d4a8f86311.png)\n\n## 堆操作\n![堆.png](https://i.loli.net/2019/06/16/5d05fac19111547738.png)","source":"_posts/2019-06-16-数据结构与算法总结.md","raw":"---\ntitle: 数据结构与算法总结\ndate: 2019-06-16 16:02:18\ntags:\n- algorithm\n- datastructure\ncategories:\n- algorithm&datastructure\n---\n\n{%note info%}\n总结下算法与数据结构的基础知识，虽然网络上有现成的总结，但拿来主义不是学习编程该走的捷径。\n{%endnote%}\n<!--more-->\n\n## 图例\n![优劣示意图.png](https://i.loli.net/2019/06/16/5d05fac1bcc8e83459.png)\n\n## 数据结构\n![数据结构复杂度.png](https://i.loli.net/2019/06/16/5d05fac1e674389225.png)\n\n## 排序算法\n![排序复杂度.png](https://i.loli.net/2019/06/16/5d05fac1d4a8f86311.png)\n\n## 堆操作\n![堆.png](https://i.loli.net/2019/06/16/5d05fac19111547738.png)","slug":"数据结构与算法总结","published":1,"updated":"2020-03-28T14:35:40.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckezigl6r000s1gp7wy4yoxh4","content":"<div class=\"note info\"><p>总结下算法与数据结构的基础知识，虽然网络上有现成的总结，但拿来主义不是学习编程该走的捷径。</p></div>\n<a id=\"more\"></a>\n<h2 id=\"图例\"><a href=\"#图例\" class=\"headerlink\" title=\"图例\"></a>图例</h2><p><img src=\"https://i.loli.net/2019/06/16/5d05fac1bcc8e83459.png\" alt=\"优劣示意图.png\"></p>\n<h2 id=\"数据结构\"><a href=\"#数据结构\" class=\"headerlink\" title=\"数据结构\"></a>数据结构</h2><p><img src=\"https://i.loli.net/2019/06/16/5d05fac1e674389225.png\" alt=\"数据结构复杂度.png\"></p>\n<h2 id=\"排序算法\"><a href=\"#排序算法\" class=\"headerlink\" title=\"排序算法\"></a>排序算法</h2><p><img src=\"https://i.loli.net/2019/06/16/5d05fac1d4a8f86311.png\" alt=\"排序复杂度.png\"></p>\n<h2 id=\"堆操作\"><a href=\"#堆操作\" class=\"headerlink\" title=\"堆操作\"></a>堆操作</h2><p><img src=\"https://i.loli.net/2019/06/16/5d05fac19111547738.png\" alt=\"堆.png\"></p>\n","site":{"data":{}},"excerpt":"<div class=\"note info\"><p>总结下算法与数据结构的基础知识，虽然网络上有现成的总结，但拿来主义不是学习编程该走的捷径。</p></div>","more":"<h2 id=\"图例\"><a href=\"#图例\" class=\"headerlink\" title=\"图例\"></a>图例</h2><p><img src=\"https://i.loli.net/2019/06/16/5d05fac1bcc8e83459.png\" alt=\"优劣示意图.png\"></p>\n<h2 id=\"数据结构\"><a href=\"#数据结构\" class=\"headerlink\" title=\"数据结构\"></a>数据结构</h2><p><img src=\"https://i.loli.net/2019/06/16/5d05fac1e674389225.png\" alt=\"数据结构复杂度.png\"></p>\n<h2 id=\"排序算法\"><a href=\"#排序算法\" class=\"headerlink\" title=\"排序算法\"></a>排序算法</h2><p><img src=\"https://i.loli.net/2019/06/16/5d05fac1d4a8f86311.png\" alt=\"排序复杂度.png\"></p>\n<h2 id=\"堆操作\"><a href=\"#堆操作\" class=\"headerlink\" title=\"堆操作\"></a>堆操作</h2><p><img src=\"https://i.loli.net/2019/06/16/5d05fac19111547738.png\" alt=\"堆.png\"></p>"},{"title":"关于pyspark-dataframe与pandas-dataframe的那些事","date":"2020-03-27T13:31:17.000Z","_content":"{%note info%}\npyspark.dataframe与pandas.dataframe大概目前机器学习算子中最长用到的数据结构了，本文来讲讲各自的常用操作和两者间相互转换。\n{%endnote%}\n<!--more-->\n\n## pyspark\n- 创建spark-session\n\n```python\nfrom pyspark.sql import SparkSession\nsession = (\n    SparkSession.builder.appName(\"spark_pyspark\")\n        .config(\"hive.metastore.uris\", \"thrift://ip:9083\")\n        .config(\"spark.sql.warehouse.dir\", \"/user/hive/warehouse\")\n        .enableHiveSupport()\n        .getOrCreate()\n)\n```\n\n- 通过pyspark-sql进行数据查询、聚合、统计\n\n```python\ndf = session.sql(\"select * from table_name\")\n```\n\n- dataframe数据落地保存\n\n```python\n// 类似的常用的方法还有saveAsPickleFile\ndf.rdd.saveAsTextFile('/tmp/text_file')\n\n// 通过spark-sql\ndf.write.saveAsTable(output_table, None, \"overwrite\", None)\n```\n\n- 重新读取落地的文件\n\t   \n```python\n// p类型为list\np = session.sparkContext.pickleFile('/tmp/pickle_file/part-00000').collect()\n```\n\n- 重新回到dataframe\n\n```python\ndf = session.createDataFrame(p)\n```\n\n- datafram实例化\n\n```python\n// csv to dataframe\n// schema数据类型为 `from pyspark.sql.types import *`\ndf = (\n    self.session.read.format(\"com.databricks.spark.csv\")\n    .options(\n        header=True,\n        schema=schema,\n        encoding=encoding,\n        delimiter=col_delimiter,\n    )\n    .load(uri) // uri 可以指定hdfs文件或者本地文件\n)\n\n// mysql to dataframe\ndf = (\n    self.session.read.format(\"jdbc\")\n    .options(\n        url=url,\n        driver=\"com.mysql.jdbc.Driver\",\n        dbtable=db_table_name,\n        user=user_name,\n        password=password,\n    )\n    .load()\n)\n```\n\n- pyspark.dataframe to pandas.dataframe\n\n```python\npdf = df.toPandas()\n```\n\n## pandas\n- pandas.dataframe 实例化\n\n```python\nimport pandas as pd\n\n// csv to pdf\npdf = pd.read_csv(file_path)\n```\n\n- dataframe to csv\n\n```python\npdf.to_csv(file_path, index=False)\n```\n\n- pandas.dataframe to pyspark.dataframe\n\n```python\n// session的声明方式见上文\ndf = session.createDataFrame(pdf)\n```\n\n- pdf to string\n\n```python\ns = pdf.to_string()\n```\n\n## 复杂问题\n\n### spark.dataframe如何实现多机同步\n\n正常情况下通过`df.write`落hdfs(上层可能基于hive或者spark-sql)实现共享。\n但若要跨集群共享就要另想办法了。\n解决方案就是将落地数据单独传输：\n\n1、df -> hdfs -> local file -> internet\n2、df -> pdf -> byte or string -> internet\n显然第二种方法只需要落地一次，更优\n\n```python\n# spark df to pandas df\npdf = df.toPandas()\n\n# pandas df to string\ns = pdf.to_string()\n\n# string to bytes\nb = str.encode(s)\n\n# send\n\n# bytes to pandas df\nfrom io import StringIO\ns = str(bytes_data,'utf-8')\n// sep 必须要指定，非则将结构混乱\ndf = pd.read_csv(StringIO(s), sep=\"\\s+\")\n```\n\n### pandas.dataframe数据精度问题\n当pandas.dataframe to_csv或者转为pysprk.dataframe时，会默认进行精度转换，\nto_csv中提供了指定精度的参数，然而每列特征的精度本就可能不一致，所以最好还是完整保留当前的数据内容。\n解决方案：\n1、通过float_format指定最长有效数字，`g`不补零，`f`补零\n\n```python\npdf.to_csv(file_path, index=False, float_format=\"%.10g\")\n```\n2、使用`pdf.to_string`的方式，保存数据快照，然后手动进行数据转换为csv。","source":"_posts/2020-03-27-关于pyspark-dataframe与pandas-dataframe的那些事.md","raw":"---\ntitle: 关于pyspark-dataframe与pandas-dataframe的那些事\ndate: 2020-03-27 21:31:17\ntags:\n- pysqark\n- pandas\ncategories:\n- python\n---\n{%note info%}\npyspark.dataframe与pandas.dataframe大概目前机器学习算子中最长用到的数据结构了，本文来讲讲各自的常用操作和两者间相互转换。\n{%endnote%}\n<!--more-->\n\n## pyspark\n- 创建spark-session\n\n```python\nfrom pyspark.sql import SparkSession\nsession = (\n    SparkSession.builder.appName(\"spark_pyspark\")\n        .config(\"hive.metastore.uris\", \"thrift://ip:9083\")\n        .config(\"spark.sql.warehouse.dir\", \"/user/hive/warehouse\")\n        .enableHiveSupport()\n        .getOrCreate()\n)\n```\n\n- 通过pyspark-sql进行数据查询、聚合、统计\n\n```python\ndf = session.sql(\"select * from table_name\")\n```\n\n- dataframe数据落地保存\n\n```python\n// 类似的常用的方法还有saveAsPickleFile\ndf.rdd.saveAsTextFile('/tmp/text_file')\n\n// 通过spark-sql\ndf.write.saveAsTable(output_table, None, \"overwrite\", None)\n```\n\n- 重新读取落地的文件\n\t   \n```python\n// p类型为list\np = session.sparkContext.pickleFile('/tmp/pickle_file/part-00000').collect()\n```\n\n- 重新回到dataframe\n\n```python\ndf = session.createDataFrame(p)\n```\n\n- datafram实例化\n\n```python\n// csv to dataframe\n// schema数据类型为 `from pyspark.sql.types import *`\ndf = (\n    self.session.read.format(\"com.databricks.spark.csv\")\n    .options(\n        header=True,\n        schema=schema,\n        encoding=encoding,\n        delimiter=col_delimiter,\n    )\n    .load(uri) // uri 可以指定hdfs文件或者本地文件\n)\n\n// mysql to dataframe\ndf = (\n    self.session.read.format(\"jdbc\")\n    .options(\n        url=url,\n        driver=\"com.mysql.jdbc.Driver\",\n        dbtable=db_table_name,\n        user=user_name,\n        password=password,\n    )\n    .load()\n)\n```\n\n- pyspark.dataframe to pandas.dataframe\n\n```python\npdf = df.toPandas()\n```\n\n## pandas\n- pandas.dataframe 实例化\n\n```python\nimport pandas as pd\n\n// csv to pdf\npdf = pd.read_csv(file_path)\n```\n\n- dataframe to csv\n\n```python\npdf.to_csv(file_path, index=False)\n```\n\n- pandas.dataframe to pyspark.dataframe\n\n```python\n// session的声明方式见上文\ndf = session.createDataFrame(pdf)\n```\n\n- pdf to string\n\n```python\ns = pdf.to_string()\n```\n\n## 复杂问题\n\n### spark.dataframe如何实现多机同步\n\n正常情况下通过`df.write`落hdfs(上层可能基于hive或者spark-sql)实现共享。\n但若要跨集群共享就要另想办法了。\n解决方案就是将落地数据单独传输：\n\n1、df -> hdfs -> local file -> internet\n2、df -> pdf -> byte or string -> internet\n显然第二种方法只需要落地一次，更优\n\n```python\n# spark df to pandas df\npdf = df.toPandas()\n\n# pandas df to string\ns = pdf.to_string()\n\n# string to bytes\nb = str.encode(s)\n\n# send\n\n# bytes to pandas df\nfrom io import StringIO\ns = str(bytes_data,'utf-8')\n// sep 必须要指定，非则将结构混乱\ndf = pd.read_csv(StringIO(s), sep=\"\\s+\")\n```\n\n### pandas.dataframe数据精度问题\n当pandas.dataframe to_csv或者转为pysprk.dataframe时，会默认进行精度转换，\nto_csv中提供了指定精度的参数，然而每列特征的精度本就可能不一致，所以最好还是完整保留当前的数据内容。\n解决方案：\n1、通过float_format指定最长有效数字，`g`不补零，`f`补零\n\n```python\npdf.to_csv(file_path, index=False, float_format=\"%.10g\")\n```\n2、使用`pdf.to_string`的方式，保存数据快照，然后手动进行数据转换为csv。","slug":"关于pyspark-dataframe与pandas-dataframe的那些事","published":1,"updated":"2020-03-28T14:35:40.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckezigl6u000w1gp7roo6l0vi","content":"<div class=\"note info\"><p>pyspark.dataframe与pandas.dataframe大概目前机器学习算子中最长用到的数据结构了，本文来讲讲各自的常用操作和两者间相互转换。</p></div>\n<a id=\"more\"></a>\n<h2 id=\"pyspark\"><a href=\"#pyspark\" class=\"headerlink\" title=\"pyspark\"></a>pyspark</h2><ul>\n<li>创建spark-session</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pyspark.sql <span class=\"keyword\">import</span> SparkSession</span><br><span class=\"line\">session = (</span><br><span class=\"line\">    SparkSession.builder.appName(<span class=\"string\">\"spark_pyspark\"</span>)</span><br><span class=\"line\">        .config(<span class=\"string\">\"hive.metastore.uris\"</span>, <span class=\"string\">\"thrift://ip:9083\"</span>)</span><br><span class=\"line\">        .config(<span class=\"string\">\"spark.sql.warehouse.dir\"</span>, <span class=\"string\">\"/user/hive/warehouse\"</span>)</span><br><span class=\"line\">        .enableHiveSupport()</span><br><span class=\"line\">        .getOrCreate()</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>通过pyspark-sql进行数据查询、聚合、统计</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">df = session.sql(<span class=\"string\">\"select * from table_name\"</span>)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>dataframe数据落地保存</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 类似的常用的方法还有saveAsPickleFile</span><br><span class=\"line\">df.rdd.saveAsTextFile(<span class=\"string\">'/tmp/text_file'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">// 通过spark-sql</span><br><span class=\"line\">df.write.saveAsTable(output_table, <span class=\"keyword\">None</span>, <span class=\"string\">\"overwrite\"</span>, <span class=\"keyword\">None</span>)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>重新读取落地的文件</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// p类型为list</span><br><span class=\"line\">p = session.sparkContext.pickleFile(<span class=\"string\">'/tmp/pickle_file/part-00000'</span>).collect()</span><br></pre></td></tr></table></figure>\n<ul>\n<li>重新回到dataframe</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">df = session.createDataFrame(p)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>datafram实例化</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// csv to dataframe</span><br><span class=\"line\">// schema数据类型为 `<span class=\"keyword\">from</span> pyspark.sql.types <span class=\"keyword\">import</span> *`</span><br><span class=\"line\">df = (</span><br><span class=\"line\">    self.session.read.format(<span class=\"string\">\"com.databricks.spark.csv\"</span>)</span><br><span class=\"line\">    .options(</span><br><span class=\"line\">        header=<span class=\"keyword\">True</span>,</span><br><span class=\"line\">        schema=schema,</span><br><span class=\"line\">        encoding=encoding,</span><br><span class=\"line\">        delimiter=col_delimiter,</span><br><span class=\"line\">    )</span><br><span class=\"line\">    .load(uri) // uri 可以指定hdfs文件或者本地文件</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">// mysql to dataframe</span><br><span class=\"line\">df = (</span><br><span class=\"line\">    self.session.read.format(<span class=\"string\">\"jdbc\"</span>)</span><br><span class=\"line\">    .options(</span><br><span class=\"line\">        url=url,</span><br><span class=\"line\">        driver=<span class=\"string\">\"com.mysql.jdbc.Driver\"</span>,</span><br><span class=\"line\">        dbtable=db_table_name,</span><br><span class=\"line\">        user=user_name,</span><br><span class=\"line\">        password=password,</span><br><span class=\"line\">    )</span><br><span class=\"line\">    .load()</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>pyspark.dataframe to pandas.dataframe</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pdf = df.toPandas()</span><br></pre></td></tr></table></figure>\n<h2 id=\"pandas\"><a href=\"#pandas\" class=\"headerlink\" title=\"pandas\"></a>pandas</h2><ul>\n<li>pandas.dataframe 实例化</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> pandas <span class=\"keyword\">as</span> pd</span><br><span class=\"line\"></span><br><span class=\"line\">// csv to pdf</span><br><span class=\"line\">pdf = pd.read_csv(file_path)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>dataframe to csv</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pdf.to_csv(file_path, index=<span class=\"keyword\">False</span>)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>pandas.dataframe to pyspark.dataframe</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// session的声明方式见上文</span><br><span class=\"line\">df = session.createDataFrame(pdf)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>pdf to string</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s = pdf.to_string()</span><br></pre></td></tr></table></figure>\n<h2 id=\"复杂问题\"><a href=\"#复杂问题\" class=\"headerlink\" title=\"复杂问题\"></a>复杂问题</h2><h3 id=\"spark-dataframe如何实现多机同步\"><a href=\"#spark-dataframe如何实现多机同步\" class=\"headerlink\" title=\"spark.dataframe如何实现多机同步\"></a>spark.dataframe如何实现多机同步</h3><p>正常情况下通过<code>df.write</code>落hdfs(上层可能基于hive或者spark-sql)实现共享。<br>但若要跨集群共享就要另想办法了。<br>解决方案就是将落地数据单独传输：</p>\n<p>1、df -&gt; hdfs -&gt; local file -&gt; internet<br>2、df -&gt; pdf -&gt; byte or string -&gt; internet<br>显然第二种方法只需要落地一次，更优</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># spark df to pandas df</span></span><br><span class=\"line\">pdf = df.toPandas()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># pandas df to string</span></span><br><span class=\"line\">s = pdf.to_string()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># string to bytes</span></span><br><span class=\"line\">b = str.encode(s)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># send</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># bytes to pandas df</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> io <span class=\"keyword\">import</span> StringIO</span><br><span class=\"line\">s = str(bytes_data,<span class=\"string\">'utf-8'</span>)</span><br><span class=\"line\">// sep 必须要指定，非则将结构混乱</span><br><span class=\"line\">df = pd.read_csv(StringIO(s), sep=<span class=\"string\">\"\\s+\"</span>)</span><br></pre></td></tr></table></figure>\n<h3 id=\"pandas-dataframe数据精度问题\"><a href=\"#pandas-dataframe数据精度问题\" class=\"headerlink\" title=\"pandas.dataframe数据精度问题\"></a>pandas.dataframe数据精度问题</h3><p>当pandas.dataframe to_csv或者转为pysprk.dataframe时，会默认进行精度转换，<br>to_csv中提供了指定精度的参数，然而每列特征的精度本就可能不一致，所以最好还是完整保留当前的数据内容。<br>解决方案：<br>1、通过float_format指定最长有效数字，<code>g</code>不补零，<code>f</code>补零</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pdf.to_csv(file_path, index=<span class=\"keyword\">False</span>, float_format=<span class=\"string\">\"%.10g\"</span>)</span><br></pre></td></tr></table></figure>\n<p>2、使用<code>pdf.to_string</code>的方式，保存数据快照，然后手动进行数据转换为csv。</p>\n","site":{"data":{}},"excerpt":"<div class=\"note info\"><p>pyspark.dataframe与pandas.dataframe大概目前机器学习算子中最长用到的数据结构了，本文来讲讲各自的常用操作和两者间相互转换。</p></div>","more":"<h2 id=\"pyspark\"><a href=\"#pyspark\" class=\"headerlink\" title=\"pyspark\"></a>pyspark</h2><ul>\n<li>创建spark-session</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pyspark.sql <span class=\"keyword\">import</span> SparkSession</span><br><span class=\"line\">session = (</span><br><span class=\"line\">    SparkSession.builder.appName(<span class=\"string\">\"spark_pyspark\"</span>)</span><br><span class=\"line\">        .config(<span class=\"string\">\"hive.metastore.uris\"</span>, <span class=\"string\">\"thrift://ip:9083\"</span>)</span><br><span class=\"line\">        .config(<span class=\"string\">\"spark.sql.warehouse.dir\"</span>, <span class=\"string\">\"/user/hive/warehouse\"</span>)</span><br><span class=\"line\">        .enableHiveSupport()</span><br><span class=\"line\">        .getOrCreate()</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>通过pyspark-sql进行数据查询、聚合、统计</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">df = session.sql(<span class=\"string\">\"select * from table_name\"</span>)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>dataframe数据落地保存</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 类似的常用的方法还有saveAsPickleFile</span><br><span class=\"line\">df.rdd.saveAsTextFile(<span class=\"string\">'/tmp/text_file'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">// 通过spark-sql</span><br><span class=\"line\">df.write.saveAsTable(output_table, <span class=\"keyword\">None</span>, <span class=\"string\">\"overwrite\"</span>, <span class=\"keyword\">None</span>)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>重新读取落地的文件</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// p类型为list</span><br><span class=\"line\">p = session.sparkContext.pickleFile(<span class=\"string\">'/tmp/pickle_file/part-00000'</span>).collect()</span><br></pre></td></tr></table></figure>\n<ul>\n<li>重新回到dataframe</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">df = session.createDataFrame(p)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>datafram实例化</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// csv to dataframe</span><br><span class=\"line\">// schema数据类型为 `<span class=\"keyword\">from</span> pyspark.sql.types <span class=\"keyword\">import</span> *`</span><br><span class=\"line\">df = (</span><br><span class=\"line\">    self.session.read.format(<span class=\"string\">\"com.databricks.spark.csv\"</span>)</span><br><span class=\"line\">    .options(</span><br><span class=\"line\">        header=<span class=\"keyword\">True</span>,</span><br><span class=\"line\">        schema=schema,</span><br><span class=\"line\">        encoding=encoding,</span><br><span class=\"line\">        delimiter=col_delimiter,</span><br><span class=\"line\">    )</span><br><span class=\"line\">    .load(uri) // uri 可以指定hdfs文件或者本地文件</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">// mysql to dataframe</span><br><span class=\"line\">df = (</span><br><span class=\"line\">    self.session.read.format(<span class=\"string\">\"jdbc\"</span>)</span><br><span class=\"line\">    .options(</span><br><span class=\"line\">        url=url,</span><br><span class=\"line\">        driver=<span class=\"string\">\"com.mysql.jdbc.Driver\"</span>,</span><br><span class=\"line\">        dbtable=db_table_name,</span><br><span class=\"line\">        user=user_name,</span><br><span class=\"line\">        password=password,</span><br><span class=\"line\">    )</span><br><span class=\"line\">    .load()</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>pyspark.dataframe to pandas.dataframe</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pdf = df.toPandas()</span><br></pre></td></tr></table></figure>\n<h2 id=\"pandas\"><a href=\"#pandas\" class=\"headerlink\" title=\"pandas\"></a>pandas</h2><ul>\n<li>pandas.dataframe 实例化</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> pandas <span class=\"keyword\">as</span> pd</span><br><span class=\"line\"></span><br><span class=\"line\">// csv to pdf</span><br><span class=\"line\">pdf = pd.read_csv(file_path)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>dataframe to csv</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pdf.to_csv(file_path, index=<span class=\"keyword\">False</span>)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>pandas.dataframe to pyspark.dataframe</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// session的声明方式见上文</span><br><span class=\"line\">df = session.createDataFrame(pdf)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>pdf to string</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s = pdf.to_string()</span><br></pre></td></tr></table></figure>\n<h2 id=\"复杂问题\"><a href=\"#复杂问题\" class=\"headerlink\" title=\"复杂问题\"></a>复杂问题</h2><h3 id=\"spark-dataframe如何实现多机同步\"><a href=\"#spark-dataframe如何实现多机同步\" class=\"headerlink\" title=\"spark.dataframe如何实现多机同步\"></a>spark.dataframe如何实现多机同步</h3><p>正常情况下通过<code>df.write</code>落hdfs(上层可能基于hive或者spark-sql)实现共享。<br>但若要跨集群共享就要另想办法了。<br>解决方案就是将落地数据单独传输：</p>\n<p>1、df -&gt; hdfs -&gt; local file -&gt; internet<br>2、df -&gt; pdf -&gt; byte or string -&gt; internet<br>显然第二种方法只需要落地一次，更优</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># spark df to pandas df</span></span><br><span class=\"line\">pdf = df.toPandas()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># pandas df to string</span></span><br><span class=\"line\">s = pdf.to_string()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># string to bytes</span></span><br><span class=\"line\">b = str.encode(s)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># send</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># bytes to pandas df</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> io <span class=\"keyword\">import</span> StringIO</span><br><span class=\"line\">s = str(bytes_data,<span class=\"string\">'utf-8'</span>)</span><br><span class=\"line\">// sep 必须要指定，非则将结构混乱</span><br><span class=\"line\">df = pd.read_csv(StringIO(s), sep=<span class=\"string\">\"\\s+\"</span>)</span><br></pre></td></tr></table></figure>\n<h3 id=\"pandas-dataframe数据精度问题\"><a href=\"#pandas-dataframe数据精度问题\" class=\"headerlink\" title=\"pandas.dataframe数据精度问题\"></a>pandas.dataframe数据精度问题</h3><p>当pandas.dataframe to_csv或者转为pysprk.dataframe时，会默认进行精度转换，<br>to_csv中提供了指定精度的参数，然而每列特征的精度本就可能不一致，所以最好还是完整保留当前的数据内容。<br>解决方案：<br>1、通过float_format指定最长有效数字，<code>g</code>不补零，<code>f</code>补零</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pdf.to_csv(file_path, index=<span class=\"keyword\">False</span>, float_format=<span class=\"string\">\"%.10g\"</span>)</span><br></pre></td></tr></table></figure>\n<p>2、使用<code>pdf.to_string</code>的方式，保存数据快照，然后手动进行数据转换为csv。</p>"},{"title":"fabric使用总结","date":"2019-12-23T13:16:44.000Z","_content":"\n{%note info%}\nfabric可谓部署神器，在小规模集群环境部署方面简直就是`屠龙刀`的存在\n{%endnote%}\n<!--more-->\n\n## 简介\n\n- fabric目前存在两个版本，分别对应python2和python3\n- 本文主要介绍fabric两个版本的常用方法\n\n## fabric（python2）\n### 安装（python2环境）\n\n```python\npip install fabric\n```\n### 若要实现ssh跳转，需另外安装fexpect\n\n```python\npip install fexpect\n```\n### fabric2的API对应部署的对象定义比较明了\n- env（定义部署主机的ip，密码，节点属性，全局变量等）\n\t\n```python\ndef dev():\n    env.roledefs = {\n        \"manager\": [\"user@x.x.x.x:22\"],\n        \"worker\": [\"user@x.x.x.x:22\"],\n    }\n    env.passwords = {\"user@x.x.x.x:22\": \"123456\", \"user@x.x.x.x:22\": \"123456\"}\n    global ENV_PARAM\n    ENV_PARAM = \"dev\"\n```\n\n- roles\n    \n```python\n@roles(\"manager\")\ndef start_swarm(tag, compose_file=\"docker-compose.yml\"):\n    with cd(SRC_PATH):\n        with shell_env(ENV_PARAM = ENV_PARAM, TAG=tag):\n            run(\n                \"docker stack deploy --with-registry-auth -c deploy/swarm_deploy/{} {}\".format(  # noqa\n                    compose_file, PREFIX\n                )\n            )   \n```\n    \n   \n- run\n\n执行shell指令\n    \n- hide, settings \n\n配合使用，隐藏输出内容等\n        \n```python\nwith settings(hide(\"warnings\", \"running\", \"stdout\", \"stderr\"), warn_only=True):\n    \n```\n    \n    \n- cd，sudo\n\n同shell指令\n    \n- execute\n\n在本地任务中执行其他任务函数，提高代码复用率\n    \n- shell_env\n\n设置环境变量\n        \n```python\nwith shell_env(ASSET_CONFIG=ASSET_CONFIG, TAG=tag):\n    run(\n        \"docker stack deploy --with-registry-auth -c deploy/swarm_deploy/{} {}\".format(  # noqa\n            compose_file, PREFIX\n        )\n    )\n```\n    \n- 配合fexpect使用\n\n贴了段之前用过的代码，可用于修饰任务函数\n        \n```python\ndef env_init(f):\n    # 代码目录\n    global SRC_PATH\n    SRC_PATH = \"\"\n    # 私有镜像仓库\n    global REGISTRY_HOST\n    REGISTRY_HOST = \"\"\n    global REGISTRY_USER\n    REGISTRY_USER = \"\"\n    global REGISTRY_PWD\n    REGISTRY_PWD = \"\"\n    # 项目前缀\n    global PREFIX\n    PREFIX = \"asset\"\n    # 主节点ip\n    global MANAGER_IP, MANAGER_SSL, MANAGER_PWD\n    \n    def _get_manager_ip():\n        return env.roledefs[\"manager\"][0][6:-3]\n    \n    def _get_manager_ssl():\n        return env.roledefs[\"manager\"][0][:-3]\n    \n    # EXPECT\n    global PROMPTS\n    \n    @wraps(f)\n    def wrapper(*args, **kwargs):\n        global MANAGER_IP, MANAGER_SSL, MANAGER_PWD, PROMPTS\n        MANAGER_IP = _get_manager_ip()\n        MANAGER_SSL = _get_manager_ssl()\n        MANAGER_PWD = env.passwords[env.roledefs[\"manager\"][0]]\n        PROMPTS = expect(\n            \"Are you sure you want to continue connecting (yes/no)?\", \"yes\"\n        )\n        return f(*args, **kwargs)\n    \n    return wrapper  \n```\n---\n## fabric（python3）\n### 安装（python3环境）\n\n```python\npip install fabric\n```\n\n### fabirc3的API相较而言显的抽象简单\n- Connection 作为连接通道抽象\n\n```python\n# 连接本地\nlocal_conn = Connection('localhost')\n\n# 远程连接\n# 没了envAPI只能自己手动定义连接环境\nenvs = {\n    'remote': {\n        'host_name': 'xx',\n        'host': 'user@x.x.x.x:22',\n        'password': '123456',\n    },\n}\nconn = Connection(\n    env.get('host'),\n    connect_kwargs={'password': env.get('password')}\n)\n```\n\n- task 定义任务\n\n```python\n@task\ndef deploy(ctx, debug=True):\n    mvn_package(ctx)\n    send_jar_2_remote(ctx)\n    start_server(ctx, debug=debug)\n```\n通过`fab deploy`执行该任务，值得注意的是ctx这个变量必须要写\n指定传参`fab start-server --jar-timestamp=20191203-1637 debug=True`(让人琢磨尝试了半天)\n\n\n- 其他注意点\n\n对task任务函数使用装饰器，需要注意ctx的传入\n\n```python\ndef timeit(start_msg=None, end_msg=None):\n    def decorator(func):\n        @wraps(func)\n        def wrapper(ctx, *args, **kwargs):\n            if start_msg:\n                print(start_msg)\n            start = time.time()\n            res = func(ctx, *args, **kwargs)\n            if end_msg:\n                print(f'{end_msg}： {round((time.time() - start), 2)}s')\n            return res\n        return wrapper\n    return decorator\n```\n\n然而遗憾的是，在自定义装饰器的修饰下，再使用命令行传参将失效\n\n```python\n# 此时debug的将无法被解析\n@task\n@timeit(end_msg='发布完成')\ndef deploy(ctx, debug=True):\n    mvn_package(ctx)\n    send_jar_2_remote(ctx)\n    start_server(ctx, debug=debug)\n```\n\n究其原因，是invoke中使用的python2的inspect.getargspec，而python3中删除了对应函数，并且six对此并未兼容，从而导致参数解析失败\n\n```python\ndef argspec(self, body):\n    func = body if isinstance(body, types.FunctionType) else body.__call__\n    spec = inspect.getargspec(func)\n    arg_names = spec.args[:]\n    matched_args = [reversed(x) for x in [spec.args, spec.defaults or []]]\n    spec_dict = dict(zip_longest(*matched_args, fillvalue=NO_DEFAULT))\n    # Pop context argument\n    try:\n        context_arg = arg_names.pop(0)\n    except IndexError:\n        # TODO: see TODO under __call__, this should be same type\n        raise TypeError(\"Tasks must have an initial Context argument!\")\n    del spec_dict[context_arg]\n    return arg_names, spec_dict\n```\n\n## 总结\n- 综上，可以看出fabric3较fabric2而言基本是完败，使用过fabric2再迁移到fabric3是格外的别扭，由此不难理解网上对fabric3对使用教程基本上寥寥无几，即便存在大部分也只是对官网用例的简单翻译，谈不上工业级的使用\n- fabric3是面向程序编程而非面向human编程\n- 无奈于python2终将被淘汰，还是对fabric3保留一些些期待吧\n","source":"_posts/2019-12-23-fabric使用总结.md","raw":"---\ntitle: fabric使用总结\ndate: 2019-12-23 21:16:44\ntags: \n- 部署\ncategories:\n---\n\n{%note info%}\nfabric可谓部署神器，在小规模集群环境部署方面简直就是`屠龙刀`的存在\n{%endnote%}\n<!--more-->\n\n## 简介\n\n- fabric目前存在两个版本，分别对应python2和python3\n- 本文主要介绍fabric两个版本的常用方法\n\n## fabric（python2）\n### 安装（python2环境）\n\n```python\npip install fabric\n```\n### 若要实现ssh跳转，需另外安装fexpect\n\n```python\npip install fexpect\n```\n### fabric2的API对应部署的对象定义比较明了\n- env（定义部署主机的ip，密码，节点属性，全局变量等）\n\t\n```python\ndef dev():\n    env.roledefs = {\n        \"manager\": [\"user@x.x.x.x:22\"],\n        \"worker\": [\"user@x.x.x.x:22\"],\n    }\n    env.passwords = {\"user@x.x.x.x:22\": \"123456\", \"user@x.x.x.x:22\": \"123456\"}\n    global ENV_PARAM\n    ENV_PARAM = \"dev\"\n```\n\n- roles\n    \n```python\n@roles(\"manager\")\ndef start_swarm(tag, compose_file=\"docker-compose.yml\"):\n    with cd(SRC_PATH):\n        with shell_env(ENV_PARAM = ENV_PARAM, TAG=tag):\n            run(\n                \"docker stack deploy --with-registry-auth -c deploy/swarm_deploy/{} {}\".format(  # noqa\n                    compose_file, PREFIX\n                )\n            )   \n```\n    \n   \n- run\n\n执行shell指令\n    \n- hide, settings \n\n配合使用，隐藏输出内容等\n        \n```python\nwith settings(hide(\"warnings\", \"running\", \"stdout\", \"stderr\"), warn_only=True):\n    \n```\n    \n    \n- cd，sudo\n\n同shell指令\n    \n- execute\n\n在本地任务中执行其他任务函数，提高代码复用率\n    \n- shell_env\n\n设置环境变量\n        \n```python\nwith shell_env(ASSET_CONFIG=ASSET_CONFIG, TAG=tag):\n    run(\n        \"docker stack deploy --with-registry-auth -c deploy/swarm_deploy/{} {}\".format(  # noqa\n            compose_file, PREFIX\n        )\n    )\n```\n    \n- 配合fexpect使用\n\n贴了段之前用过的代码，可用于修饰任务函数\n        \n```python\ndef env_init(f):\n    # 代码目录\n    global SRC_PATH\n    SRC_PATH = \"\"\n    # 私有镜像仓库\n    global REGISTRY_HOST\n    REGISTRY_HOST = \"\"\n    global REGISTRY_USER\n    REGISTRY_USER = \"\"\n    global REGISTRY_PWD\n    REGISTRY_PWD = \"\"\n    # 项目前缀\n    global PREFIX\n    PREFIX = \"asset\"\n    # 主节点ip\n    global MANAGER_IP, MANAGER_SSL, MANAGER_PWD\n    \n    def _get_manager_ip():\n        return env.roledefs[\"manager\"][0][6:-3]\n    \n    def _get_manager_ssl():\n        return env.roledefs[\"manager\"][0][:-3]\n    \n    # EXPECT\n    global PROMPTS\n    \n    @wraps(f)\n    def wrapper(*args, **kwargs):\n        global MANAGER_IP, MANAGER_SSL, MANAGER_PWD, PROMPTS\n        MANAGER_IP = _get_manager_ip()\n        MANAGER_SSL = _get_manager_ssl()\n        MANAGER_PWD = env.passwords[env.roledefs[\"manager\"][0]]\n        PROMPTS = expect(\n            \"Are you sure you want to continue connecting (yes/no)?\", \"yes\"\n        )\n        return f(*args, **kwargs)\n    \n    return wrapper  \n```\n---\n## fabric（python3）\n### 安装（python3环境）\n\n```python\npip install fabric\n```\n\n### fabirc3的API相较而言显的抽象简单\n- Connection 作为连接通道抽象\n\n```python\n# 连接本地\nlocal_conn = Connection('localhost')\n\n# 远程连接\n# 没了envAPI只能自己手动定义连接环境\nenvs = {\n    'remote': {\n        'host_name': 'xx',\n        'host': 'user@x.x.x.x:22',\n        'password': '123456',\n    },\n}\nconn = Connection(\n    env.get('host'),\n    connect_kwargs={'password': env.get('password')}\n)\n```\n\n- task 定义任务\n\n```python\n@task\ndef deploy(ctx, debug=True):\n    mvn_package(ctx)\n    send_jar_2_remote(ctx)\n    start_server(ctx, debug=debug)\n```\n通过`fab deploy`执行该任务，值得注意的是ctx这个变量必须要写\n指定传参`fab start-server --jar-timestamp=20191203-1637 debug=True`(让人琢磨尝试了半天)\n\n\n- 其他注意点\n\n对task任务函数使用装饰器，需要注意ctx的传入\n\n```python\ndef timeit(start_msg=None, end_msg=None):\n    def decorator(func):\n        @wraps(func)\n        def wrapper(ctx, *args, **kwargs):\n            if start_msg:\n                print(start_msg)\n            start = time.time()\n            res = func(ctx, *args, **kwargs)\n            if end_msg:\n                print(f'{end_msg}： {round((time.time() - start), 2)}s')\n            return res\n        return wrapper\n    return decorator\n```\n\n然而遗憾的是，在自定义装饰器的修饰下，再使用命令行传参将失效\n\n```python\n# 此时debug的将无法被解析\n@task\n@timeit(end_msg='发布完成')\ndef deploy(ctx, debug=True):\n    mvn_package(ctx)\n    send_jar_2_remote(ctx)\n    start_server(ctx, debug=debug)\n```\n\n究其原因，是invoke中使用的python2的inspect.getargspec，而python3中删除了对应函数，并且six对此并未兼容，从而导致参数解析失败\n\n```python\ndef argspec(self, body):\n    func = body if isinstance(body, types.FunctionType) else body.__call__\n    spec = inspect.getargspec(func)\n    arg_names = spec.args[:]\n    matched_args = [reversed(x) for x in [spec.args, spec.defaults or []]]\n    spec_dict = dict(zip_longest(*matched_args, fillvalue=NO_DEFAULT))\n    # Pop context argument\n    try:\n        context_arg = arg_names.pop(0)\n    except IndexError:\n        # TODO: see TODO under __call__, this should be same type\n        raise TypeError(\"Tasks must have an initial Context argument!\")\n    del spec_dict[context_arg]\n    return arg_names, spec_dict\n```\n\n## 总结\n- 综上，可以看出fabric3较fabric2而言基本是完败，使用过fabric2再迁移到fabric3是格外的别扭，由此不难理解网上对fabric3对使用教程基本上寥寥无几，即便存在大部分也只是对官网用例的简单翻译，谈不上工业级的使用\n- fabric3是面向程序编程而非面向human编程\n- 无奈于python2终将被淘汰，还是对fabric3保留一些些期待吧\n","slug":"fabric使用总结","published":1,"updated":"2020-03-28T14:35:40.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckezigl6x000y1gp7zx4l86s5","content":"<div class=\"note info\"><p>fabric可谓部署神器，在小规模集群环境部署方面简直就是<code>屠龙刀</code>的存在</p></div>\n<a id=\"more\"></a>\n<h2 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h2><ul>\n<li>fabric目前存在两个版本，分别对应python2和python3</li>\n<li>本文主要介绍fabric两个版本的常用方法</li>\n</ul>\n<h2 id=\"fabric（python2）\"><a href=\"#fabric（python2）\" class=\"headerlink\" title=\"fabric（python2）\"></a>fabric（python2）</h2><h3 id=\"安装（python2环境）\"><a href=\"#安装（python2环境）\" class=\"headerlink\" title=\"安装（python2环境）\"></a>安装（python2环境）</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install fabric</span><br></pre></td></tr></table></figure>\n<h3 id=\"若要实现ssh跳转，需另外安装fexpect\"><a href=\"#若要实现ssh跳转，需另外安装fexpect\" class=\"headerlink\" title=\"若要实现ssh跳转，需另外安装fexpect\"></a>若要实现ssh跳转，需另外安装fexpect</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install fexpect</span><br></pre></td></tr></table></figure>\n<h3 id=\"fabric2的API对应部署的对象定义比较明了\"><a href=\"#fabric2的API对应部署的对象定义比较明了\" class=\"headerlink\" title=\"fabric2的API对应部署的对象定义比较明了\"></a>fabric2的API对应部署的对象定义比较明了</h3><ul>\n<li>env（定义部署主机的ip，密码，节点属性，全局变量等）</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">dev</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    env.roledefs = &#123;</span><br><span class=\"line\">        <span class=\"string\">\"manager\"</span>: [<span class=\"string\">\"user@x.x.x.x:22\"</span>],</span><br><span class=\"line\">        <span class=\"string\">\"worker\"</span>: [<span class=\"string\">\"user@x.x.x.x:22\"</span>],</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    env.passwords = &#123;<span class=\"string\">\"user@x.x.x.x:22\"</span>: <span class=\"string\">\"123456\"</span>, <span class=\"string\">\"user@x.x.x.x:22\"</span>: <span class=\"string\">\"123456\"</span>&#125;</span><br><span class=\"line\">    <span class=\"keyword\">global</span> ENV_PARAM</span><br><span class=\"line\">    ENV_PARAM = <span class=\"string\">\"dev\"</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>roles</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@roles(\"manager\")</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">start_swarm</span><span class=\"params\">(tag, compose_file=<span class=\"string\">\"docker-compose.yml\"</span>)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">with</span> cd(SRC_PATH):</span><br><span class=\"line\">        <span class=\"keyword\">with</span> shell_env(ENV_PARAM = ENV_PARAM, TAG=tag):</span><br><span class=\"line\">            run(</span><br><span class=\"line\">                <span class=\"string\">\"docker stack deploy --with-registry-auth -c deploy/swarm_deploy/&#123;&#125; &#123;&#125;\"</span>.format(  <span class=\"comment\"># noqa</span></span><br><span class=\"line\">                    compose_file, PREFIX</span><br><span class=\"line\">                )</span><br><span class=\"line\">            )</span><br></pre></td></tr></table></figure>\n<ul>\n<li>run</li>\n</ul>\n<p>执行shell指令</p>\n<ul>\n<li>hide, settings </li>\n</ul>\n<p>配合使用，隐藏输出内容等</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">with</span> settings(hide(<span class=\"string\">\"warnings\"</span>, <span class=\"string\">\"running\"</span>, <span class=\"string\">\"stdout\"</span>, <span class=\"string\">\"stderr\"</span>), warn_only=<span class=\"keyword\">True</span>):</span><br></pre></td></tr></table></figure>\n<ul>\n<li>cd，sudo</li>\n</ul>\n<p>同shell指令</p>\n<ul>\n<li>execute</li>\n</ul>\n<p>在本地任务中执行其他任务函数，提高代码复用率</p>\n<ul>\n<li>shell_env</li>\n</ul>\n<p>设置环境变量</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">with</span> shell_env(ASSET_CONFIG=ASSET_CONFIG, TAG=tag):</span><br><span class=\"line\">    run(</span><br><span class=\"line\">        <span class=\"string\">\"docker stack deploy --with-registry-auth -c deploy/swarm_deploy/&#123;&#125; &#123;&#125;\"</span>.format(  <span class=\"comment\"># noqa</span></span><br><span class=\"line\">            compose_file, PREFIX</span><br><span class=\"line\">        )</span><br><span class=\"line\">    )</span><br></pre></td></tr></table></figure>\n<ul>\n<li>配合fexpect使用</li>\n</ul>\n<p>贴了段之前用过的代码，可用于修饰任务函数</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">env_init</span><span class=\"params\">(f)</span>:</span></span><br><span class=\"line\">    <span class=\"comment\"># 代码目录</span></span><br><span class=\"line\">    <span class=\"keyword\">global</span> SRC_PATH</span><br><span class=\"line\">    SRC_PATH = <span class=\"string\">\"\"</span></span><br><span class=\"line\">    <span class=\"comment\"># 私有镜像仓库</span></span><br><span class=\"line\">    <span class=\"keyword\">global</span> REGISTRY_HOST</span><br><span class=\"line\">    REGISTRY_HOST = <span class=\"string\">\"\"</span></span><br><span class=\"line\">    <span class=\"keyword\">global</span> REGISTRY_USER</span><br><span class=\"line\">    REGISTRY_USER = <span class=\"string\">\"\"</span></span><br><span class=\"line\">    <span class=\"keyword\">global</span> REGISTRY_PWD</span><br><span class=\"line\">    REGISTRY_PWD = <span class=\"string\">\"\"</span></span><br><span class=\"line\">    <span class=\"comment\"># 项目前缀</span></span><br><span class=\"line\">    <span class=\"keyword\">global</span> PREFIX</span><br><span class=\"line\">    PREFIX = <span class=\"string\">\"asset\"</span></span><br><span class=\"line\">    <span class=\"comment\"># 主节点ip</span></span><br><span class=\"line\">    <span class=\"keyword\">global</span> MANAGER_IP, MANAGER_SSL, MANAGER_PWD</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">_get_manager_ip</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> env.roledefs[<span class=\"string\">\"manager\"</span>][<span class=\"number\">0</span>][<span class=\"number\">6</span>:<span class=\"number\">-3</span>]</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">_get_manager_ssl</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> env.roledefs[<span class=\"string\">\"manager\"</span>][<span class=\"number\">0</span>][:<span class=\"number\">-3</span>]</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\"># EXPECT</span></span><br><span class=\"line\">    <span class=\"keyword\">global</span> PROMPTS</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"meta\">    @wraps(f)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">wrapper</span><span class=\"params\">(*args, **kwargs)</span>:</span></span><br><span class=\"line\">        <span class=\"keyword\">global</span> MANAGER_IP, MANAGER_SSL, MANAGER_PWD, PROMPTS</span><br><span class=\"line\">        MANAGER_IP = _get_manager_ip()</span><br><span class=\"line\">        MANAGER_SSL = _get_manager_ssl()</span><br><span class=\"line\">        MANAGER_PWD = env.passwords[env.roledefs[<span class=\"string\">\"manager\"</span>][<span class=\"number\">0</span>]]</span><br><span class=\"line\">        PROMPTS = expect(</span><br><span class=\"line\">            <span class=\"string\">\"Are you sure you want to continue connecting (yes/no)?\"</span>, <span class=\"string\">\"yes\"</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">        <span class=\"keyword\">return</span> f(*args, **kwargs)</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">return</span> wrapper</span><br></pre></td></tr></table></figure>\n<hr>\n<h2 id=\"fabric（python3）\"><a href=\"#fabric（python3）\" class=\"headerlink\" title=\"fabric（python3）\"></a>fabric（python3）</h2><h3 id=\"安装（python3环境）\"><a href=\"#安装（python3环境）\" class=\"headerlink\" title=\"安装（python3环境）\"></a>安装（python3环境）</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install fabric</span><br></pre></td></tr></table></figure>\n<h3 id=\"fabirc3的API相较而言显的抽象简单\"><a href=\"#fabirc3的API相较而言显的抽象简单\" class=\"headerlink\" title=\"fabirc3的API相较而言显的抽象简单\"></a>fabirc3的API相较而言显的抽象简单</h3><ul>\n<li>Connection 作为连接通道抽象</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 连接本地</span></span><br><span class=\"line\">local_conn = Connection(<span class=\"string\">'localhost'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 远程连接</span></span><br><span class=\"line\"><span class=\"comment\"># 没了envAPI只能自己手动定义连接环境</span></span><br><span class=\"line\">envs = &#123;</span><br><span class=\"line\">    <span class=\"string\">'remote'</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">'host_name'</span>: <span class=\"string\">'xx'</span>,</span><br><span class=\"line\">        <span class=\"string\">'host'</span>: <span class=\"string\">'user@x.x.x.x:22'</span>,</span><br><span class=\"line\">        <span class=\"string\">'password'</span>: <span class=\"string\">'123456'</span>,</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">conn = Connection(</span><br><span class=\"line\">    env.get(<span class=\"string\">'host'</span>),</span><br><span class=\"line\">    connect_kwargs=&#123;<span class=\"string\">'password'</span>: env.get(<span class=\"string\">'password'</span>)&#125;</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>task 定义任务</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@task</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">deploy</span><span class=\"params\">(ctx, debug=True)</span>:</span></span><br><span class=\"line\">    mvn_package(ctx)</span><br><span class=\"line\">    send_jar_2_remote(ctx)</span><br><span class=\"line\">    start_server(ctx, debug=debug)</span><br></pre></td></tr></table></figure>\n<p>通过<code>fab deploy</code>执行该任务，值得注意的是ctx这个变量必须要写<br>指定传参<code>fab start-server --jar-timestamp=20191203-1637 debug=True</code>(让人琢磨尝试了半天)</p>\n<ul>\n<li>其他注意点</li>\n</ul>\n<p>对task任务函数使用装饰器，需要注意ctx的传入</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">timeit</span><span class=\"params\">(start_msg=None, end_msg=None)</span>:</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">decorator</span><span class=\"params\">(func)</span>:</span></span><br><span class=\"line\"><span class=\"meta\">        @wraps(func)</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">wrapper</span><span class=\"params\">(ctx, *args, **kwargs)</span>:</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> start_msg:</span><br><span class=\"line\">                print(start_msg)</span><br><span class=\"line\">            start = time.time()</span><br><span class=\"line\">            res = func(ctx, *args, **kwargs)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> end_msg:</span><br><span class=\"line\">                print(<span class=\"string\">f'<span class=\"subst\">&#123;end_msg&#125;</span>： <span class=\"subst\">&#123;round((time.time() - start), <span class=\"number\">2</span>)&#125;</span>s'</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> res</span><br><span class=\"line\">        <span class=\"keyword\">return</span> wrapper</span><br><span class=\"line\">    <span class=\"keyword\">return</span> decorator</span><br></pre></td></tr></table></figure>\n<p>然而遗憾的是，在自定义装饰器的修饰下，再使用命令行传参将失效</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 此时debug的将无法被解析</span></span><br><span class=\"line\"><span class=\"meta\">@task</span></span><br><span class=\"line\"><span class=\"meta\">@timeit(end_msg='发布完成')</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">deploy</span><span class=\"params\">(ctx, debug=True)</span>:</span></span><br><span class=\"line\">    mvn_package(ctx)</span><br><span class=\"line\">    send_jar_2_remote(ctx)</span><br><span class=\"line\">    start_server(ctx, debug=debug)</span><br></pre></td></tr></table></figure>\n<p>究其原因，是invoke中使用的python2的inspect.getargspec，而python3中删除了对应函数，并且six对此并未兼容，从而导致参数解析失败</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">argspec</span><span class=\"params\">(self, body)</span>:</span></span><br><span class=\"line\">    func = body <span class=\"keyword\">if</span> isinstance(body, types.FunctionType) <span class=\"keyword\">else</span> body.__call__</span><br><span class=\"line\">    spec = inspect.getargspec(func)</span><br><span class=\"line\">    arg_names = spec.args[:]</span><br><span class=\"line\">    matched_args = [reversed(x) <span class=\"keyword\">for</span> x <span class=\"keyword\">in</span> [spec.args, spec.defaults <span class=\"keyword\">or</span> []]]</span><br><span class=\"line\">    spec_dict = dict(zip_longest(*matched_args, fillvalue=NO_DEFAULT))</span><br><span class=\"line\">    <span class=\"comment\"># Pop context argument</span></span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        context_arg = arg_names.pop(<span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"keyword\">except</span> IndexError:</span><br><span class=\"line\">        <span class=\"comment\"># <span class=\"doctag\">TODO:</span> see TODO under __call__, this should be same type</span></span><br><span class=\"line\">        <span class=\"keyword\">raise</span> TypeError(<span class=\"string\">\"Tasks must have an initial Context argument!\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">del</span> spec_dict[context_arg]</span><br><span class=\"line\">    <span class=\"keyword\">return</span> arg_names, spec_dict</span><br></pre></td></tr></table></figure>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><ul>\n<li>综上，可以看出fabric3较fabric2而言基本是完败，使用过fabric2再迁移到fabric3是格外的别扭，由此不难理解网上对fabric3对使用教程基本上寥寥无几，即便存在大部分也只是对官网用例的简单翻译，谈不上工业级的使用</li>\n<li>fabric3是面向程序编程而非面向human编程</li>\n<li>无奈于python2终将被淘汰，还是对fabric3保留一些些期待吧</li>\n</ul>\n","site":{"data":{}},"excerpt":"<div class=\"note info\"><p>fabric可谓部署神器，在小规模集群环境部署方面简直就是<code>屠龙刀</code>的存在</p></div>","more":"<h2 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h2><ul>\n<li>fabric目前存在两个版本，分别对应python2和python3</li>\n<li>本文主要介绍fabric两个版本的常用方法</li>\n</ul>\n<h2 id=\"fabric（python2）\"><a href=\"#fabric（python2）\" class=\"headerlink\" title=\"fabric（python2）\"></a>fabric（python2）</h2><h3 id=\"安装（python2环境）\"><a href=\"#安装（python2环境）\" class=\"headerlink\" title=\"安装（python2环境）\"></a>安装（python2环境）</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install fabric</span><br></pre></td></tr></table></figure>\n<h3 id=\"若要实现ssh跳转，需另外安装fexpect\"><a href=\"#若要实现ssh跳转，需另外安装fexpect\" class=\"headerlink\" title=\"若要实现ssh跳转，需另外安装fexpect\"></a>若要实现ssh跳转，需另外安装fexpect</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install fexpect</span><br></pre></td></tr></table></figure>\n<h3 id=\"fabric2的API对应部署的对象定义比较明了\"><a href=\"#fabric2的API对应部署的对象定义比较明了\" class=\"headerlink\" title=\"fabric2的API对应部署的对象定义比较明了\"></a>fabric2的API对应部署的对象定义比较明了</h3><ul>\n<li>env（定义部署主机的ip，密码，节点属性，全局变量等）</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">dev</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    env.roledefs = &#123;</span><br><span class=\"line\">        <span class=\"string\">\"manager\"</span>: [<span class=\"string\">\"user@x.x.x.x:22\"</span>],</span><br><span class=\"line\">        <span class=\"string\">\"worker\"</span>: [<span class=\"string\">\"user@x.x.x.x:22\"</span>],</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    env.passwords = &#123;<span class=\"string\">\"user@x.x.x.x:22\"</span>: <span class=\"string\">\"123456\"</span>, <span class=\"string\">\"user@x.x.x.x:22\"</span>: <span class=\"string\">\"123456\"</span>&#125;</span><br><span class=\"line\">    <span class=\"keyword\">global</span> ENV_PARAM</span><br><span class=\"line\">    ENV_PARAM = <span class=\"string\">\"dev\"</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>roles</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@roles(\"manager\")</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">start_swarm</span><span class=\"params\">(tag, compose_file=<span class=\"string\">\"docker-compose.yml\"</span>)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">with</span> cd(SRC_PATH):</span><br><span class=\"line\">        <span class=\"keyword\">with</span> shell_env(ENV_PARAM = ENV_PARAM, TAG=tag):</span><br><span class=\"line\">            run(</span><br><span class=\"line\">                <span class=\"string\">\"docker stack deploy --with-registry-auth -c deploy/swarm_deploy/&#123;&#125; &#123;&#125;\"</span>.format(  <span class=\"comment\"># noqa</span></span><br><span class=\"line\">                    compose_file, PREFIX</span><br><span class=\"line\">                )</span><br><span class=\"line\">            )</span><br></pre></td></tr></table></figure>\n<ul>\n<li>run</li>\n</ul>\n<p>执行shell指令</p>\n<ul>\n<li>hide, settings </li>\n</ul>\n<p>配合使用，隐藏输出内容等</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">with</span> settings(hide(<span class=\"string\">\"warnings\"</span>, <span class=\"string\">\"running\"</span>, <span class=\"string\">\"stdout\"</span>, <span class=\"string\">\"stderr\"</span>), warn_only=<span class=\"keyword\">True</span>):</span><br></pre></td></tr></table></figure>\n<ul>\n<li>cd，sudo</li>\n</ul>\n<p>同shell指令</p>\n<ul>\n<li>execute</li>\n</ul>\n<p>在本地任务中执行其他任务函数，提高代码复用率</p>\n<ul>\n<li>shell_env</li>\n</ul>\n<p>设置环境变量</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">with</span> shell_env(ASSET_CONFIG=ASSET_CONFIG, TAG=tag):</span><br><span class=\"line\">    run(</span><br><span class=\"line\">        <span class=\"string\">\"docker stack deploy --with-registry-auth -c deploy/swarm_deploy/&#123;&#125; &#123;&#125;\"</span>.format(  <span class=\"comment\"># noqa</span></span><br><span class=\"line\">            compose_file, PREFIX</span><br><span class=\"line\">        )</span><br><span class=\"line\">    )</span><br></pre></td></tr></table></figure>\n<ul>\n<li>配合fexpect使用</li>\n</ul>\n<p>贴了段之前用过的代码，可用于修饰任务函数</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">env_init</span><span class=\"params\">(f)</span>:</span></span><br><span class=\"line\">    <span class=\"comment\"># 代码目录</span></span><br><span class=\"line\">    <span class=\"keyword\">global</span> SRC_PATH</span><br><span class=\"line\">    SRC_PATH = <span class=\"string\">\"\"</span></span><br><span class=\"line\">    <span class=\"comment\"># 私有镜像仓库</span></span><br><span class=\"line\">    <span class=\"keyword\">global</span> REGISTRY_HOST</span><br><span class=\"line\">    REGISTRY_HOST = <span class=\"string\">\"\"</span></span><br><span class=\"line\">    <span class=\"keyword\">global</span> REGISTRY_USER</span><br><span class=\"line\">    REGISTRY_USER = <span class=\"string\">\"\"</span></span><br><span class=\"line\">    <span class=\"keyword\">global</span> REGISTRY_PWD</span><br><span class=\"line\">    REGISTRY_PWD = <span class=\"string\">\"\"</span></span><br><span class=\"line\">    <span class=\"comment\"># 项目前缀</span></span><br><span class=\"line\">    <span class=\"keyword\">global</span> PREFIX</span><br><span class=\"line\">    PREFIX = <span class=\"string\">\"asset\"</span></span><br><span class=\"line\">    <span class=\"comment\"># 主节点ip</span></span><br><span class=\"line\">    <span class=\"keyword\">global</span> MANAGER_IP, MANAGER_SSL, MANAGER_PWD</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">_get_manager_ip</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> env.roledefs[<span class=\"string\">\"manager\"</span>][<span class=\"number\">0</span>][<span class=\"number\">6</span>:<span class=\"number\">-3</span>]</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">_get_manager_ssl</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> env.roledefs[<span class=\"string\">\"manager\"</span>][<span class=\"number\">0</span>][:<span class=\"number\">-3</span>]</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\"># EXPECT</span></span><br><span class=\"line\">    <span class=\"keyword\">global</span> PROMPTS</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"meta\">    @wraps(f)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">wrapper</span><span class=\"params\">(*args, **kwargs)</span>:</span></span><br><span class=\"line\">        <span class=\"keyword\">global</span> MANAGER_IP, MANAGER_SSL, MANAGER_PWD, PROMPTS</span><br><span class=\"line\">        MANAGER_IP = _get_manager_ip()</span><br><span class=\"line\">        MANAGER_SSL = _get_manager_ssl()</span><br><span class=\"line\">        MANAGER_PWD = env.passwords[env.roledefs[<span class=\"string\">\"manager\"</span>][<span class=\"number\">0</span>]]</span><br><span class=\"line\">        PROMPTS = expect(</span><br><span class=\"line\">            <span class=\"string\">\"Are you sure you want to continue connecting (yes/no)?\"</span>, <span class=\"string\">\"yes\"</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">        <span class=\"keyword\">return</span> f(*args, **kwargs)</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">return</span> wrapper</span><br></pre></td></tr></table></figure>\n<hr>\n<h2 id=\"fabric（python3）\"><a href=\"#fabric（python3）\" class=\"headerlink\" title=\"fabric（python3）\"></a>fabric（python3）</h2><h3 id=\"安装（python3环境）\"><a href=\"#安装（python3环境）\" class=\"headerlink\" title=\"安装（python3环境）\"></a>安装（python3环境）</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install fabric</span><br></pre></td></tr></table></figure>\n<h3 id=\"fabirc3的API相较而言显的抽象简单\"><a href=\"#fabirc3的API相较而言显的抽象简单\" class=\"headerlink\" title=\"fabirc3的API相较而言显的抽象简单\"></a>fabirc3的API相较而言显的抽象简单</h3><ul>\n<li>Connection 作为连接通道抽象</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 连接本地</span></span><br><span class=\"line\">local_conn = Connection(<span class=\"string\">'localhost'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 远程连接</span></span><br><span class=\"line\"><span class=\"comment\"># 没了envAPI只能自己手动定义连接环境</span></span><br><span class=\"line\">envs = &#123;</span><br><span class=\"line\">    <span class=\"string\">'remote'</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">'host_name'</span>: <span class=\"string\">'xx'</span>,</span><br><span class=\"line\">        <span class=\"string\">'host'</span>: <span class=\"string\">'user@x.x.x.x:22'</span>,</span><br><span class=\"line\">        <span class=\"string\">'password'</span>: <span class=\"string\">'123456'</span>,</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">conn = Connection(</span><br><span class=\"line\">    env.get(<span class=\"string\">'host'</span>),</span><br><span class=\"line\">    connect_kwargs=&#123;<span class=\"string\">'password'</span>: env.get(<span class=\"string\">'password'</span>)&#125;</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>task 定义任务</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@task</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">deploy</span><span class=\"params\">(ctx, debug=True)</span>:</span></span><br><span class=\"line\">    mvn_package(ctx)</span><br><span class=\"line\">    send_jar_2_remote(ctx)</span><br><span class=\"line\">    start_server(ctx, debug=debug)</span><br></pre></td></tr></table></figure>\n<p>通过<code>fab deploy</code>执行该任务，值得注意的是ctx这个变量必须要写<br>指定传参<code>fab start-server --jar-timestamp=20191203-1637 debug=True</code>(让人琢磨尝试了半天)</p>\n<ul>\n<li>其他注意点</li>\n</ul>\n<p>对task任务函数使用装饰器，需要注意ctx的传入</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">timeit</span><span class=\"params\">(start_msg=None, end_msg=None)</span>:</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">decorator</span><span class=\"params\">(func)</span>:</span></span><br><span class=\"line\"><span class=\"meta\">        @wraps(func)</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">wrapper</span><span class=\"params\">(ctx, *args, **kwargs)</span>:</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> start_msg:</span><br><span class=\"line\">                print(start_msg)</span><br><span class=\"line\">            start = time.time()</span><br><span class=\"line\">            res = func(ctx, *args, **kwargs)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> end_msg:</span><br><span class=\"line\">                print(<span class=\"string\">f'<span class=\"subst\">&#123;end_msg&#125;</span>： <span class=\"subst\">&#123;round((time.time() - start), <span class=\"number\">2</span>)&#125;</span>s'</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> res</span><br><span class=\"line\">        <span class=\"keyword\">return</span> wrapper</span><br><span class=\"line\">    <span class=\"keyword\">return</span> decorator</span><br></pre></td></tr></table></figure>\n<p>然而遗憾的是，在自定义装饰器的修饰下，再使用命令行传参将失效</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 此时debug的将无法被解析</span></span><br><span class=\"line\"><span class=\"meta\">@task</span></span><br><span class=\"line\"><span class=\"meta\">@timeit(end_msg='发布完成')</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">deploy</span><span class=\"params\">(ctx, debug=True)</span>:</span></span><br><span class=\"line\">    mvn_package(ctx)</span><br><span class=\"line\">    send_jar_2_remote(ctx)</span><br><span class=\"line\">    start_server(ctx, debug=debug)</span><br></pre></td></tr></table></figure>\n<p>究其原因，是invoke中使用的python2的inspect.getargspec，而python3中删除了对应函数，并且six对此并未兼容，从而导致参数解析失败</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">argspec</span><span class=\"params\">(self, body)</span>:</span></span><br><span class=\"line\">    func = body <span class=\"keyword\">if</span> isinstance(body, types.FunctionType) <span class=\"keyword\">else</span> body.__call__</span><br><span class=\"line\">    spec = inspect.getargspec(func)</span><br><span class=\"line\">    arg_names = spec.args[:]</span><br><span class=\"line\">    matched_args = [reversed(x) <span class=\"keyword\">for</span> x <span class=\"keyword\">in</span> [spec.args, spec.defaults <span class=\"keyword\">or</span> []]]</span><br><span class=\"line\">    spec_dict = dict(zip_longest(*matched_args, fillvalue=NO_DEFAULT))</span><br><span class=\"line\">    <span class=\"comment\"># Pop context argument</span></span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        context_arg = arg_names.pop(<span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"keyword\">except</span> IndexError:</span><br><span class=\"line\">        <span class=\"comment\"># <span class=\"doctag\">TODO:</span> see TODO under __call__, this should be same type</span></span><br><span class=\"line\">        <span class=\"keyword\">raise</span> TypeError(<span class=\"string\">\"Tasks must have an initial Context argument!\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">del</span> spec_dict[context_arg]</span><br><span class=\"line\">    <span class=\"keyword\">return</span> arg_names, spec_dict</span><br></pre></td></tr></table></figure>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><ul>\n<li>综上，可以看出fabric3较fabric2而言基本是完败，使用过fabric2再迁移到fabric3是格外的别扭，由此不难理解网上对fabric3对使用教程基本上寥寥无几，即便存在大部分也只是对官网用例的简单翻译，谈不上工业级的使用</li>\n<li>fabric3是面向程序编程而非面向human编程</li>\n<li>无奈于python2终将被淘汰，还是对fabric3保留一些些期待吧</li>\n</ul>"},{"title":"兼职运维之ulimit","date":"2019-12-27T13:09:45.000Z","_content":"\n\n{%note info%}\n今天部署生产环境遇到了坑，本文聊聊这个坑的上下文。\n{%endnote%}\n<!--more-->\n\n## 现象&定位\n- 部署完成后，收到测试人员反馈业务运行异常\n- 排查后，定位为livy向spark提交任务时执行失败\nlivy日志如下：\n![spark异常.jpg](https://i.loli.net/2019/12/27/tVroEwZsClS9b54.jpg)\n\n- 初看有点懵，将关键字`spark`和`OpenBLAS blas_thread_init`提交google，结果大多匹配python运行时相关异常，\n![spark异常google.jpg](https://i.loli.net/2019/12/27/4rdolfctzh18ZCE.jpg)\n\n- 仔细看不难发现`RLIMIT_NPROC 4096 current, 514476 max`\n- 由此自然联想到`ulimit -u`，一查发现果然只有4096\n\n## 解决方案\n- 解决方案也简单，设置系统最大允许进程数\n\n**永久生效：**\n\n```\n/etc/security/limits.d/90-nproc.conf\n或\n/etc/security/limits.conf\n在末行加入\n* hard nproc 1000000\n* soft nproc 1000000\n\n```\n**当前session生效：**\n\n```\nulimit -u 1000000\n```\n- 重新测试，问题果然修复\n\n\n## 总结\n- 问题事后看并不复杂，但前前后后还是花了不少时间，其实之前ulimit也不是没学习过，但真正出现异常时，往往没有看透问题的本质\n- 该生产环境主机时刚部署的，毕竟兼职运维，像ulimit此类系统资源的设置没有统一的整体设置过，吃一堑长一智，兼职运维的路上且走且学吧\n","source":"_posts/2019-12-27-兼职运维之ulimit-u.md","raw":"---\ntitle: 兼职运维之ulimit\ndate: 2019-12-27 21:09:45\ntags:\n- 兼职运维\ncategories:\n- linux\n---\n\n\n{%note info%}\n今天部署生产环境遇到了坑，本文聊聊这个坑的上下文。\n{%endnote%}\n<!--more-->\n\n## 现象&定位\n- 部署完成后，收到测试人员反馈业务运行异常\n- 排查后，定位为livy向spark提交任务时执行失败\nlivy日志如下：\n![spark异常.jpg](https://i.loli.net/2019/12/27/tVroEwZsClS9b54.jpg)\n\n- 初看有点懵，将关键字`spark`和`OpenBLAS blas_thread_init`提交google，结果大多匹配python运行时相关异常，\n![spark异常google.jpg](https://i.loli.net/2019/12/27/4rdolfctzh18ZCE.jpg)\n\n- 仔细看不难发现`RLIMIT_NPROC 4096 current, 514476 max`\n- 由此自然联想到`ulimit -u`，一查发现果然只有4096\n\n## 解决方案\n- 解决方案也简单，设置系统最大允许进程数\n\n**永久生效：**\n\n```\n/etc/security/limits.d/90-nproc.conf\n或\n/etc/security/limits.conf\n在末行加入\n* hard nproc 1000000\n* soft nproc 1000000\n\n```\n**当前session生效：**\n\n```\nulimit -u 1000000\n```\n- 重新测试，问题果然修复\n\n\n## 总结\n- 问题事后看并不复杂，但前前后后还是花了不少时间，其实之前ulimit也不是没学习过，但真正出现异常时，往往没有看透问题的本质\n- 该生产环境主机时刚部署的，毕竟兼职运维，像ulimit此类系统资源的设置没有统一的整体设置过，吃一堑长一智，兼职运维的路上且走且学吧\n","slug":"兼职运维之ulimit-u","published":1,"updated":"2020-03-28T14:35:40.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckezigl7600111gp7ld6u6kfy","content":"<div class=\"note info\"><p>今天部署生产环境遇到了坑，本文聊聊这个坑的上下文。</p></div>\n<a id=\"more\"></a>\n<h2 id=\"现象-amp-定位\"><a href=\"#现象-amp-定位\" class=\"headerlink\" title=\"现象&amp;定位\"></a>现象&amp;定位</h2><ul>\n<li>部署完成后，收到测试人员反馈业务运行异常</li>\n<li><p>排查后，定位为livy向spark提交任务时执行失败<br>livy日志如下：<br><img src=\"https://i.loli.net/2019/12/27/tVroEwZsClS9b54.jpg\" alt=\"spark异常.jpg\"></p>\n</li>\n<li><p>初看有点懵，将关键字<code>spark</code>和<code>OpenBLAS blas_thread_init</code>提交google，结果大多匹配python运行时相关异常，<br><img src=\"https://i.loli.net/2019/12/27/4rdolfctzh18ZCE.jpg\" alt=\"spark异常google.jpg\"></p>\n</li>\n<li><p>仔细看不难发现<code>RLIMIT_NPROC 4096 current, 514476 max</code></p>\n</li>\n<li>由此自然联想到<code>ulimit -u</code>，一查发现果然只有4096</li>\n</ul>\n<h2 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h2><ul>\n<li>解决方案也简单，设置系统最大允许进程数</li>\n</ul>\n<p><strong>永久生效：</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/etc/security/limits.d/90-nproc.conf</span><br><span class=\"line\">或</span><br><span class=\"line\">/etc/security/limits.conf</span><br><span class=\"line\">在末行加入</span><br><span class=\"line\">* hard nproc 1000000</span><br><span class=\"line\">* soft nproc 1000000</span><br></pre></td></tr></table></figure>\n<p><strong>当前session生效：</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ulimit -u 1000000</span><br></pre></td></tr></table></figure>\n<ul>\n<li>重新测试，问题果然修复</li>\n</ul>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><ul>\n<li>问题事后看并不复杂，但前前后后还是花了不少时间，其实之前ulimit也不是没学习过，但真正出现异常时，往往没有看透问题的本质</li>\n<li>该生产环境主机时刚部署的，毕竟兼职运维，像ulimit此类系统资源的设置没有统一的整体设置过，吃一堑长一智，兼职运维的路上且走且学吧</li>\n</ul>\n","site":{"data":{}},"excerpt":"<div class=\"note info\"><p>今天部署生产环境遇到了坑，本文聊聊这个坑的上下文。</p></div>","more":"<h2 id=\"现象-amp-定位\"><a href=\"#现象-amp-定位\" class=\"headerlink\" title=\"现象&amp;定位\"></a>现象&amp;定位</h2><ul>\n<li>部署完成后，收到测试人员反馈业务运行异常</li>\n<li><p>排查后，定位为livy向spark提交任务时执行失败<br>livy日志如下：<br><img src=\"https://i.loli.net/2019/12/27/tVroEwZsClS9b54.jpg\" alt=\"spark异常.jpg\"></p>\n</li>\n<li><p>初看有点懵，将关键字<code>spark</code>和<code>OpenBLAS blas_thread_init</code>提交google，结果大多匹配python运行时相关异常，<br><img src=\"https://i.loli.net/2019/12/27/4rdolfctzh18ZCE.jpg\" alt=\"spark异常google.jpg\"></p>\n</li>\n<li><p>仔细看不难发现<code>RLIMIT_NPROC 4096 current, 514476 max</code></p>\n</li>\n<li>由此自然联想到<code>ulimit -u</code>，一查发现果然只有4096</li>\n</ul>\n<h2 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h2><ul>\n<li>解决方案也简单，设置系统最大允许进程数</li>\n</ul>\n<p><strong>永久生效：</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/etc/security/limits.d/90-nproc.conf</span><br><span class=\"line\">或</span><br><span class=\"line\">/etc/security/limits.conf</span><br><span class=\"line\">在末行加入</span><br><span class=\"line\">* hard nproc 1000000</span><br><span class=\"line\">* soft nproc 1000000</span><br></pre></td></tr></table></figure>\n<p><strong>当前session生效：</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ulimit -u 1000000</span><br></pre></td></tr></table></figure>\n<ul>\n<li>重新测试，问题果然修复</li>\n</ul>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><ul>\n<li>问题事后看并不复杂，但前前后后还是花了不少时间，其实之前ulimit也不是没学习过，但真正出现异常时，往往没有看透问题的本质</li>\n<li>该生产环境主机时刚部署的，毕竟兼职运维，像ulimit此类系统资源的设置没有统一的整体设置过，吃一堑长一智，兼职运维的路上且走且学吧</li>\n</ul>"},{"title":"python-pandas.to_csv的使用记录","date":"2020-03-31T11:46:42.000Z","_content":"{%note info%}\n记录下pandas.to_csv函数使用的坑。\n{%endnote%}\n<!--more-->\n\n- 本想聊聊事情起因，经过，结果，奈何手懒，直接记录下结果吧\n- 问题：\n    - 1、pandas读取csv，再to_string，再转回pandas.dataframe，再保存为csv\n    - 2、pandas读取csv，再保存为csv\n    - 1，2保存的数据结果不一致\n- 样本数据：\n\n```\n# sample.csv\na,b,c,d,e,f\n11.0,22.0,1.0,2.0,3.0,4.0\n22.0,33.0,1.0,2.0,3.0,4.0\n33.0,33.0,1.0,2.0,3.0,4.0\n44.0,33.0,1.0,2.0,3.0,4.0\n55.0,33.0,1.0,2.0,3.0,4.0\n66.0,33.0,1.0,2.0,3.0,4.0\n77.0,33.0,1.0,2.0,3.0,4.0\n88.0,33.0,1.0,2.0,3.0,4.0\n```\n- 涉及的代码也简单，如下：\n\n```python\nfrom io import StringIO\n\nimport pandas as pd\n\n\n# 1\npdf = pd.read_csv('sample.csv', sep='\\s+')\npdf.to_csv('/tmp/sample2.csv', index=0, float_format='%.10g')\n\n# 2\npdf2 = pd.read_csv(StringIO(pdf.to_string()), sep='\\s+')\npdf2.to_csv('/tmp/sample2.csv', index=0, float_format='%.10g')\n\n```\n\n- 1的保存结果：\n\n```\n11.0,22.0,1.0,2.0,3.0,4.0\n22.0,33.0,1.0,2.0,3.0,4.0\n33.0,33.0,1.0,2.0,3.0,4.0\n44.0,33.0,1.0,2.0,3.0,4.0\n55.0,33.0,1.0,2.0,3.0,4.0\n66.0,33.0,1.0,2.0,3.0,4.0\n77.0,33.0,1.0,2.0,3.0,4.0\n88.0,33.0,1.0,2.0,3.0,4.0\n```\n\n- 2的保存结果：\n\n```\n11,22,1,2,3,4\n22,33,1,2,3,4\n33,33,1,2,3,4\n44,33,1,2,3,4\n55,33,1,2,3,4\n66,33,1,2,3,4\n77,33,1,2,3,4\n88,33,1,2,3,4\n```\n\n- 解决方案：\n```python\n# 去除float_format='%.10g'\npdf2.to_csv('/tmp/sample2.csv', index=0)\n```","source":"_posts/2020-03-31-python-pandas-to-csv的使用记录.md","raw":"---\ntitle: python-pandas.to_csv的使用记录\ndate: 2020-03-31 19:46:42\ntags:\n- pandas\ncategories:\n- python\n---\n{%note info%}\n记录下pandas.to_csv函数使用的坑。\n{%endnote%}\n<!--more-->\n\n- 本想聊聊事情起因，经过，结果，奈何手懒，直接记录下结果吧\n- 问题：\n    - 1、pandas读取csv，再to_string，再转回pandas.dataframe，再保存为csv\n    - 2、pandas读取csv，再保存为csv\n    - 1，2保存的数据结果不一致\n- 样本数据：\n\n```\n# sample.csv\na,b,c,d,e,f\n11.0,22.0,1.0,2.0,3.0,4.0\n22.0,33.0,1.0,2.0,3.0,4.0\n33.0,33.0,1.0,2.0,3.0,4.0\n44.0,33.0,1.0,2.0,3.0,4.0\n55.0,33.0,1.0,2.0,3.0,4.0\n66.0,33.0,1.0,2.0,3.0,4.0\n77.0,33.0,1.0,2.0,3.0,4.0\n88.0,33.0,1.0,2.0,3.0,4.0\n```\n- 涉及的代码也简单，如下：\n\n```python\nfrom io import StringIO\n\nimport pandas as pd\n\n\n# 1\npdf = pd.read_csv('sample.csv', sep='\\s+')\npdf.to_csv('/tmp/sample2.csv', index=0, float_format='%.10g')\n\n# 2\npdf2 = pd.read_csv(StringIO(pdf.to_string()), sep='\\s+')\npdf2.to_csv('/tmp/sample2.csv', index=0, float_format='%.10g')\n\n```\n\n- 1的保存结果：\n\n```\n11.0,22.0,1.0,2.0,3.0,4.0\n22.0,33.0,1.0,2.0,3.0,4.0\n33.0,33.0,1.0,2.0,3.0,4.0\n44.0,33.0,1.0,2.0,3.0,4.0\n55.0,33.0,1.0,2.0,3.0,4.0\n66.0,33.0,1.0,2.0,3.0,4.0\n77.0,33.0,1.0,2.0,3.0,4.0\n88.0,33.0,1.0,2.0,3.0,4.0\n```\n\n- 2的保存结果：\n\n```\n11,22,1,2,3,4\n22,33,1,2,3,4\n33,33,1,2,3,4\n44,33,1,2,3,4\n55,33,1,2,3,4\n66,33,1,2,3,4\n77,33,1,2,3,4\n88,33,1,2,3,4\n```\n\n- 解决方案：\n```python\n# 去除float_format='%.10g'\npdf2.to_csv('/tmp/sample2.csv', index=0)\n```","slug":"python-pandas-to-csv的使用记录","published":1,"updated":"2020-03-31T12:41:05.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckezigl7a00151gp7zph2vlt5","content":"<div class=\"note info\"><p>记录下pandas.to_csv函数使用的坑。</p></div>\n<a id=\"more\"></a>\n<ul>\n<li>本想聊聊事情起因，经过，结果，奈何手懒，直接记录下结果吧</li>\n<li>问题：<ul>\n<li>1、pandas读取csv，再to_string，再转回pandas.dataframe，再保存为csv</li>\n<li>2、pandas读取csv，再保存为csv</li>\n<li>1，2保存的数据结果不一致</li>\n</ul>\n</li>\n<li>样本数据：</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># sample.csv</span><br><span class=\"line\">a,b,c,d,e,f</span><br><span class=\"line\">11.0,22.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">22.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">33.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">44.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">55.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">66.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">77.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">88.0,33.0,1.0,2.0,3.0,4.0</span><br></pre></td></tr></table></figure>\n<ul>\n<li>涉及的代码也简单，如下：</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> io <span class=\"keyword\">import</span> StringIO</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> pandas <span class=\"keyword\">as</span> pd</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 1</span></span><br><span class=\"line\">pdf = pd.read_csv(<span class=\"string\">'sample.csv'</span>, sep=<span class=\"string\">'\\s+'</span>)</span><br><span class=\"line\">pdf.to_csv(<span class=\"string\">'/tmp/sample2.csv'</span>, index=<span class=\"number\">0</span>, float_format=<span class=\"string\">'%.10g'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2</span></span><br><span class=\"line\">pdf2 = pd.read_csv(StringIO(pdf.to_string()), sep=<span class=\"string\">'\\s+'</span>)</span><br><span class=\"line\">pdf2.to_csv(<span class=\"string\">'/tmp/sample2.csv'</span>, index=<span class=\"number\">0</span>, float_format=<span class=\"string\">'%.10g'</span>)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>1的保存结果：</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">11.0,22.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">22.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">33.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">44.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">55.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">66.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">77.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">88.0,33.0,1.0,2.0,3.0,4.0</span><br></pre></td></tr></table></figure>\n<ul>\n<li>2的保存结果：</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">11,22,1,2,3,4</span><br><span class=\"line\">22,33,1,2,3,4</span><br><span class=\"line\">33,33,1,2,3,4</span><br><span class=\"line\">44,33,1,2,3,4</span><br><span class=\"line\">55,33,1,2,3,4</span><br><span class=\"line\">66,33,1,2,3,4</span><br><span class=\"line\">77,33,1,2,3,4</span><br><span class=\"line\">88,33,1,2,3,4</span><br></pre></td></tr></table></figure>\n<ul>\n<li>解决方案：<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 去除float_format='%.10g'</span></span><br><span class=\"line\">pdf2.to_csv(<span class=\"string\">'/tmp/sample2.csv'</span>, index=<span class=\"number\">0</span>)</span><br></pre></td></tr></table></figure></li>\n</ul>\n","site":{"data":{}},"excerpt":"<div class=\"note info\"><p>记录下pandas.to_csv函数使用的坑。</p></div>","more":"<ul>\n<li>本想聊聊事情起因，经过，结果，奈何手懒，直接记录下结果吧</li>\n<li>问题：<ul>\n<li>1、pandas读取csv，再to_string，再转回pandas.dataframe，再保存为csv</li>\n<li>2、pandas读取csv，再保存为csv</li>\n<li>1，2保存的数据结果不一致</li>\n</ul>\n</li>\n<li>样本数据：</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># sample.csv</span><br><span class=\"line\">a,b,c,d,e,f</span><br><span class=\"line\">11.0,22.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">22.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">33.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">44.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">55.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">66.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">77.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">88.0,33.0,1.0,2.0,3.0,4.0</span><br></pre></td></tr></table></figure>\n<ul>\n<li>涉及的代码也简单，如下：</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> io <span class=\"keyword\">import</span> StringIO</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> pandas <span class=\"keyword\">as</span> pd</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 1</span></span><br><span class=\"line\">pdf = pd.read_csv(<span class=\"string\">'sample.csv'</span>, sep=<span class=\"string\">'\\s+'</span>)</span><br><span class=\"line\">pdf.to_csv(<span class=\"string\">'/tmp/sample2.csv'</span>, index=<span class=\"number\">0</span>, float_format=<span class=\"string\">'%.10g'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2</span></span><br><span class=\"line\">pdf2 = pd.read_csv(StringIO(pdf.to_string()), sep=<span class=\"string\">'\\s+'</span>)</span><br><span class=\"line\">pdf2.to_csv(<span class=\"string\">'/tmp/sample2.csv'</span>, index=<span class=\"number\">0</span>, float_format=<span class=\"string\">'%.10g'</span>)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>1的保存结果：</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">11.0,22.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">22.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">33.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">44.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">55.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">66.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">77.0,33.0,1.0,2.0,3.0,4.0</span><br><span class=\"line\">88.0,33.0,1.0,2.0,3.0,4.0</span><br></pre></td></tr></table></figure>\n<ul>\n<li>2的保存结果：</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">11,22,1,2,3,4</span><br><span class=\"line\">22,33,1,2,3,4</span><br><span class=\"line\">33,33,1,2,3,4</span><br><span class=\"line\">44,33,1,2,3,4</span><br><span class=\"line\">55,33,1,2,3,4</span><br><span class=\"line\">66,33,1,2,3,4</span><br><span class=\"line\">77,33,1,2,3,4</span><br><span class=\"line\">88,33,1,2,3,4</span><br></pre></td></tr></table></figure>\n<ul>\n<li>解决方案：<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 去除float_format='%.10g'</span></span><br><span class=\"line\">pdf2.to_csv(<span class=\"string\">'/tmp/sample2.csv'</span>, index=<span class=\"number\">0</span>)</span><br></pre></td></tr></table></figure></li>\n</ul>"},{"title":"设计模式学习总结","date":"2020-09-12T10:11:36.000Z","_content":"\n{%note info%}\n落下的都得补上。\n{%endnote%}\n<!--more-->\n\n\n\n- 一张总结图起手\n\n  ![20200908194129.jpg](https://i.loli.net/2020/09/08/z8xwGEeyLJdBZ71.jpg)\n\n## 相似的设计模式对比\n\n- 工厂模式 && 建造者模式\n  - 工厂模式是用来创建不同但是相关类型的对象（继承同一父类或者接口的一组子类），由给定的参数来决定创建哪种类型的对象\n  - 建造者模式是用来创建一种类型的复杂对象，可以通过设置不同的可选参数，“定制化”地创建不同的对象\n  - 比喻\n    - 工厂模式：土豆，面粉，番茄\n    - 建造者模式：披萨\n- 策略模式  && 命令模式\n  - 在策略模式中，不同的策略具有相同的目的、不同的实现、互相之间可以替换。比如，BubbleSort、SelectionSort 都是为了实现排序的，只不过一个是用冒泡排序算法来实现的，另一个是用选择排序算法来实现的。而在命令模式中，不同的命令具有不同的目的，对应不同的处理逻辑，并且互相之间不可替换\n- 单例模式  && 享元模式  && 缓存  && 静态工厂方法\n  - 他们的共同点是:对象的复用\n  - 不同点:\n    - 应用享元模式是为了对象\"共享使用\"，节省内存\n    - 而应用单例/多例模式是为了限制对象的个数\n    - 应用缓存是为了提高访问效率\n    - 应用对象池(数据库连接池,线程池)是为了对象的\"重复使用\"和管理,主要是为了节省时间\n    - 有一种方法叫 静态工厂方法,例如 Boolean.valueof(),不会在每次调用时返回一个新对象,而是复用已有的,这一点有点像享元模式\n\n- 适配器  && 代理 && 装饰器 && 桥接,:\n  - 他们的共同点是:对方法的增强\n  - 不同点:\n    - 适配器模式的作用是\"适配\",通常用于适配不同的组件,新旧系统\n    - 桥接模式将接口部分和实现部分分离,使两者可以分别扩展\n    - 装饰者模式是对原始类功能进行增强，并且可以支持多次,多种增强\n    - 代理模式实现了代理类和原始类的解耦,使代理类可以用于增强不同的功能\n\n- 策略模式 && 简单工厂模式 && 命令模式:\n  - 共同点:都有对if/else进行下沉\n  - 不同点:\n    - 策略模式根据运行时状态返回一个\"策略\"/\"算法\",这些\"策略\"具有相同目的,比如BubbleSort、SelectionSort 都是为了实现排序\n    - 命令模式中不同的命令具有不同的目的，对应不同的处理逻辑，并且互相之间不可替换\n    - 而简单工厂更侧重返回一个创建的对象\n\n\n- 中介模式  &&  观察者模式\n\n  - 在观察者模式中，尽管一个参与者既可以是观察者，同时也可以是被观察者，但是，大部分情况下，交互关系往往都是单向的，一个参与者要么是观察者，要么是被观察者，不会兼具两种身份。也就是说，在观察者模式的应用场景中，参与者之间的交互关系比较有条理\n  - 而中介模式正好相反。只有当参与者之间的交互关系错综复杂，维护成本很高的时候，我们才考虑使用中介模式。毕竟，中介模式的应用会带来一定的副作用，前面也讲到，它有可能会产生大而复杂的上帝类。除此之外，如果一个参与者状态的改变，其他参与者执行的操作有一定先后顺序的要求，这个时候，中介模式就可以利用中介类，通过先后调用不同参与者的方法，来实现顺序的控制，而观察者模式是无法实现这样的顺序要求的\n\n- 享元模式  &&  单例  && 缓存 && 对象池\n\n  - 享元模式跟单例\n    - 在单例模式中，一个类只能创建一个对象，而在享元模式中，一个类可以创建多个对象，每个对象被多处代码引用共享。实际上，享元模式有点类似于之前讲到的单例的变体：==多例==\n    - 尽管从代码实现上来看，享元模式和多例有很多相似之处，但从设计意图上来看，它们是完全不同的。应用享元模式是为了对象复用，节省内存，而应用多例模式是为了限制对象的个数\n  - 享元模式跟缓存\n    - 享元的“缓存”实际上是“存储”的意思\n    - 通常意义上的缓存，主要是为了提高访问效率，而非复用\n  - 享元模式跟对象池\n    - 对象池、连接池、线程池等池化技术中的“复用”和享元模式中的“复用”实际上是不同的概念\n    - 池化技术中的“复用”可以理解为“重复使用”，主要目的是节省时间，在任意时刻，每一个对象、连接、线程，并不会被多处使用，而是被一个使用者独占，当使用完成之后，放回到池中，再由其他使用者重复利用\n  - 享元模式中的“复用”可以理解为“共享使用”，在整个生命周期中，都是被所有使用者共享的，主要目的是节省空间\n\n- 模板模式  &&  回调\n\n  - 从应用场景上来看，同步回调跟模板模式几乎一致。它们都是在一个大的算法骨架中，自由替换其中的某个步骤，起到代码复用和扩展的目的。而异步回调跟模板模式有较大差别，更像是观察者模式\n\n  - 从代码实现上来看，回调和模板模式完全不同。回调基于组合关系来实现，把一个对象传递给另一个对象，是一种对象之间的关系；模板模式基于继承关系来实现，子类重写父类的抽象方法，是一种类之间的关系\n\n  - 回调相对于模板模式会更加灵活\n\n    - 像 Java 这种只支持单继承的语言，基于模板模式编写的子类，已经继承了一个父类，不再具有继承的能力\n    - 回调可以使用匿名类来创建回调对象，可以不用事先定义类；而模板模式针对不同的实现都要定义不同的子类\n    - 如果某个类中定义了多个模板方法，每个方法都有对应的抽象方法，那即便我们只用到其中的一个模板方法，子类也必须实现所有的抽象方法。而回调就更加灵活，我们只需要往用到的模板方法中注入回调对象即可\n\n    \n\n## 总结\n\n- 实际上，每个设计模式都应该由两部分组成：第一部分是应用场景，即这个模式可以解决哪类问题；第二部分是解决方案，即这个模式的设计思路和具体的代码实现。不过，代码实现并不是模式必须包含的。如果你单纯地只关注解决方案这一部分，甚至只关注代码实现，就会产生大部分模式看起来都很相似的错觉\n- 实际上，==设计模式之间的主要区别还是在于设计意图==，也就是应用场景。单纯地看设计思路或者代码实现，有些模式确实很相似，比如策略模式和工厂模式","source":"_posts/2020-09-12-设计模式学习总结.md","raw":"---\ntitle: 设计模式学习总结\ndate: 2020-09-12 18:11:36\ntags:\ncategories: 设计模式\n---\n\n{%note info%}\n落下的都得补上。\n{%endnote%}\n<!--more-->\n\n\n\n- 一张总结图起手\n\n  ![20200908194129.jpg](https://i.loli.net/2020/09/08/z8xwGEeyLJdBZ71.jpg)\n\n## 相似的设计模式对比\n\n- 工厂模式 && 建造者模式\n  - 工厂模式是用来创建不同但是相关类型的对象（继承同一父类或者接口的一组子类），由给定的参数来决定创建哪种类型的对象\n  - 建造者模式是用来创建一种类型的复杂对象，可以通过设置不同的可选参数，“定制化”地创建不同的对象\n  - 比喻\n    - 工厂模式：土豆，面粉，番茄\n    - 建造者模式：披萨\n- 策略模式  && 命令模式\n  - 在策略模式中，不同的策略具有相同的目的、不同的实现、互相之间可以替换。比如，BubbleSort、SelectionSort 都是为了实现排序的，只不过一个是用冒泡排序算法来实现的，另一个是用选择排序算法来实现的。而在命令模式中，不同的命令具有不同的目的，对应不同的处理逻辑，并且互相之间不可替换\n- 单例模式  && 享元模式  && 缓存  && 静态工厂方法\n  - 他们的共同点是:对象的复用\n  - 不同点:\n    - 应用享元模式是为了对象\"共享使用\"，节省内存\n    - 而应用单例/多例模式是为了限制对象的个数\n    - 应用缓存是为了提高访问效率\n    - 应用对象池(数据库连接池,线程池)是为了对象的\"重复使用\"和管理,主要是为了节省时间\n    - 有一种方法叫 静态工厂方法,例如 Boolean.valueof(),不会在每次调用时返回一个新对象,而是复用已有的,这一点有点像享元模式\n\n- 适配器  && 代理 && 装饰器 && 桥接,:\n  - 他们的共同点是:对方法的增强\n  - 不同点:\n    - 适配器模式的作用是\"适配\",通常用于适配不同的组件,新旧系统\n    - 桥接模式将接口部分和实现部分分离,使两者可以分别扩展\n    - 装饰者模式是对原始类功能进行增强，并且可以支持多次,多种增强\n    - 代理模式实现了代理类和原始类的解耦,使代理类可以用于增强不同的功能\n\n- 策略模式 && 简单工厂模式 && 命令模式:\n  - 共同点:都有对if/else进行下沉\n  - 不同点:\n    - 策略模式根据运行时状态返回一个\"策略\"/\"算法\",这些\"策略\"具有相同目的,比如BubbleSort、SelectionSort 都是为了实现排序\n    - 命令模式中不同的命令具有不同的目的，对应不同的处理逻辑，并且互相之间不可替换\n    - 而简单工厂更侧重返回一个创建的对象\n\n\n- 中介模式  &&  观察者模式\n\n  - 在观察者模式中，尽管一个参与者既可以是观察者，同时也可以是被观察者，但是，大部分情况下，交互关系往往都是单向的，一个参与者要么是观察者，要么是被观察者，不会兼具两种身份。也就是说，在观察者模式的应用场景中，参与者之间的交互关系比较有条理\n  - 而中介模式正好相反。只有当参与者之间的交互关系错综复杂，维护成本很高的时候，我们才考虑使用中介模式。毕竟，中介模式的应用会带来一定的副作用，前面也讲到，它有可能会产生大而复杂的上帝类。除此之外，如果一个参与者状态的改变，其他参与者执行的操作有一定先后顺序的要求，这个时候，中介模式就可以利用中介类，通过先后调用不同参与者的方法，来实现顺序的控制，而观察者模式是无法实现这样的顺序要求的\n\n- 享元模式  &&  单例  && 缓存 && 对象池\n\n  - 享元模式跟单例\n    - 在单例模式中，一个类只能创建一个对象，而在享元模式中，一个类可以创建多个对象，每个对象被多处代码引用共享。实际上，享元模式有点类似于之前讲到的单例的变体：==多例==\n    - 尽管从代码实现上来看，享元模式和多例有很多相似之处，但从设计意图上来看，它们是完全不同的。应用享元模式是为了对象复用，节省内存，而应用多例模式是为了限制对象的个数\n  - 享元模式跟缓存\n    - 享元的“缓存”实际上是“存储”的意思\n    - 通常意义上的缓存，主要是为了提高访问效率，而非复用\n  - 享元模式跟对象池\n    - 对象池、连接池、线程池等池化技术中的“复用”和享元模式中的“复用”实际上是不同的概念\n    - 池化技术中的“复用”可以理解为“重复使用”，主要目的是节省时间，在任意时刻，每一个对象、连接、线程，并不会被多处使用，而是被一个使用者独占，当使用完成之后，放回到池中，再由其他使用者重复利用\n  - 享元模式中的“复用”可以理解为“共享使用”，在整个生命周期中，都是被所有使用者共享的，主要目的是节省空间\n\n- 模板模式  &&  回调\n\n  - 从应用场景上来看，同步回调跟模板模式几乎一致。它们都是在一个大的算法骨架中，自由替换其中的某个步骤，起到代码复用和扩展的目的。而异步回调跟模板模式有较大差别，更像是观察者模式\n\n  - 从代码实现上来看，回调和模板模式完全不同。回调基于组合关系来实现，把一个对象传递给另一个对象，是一种对象之间的关系；模板模式基于继承关系来实现，子类重写父类的抽象方法，是一种类之间的关系\n\n  - 回调相对于模板模式会更加灵活\n\n    - 像 Java 这种只支持单继承的语言，基于模板模式编写的子类，已经继承了一个父类，不再具有继承的能力\n    - 回调可以使用匿名类来创建回调对象，可以不用事先定义类；而模板模式针对不同的实现都要定义不同的子类\n    - 如果某个类中定义了多个模板方法，每个方法都有对应的抽象方法，那即便我们只用到其中的一个模板方法，子类也必须实现所有的抽象方法。而回调就更加灵活，我们只需要往用到的模板方法中注入回调对象即可\n\n    \n\n## 总结\n\n- 实际上，每个设计模式都应该由两部分组成：第一部分是应用场景，即这个模式可以解决哪类问题；第二部分是解决方案，即这个模式的设计思路和具体的代码实现。不过，代码实现并不是模式必须包含的。如果你单纯地只关注解决方案这一部分，甚至只关注代码实现，就会产生大部分模式看起来都很相似的错觉\n- 实际上，==设计模式之间的主要区别还是在于设计意图==，也就是应用场景。单纯地看设计思路或者代码实现，有些模式确实很相似，比如策略模式和工厂模式","slug":"设计模式学习总结","published":1,"updated":"2020-09-12T10:12:08.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckezigl7d00171gp79twqcr62","content":"<div class=\"note info\"><p>落下的都得补上。</p></div>\n<a id=\"more\"></a>\n<ul>\n<li><p>一张总结图起手</p>\n<p><img src=\"https://i.loli.net/2020/09/08/z8xwGEeyLJdBZ71.jpg\" alt=\"20200908194129.jpg\"></p>\n</li>\n</ul>\n<h2 id=\"相似的设计模式对比\"><a href=\"#相似的设计模式对比\" class=\"headerlink\" title=\"相似的设计模式对比\"></a>相似的设计模式对比</h2><ul>\n<li>工厂模式 &amp;&amp; 建造者模式<ul>\n<li>工厂模式是用来创建不同但是相关类型的对象（继承同一父类或者接口的一组子类），由给定的参数来决定创建哪种类型的对象</li>\n<li>建造者模式是用来创建一种类型的复杂对象，可以通过设置不同的可选参数，“定制化”地创建不同的对象</li>\n<li>比喻<ul>\n<li>工厂模式：土豆，面粉，番茄</li>\n<li>建造者模式：披萨</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>策略模式  &amp;&amp; 命令模式<ul>\n<li>在策略模式中，不同的策略具有相同的目的、不同的实现、互相之间可以替换。比如，BubbleSort、SelectionSort 都是为了实现排序的，只不过一个是用冒泡排序算法来实现的，另一个是用选择排序算法来实现的。而在命令模式中，不同的命令具有不同的目的，对应不同的处理逻辑，并且互相之间不可替换</li>\n</ul>\n</li>\n<li><p>单例模式  &amp;&amp; 享元模式  &amp;&amp; 缓存  &amp;&amp; 静态工厂方法</p>\n<ul>\n<li>他们的共同点是:对象的复用</li>\n<li>不同点:<ul>\n<li>应用享元模式是为了对象”共享使用”，节省内存</li>\n<li>而应用单例/多例模式是为了限制对象的个数</li>\n<li>应用缓存是为了提高访问效率</li>\n<li>应用对象池(数据库连接池,线程池)是为了对象的”重复使用”和管理,主要是为了节省时间</li>\n<li>有一种方法叫 静态工厂方法,例如 Boolean.valueof(),不会在每次调用时返回一个新对象,而是复用已有的,这一点有点像享元模式</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>适配器  &amp;&amp; 代理 &amp;&amp; 装饰器 &amp;&amp; 桥接,:</p>\n<ul>\n<li>他们的共同点是:对方法的增强</li>\n<li>不同点:<ul>\n<li>适配器模式的作用是”适配”,通常用于适配不同的组件,新旧系统</li>\n<li>桥接模式将接口部分和实现部分分离,使两者可以分别扩展</li>\n<li>装饰者模式是对原始类功能进行增强，并且可以支持多次,多种增强</li>\n<li>代理模式实现了代理类和原始类的解耦,使代理类可以用于增强不同的功能</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>策略模式 &amp;&amp; 简单工厂模式 &amp;&amp; 命令模式:</p>\n<ul>\n<li>共同点:都有对if/else进行下沉</li>\n<li>不同点:<ul>\n<li>策略模式根据运行时状态返回一个”策略”/“算法”,这些”策略”具有相同目的,比如BubbleSort、SelectionSort 都是为了实现排序</li>\n<li>命令模式中不同的命令具有不同的目的，对应不同的处理逻辑，并且互相之间不可替换</li>\n<li>而简单工厂更侧重返回一个创建的对象</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><p>中介模式  &amp;&amp;  观察者模式</p>\n<ul>\n<li>在观察者模式中，尽管一个参与者既可以是观察者，同时也可以是被观察者，但是，大部分情况下，交互关系往往都是单向的，一个参与者要么是观察者，要么是被观察者，不会兼具两种身份。也就是说，在观察者模式的应用场景中，参与者之间的交互关系比较有条理</li>\n<li>而中介模式正好相反。只有当参与者之间的交互关系错综复杂，维护成本很高的时候，我们才考虑使用中介模式。毕竟，中介模式的应用会带来一定的副作用，前面也讲到，它有可能会产生大而复杂的上帝类。除此之外，如果一个参与者状态的改变，其他参与者执行的操作有一定先后顺序的要求，这个时候，中介模式就可以利用中介类，通过先后调用不同参与者的方法，来实现顺序的控制，而观察者模式是无法实现这样的顺序要求的</li>\n</ul>\n</li>\n<li><p>享元模式  &amp;&amp;  单例  &amp;&amp; 缓存 &amp;&amp; 对象池</p>\n<ul>\n<li>享元模式跟单例<ul>\n<li>在单例模式中，一个类只能创建一个对象，而在享元模式中，一个类可以创建多个对象，每个对象被多处代码引用共享。实际上，享元模式有点类似于之前讲到的单例的变体：==多例==</li>\n<li>尽管从代码实现上来看，享元模式和多例有很多相似之处，但从设计意图上来看，它们是完全不同的。应用享元模式是为了对象复用，节省内存，而应用多例模式是为了限制对象的个数</li>\n</ul>\n</li>\n<li>享元模式跟缓存<ul>\n<li>享元的“缓存”实际上是“存储”的意思</li>\n<li>通常意义上的缓存，主要是为了提高访问效率，而非复用</li>\n</ul>\n</li>\n<li>享元模式跟对象池<ul>\n<li>对象池、连接池、线程池等池化技术中的“复用”和享元模式中的“复用”实际上是不同的概念</li>\n<li>池化技术中的“复用”可以理解为“重复使用”，主要目的是节省时间，在任意时刻，每一个对象、连接、线程，并不会被多处使用，而是被一个使用者独占，当使用完成之后，放回到池中，再由其他使用者重复利用</li>\n</ul>\n</li>\n<li>享元模式中的“复用”可以理解为“共享使用”，在整个生命周期中，都是被所有使用者共享的，主要目的是节省空间</li>\n</ul>\n</li>\n<li><p>模板模式  &amp;&amp;  回调</p>\n<ul>\n<li><p>从应用场景上来看，同步回调跟模板模式几乎一致。它们都是在一个大的算法骨架中，自由替换其中的某个步骤，起到代码复用和扩展的目的。而异步回调跟模板模式有较大差别，更像是观察者模式</p>\n</li>\n<li><p>从代码实现上来看，回调和模板模式完全不同。回调基于组合关系来实现，把一个对象传递给另一个对象，是一种对象之间的关系；模板模式基于继承关系来实现，子类重写父类的抽象方法，是一种类之间的关系</p>\n</li>\n<li><p>回调相对于模板模式会更加灵活</p>\n<ul>\n<li>像 Java 这种只支持单继承的语言，基于模板模式编写的子类，已经继承了一个父类，不再具有继承的能力</li>\n<li>回调可以使用匿名类来创建回调对象，可以不用事先定义类；而模板模式针对不同的实现都要定义不同的子类</li>\n<li>如果某个类中定义了多个模板方法，每个方法都有对应的抽象方法，那即便我们只用到其中的一个模板方法，子类也必须实现所有的抽象方法。而回调就更加灵活，我们只需要往用到的模板方法中注入回调对象即可</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><ul>\n<li>实际上，每个设计模式都应该由两部分组成：第一部分是应用场景，即这个模式可以解决哪类问题；第二部分是解决方案，即这个模式的设计思路和具体的代码实现。不过，代码实现并不是模式必须包含的。如果你单纯地只关注解决方案这一部分，甚至只关注代码实现，就会产生大部分模式看起来都很相似的错觉</li>\n<li>实际上，==设计模式之间的主要区别还是在于设计意图==，也就是应用场景。单纯地看设计思路或者代码实现，有些模式确实很相似，比如策略模式和工厂模式</li>\n</ul>\n","site":{"data":{}},"excerpt":"<div class=\"note info\"><p>落下的都得补上。</p></div>","more":"<ul>\n<li><p>一张总结图起手</p>\n<p><img src=\"https://i.loli.net/2020/09/08/z8xwGEeyLJdBZ71.jpg\" alt=\"20200908194129.jpg\"></p>\n</li>\n</ul>\n<h2 id=\"相似的设计模式对比\"><a href=\"#相似的设计模式对比\" class=\"headerlink\" title=\"相似的设计模式对比\"></a>相似的设计模式对比</h2><ul>\n<li>工厂模式 &amp;&amp; 建造者模式<ul>\n<li>工厂模式是用来创建不同但是相关类型的对象（继承同一父类或者接口的一组子类），由给定的参数来决定创建哪种类型的对象</li>\n<li>建造者模式是用来创建一种类型的复杂对象，可以通过设置不同的可选参数，“定制化”地创建不同的对象</li>\n<li>比喻<ul>\n<li>工厂模式：土豆，面粉，番茄</li>\n<li>建造者模式：披萨</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>策略模式  &amp;&amp; 命令模式<ul>\n<li>在策略模式中，不同的策略具有相同的目的、不同的实现、互相之间可以替换。比如，BubbleSort、SelectionSort 都是为了实现排序的，只不过一个是用冒泡排序算法来实现的，另一个是用选择排序算法来实现的。而在命令模式中，不同的命令具有不同的目的，对应不同的处理逻辑，并且互相之间不可替换</li>\n</ul>\n</li>\n<li><p>单例模式  &amp;&amp; 享元模式  &amp;&amp; 缓存  &amp;&amp; 静态工厂方法</p>\n<ul>\n<li>他们的共同点是:对象的复用</li>\n<li>不同点:<ul>\n<li>应用享元模式是为了对象”共享使用”，节省内存</li>\n<li>而应用单例/多例模式是为了限制对象的个数</li>\n<li>应用缓存是为了提高访问效率</li>\n<li>应用对象池(数据库连接池,线程池)是为了对象的”重复使用”和管理,主要是为了节省时间</li>\n<li>有一种方法叫 静态工厂方法,例如 Boolean.valueof(),不会在每次调用时返回一个新对象,而是复用已有的,这一点有点像享元模式</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>适配器  &amp;&amp; 代理 &amp;&amp; 装饰器 &amp;&amp; 桥接,:</p>\n<ul>\n<li>他们的共同点是:对方法的增强</li>\n<li>不同点:<ul>\n<li>适配器模式的作用是”适配”,通常用于适配不同的组件,新旧系统</li>\n<li>桥接模式将接口部分和实现部分分离,使两者可以分别扩展</li>\n<li>装饰者模式是对原始类功能进行增强，并且可以支持多次,多种增强</li>\n<li>代理模式实现了代理类和原始类的解耦,使代理类可以用于增强不同的功能</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>策略模式 &amp;&amp; 简单工厂模式 &amp;&amp; 命令模式:</p>\n<ul>\n<li>共同点:都有对if/else进行下沉</li>\n<li>不同点:<ul>\n<li>策略模式根据运行时状态返回一个”策略”/“算法”,这些”策略”具有相同目的,比如BubbleSort、SelectionSort 都是为了实现排序</li>\n<li>命令模式中不同的命令具有不同的目的，对应不同的处理逻辑，并且互相之间不可替换</li>\n<li>而简单工厂更侧重返回一个创建的对象</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><p>中介模式  &amp;&amp;  观察者模式</p>\n<ul>\n<li>在观察者模式中，尽管一个参与者既可以是观察者，同时也可以是被观察者，但是，大部分情况下，交互关系往往都是单向的，一个参与者要么是观察者，要么是被观察者，不会兼具两种身份。也就是说，在观察者模式的应用场景中，参与者之间的交互关系比较有条理</li>\n<li>而中介模式正好相反。只有当参与者之间的交互关系错综复杂，维护成本很高的时候，我们才考虑使用中介模式。毕竟，中介模式的应用会带来一定的副作用，前面也讲到，它有可能会产生大而复杂的上帝类。除此之外，如果一个参与者状态的改变，其他参与者执行的操作有一定先后顺序的要求，这个时候，中介模式就可以利用中介类，通过先后调用不同参与者的方法，来实现顺序的控制，而观察者模式是无法实现这样的顺序要求的</li>\n</ul>\n</li>\n<li><p>享元模式  &amp;&amp;  单例  &amp;&amp; 缓存 &amp;&amp; 对象池</p>\n<ul>\n<li>享元模式跟单例<ul>\n<li>在单例模式中，一个类只能创建一个对象，而在享元模式中，一个类可以创建多个对象，每个对象被多处代码引用共享。实际上，享元模式有点类似于之前讲到的单例的变体：==多例==</li>\n<li>尽管从代码实现上来看，享元模式和多例有很多相似之处，但从设计意图上来看，它们是完全不同的。应用享元模式是为了对象复用，节省内存，而应用多例模式是为了限制对象的个数</li>\n</ul>\n</li>\n<li>享元模式跟缓存<ul>\n<li>享元的“缓存”实际上是“存储”的意思</li>\n<li>通常意义上的缓存，主要是为了提高访问效率，而非复用</li>\n</ul>\n</li>\n<li>享元模式跟对象池<ul>\n<li>对象池、连接池、线程池等池化技术中的“复用”和享元模式中的“复用”实际上是不同的概念</li>\n<li>池化技术中的“复用”可以理解为“重复使用”，主要目的是节省时间，在任意时刻，每一个对象、连接、线程，并不会被多处使用，而是被一个使用者独占，当使用完成之后，放回到池中，再由其他使用者重复利用</li>\n</ul>\n</li>\n<li>享元模式中的“复用”可以理解为“共享使用”，在整个生命周期中，都是被所有使用者共享的，主要目的是节省空间</li>\n</ul>\n</li>\n<li><p>模板模式  &amp;&amp;  回调</p>\n<ul>\n<li><p>从应用场景上来看，同步回调跟模板模式几乎一致。它们都是在一个大的算法骨架中，自由替换其中的某个步骤，起到代码复用和扩展的目的。而异步回调跟模板模式有较大差别，更像是观察者模式</p>\n</li>\n<li><p>从代码实现上来看，回调和模板模式完全不同。回调基于组合关系来实现，把一个对象传递给另一个对象，是一种对象之间的关系；模板模式基于继承关系来实现，子类重写父类的抽象方法，是一种类之间的关系</p>\n</li>\n<li><p>回调相对于模板模式会更加灵活</p>\n<ul>\n<li>像 Java 这种只支持单继承的语言，基于模板模式编写的子类，已经继承了一个父类，不再具有继承的能力</li>\n<li>回调可以使用匿名类来创建回调对象，可以不用事先定义类；而模板模式针对不同的实现都要定义不同的子类</li>\n<li>如果某个类中定义了多个模板方法，每个方法都有对应的抽象方法，那即便我们只用到其中的一个模板方法，子类也必须实现所有的抽象方法。而回调就更加灵活，我们只需要往用到的模板方法中注入回调对象即可</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><ul>\n<li>实际上，每个设计模式都应该由两部分组成：第一部分是应用场景，即这个模式可以解决哪类问题；第二部分是解决方案，即这个模式的设计思路和具体的代码实现。不过，代码实现并不是模式必须包含的。如果你单纯地只关注解决方案这一部分，甚至只关注代码实现，就会产生大部分模式看起来都很相似的错觉</li>\n<li>实际上，==设计模式之间的主要区别还是在于设计意图==，也就是应用场景。单纯地看设计思路或者代码实现，有些模式确实很相似，比如策略模式和工厂模式</li>\n</ul>"},{"title":"破解安卓机nfc功能模拟卡限制","date":"2020-07-19T13:09:16.000Z","_content":"\n{%note info%}\n本文记录使用`PN532`破解手机厂商对收集nfc功能的限制。\n{%endnote%}\n<!--more-->\n\n## 背景\n\n- 一般安卓旗舰都带有nfc功能，但是简单的使用门卡功能复制了两张卡片，缺无法使用，本文记录使用`PN532`破解手机厂商对收集nfc功能的限制\n\n## 准备材料\n\n- 带nfc功能的`安卓`手机（iphone没试过）\n- `PN532`nfc加解密工具（TB购买）\n- 一张CUID卡，用于克隆卡数据\n- 一台Windows上位机，用于安装PN532驱动\n- 破解卡类型只针对`半加密卡`\n\n## 操作步骤\n\n1. 判断待模拟卡是否为半加密卡\n    - 手机安装`MIFARE Classic Tool`工具，通过`读标签`读取实体卡片数据\n      ![WechatIMG26.jpeg](https://i.loli.net/2020/07/18/pJk3hv4cu6MOsRD.jpg) \n    \n      \n    \n    - 半解密卡数据格式如下\n    ![20200718221445.jpg](https://i.loli.net/2020/07/18/jUFSKEIyl9hXxLt.jpg)\n2. 安装PN532上位机驱动（软件操作大同小异，就不贴图了）\n3. 使用PN532破解，并读取实体卡数据\n    \n    - 将原卡放在PN532上，点击“一键破解”，大概5s后窗口显示破解数据（读出数据后，可以选择保存文件，记住该文件名）\n4. 使用CUID卡克隆实体卡\n    \n    - 将CUID卡放在PN532上，点击“写CUID卡”（因为此时步骤3暂存着实体卡的解密数据），等待CUID卡写入完成，使用该CUID卡去刷门禁，成功则说明克隆完成\n5. 格式化CUID，使其只保留0扇区数据\n    \n    - 将CUID卡放在PN532上，点击“格式化卡”，这样CUID即成了实体卡的同号空卡\n6. 手机模拟CUID卡数据（即实体卡的同号空卡）\n    - （以小米手机为例）小米钱包-==门卡==-模拟实体门卡，讲CUID卡在上手机背面，并完成对应操作\n    ![301595081317_.pic.jpg](https://i.loli.net/2020/07/18/WmZw7TpEuzBDJqL.jpg)\n7. 通过PN532像手机模拟的同号空卡中写入其他扇区加密数据\n    \n    - 讲手机放在PN532上，导入步骤1保存的数据，点击“写普通M1卡”，写入成功加密数据，不出意外，手机上的模拟卡已可以正常使用\n\n- 异常情况\n    - 确认步骤如下，若模拟卡无法使用，则导出模拟卡数据至CUID卡，若CUID卡可以使用，则说明该设备不支持识别模拟卡（一些设备，如家庭门禁不识别模拟卡，暂时无解）\n    \n    - 若CUID卡也无法使用，则说明整体操作存在问题，需仔细阅读操作步骤，并也可以到处模拟卡数据，通过dump数据比对工具和原实体卡导出数据比对，若0扇区前8位数据不一致，则说明没有模拟成功，后8位为厂商识别码，不一致是正常的\n    \n    - 异常情况的`银弹`是使用卡贴（选择CUID卡功能的卡贴）\n    \n      \n## 扫盲\n\n- 芯片分类\n  - 8268卡也叫ID防火墙卡\n  - 手机nfc能模拟的是IC卡\n\n![281595081315_.pic.jpg](https://i.loli.net/2020/07/18/tXbNPakwWYyfOeV.jpg)\n\n- IC卡与ID卡\n\n  [![271595081314_.pic.jpg](https://i.loli.net/2020/07/19/WeODnArb1QuRMIy.jpg)](https://i.loli.net/2020/07/19/WeODnArb1QuRMIy.jpg)\n\n","source":"_posts/2020-07-19-破解安卓机nfc功能模拟卡限制.md","raw":"title: 破解安卓机nfc功能模拟卡限制\ndate: 2020-07-19 21:09:16\ntags: nfc\ncategories: 手机\n\n---\n\n{%note info%}\n本文记录使用`PN532`破解手机厂商对收集nfc功能的限制。\n{%endnote%}\n<!--more-->\n\n## 背景\n\n- 一般安卓旗舰都带有nfc功能，但是简单的使用门卡功能复制了两张卡片，缺无法使用，本文记录使用`PN532`破解手机厂商对收集nfc功能的限制\n\n## 准备材料\n\n- 带nfc功能的`安卓`手机（iphone没试过）\n- `PN532`nfc加解密工具（TB购买）\n- 一张CUID卡，用于克隆卡数据\n- 一台Windows上位机，用于安装PN532驱动\n- 破解卡类型只针对`半加密卡`\n\n## 操作步骤\n\n1. 判断待模拟卡是否为半加密卡\n    - 手机安装`MIFARE Classic Tool`工具，通过`读标签`读取实体卡片数据\n      ![WechatIMG26.jpeg](https://i.loli.net/2020/07/18/pJk3hv4cu6MOsRD.jpg) \n    \n      \n    \n    - 半解密卡数据格式如下\n    ![20200718221445.jpg](https://i.loli.net/2020/07/18/jUFSKEIyl9hXxLt.jpg)\n2. 安装PN532上位机驱动（软件操作大同小异，就不贴图了）\n3. 使用PN532破解，并读取实体卡数据\n    \n    - 将原卡放在PN532上，点击“一键破解”，大概5s后窗口显示破解数据（读出数据后，可以选择保存文件，记住该文件名）\n4. 使用CUID卡克隆实体卡\n    \n    - 将CUID卡放在PN532上，点击“写CUID卡”（因为此时步骤3暂存着实体卡的解密数据），等待CUID卡写入完成，使用该CUID卡去刷门禁，成功则说明克隆完成\n5. 格式化CUID，使其只保留0扇区数据\n    \n    - 将CUID卡放在PN532上，点击“格式化卡”，这样CUID即成了实体卡的同号空卡\n6. 手机模拟CUID卡数据（即实体卡的同号空卡）\n    - （以小米手机为例）小米钱包-==门卡==-模拟实体门卡，讲CUID卡在上手机背面，并完成对应操作\n    ![301595081317_.pic.jpg](https://i.loli.net/2020/07/18/WmZw7TpEuzBDJqL.jpg)\n7. 通过PN532像手机模拟的同号空卡中写入其他扇区加密数据\n    \n    - 讲手机放在PN532上，导入步骤1保存的数据，点击“写普通M1卡”，写入成功加密数据，不出意外，手机上的模拟卡已可以正常使用\n\n- 异常情况\n    - 确认步骤如下，若模拟卡无法使用，则导出模拟卡数据至CUID卡，若CUID卡可以使用，则说明该设备不支持识别模拟卡（一些设备，如家庭门禁不识别模拟卡，暂时无解）\n    \n    - 若CUID卡也无法使用，则说明整体操作存在问题，需仔细阅读操作步骤，并也可以到处模拟卡数据，通过dump数据比对工具和原实体卡导出数据比对，若0扇区前8位数据不一致，则说明没有模拟成功，后8位为厂商识别码，不一致是正常的\n    \n    - 异常情况的`银弹`是使用卡贴（选择CUID卡功能的卡贴）\n    \n      \n## 扫盲\n\n- 芯片分类\n  - 8268卡也叫ID防火墙卡\n  - 手机nfc能模拟的是IC卡\n\n![281595081315_.pic.jpg](https://i.loli.net/2020/07/18/tXbNPakwWYyfOeV.jpg)\n\n- IC卡与ID卡\n\n  [![271595081314_.pic.jpg](https://i.loli.net/2020/07/19/WeODnArb1QuRMIy.jpg)](https://i.loli.net/2020/07/19/WeODnArb1QuRMIy.jpg)\n\n","slug":"破解安卓机nfc功能模拟卡限制","published":1,"updated":"2020-07-19T13:43:00.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckezigl7p001b1gp7x24h7piu","content":"<div class=\"note info\"><p>本文记录使用<code>PN532</code>破解手机厂商对收集nfc功能的限制。</p></div>\n<a id=\"more\"></a>\n<h2 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h2><ul>\n<li>一般安卓旗舰都带有nfc功能，但是简单的使用门卡功能复制了两张卡片，缺无法使用，本文记录使用<code>PN532</code>破解手机厂商对收集nfc功能的限制</li>\n</ul>\n<h2 id=\"准备材料\"><a href=\"#准备材料\" class=\"headerlink\" title=\"准备材料\"></a>准备材料</h2><ul>\n<li>带nfc功能的<code>安卓</code>手机（iphone没试过）</li>\n<li><code>PN532</code>nfc加解密工具（TB购买）</li>\n<li>一张CUID卡，用于克隆卡数据</li>\n<li>一台Windows上位机，用于安装PN532驱动</li>\n<li>破解卡类型只针对<code>半加密卡</code></li>\n</ul>\n<h2 id=\"操作步骤\"><a href=\"#操作步骤\" class=\"headerlink\" title=\"操作步骤\"></a>操作步骤</h2><ol>\n<li>判断待模拟卡是否为半加密卡<ul>\n<li>手机安装<code>MIFARE Classic Tool</code>工具，通过<code>读标签</code>读取实体卡片数据<br><img src=\"https://i.loli.net/2020/07/18/pJk3hv4cu6MOsRD.jpg\" alt=\"WechatIMG26.jpeg\"> </li>\n</ul>\n</li>\n</ol>\n<pre><code>- 半解密卡数据格式如下\n![20200718221445.jpg](https://i.loli.net/2020/07/18/jUFSKEIyl9hXxLt.jpg)\n</code></pre><ol start=\"2\">\n<li>安装PN532上位机驱动（软件操作大同小异，就不贴图了）</li>\n<li><p>使用PN532破解，并读取实体卡数据</p>\n<ul>\n<li>将原卡放在PN532上，点击“一键破解”，大概5s后窗口显示破解数据（读出数据后，可以选择保存文件，记住该文件名）</li>\n</ul>\n</li>\n<li><p>使用CUID卡克隆实体卡</p>\n<ul>\n<li>将CUID卡放在PN532上，点击“写CUID卡”（因为此时步骤3暂存着实体卡的解密数据），等待CUID卡写入完成，使用该CUID卡去刷门禁，成功则说明克隆完成</li>\n</ul>\n</li>\n<li><p>格式化CUID，使其只保留0扇区数据</p>\n<ul>\n<li>将CUID卡放在PN532上，点击“格式化卡”，这样CUID即成了实体卡的同号空卡</li>\n</ul>\n</li>\n<li>手机模拟CUID卡数据（即实体卡的同号空卡）<ul>\n<li>（以小米手机为例）小米钱包-==门卡==-模拟实体门卡，讲CUID卡在上手机背面，并完成对应操作<br><img src=\"https://i.loli.net/2020/07/18/WmZw7TpEuzBDJqL.jpg\" alt=\"301595081317_.pic.jpg\"></li>\n</ul>\n</li>\n<li><p>通过PN532像手机模拟的同号空卡中写入其他扇区加密数据</p>\n<ul>\n<li>讲手机放在PN532上，导入步骤1保存的数据，点击“写普通M1卡”，写入成功加密数据，不出意外，手机上的模拟卡已可以正常使用</li>\n</ul>\n</li>\n</ol>\n<ul>\n<li><p>异常情况</p>\n<ul>\n<li><p>确认步骤如下，若模拟卡无法使用，则导出模拟卡数据至CUID卡，若CUID卡可以使用，则说明该设备不支持识别模拟卡（一些设备，如家庭门禁不识别模拟卡，暂时无解）</p>\n</li>\n<li><p>若CUID卡也无法使用，则说明整体操作存在问题，需仔细阅读操作步骤，并也可以到处模拟卡数据，通过dump数据比对工具和原实体卡导出数据比对，若0扇区前8位数据不一致，则说明没有模拟成功，后8位为厂商识别码，不一致是正常的</p>\n</li>\n<li><p>异常情况的<code>银弹</code>是使用卡贴（选择CUID卡功能的卡贴）</p>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"扫盲\"><a href=\"#扫盲\" class=\"headerlink\" title=\"扫盲\"></a>扫盲</h2><ul>\n<li>芯片分类<ul>\n<li>8268卡也叫ID防火墙卡</li>\n<li>手机nfc能模拟的是IC卡</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"https://i.loli.net/2020/07/18/tXbNPakwWYyfOeV.jpg\" alt=\"281595081315_.pic.jpg\"></p>\n<ul>\n<li><p>IC卡与ID卡</p>\n<p><a href=\"https://i.loli.net/2020/07/19/WeODnArb1QuRMIy.jpg\" target=\"_blank\" rel=\"noopener\"><img src=\"https://i.loli.net/2020/07/19/WeODnArb1QuRMIy.jpg\" alt=\"271595081314_.pic.jpg\"></a></p>\n</li>\n</ul>\n","site":{"data":{}},"excerpt":"<div class=\"note info\"><p>本文记录使用<code>PN532</code>破解手机厂商对收集nfc功能的限制。</p></div>","more":"<h2 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h2><ul>\n<li>一般安卓旗舰都带有nfc功能，但是简单的使用门卡功能复制了两张卡片，缺无法使用，本文记录使用<code>PN532</code>破解手机厂商对收集nfc功能的限制</li>\n</ul>\n<h2 id=\"准备材料\"><a href=\"#准备材料\" class=\"headerlink\" title=\"准备材料\"></a>准备材料</h2><ul>\n<li>带nfc功能的<code>安卓</code>手机（iphone没试过）</li>\n<li><code>PN532</code>nfc加解密工具（TB购买）</li>\n<li>一张CUID卡，用于克隆卡数据</li>\n<li>一台Windows上位机，用于安装PN532驱动</li>\n<li>破解卡类型只针对<code>半加密卡</code></li>\n</ul>\n<h2 id=\"操作步骤\"><a href=\"#操作步骤\" class=\"headerlink\" title=\"操作步骤\"></a>操作步骤</h2><ol>\n<li>判断待模拟卡是否为半加密卡<ul>\n<li>手机安装<code>MIFARE Classic Tool</code>工具，通过<code>读标签</code>读取实体卡片数据<br><img src=\"https://i.loli.net/2020/07/18/pJk3hv4cu6MOsRD.jpg\" alt=\"WechatIMG26.jpeg\"> </li>\n</ul>\n</li>\n</ol>\n<pre><code>- 半解密卡数据格式如下\n![20200718221445.jpg](https://i.loli.net/2020/07/18/jUFSKEIyl9hXxLt.jpg)\n</code></pre><ol start=\"2\">\n<li>安装PN532上位机驱动（软件操作大同小异，就不贴图了）</li>\n<li><p>使用PN532破解，并读取实体卡数据</p>\n<ul>\n<li>将原卡放在PN532上，点击“一键破解”，大概5s后窗口显示破解数据（读出数据后，可以选择保存文件，记住该文件名）</li>\n</ul>\n</li>\n<li><p>使用CUID卡克隆实体卡</p>\n<ul>\n<li>将CUID卡放在PN532上，点击“写CUID卡”（因为此时步骤3暂存着实体卡的解密数据），等待CUID卡写入完成，使用该CUID卡去刷门禁，成功则说明克隆完成</li>\n</ul>\n</li>\n<li><p>格式化CUID，使其只保留0扇区数据</p>\n<ul>\n<li>将CUID卡放在PN532上，点击“格式化卡”，这样CUID即成了实体卡的同号空卡</li>\n</ul>\n</li>\n<li>手机模拟CUID卡数据（即实体卡的同号空卡）<ul>\n<li>（以小米手机为例）小米钱包-==门卡==-模拟实体门卡，讲CUID卡在上手机背面，并完成对应操作<br><img src=\"https://i.loli.net/2020/07/18/WmZw7TpEuzBDJqL.jpg\" alt=\"301595081317_.pic.jpg\"></li>\n</ul>\n</li>\n<li><p>通过PN532像手机模拟的同号空卡中写入其他扇区加密数据</p>\n<ul>\n<li>讲手机放在PN532上，导入步骤1保存的数据，点击“写普通M1卡”，写入成功加密数据，不出意外，手机上的模拟卡已可以正常使用</li>\n</ul>\n</li>\n</ol>\n<ul>\n<li><p>异常情况</p>\n<ul>\n<li><p>确认步骤如下，若模拟卡无法使用，则导出模拟卡数据至CUID卡，若CUID卡可以使用，则说明该设备不支持识别模拟卡（一些设备，如家庭门禁不识别模拟卡，暂时无解）</p>\n</li>\n<li><p>若CUID卡也无法使用，则说明整体操作存在问题，需仔细阅读操作步骤，并也可以到处模拟卡数据，通过dump数据比对工具和原实体卡导出数据比对，若0扇区前8位数据不一致，则说明没有模拟成功，后8位为厂商识别码，不一致是正常的</p>\n</li>\n<li><p>异常情况的<code>银弹</code>是使用卡贴（选择CUID卡功能的卡贴）</p>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"扫盲\"><a href=\"#扫盲\" class=\"headerlink\" title=\"扫盲\"></a>扫盲</h2><ul>\n<li>芯片分类<ul>\n<li>8268卡也叫ID防火墙卡</li>\n<li>手机nfc能模拟的是IC卡</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"https://i.loli.net/2020/07/18/tXbNPakwWYyfOeV.jpg\" alt=\"281595081315_.pic.jpg\"></p>\n<ul>\n<li><p>IC卡与ID卡</p>\n<p><a href=\"https://i.loli.net/2020/07/19/WeODnArb1QuRMIy.jpg\" target=\"_blank\" rel=\"noopener\"><img src=\"https://i.loli.net/2020/07/19/WeODnArb1QuRMIy.jpg\" alt=\"271595081314_.pic.jpg\"></a></p>\n</li>\n</ul>"},{"title":"shell编码整理","date":"2020-01-13T13:54:44.000Z","_content":"\n{%note info%}\n从开始接触linux，或多或少会使用到shell，这篇文章用来整理下用过的shell语法，和比较常见的套路。\n{%endnote%}\n<!--more-->\n\n## 常用语法\n### test\n- 用于检查某个条件是否成立，它可以进行数值、字符和文件三个方面的测试\n```shell\nif test  -e startup.sh ;then \n等价于\nif [[ -e startup.sh ]];then\n```\n- 注意：可以使用[[]]就不要使用[]，[[]]兼容在命令中使用&&、||、<和> 等操作符\n\n### 数组\n- 定义数组\n```shell\nmodules=(bond-web bifrost model-engine gaeaproxy) \n```\n- 获取数组所有元素，@可被*替换\n```shell\n${modules[@]}\n```\n- 遍历数组\n```shell\nfor module in \"${modules[@]}\"; do\necho $module\ndone\n```\n- 读取数组指定元素\n```shell\n${modules[index]} \n```\n- 数组长度\n```shell\n@可被*替换|${#my_array[@]}\n```\n\n### 变量\n- 全局变量\n```shell\n# 全局变量的作用域是当前的进程，而不是前端的shell脚本文件\na=1\n```\n- 局部变量\n```shell\nlocal a=1\n```\n- 环境变量\n```shell\nexport a=1\n作用域为当前shell进程和其子进程\n```\n- 特殊变量\n\n|示例|变量含义|\n|:---:|:---|\n|$@|所有入参，可以通过set设置 set 11 22 33 44|\n|$#|参数个数|\n|$?|上个命令的退出状态|函数的返回值|\n|$$|当前shell进程的ID|\n|$!|Shell最后运行的后台Process的PID|\n|total=$#｜action=${!total}|获取最后一个参数，也可通过eval action=\\$$#|\n｜\\` \\`｜指令定义，相较于''，``会预执行，在指令嵌套时经常用到｜\n｜echo $aa | echo ${aa}｜读取变量｜\t\t\n｜$((2+3)) ｜进行整数运算｜\n\n### eval\n- 该命令对变量进行两次扫描\n```shell\na=`echo hello`\nb='echo $a' \n等价于\na='echo hello'\nb=eval 'echo $a'\n```\n### 引号\n|示例|含义|\n|:---:|:---|\n|' ' 单引号|剥夺所有字符的特殊含义，如 n=3；echo '$n' -> $n|\n|\" \" 双引号|引号内可参数替换，$和反引号 ``|\n|``反引号|用命令替换，即先执行``内命令，将输出结果暂存，在适当的地方输出|\n\t\n### 重定向\n```shell\nehco 'haha' > /tmp/tmp.log 2>&1\n```\n\t \n## 常见的服务启动脚本\n```shell\n#!/bin/bash\n\neval action=\\$$#\n\nmain() {\n    case \"$module\" in\n        module1)\n            start_cmd=\"cmd1\"\n            ;;\n        module2)\n            start_cmd=\"cmd2\"\n            ;;\n        *)\n            echo \"usage: $module {module1|module2}\"\n            exit -1\n    esac\n}\n\nall() {\n\t  for module in \"${modules[@]}\"; do\n\t      main\n\t      echo\n        echo \"[INFO] $module:\"\n            echo \"[INFO] processing: ${module} ${action}\"\n            echo \"==================\"\n            action\n            echo \"--------------\"\n    done\n}\n\naction() {\n\tcase \"$action\" in\n\t\tstart)\n\t\t\tstart\n\t\t\tstatus\n\t\t\t;;\n\t\tstop)\n\t\t\tstop\n\t\t\t;;\n\t\tstatus)\n\t\t\tstatus\n\t\t\t;;\n\t\trestart)\n\t\t\tstop\n\t\t\tstart\n\t\t\tstatus\n\t\t\t;;\n\t\t*)\n\t\t\techo \"usage: $action {start|stop|status|restart}\"\n\t\t\texit -1\n\tesac\n}\n\nusage() {\n    echo \"usage: $0 {all|[module1, ...]} {start|stop|status|restart}\"\n}\n\nmultiple() {\n    total=$#\n    action=${!total}\n    for (( i=1; i<total; i++)); do\n        module=${!i//\\//}\n        main\n\t     echo \"[INFO] $module:${start_cmd}\"\n        echo \"[INFO] processing: ${module} ${action}\"\n        echo \"==================\"\n        action\n        echo \"--------------\"\n    done\n}\n\ngetpid() {\n    if [ ! -d \"pids\" ]; then\n        mkdir pids\n    fi\n    if [ ! -f \"pids/${module}_pid\" ];then\n        echo \"\" > pids/${module}_pid\n    fi\n    module_pid=`cat pids/${module}_pid`\n\n    pid=`ps aux | grep ${module_pid} | grep -v grep | grep -v $0 | awk '{print $2}'`\n\n    if [[ -n ${pid} ]]; then\n        return 0\n    else\n        return 1\n    fi\n}\n\nstatus() {\n    getpid\n    if [[ -n ${pid} ]]; then\n        echo \"status:\n        `ps aux | grep ${pid} | grep -v grep`\"\n        return 0\n    else\n        echo \"service not running\"\n        return 1\n    fi\n}\n\nstart() {\n    getpid\n    if [[ $? -eq 1 ]]; then\n        eval $start_cmd\n        echo $!>pids/${module}_pid\n        getpid\n        if [[ $? -eq 0 ]]; then\n            echo \"service start sucessfully. pid: ${pid}\"\n        else\n            echo \"service start failed\"\n        fi\n    else\n        echo \"service already started. pid: ${pid}\"\n    fi\n}\n\nstop() {\n    getpid\n    if [[ -n ${pid} ]]; then\n        echo \"killing:\n        `ps aux | grep ${pid} | grep -v grep`\"\n        kill -9 ${pid} && sleep 0.01\n\t\t    getpid\n        if [[ $? -eq 1 ]]; then\n            echo \"killed\"\n        else\n            echo \"kill error\"\n        fi\n    else\n        echo \"service not running\"\n    fi\n}\n\ncase \"$1\" in\n    all)\n        all $@\n        ;;\n    usage)\n        usage\n        ;;\n    *)\n        multiple $@\n        ;;\nesac\n```\n- 注意服务启动间隔如果不加`sleep 0.01`，可能会导致获取服务状态异常，即杀掉服务需要一定的信号处理时间\n\n## 开机启动\n- 将启动指令配置进/etc/rc.d/rc.local\n- 注意，任何一个脚本执行失败，即exit非0，将导致该shell session内的所有启动服务失败，而如何配置在rc.local中的指令exit非0，将导致整个系统初始化失败","source":"_posts/2020-01-13-shell编码整理.md","raw":"---\ntitle: shell编码整理\ndate: 2020-01-13 21:54:44\ntags: \n- shell\n- 部署\n- 运维\ncategories: \n- shell\n---\n\n{%note info%}\n从开始接触linux，或多或少会使用到shell，这篇文章用来整理下用过的shell语法，和比较常见的套路。\n{%endnote%}\n<!--more-->\n\n## 常用语法\n### test\n- 用于检查某个条件是否成立，它可以进行数值、字符和文件三个方面的测试\n```shell\nif test  -e startup.sh ;then \n等价于\nif [[ -e startup.sh ]];then\n```\n- 注意：可以使用[[]]就不要使用[]，[[]]兼容在命令中使用&&、||、<和> 等操作符\n\n### 数组\n- 定义数组\n```shell\nmodules=(bond-web bifrost model-engine gaeaproxy) \n```\n- 获取数组所有元素，@可被*替换\n```shell\n${modules[@]}\n```\n- 遍历数组\n```shell\nfor module in \"${modules[@]}\"; do\necho $module\ndone\n```\n- 读取数组指定元素\n```shell\n${modules[index]} \n```\n- 数组长度\n```shell\n@可被*替换|${#my_array[@]}\n```\n\n### 变量\n- 全局变量\n```shell\n# 全局变量的作用域是当前的进程，而不是前端的shell脚本文件\na=1\n```\n- 局部变量\n```shell\nlocal a=1\n```\n- 环境变量\n```shell\nexport a=1\n作用域为当前shell进程和其子进程\n```\n- 特殊变量\n\n|示例|变量含义|\n|:---:|:---|\n|$@|所有入参，可以通过set设置 set 11 22 33 44|\n|$#|参数个数|\n|$?|上个命令的退出状态|函数的返回值|\n|$$|当前shell进程的ID|\n|$!|Shell最后运行的后台Process的PID|\n|total=$#｜action=${!total}|获取最后一个参数，也可通过eval action=\\$$#|\n｜\\` \\`｜指令定义，相较于''，``会预执行，在指令嵌套时经常用到｜\n｜echo $aa | echo ${aa}｜读取变量｜\t\t\n｜$((2+3)) ｜进行整数运算｜\n\n### eval\n- 该命令对变量进行两次扫描\n```shell\na=`echo hello`\nb='echo $a' \n等价于\na='echo hello'\nb=eval 'echo $a'\n```\n### 引号\n|示例|含义|\n|:---:|:---|\n|' ' 单引号|剥夺所有字符的特殊含义，如 n=3；echo '$n' -> $n|\n|\" \" 双引号|引号内可参数替换，$和反引号 ``|\n|``反引号|用命令替换，即先执行``内命令，将输出结果暂存，在适当的地方输出|\n\t\n### 重定向\n```shell\nehco 'haha' > /tmp/tmp.log 2>&1\n```\n\t \n## 常见的服务启动脚本\n```shell\n#!/bin/bash\n\neval action=\\$$#\n\nmain() {\n    case \"$module\" in\n        module1)\n            start_cmd=\"cmd1\"\n            ;;\n        module2)\n            start_cmd=\"cmd2\"\n            ;;\n        *)\n            echo \"usage: $module {module1|module2}\"\n            exit -1\n    esac\n}\n\nall() {\n\t  for module in \"${modules[@]}\"; do\n\t      main\n\t      echo\n        echo \"[INFO] $module:\"\n            echo \"[INFO] processing: ${module} ${action}\"\n            echo \"==================\"\n            action\n            echo \"--------------\"\n    done\n}\n\naction() {\n\tcase \"$action\" in\n\t\tstart)\n\t\t\tstart\n\t\t\tstatus\n\t\t\t;;\n\t\tstop)\n\t\t\tstop\n\t\t\t;;\n\t\tstatus)\n\t\t\tstatus\n\t\t\t;;\n\t\trestart)\n\t\t\tstop\n\t\t\tstart\n\t\t\tstatus\n\t\t\t;;\n\t\t*)\n\t\t\techo \"usage: $action {start|stop|status|restart}\"\n\t\t\texit -1\n\tesac\n}\n\nusage() {\n    echo \"usage: $0 {all|[module1, ...]} {start|stop|status|restart}\"\n}\n\nmultiple() {\n    total=$#\n    action=${!total}\n    for (( i=1; i<total; i++)); do\n        module=${!i//\\//}\n        main\n\t     echo \"[INFO] $module:${start_cmd}\"\n        echo \"[INFO] processing: ${module} ${action}\"\n        echo \"==================\"\n        action\n        echo \"--------------\"\n    done\n}\n\ngetpid() {\n    if [ ! -d \"pids\" ]; then\n        mkdir pids\n    fi\n    if [ ! -f \"pids/${module}_pid\" ];then\n        echo \"\" > pids/${module}_pid\n    fi\n    module_pid=`cat pids/${module}_pid`\n\n    pid=`ps aux | grep ${module_pid} | grep -v grep | grep -v $0 | awk '{print $2}'`\n\n    if [[ -n ${pid} ]]; then\n        return 0\n    else\n        return 1\n    fi\n}\n\nstatus() {\n    getpid\n    if [[ -n ${pid} ]]; then\n        echo \"status:\n        `ps aux | grep ${pid} | grep -v grep`\"\n        return 0\n    else\n        echo \"service not running\"\n        return 1\n    fi\n}\n\nstart() {\n    getpid\n    if [[ $? -eq 1 ]]; then\n        eval $start_cmd\n        echo $!>pids/${module}_pid\n        getpid\n        if [[ $? -eq 0 ]]; then\n            echo \"service start sucessfully. pid: ${pid}\"\n        else\n            echo \"service start failed\"\n        fi\n    else\n        echo \"service already started. pid: ${pid}\"\n    fi\n}\n\nstop() {\n    getpid\n    if [[ -n ${pid} ]]; then\n        echo \"killing:\n        `ps aux | grep ${pid} | grep -v grep`\"\n        kill -9 ${pid} && sleep 0.01\n\t\t    getpid\n        if [[ $? -eq 1 ]]; then\n            echo \"killed\"\n        else\n            echo \"kill error\"\n        fi\n    else\n        echo \"service not running\"\n    fi\n}\n\ncase \"$1\" in\n    all)\n        all $@\n        ;;\n    usage)\n        usage\n        ;;\n    *)\n        multiple $@\n        ;;\nesac\n```\n- 注意服务启动间隔如果不加`sleep 0.01`，可能会导致获取服务状态异常，即杀掉服务需要一定的信号处理时间\n\n## 开机启动\n- 将启动指令配置进/etc/rc.d/rc.local\n- 注意，任何一个脚本执行失败，即exit非0，将导致该shell session内的所有启动服务失败，而如何配置在rc.local中的指令exit非0，将导致整个系统初始化失败","slug":"shell编码整理","published":1,"updated":"2020-03-28T14:35:40.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckezigl7t001c1gp7odokm3ob","content":"<div class=\"note info\"><p>从开始接触linux，或多或少会使用到shell，这篇文章用来整理下用过的shell语法，和比较常见的套路。</p></div>\n<a id=\"more\"></a>\n<h2 id=\"常用语法\"><a href=\"#常用语法\" class=\"headerlink\" title=\"常用语法\"></a>常用语法</h2><h3 id=\"test\"><a href=\"#test\" class=\"headerlink\" title=\"test\"></a>test</h3><ul>\n<li><p>用于检查某个条件是否成立，它可以进行数值、字符和文件三个方面的测试</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if test  -e startup.sh ;then </span><br><span class=\"line\">等价于</span><br><span class=\"line\">if [[ -e startup.sh ]];then</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>注意：可以使用[[]]就不要使用[]，[[]]兼容在命令中使用&amp;&amp;、||、&lt;和&gt; 等操作符</p>\n</li>\n</ul>\n<h3 id=\"数组\"><a href=\"#数组\" class=\"headerlink\" title=\"数组\"></a>数组</h3><ul>\n<li><p>定义数组</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">modules=(bond-web bifrost model-engine gaeaproxy)</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>获取数组所有元素，@可被*替换</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\">&#123;modules[@]&#125;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>遍历数组</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">for module in \"$&#123;modules[@]&#125;\"; do</span><br><span class=\"line\">echo $module</span><br><span class=\"line\">done</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>读取数组指定元素</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\">&#123;modules[index]&#125;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>数组长度</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@可被*替换|$&#123;#my_array[@]&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"变量\"><a href=\"#变量\" class=\"headerlink\" title=\"变量\"></a>变量</h3><ul>\n<li><p>全局变量</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 全局变量的作用域是当前的进程，而不是前端的shell脚本文件</span></span><br><span class=\"line\">a=1</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>局部变量</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">local a=1</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>环境变量</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export a=1</span><br><span class=\"line\">作用域为当前shell进程和其子进程</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>特殊变量</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">示例</th>\n<th style=\"text-align:left\">变量含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">$@</td>\n<td style=\"text-align:left\">所有入参，可以通过set设置 set 11 22 33 44</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">$#</td>\n<td style=\"text-align:left\">参数个数</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">$?</td>\n<td style=\"text-align:left\">上个命令的退出状态</td>\n<td>函数的返回值</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">$$</td>\n<td style=\"text-align:left\">当前shell进程的ID</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">$!</td>\n<td style=\"text-align:left\">Shell最后运行的后台Process的PID</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">total=$#｜action=${!total}</td>\n<td style=\"text-align:left\">获取最后一个参数，也可通过eval action=\\$$#</td>\n</tr>\n</tbody>\n</table>\n<p>｜` `｜指令定义，相较于’’，<code></code>会预执行，在指令嵌套时经常用到｜<br>｜echo $aa | echo ${aa}｜读取变量｜<br>｜$((2+3)) ｜进行整数运算｜</p>\n<h3 id=\"eval\"><a href=\"#eval\" class=\"headerlink\" title=\"eval\"></a>eval</h3><ul>\n<li>该命令对变量进行两次扫描<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a=`echo hello`</span><br><span class=\"line\">b='echo $a' </span><br><span class=\"line\">等价于</span><br><span class=\"line\">a='echo hello'</span><br><span class=\"line\">b=eval 'echo $a'</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"引号\"><a href=\"#引号\" class=\"headerlink\" title=\"引号\"></a>引号</h3><table>\n<thead>\n<tr>\n<th style=\"text-align:center\">示例</th>\n<th style=\"text-align:left\">含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">‘ ‘ 单引号</td>\n<td style=\"text-align:left\">剥夺所有字符的特殊含义，如 n=3；echo ‘$n’ -&gt; $n</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">“ “ 双引号</td>\n<td style=\"text-align:left\">引号内可参数替换，$和反引号 <code></code></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code></code>反引号</td>\n<td style=\"text-align:left\">用命令替换，即先执行<code></code>内命令，将输出结果暂存，在适当的地方输出</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"重定向\"><a href=\"#重定向\" class=\"headerlink\" title=\"重定向\"></a>重定向</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ehco 'haha' &gt; /tmp/tmp.log 2&gt;&amp;1</span><br></pre></td></tr></table></figure>\n<h2 id=\"常见的服务启动脚本\"><a href=\"#常见的服务启动脚本\" class=\"headerlink\" title=\"常见的服务启动脚本\"></a>常见的服务启动脚本</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\">eval action=\\$$#</span><br><span class=\"line\"></span><br><span class=\"line\">main() &#123;</span><br><span class=\"line\">    case \"$module\" in</span><br><span class=\"line\">        module1)</span><br><span class=\"line\">            start_cmd=\"cmd1\"</span><br><span class=\"line\">            ;;</span><br><span class=\"line\">        module2)</span><br><span class=\"line\">            start_cmd=\"cmd2\"</span><br><span class=\"line\">            ;;</span><br><span class=\"line\">        *)</span><br><span class=\"line\">            echo \"usage: $module &#123;module1|module2&#125;\"</span><br><span class=\"line\">            exit -1</span><br><span class=\"line\">    esac</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">all() &#123;</span><br><span class=\"line\">\t  for module in \"$&#123;modules[@]&#125;\"; do</span><br><span class=\"line\">\t      main</span><br><span class=\"line\">\t      echo</span><br><span class=\"line\">        echo \"[INFO] $module:\"</span><br><span class=\"line\">            echo \"[INFO] processing: $&#123;module&#125; $&#123;action&#125;\"</span><br><span class=\"line\">            echo \"==================\"</span><br><span class=\"line\">            action</span><br><span class=\"line\">            echo \"--------------\"</span><br><span class=\"line\">    done</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">action() &#123;</span><br><span class=\"line\">\tcase \"$action\" in</span><br><span class=\"line\">\t\tstart)</span><br><span class=\"line\">\t\t\tstart</span><br><span class=\"line\">\t\t\tstatus</span><br><span class=\"line\">\t\t\t;;</span><br><span class=\"line\">\t\tstop)</span><br><span class=\"line\">\t\t\tstop</span><br><span class=\"line\">\t\t\t;;</span><br><span class=\"line\">\t\tstatus)</span><br><span class=\"line\">\t\t\tstatus</span><br><span class=\"line\">\t\t\t;;</span><br><span class=\"line\">\t\trestart)</span><br><span class=\"line\">\t\t\tstop</span><br><span class=\"line\">\t\t\tstart</span><br><span class=\"line\">\t\t\tstatus</span><br><span class=\"line\">\t\t\t;;</span><br><span class=\"line\">\t\t*)</span><br><span class=\"line\">\t\t\techo \"usage: $action &#123;start|stop|status|restart&#125;\"</span><br><span class=\"line\">\t\t\texit -1</span><br><span class=\"line\">\tesac</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">usage() &#123;</span><br><span class=\"line\">    echo \"usage: $0 &#123;all|[module1, ...]&#125; &#123;start|stop|status|restart&#125;\"</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">multiple() &#123;</span><br><span class=\"line\">    total=$#</span><br><span class=\"line\">    action=$&#123;!total&#125;</span><br><span class=\"line\">    for (( i=1; i&lt;total; i++)); do</span><br><span class=\"line\">        module=$&#123;!i//\\//&#125;</span><br><span class=\"line\">        main</span><br><span class=\"line\">\t     echo \"[INFO] $module:$&#123;start_cmd&#125;\"</span><br><span class=\"line\">        echo \"[INFO] processing: $&#123;module&#125; $&#123;action&#125;\"</span><br><span class=\"line\">        echo \"==================\"</span><br><span class=\"line\">        action</span><br><span class=\"line\">        echo \"--------------\"</span><br><span class=\"line\">    done</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">getpid() &#123;</span><br><span class=\"line\">    if [ ! -d \"pids\" ]; then</span><br><span class=\"line\">        mkdir pids</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    if [ ! -f \"pids/$&#123;module&#125;_pid\" ];then</span><br><span class=\"line\">        echo \"\" &gt; pids/$&#123;module&#125;_pid</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    module_pid=`cat pids/$&#123;module&#125;_pid`</span><br><span class=\"line\"></span><br><span class=\"line\">    pid=`ps aux | grep $&#123;module_pid&#125; | grep -v grep | grep -v $0 | awk '&#123;print $2&#125;'`</span><br><span class=\"line\"></span><br><span class=\"line\">    if [[ -n $&#123;pid&#125; ]]; then</span><br><span class=\"line\">        return 0</span><br><span class=\"line\">    else</span><br><span class=\"line\">        return 1</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">status() &#123;</span><br><span class=\"line\">    getpid</span><br><span class=\"line\">    if [[ -n $&#123;pid&#125; ]]; then</span><br><span class=\"line\">        echo \"status:</span><br><span class=\"line\">        `ps aux | grep $&#123;pid&#125; | grep -v grep`\"</span><br><span class=\"line\">        return 0</span><br><span class=\"line\">    else</span><br><span class=\"line\">        echo \"service not running\"</span><br><span class=\"line\">        return 1</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">start() &#123;</span><br><span class=\"line\">    getpid</span><br><span class=\"line\">    if [[ $? -eq 1 ]]; then</span><br><span class=\"line\">        eval $start_cmd</span><br><span class=\"line\">        echo $!&gt;pids/$&#123;module&#125;_pid</span><br><span class=\"line\">        getpid</span><br><span class=\"line\">        if [[ $? -eq 0 ]]; then</span><br><span class=\"line\">            echo \"service start sucessfully. pid: $&#123;pid&#125;\"</span><br><span class=\"line\">        else</span><br><span class=\"line\">            echo \"service start failed\"</span><br><span class=\"line\">        fi</span><br><span class=\"line\">    else</span><br><span class=\"line\">        echo \"service already started. pid: $&#123;pid&#125;\"</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">stop() &#123;</span><br><span class=\"line\">    getpid</span><br><span class=\"line\">    if [[ -n $&#123;pid&#125; ]]; then</span><br><span class=\"line\">        echo \"killing:</span><br><span class=\"line\">        `ps aux | grep $&#123;pid&#125; | grep -v grep`\"</span><br><span class=\"line\">        kill -9 $&#123;pid&#125; &amp;&amp; sleep 0.01</span><br><span class=\"line\">\t\t    getpid</span><br><span class=\"line\">        if [[ $? -eq 1 ]]; then</span><br><span class=\"line\">            echo \"killed\"</span><br><span class=\"line\">        else</span><br><span class=\"line\">            echo \"kill error\"</span><br><span class=\"line\">        fi</span><br><span class=\"line\">    else</span><br><span class=\"line\">        echo \"service not running\"</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">case \"$1\" in</span><br><span class=\"line\">    all)</span><br><span class=\"line\">        all $@</span><br><span class=\"line\">        ;;</span><br><span class=\"line\">    usage)</span><br><span class=\"line\">        usage</span><br><span class=\"line\">        ;;</span><br><span class=\"line\">    *)</span><br><span class=\"line\">        multiple $@</span><br><span class=\"line\">        ;;</span><br><span class=\"line\">esac</span><br></pre></td></tr></table></figure>\n<ul>\n<li>注意服务启动间隔如果不加<code>sleep 0.01</code>，可能会导致获取服务状态异常，即杀掉服务需要一定的信号处理时间</li>\n</ul>\n<h2 id=\"开机启动\"><a href=\"#开机启动\" class=\"headerlink\" title=\"开机启动\"></a>开机启动</h2><ul>\n<li>将启动指令配置进/etc/rc.d/rc.local</li>\n<li>注意，任何一个脚本执行失败，即exit非0，将导致该shell session内的所有启动服务失败，而如何配置在rc.local中的指令exit非0，将导致整个系统初始化失败</li>\n</ul>\n","site":{"data":{}},"excerpt":"<div class=\"note info\"><p>从开始接触linux，或多或少会使用到shell，这篇文章用来整理下用过的shell语法，和比较常见的套路。</p></div>","more":"<h2 id=\"常用语法\"><a href=\"#常用语法\" class=\"headerlink\" title=\"常用语法\"></a>常用语法</h2><h3 id=\"test\"><a href=\"#test\" class=\"headerlink\" title=\"test\"></a>test</h3><ul>\n<li><p>用于检查某个条件是否成立，它可以进行数值、字符和文件三个方面的测试</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if test  -e startup.sh ;then </span><br><span class=\"line\">等价于</span><br><span class=\"line\">if [[ -e startup.sh ]];then</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>注意：可以使用[[]]就不要使用[]，[[]]兼容在命令中使用&amp;&amp;、||、&lt;和&gt; 等操作符</p>\n</li>\n</ul>\n<h3 id=\"数组\"><a href=\"#数组\" class=\"headerlink\" title=\"数组\"></a>数组</h3><ul>\n<li><p>定义数组</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">modules=(bond-web bifrost model-engine gaeaproxy)</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>获取数组所有元素，@可被*替换</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\">&#123;modules[@]&#125;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>遍历数组</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">for module in \"$&#123;modules[@]&#125;\"; do</span><br><span class=\"line\">echo $module</span><br><span class=\"line\">done</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>读取数组指定元素</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\">&#123;modules[index]&#125;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>数组长度</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@可被*替换|$&#123;#my_array[@]&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"变量\"><a href=\"#变量\" class=\"headerlink\" title=\"变量\"></a>变量</h3><ul>\n<li><p>全局变量</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 全局变量的作用域是当前的进程，而不是前端的shell脚本文件</span></span><br><span class=\"line\">a=1</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>局部变量</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">local a=1</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>环境变量</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export a=1</span><br><span class=\"line\">作用域为当前shell进程和其子进程</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>特殊变量</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">示例</th>\n<th style=\"text-align:left\">变量含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">$@</td>\n<td style=\"text-align:left\">所有入参，可以通过set设置 set 11 22 33 44</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">$#</td>\n<td style=\"text-align:left\">参数个数</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">$?</td>\n<td style=\"text-align:left\">上个命令的退出状态</td>\n<td>函数的返回值</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">$$</td>\n<td style=\"text-align:left\">当前shell进程的ID</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">$!</td>\n<td style=\"text-align:left\">Shell最后运行的后台Process的PID</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">total=$#｜action=${!total}</td>\n<td style=\"text-align:left\">获取最后一个参数，也可通过eval action=\\$$#</td>\n</tr>\n</tbody>\n</table>\n<p>｜` `｜指令定义，相较于’’，<code></code>会预执行，在指令嵌套时经常用到｜<br>｜echo $aa | echo ${aa}｜读取变量｜<br>｜$((2+3)) ｜进行整数运算｜</p>\n<h3 id=\"eval\"><a href=\"#eval\" class=\"headerlink\" title=\"eval\"></a>eval</h3><ul>\n<li>该命令对变量进行两次扫描<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a=`echo hello`</span><br><span class=\"line\">b='echo $a' </span><br><span class=\"line\">等价于</span><br><span class=\"line\">a='echo hello'</span><br><span class=\"line\">b=eval 'echo $a'</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"引号\"><a href=\"#引号\" class=\"headerlink\" title=\"引号\"></a>引号</h3><table>\n<thead>\n<tr>\n<th style=\"text-align:center\">示例</th>\n<th style=\"text-align:left\">含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">‘ ‘ 单引号</td>\n<td style=\"text-align:left\">剥夺所有字符的特殊含义，如 n=3；echo ‘$n’ -&gt; $n</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">“ “ 双引号</td>\n<td style=\"text-align:left\">引号内可参数替换，$和反引号 <code></code></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code></code>反引号</td>\n<td style=\"text-align:left\">用命令替换，即先执行<code></code>内命令，将输出结果暂存，在适当的地方输出</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"重定向\"><a href=\"#重定向\" class=\"headerlink\" title=\"重定向\"></a>重定向</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ehco 'haha' &gt; /tmp/tmp.log 2&gt;&amp;1</span><br></pre></td></tr></table></figure>\n<h2 id=\"常见的服务启动脚本\"><a href=\"#常见的服务启动脚本\" class=\"headerlink\" title=\"常见的服务启动脚本\"></a>常见的服务启动脚本</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\">eval action=\\$$#</span><br><span class=\"line\"></span><br><span class=\"line\">main() &#123;</span><br><span class=\"line\">    case \"$module\" in</span><br><span class=\"line\">        module1)</span><br><span class=\"line\">            start_cmd=\"cmd1\"</span><br><span class=\"line\">            ;;</span><br><span class=\"line\">        module2)</span><br><span class=\"line\">            start_cmd=\"cmd2\"</span><br><span class=\"line\">            ;;</span><br><span class=\"line\">        *)</span><br><span class=\"line\">            echo \"usage: $module &#123;module1|module2&#125;\"</span><br><span class=\"line\">            exit -1</span><br><span class=\"line\">    esac</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">all() &#123;</span><br><span class=\"line\">\t  for module in \"$&#123;modules[@]&#125;\"; do</span><br><span class=\"line\">\t      main</span><br><span class=\"line\">\t      echo</span><br><span class=\"line\">        echo \"[INFO] $module:\"</span><br><span class=\"line\">            echo \"[INFO] processing: $&#123;module&#125; $&#123;action&#125;\"</span><br><span class=\"line\">            echo \"==================\"</span><br><span class=\"line\">            action</span><br><span class=\"line\">            echo \"--------------\"</span><br><span class=\"line\">    done</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">action() &#123;</span><br><span class=\"line\">\tcase \"$action\" in</span><br><span class=\"line\">\t\tstart)</span><br><span class=\"line\">\t\t\tstart</span><br><span class=\"line\">\t\t\tstatus</span><br><span class=\"line\">\t\t\t;;</span><br><span class=\"line\">\t\tstop)</span><br><span class=\"line\">\t\t\tstop</span><br><span class=\"line\">\t\t\t;;</span><br><span class=\"line\">\t\tstatus)</span><br><span class=\"line\">\t\t\tstatus</span><br><span class=\"line\">\t\t\t;;</span><br><span class=\"line\">\t\trestart)</span><br><span class=\"line\">\t\t\tstop</span><br><span class=\"line\">\t\t\tstart</span><br><span class=\"line\">\t\t\tstatus</span><br><span class=\"line\">\t\t\t;;</span><br><span class=\"line\">\t\t*)</span><br><span class=\"line\">\t\t\techo \"usage: $action &#123;start|stop|status|restart&#125;\"</span><br><span class=\"line\">\t\t\texit -1</span><br><span class=\"line\">\tesac</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">usage() &#123;</span><br><span class=\"line\">    echo \"usage: $0 &#123;all|[module1, ...]&#125; &#123;start|stop|status|restart&#125;\"</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">multiple() &#123;</span><br><span class=\"line\">    total=$#</span><br><span class=\"line\">    action=$&#123;!total&#125;</span><br><span class=\"line\">    for (( i=1; i&lt;total; i++)); do</span><br><span class=\"line\">        module=$&#123;!i//\\//&#125;</span><br><span class=\"line\">        main</span><br><span class=\"line\">\t     echo \"[INFO] $module:$&#123;start_cmd&#125;\"</span><br><span class=\"line\">        echo \"[INFO] processing: $&#123;module&#125; $&#123;action&#125;\"</span><br><span class=\"line\">        echo \"==================\"</span><br><span class=\"line\">        action</span><br><span class=\"line\">        echo \"--------------\"</span><br><span class=\"line\">    done</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">getpid() &#123;</span><br><span class=\"line\">    if [ ! -d \"pids\" ]; then</span><br><span class=\"line\">        mkdir pids</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    if [ ! -f \"pids/$&#123;module&#125;_pid\" ];then</span><br><span class=\"line\">        echo \"\" &gt; pids/$&#123;module&#125;_pid</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    module_pid=`cat pids/$&#123;module&#125;_pid`</span><br><span class=\"line\"></span><br><span class=\"line\">    pid=`ps aux | grep $&#123;module_pid&#125; | grep -v grep | grep -v $0 | awk '&#123;print $2&#125;'`</span><br><span class=\"line\"></span><br><span class=\"line\">    if [[ -n $&#123;pid&#125; ]]; then</span><br><span class=\"line\">        return 0</span><br><span class=\"line\">    else</span><br><span class=\"line\">        return 1</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">status() &#123;</span><br><span class=\"line\">    getpid</span><br><span class=\"line\">    if [[ -n $&#123;pid&#125; ]]; then</span><br><span class=\"line\">        echo \"status:</span><br><span class=\"line\">        `ps aux | grep $&#123;pid&#125; | grep -v grep`\"</span><br><span class=\"line\">        return 0</span><br><span class=\"line\">    else</span><br><span class=\"line\">        echo \"service not running\"</span><br><span class=\"line\">        return 1</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">start() &#123;</span><br><span class=\"line\">    getpid</span><br><span class=\"line\">    if [[ $? -eq 1 ]]; then</span><br><span class=\"line\">        eval $start_cmd</span><br><span class=\"line\">        echo $!&gt;pids/$&#123;module&#125;_pid</span><br><span class=\"line\">        getpid</span><br><span class=\"line\">        if [[ $? -eq 0 ]]; then</span><br><span class=\"line\">            echo \"service start sucessfully. pid: $&#123;pid&#125;\"</span><br><span class=\"line\">        else</span><br><span class=\"line\">            echo \"service start failed\"</span><br><span class=\"line\">        fi</span><br><span class=\"line\">    else</span><br><span class=\"line\">        echo \"service already started. pid: $&#123;pid&#125;\"</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">stop() &#123;</span><br><span class=\"line\">    getpid</span><br><span class=\"line\">    if [[ -n $&#123;pid&#125; ]]; then</span><br><span class=\"line\">        echo \"killing:</span><br><span class=\"line\">        `ps aux | grep $&#123;pid&#125; | grep -v grep`\"</span><br><span class=\"line\">        kill -9 $&#123;pid&#125; &amp;&amp; sleep 0.01</span><br><span class=\"line\">\t\t    getpid</span><br><span class=\"line\">        if [[ $? -eq 1 ]]; then</span><br><span class=\"line\">            echo \"killed\"</span><br><span class=\"line\">        else</span><br><span class=\"line\">            echo \"kill error\"</span><br><span class=\"line\">        fi</span><br><span class=\"line\">    else</span><br><span class=\"line\">        echo \"service not running\"</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">case \"$1\" in</span><br><span class=\"line\">    all)</span><br><span class=\"line\">        all $@</span><br><span class=\"line\">        ;;</span><br><span class=\"line\">    usage)</span><br><span class=\"line\">        usage</span><br><span class=\"line\">        ;;</span><br><span class=\"line\">    *)</span><br><span class=\"line\">        multiple $@</span><br><span class=\"line\">        ;;</span><br><span class=\"line\">esac</span><br></pre></td></tr></table></figure>\n<ul>\n<li>注意服务启动间隔如果不加<code>sleep 0.01</code>，可能会导致获取服务状态异常，即杀掉服务需要一定的信号处理时间</li>\n</ul>\n<h2 id=\"开机启动\"><a href=\"#开机启动\" class=\"headerlink\" title=\"开机启动\"></a>开机启动</h2><ul>\n<li>将启动指令配置进/etc/rc.d/rc.local</li>\n<li>注意，任何一个脚本执行失败，即exit非0，将导致该shell session内的所有启动服务失败，而如何配置在rc.local中的指令exit非0，将导致整个系统初始化失败</li>\n</ul>"},{"title":"jenkins前后端分离部署","date":"2020-04-09T12:24:23.000Z","_content":"{%note info%}\n解放手动挡部署，丰衣足食。\n{%endnote%}\n<!--more-->\n\n## 简介\n- 大名鼎鼎jenkins，CI/CD的概念咱就不赘述了，打舌。\n\n## Jenkins的安装及配置\n### Docker环境下的安装\n- 下载Jenkins的Docker镜像：\n\n```bash\ndocker pull jenkins/jenkins:lts\n```\n- 在Docker容器中运行Jenkins：\n\n```bash\ndocker run -p 8080:8080 -p 50000:5000 --name jenkins \\\n-u root \\\n-v /var/jenkins_home:/var/jenkins_home \\\n-d jenkins/jenkins:lts\n```\n- `这点很重要`，配置都在jenkins_home,若需重新挂载,拷贝jenkins_home即可\n\n```\n# 重新封装镜像\ndocker commit 8ba98fd637f6 registry.xx.me/jenkins:latest\n```\n### Jenkins的配置\n运行成功后访问该地址登录Jenkins，第一次登录需要输入管理员密码：http://x.x.x.x:8080/\n![第一次登陆jenkins.jpg](https://i.loli.net/2020/04/10/1XdODQlbnmyTvzr.jpg)\n- 使用管理员密码进行登录，可以使用以下命令从容器启动日志中获取管理密码：\n\n```bash\ndocker logs jenkins\n```\n- 选择安装插件方式，这里我们直接安装推荐的插件：\n选择`安装推荐插件`即可\n- 根据引导提示进行配置，确保插件`Publish Over SSH`，`git`已被安装\n- 在系统管理->系统配置中添加全局ssh的配置，这样Jenkins使用ssh就可以执行远程的linux脚本了：\n![系统全局ssh配置.jpg](https://i.loli.net/2020/04/10/B4KIDoxwch5zpr9.jpg)\n`Homename`为ip\n可以通过ssh公钥的方式在`Key`中填写\n也可以使用账号密码，在`高级`中填写\n注意这里的`Remote Directory\t`会成功后续job中指定脚本环境的初始目录\n\n## 前端部署\n### 环境准备\n- 部署主机需要安装npm，nodejs\n\n```bash\nyum install nodejs npm\n```\n\n### 执行脚本准备\n```bash\n#!/bin/bash\ncd /home/user/deploy/web-front\nnpm run build\n```\n### 在Jenkins中创建执行任务\n- 首先我们需要新建一个任务：\n![新建任务.jpg](https://i.loli.net/2020/04/10/y2tqSXwnorHRsBf.jpg)\n- 指定`自由风格软件`\n![自由风格软件.jpg](https://i.loli.net/2020/04/10/B9YsoD6AbOqckiM.jpg)\n- 设置源代码管理\n![添加源代码管理.jpg](https://i.loli.net/2020/04/10/v1proYaW8VUSTlq.jpg)\n- 之后添加一个执行远程shell脚本的构建，用于编译前端代码\n![设置构建脚本.png](https://i.loli.net/2020/04/10/pmdsiUYu2teTBG8.png)\n\n## 后端部署\n### 环境准备\n- 可以选择在部署主机编译源代码，将编译好的包传入容器\n- 也可以在容器内编译，省去宿主机的环境搭建\n\n### 执行脚本准备\n```bash\n#!/bin/bash\nWORKSPACE=/home/tdops/jenkins_home/workspace\nENV=$1 # 可以指定对应环境的配置文件\nAPP_NAME=web\nCODE_DIR=/home/user/jenkins/${APP_NAME}\nDOCKER_BUILD_DIR=${CODE_DIR}/web\nCORE_DIR=${DOCKER_BUILD_DIR}/core\nWORK_DIR=/home/tdops/deploy/${APP_NAME}\nIMAGE_NAME=registry.xx.me/${APP_NAME}\nLATEST_IMAGE=${IMAGE_NAME}:latest\nDATE_TAG=`date +%Y%m%d`\nEXPOSE_PORT=8089\nEXPOSE_PORT_GRPC=5555\n\nbuild_image_and_push() {\n  # make package\n  cd ${CORE_DIR} && mvn clean install -U\n\n  if [[ $? -ne 0 ]]; then\n      echo \"maven打包失败\" && exit 1\n  fi\n\n  # build docker image\n  cd ${DOCKER_BUILD_DIR} && docker build -t ${LATEST_IMAGE} .\n  echo '----build image----'\n\n  # docker tag\n  docker tag ${LATEST_IMAGE} ${IMAGE_NAME}:${DATE_TAG}\n  echo '----tag image----'\n\n  # docker push\n  docker push ${LATEST_IMAGE}\n  docker push ${IMAGE_NAME}:${DATE_TAG}\n  echo '----push image----'\n}\n\npull_image() {\n  docker pull ${LATEST_IMAGE}\n  echo '----pull image----'\n}\n\nrestart_server() {\n  # docker stop\n  echo '----stop container----'\n  docker stop ${APP_NAME}\n\n  # docker rm\n  echo '----rm container----'\n  docker rm ${APP_NAME}\n\n  # docker run\n  echo '----start container----'\n  docker run -d -it -p ${EXPOSE_PORT}:8089 -p ${EXPOSE_PORT_GRPC}:5555 -e DEPLOY_ENV=${ENV} -v ${WORK_DIR}:/home/admin/${APP_NAME}/log --name ${APP_NAME} ${LATEST_IMAGE} bash\n}\n\nif [[ ! ${ENV} ]]; then\n  build_image_and_push\nelse\n  pull_image\n  restart_server\nfi\n```\n\n\n### 在Jenkins中创建执行任务\n\n- 任务的设置和前端的部署任务类似\n\n## 网关\n- 一般前后端分离项目会使用nginx做静态资源的服务方，并对后端服务做反向代理\n- 简单的提供个配置文件做为例子：\n\n```\nuser admin;\nworker_processes auto;\nerror_log /var/log/nginx/error.log;\npid /run/nginx.pid;\n\nevents {\n    worker_connections 1024;\n}\n\nhttp {\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\n    types_hash_max_size 2048;\n    client_max_body_size 2g;\n\n    include               /etc/nginx/mime.types;\n    default_type          application/octet-stream;\n    client_body_temp_path /usr/share/nginx/html/nginx_file;\n\n    server {\n        listen 8080;\n        server_name mydomain.com;\n        root /usr/share/nginx/html; \n        location / {\n            try_files $uri /index.html;\n        }\n\n        location ^~ /api {\n            proxy_set_header X-Forwarded-For $remote_addr;\n            proxy_pass http://web-server:8089/api;\n        }\n   }\n}\n```\n\n- docker 运行命令为：\n\n```\ndocker run \\\n  --name nginx \\\n  -it -d -p 8080:8080 \\\n  -v /home/user/deploy/web-front/dist:/usr/share/nginx/html \\\n  -v /home/user/deploy/nginx/nginx.conf:/etc/nginx/nginx.conf \\\n  -v /home/user/deploy/nginx/conf.d:/etc/nginx/conf.d \\\n  -v /home/user/deploy/nginx/log:/var/log/nginx \\\n  --link web-server \\\n  nginx:latest\n```\n\n## 问题记录\n1. No valid crumb was included in the request\n*解决方案*：\n  - 在jenkins 的Configure Global Security下 , 取消“防止跨站点请求伪造（Prevent Cross Site Request Forgery exploits）”的勾选\n2. 插件下载过慢，失败\n*解决方案*：\n  - 修改下载源,jenkins_home/updates/default.json\n```\nsed -i 's/http:\\/\\/updates.jenkins-ci.org\\/download/https:\\/\\/mirrors.tuna.tsinghua.edu.cn\\/jenkins/g' default.json && sed -i 's/http:\\/\\/www.google.com/https:\\/\\/www.baidu.com/g' default.json\n```\n3. mvn 未找到命令\n*解决方案*：\n  - 设置环境变量：\n```\nsource /etc/profile\nsource ~/.bash_profile\n```\n  - 或者 在/usr/bin下创建软链接\n```\nln –s /opt/maven/bin/mvn /usr/bin/mvn\n```\n","source":"_posts/2020-04-09-jenkins前后端分离部署.md","raw":"---\ntitle: jenkins前后端分离部署\ndate: 2020-04-09 20:24:23\ntags: jenkins\ncategories: 部署\n---\n{%note info%}\n解放手动挡部署，丰衣足食。\n{%endnote%}\n<!--more-->\n\n## 简介\n- 大名鼎鼎jenkins，CI/CD的概念咱就不赘述了，打舌。\n\n## Jenkins的安装及配置\n### Docker环境下的安装\n- 下载Jenkins的Docker镜像：\n\n```bash\ndocker pull jenkins/jenkins:lts\n```\n- 在Docker容器中运行Jenkins：\n\n```bash\ndocker run -p 8080:8080 -p 50000:5000 --name jenkins \\\n-u root \\\n-v /var/jenkins_home:/var/jenkins_home \\\n-d jenkins/jenkins:lts\n```\n- `这点很重要`，配置都在jenkins_home,若需重新挂载,拷贝jenkins_home即可\n\n```\n# 重新封装镜像\ndocker commit 8ba98fd637f6 registry.xx.me/jenkins:latest\n```\n### Jenkins的配置\n运行成功后访问该地址登录Jenkins，第一次登录需要输入管理员密码：http://x.x.x.x:8080/\n![第一次登陆jenkins.jpg](https://i.loli.net/2020/04/10/1XdODQlbnmyTvzr.jpg)\n- 使用管理员密码进行登录，可以使用以下命令从容器启动日志中获取管理密码：\n\n```bash\ndocker logs jenkins\n```\n- 选择安装插件方式，这里我们直接安装推荐的插件：\n选择`安装推荐插件`即可\n- 根据引导提示进行配置，确保插件`Publish Over SSH`，`git`已被安装\n- 在系统管理->系统配置中添加全局ssh的配置，这样Jenkins使用ssh就可以执行远程的linux脚本了：\n![系统全局ssh配置.jpg](https://i.loli.net/2020/04/10/B4KIDoxwch5zpr9.jpg)\n`Homename`为ip\n可以通过ssh公钥的方式在`Key`中填写\n也可以使用账号密码，在`高级`中填写\n注意这里的`Remote Directory\t`会成功后续job中指定脚本环境的初始目录\n\n## 前端部署\n### 环境准备\n- 部署主机需要安装npm，nodejs\n\n```bash\nyum install nodejs npm\n```\n\n### 执行脚本准备\n```bash\n#!/bin/bash\ncd /home/user/deploy/web-front\nnpm run build\n```\n### 在Jenkins中创建执行任务\n- 首先我们需要新建一个任务：\n![新建任务.jpg](https://i.loli.net/2020/04/10/y2tqSXwnorHRsBf.jpg)\n- 指定`自由风格软件`\n![自由风格软件.jpg](https://i.loli.net/2020/04/10/B9YsoD6AbOqckiM.jpg)\n- 设置源代码管理\n![添加源代码管理.jpg](https://i.loli.net/2020/04/10/v1proYaW8VUSTlq.jpg)\n- 之后添加一个执行远程shell脚本的构建，用于编译前端代码\n![设置构建脚本.png](https://i.loli.net/2020/04/10/pmdsiUYu2teTBG8.png)\n\n## 后端部署\n### 环境准备\n- 可以选择在部署主机编译源代码，将编译好的包传入容器\n- 也可以在容器内编译，省去宿主机的环境搭建\n\n### 执行脚本准备\n```bash\n#!/bin/bash\nWORKSPACE=/home/tdops/jenkins_home/workspace\nENV=$1 # 可以指定对应环境的配置文件\nAPP_NAME=web\nCODE_DIR=/home/user/jenkins/${APP_NAME}\nDOCKER_BUILD_DIR=${CODE_DIR}/web\nCORE_DIR=${DOCKER_BUILD_DIR}/core\nWORK_DIR=/home/tdops/deploy/${APP_NAME}\nIMAGE_NAME=registry.xx.me/${APP_NAME}\nLATEST_IMAGE=${IMAGE_NAME}:latest\nDATE_TAG=`date +%Y%m%d`\nEXPOSE_PORT=8089\nEXPOSE_PORT_GRPC=5555\n\nbuild_image_and_push() {\n  # make package\n  cd ${CORE_DIR} && mvn clean install -U\n\n  if [[ $? -ne 0 ]]; then\n      echo \"maven打包失败\" && exit 1\n  fi\n\n  # build docker image\n  cd ${DOCKER_BUILD_DIR} && docker build -t ${LATEST_IMAGE} .\n  echo '----build image----'\n\n  # docker tag\n  docker tag ${LATEST_IMAGE} ${IMAGE_NAME}:${DATE_TAG}\n  echo '----tag image----'\n\n  # docker push\n  docker push ${LATEST_IMAGE}\n  docker push ${IMAGE_NAME}:${DATE_TAG}\n  echo '----push image----'\n}\n\npull_image() {\n  docker pull ${LATEST_IMAGE}\n  echo '----pull image----'\n}\n\nrestart_server() {\n  # docker stop\n  echo '----stop container----'\n  docker stop ${APP_NAME}\n\n  # docker rm\n  echo '----rm container----'\n  docker rm ${APP_NAME}\n\n  # docker run\n  echo '----start container----'\n  docker run -d -it -p ${EXPOSE_PORT}:8089 -p ${EXPOSE_PORT_GRPC}:5555 -e DEPLOY_ENV=${ENV} -v ${WORK_DIR}:/home/admin/${APP_NAME}/log --name ${APP_NAME} ${LATEST_IMAGE} bash\n}\n\nif [[ ! ${ENV} ]]; then\n  build_image_and_push\nelse\n  pull_image\n  restart_server\nfi\n```\n\n\n### 在Jenkins中创建执行任务\n\n- 任务的设置和前端的部署任务类似\n\n## 网关\n- 一般前后端分离项目会使用nginx做静态资源的服务方，并对后端服务做反向代理\n- 简单的提供个配置文件做为例子：\n\n```\nuser admin;\nworker_processes auto;\nerror_log /var/log/nginx/error.log;\npid /run/nginx.pid;\n\nevents {\n    worker_connections 1024;\n}\n\nhttp {\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\n    types_hash_max_size 2048;\n    client_max_body_size 2g;\n\n    include               /etc/nginx/mime.types;\n    default_type          application/octet-stream;\n    client_body_temp_path /usr/share/nginx/html/nginx_file;\n\n    server {\n        listen 8080;\n        server_name mydomain.com;\n        root /usr/share/nginx/html; \n        location / {\n            try_files $uri /index.html;\n        }\n\n        location ^~ /api {\n            proxy_set_header X-Forwarded-For $remote_addr;\n            proxy_pass http://web-server:8089/api;\n        }\n   }\n}\n```\n\n- docker 运行命令为：\n\n```\ndocker run \\\n  --name nginx \\\n  -it -d -p 8080:8080 \\\n  -v /home/user/deploy/web-front/dist:/usr/share/nginx/html \\\n  -v /home/user/deploy/nginx/nginx.conf:/etc/nginx/nginx.conf \\\n  -v /home/user/deploy/nginx/conf.d:/etc/nginx/conf.d \\\n  -v /home/user/deploy/nginx/log:/var/log/nginx \\\n  --link web-server \\\n  nginx:latest\n```\n\n## 问题记录\n1. No valid crumb was included in the request\n*解决方案*：\n  - 在jenkins 的Configure Global Security下 , 取消“防止跨站点请求伪造（Prevent Cross Site Request Forgery exploits）”的勾选\n2. 插件下载过慢，失败\n*解决方案*：\n  - 修改下载源,jenkins_home/updates/default.json\n```\nsed -i 's/http:\\/\\/updates.jenkins-ci.org\\/download/https:\\/\\/mirrors.tuna.tsinghua.edu.cn\\/jenkins/g' default.json && sed -i 's/http:\\/\\/www.google.com/https:\\/\\/www.baidu.com/g' default.json\n```\n3. mvn 未找到命令\n*解决方案*：\n  - 设置环境变量：\n```\nsource /etc/profile\nsource ~/.bash_profile\n```\n  - 或者 在/usr/bin下创建软链接\n```\nln –s /opt/maven/bin/mvn /usr/bin/mvn\n```\n","slug":"jenkins前后端分离部署","published":1,"updated":"2020-07-25T07:06:48.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckezigl86001g1gp7rxet6n2s","content":"<div class=\"note info\"><p>解放手动挡部署，丰衣足食。</p></div>\n<a id=\"more\"></a>\n<h2 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h2><ul>\n<li>大名鼎鼎jenkins，CI/CD的概念咱就不赘述了，打舌。</li>\n</ul>\n<h2 id=\"Jenkins的安装及配置\"><a href=\"#Jenkins的安装及配置\" class=\"headerlink\" title=\"Jenkins的安装及配置\"></a>Jenkins的安装及配置</h2><h3 id=\"Docker环境下的安装\"><a href=\"#Docker环境下的安装\" class=\"headerlink\" title=\"Docker环境下的安装\"></a>Docker环境下的安装</h3><ul>\n<li>下载Jenkins的Docker镜像：</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull jenkins/jenkins:lts</span><br></pre></td></tr></table></figure>\n<ul>\n<li>在Docker容器中运行Jenkins：</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -p 8080:8080 -p 50000:5000 --name jenkins \\</span><br><span class=\"line\">-u root \\</span><br><span class=\"line\">-v /var/jenkins_home:/var/jenkins_home \\</span><br><span class=\"line\">-d jenkins/jenkins:lts</span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>这点很重要</code>，配置都在jenkins_home,若需重新挂载,拷贝jenkins_home即可</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 重新封装镜像</span><br><span class=\"line\">docker commit 8ba98fd637f6 registry.xx.me/jenkins:latest</span><br></pre></td></tr></table></figure>\n<h3 id=\"Jenkins的配置\"><a href=\"#Jenkins的配置\" class=\"headerlink\" title=\"Jenkins的配置\"></a>Jenkins的配置</h3><p>运行成功后访问该地址登录Jenkins，第一次登录需要输入管理员密码：<a href=\"http://x.x.x.x:8080/\" target=\"_blank\" rel=\"noopener\">http://x.x.x.x:8080/</a><br><img src=\"https://i.loli.net/2020/04/10/1XdODQlbnmyTvzr.jpg\" alt=\"第一次登陆jenkins.jpg\"></p>\n<ul>\n<li>使用管理员密码进行登录，可以使用以下命令从容器启动日志中获取管理密码：</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker logs jenkins</span><br></pre></td></tr></table></figure>\n<ul>\n<li>选择安装插件方式，这里我们直接安装推荐的插件：<br>选择<code>安装推荐插件</code>即可</li>\n<li>根据引导提示进行配置，确保插件<code>Publish Over SSH</code>，<code>git</code>已被安装</li>\n<li>在系统管理-&gt;系统配置中添加全局ssh的配置，这样Jenkins使用ssh就可以执行远程的linux脚本了：<br><img src=\"https://i.loli.net/2020/04/10/B4KIDoxwch5zpr9.jpg\" alt=\"系统全局ssh配置.jpg\"><br><code>Homename</code>为ip<br>可以通过ssh公钥的方式在<code>Key</code>中填写<br>也可以使用账号密码，在<code>高级</code>中填写<br>注意这里的<code>Remote Directory</code>会成功后续job中指定脚本环境的初始目录</li>\n</ul>\n<h2 id=\"前端部署\"><a href=\"#前端部署\" class=\"headerlink\" title=\"前端部署\"></a>前端部署</h2><h3 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h3><ul>\n<li>部署主机需要安装npm，nodejs</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install nodejs npm</span><br></pre></td></tr></table></figure>\n<h3 id=\"执行脚本准备\"><a href=\"#执行脚本准备\" class=\"headerlink\" title=\"执行脚本准备\"></a>执行脚本准备</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /home/user/deploy/web-front</span><br><span class=\"line\">npm run build</span><br></pre></td></tr></table></figure>\n<h3 id=\"在Jenkins中创建执行任务\"><a href=\"#在Jenkins中创建执行任务\" class=\"headerlink\" title=\"在Jenkins中创建执行任务\"></a>在Jenkins中创建执行任务</h3><ul>\n<li>首先我们需要新建一个任务：<br><img src=\"https://i.loli.net/2020/04/10/y2tqSXwnorHRsBf.jpg\" alt=\"新建任务.jpg\"></li>\n<li>指定<code>自由风格软件</code><br><img src=\"https://i.loli.net/2020/04/10/B9YsoD6AbOqckiM.jpg\" alt=\"自由风格软件.jpg\"></li>\n<li>设置源代码管理<br><img src=\"https://i.loli.net/2020/04/10/v1proYaW8VUSTlq.jpg\" alt=\"添加源代码管理.jpg\"></li>\n<li>之后添加一个执行远程shell脚本的构建，用于编译前端代码<br><img src=\"https://i.loli.net/2020/04/10/pmdsiUYu2teTBG8.png\" alt=\"设置构建脚本.png\"></li>\n</ul>\n<h2 id=\"后端部署\"><a href=\"#后端部署\" class=\"headerlink\" title=\"后端部署\"></a>后端部署</h2><h3 id=\"环境准备-1\"><a href=\"#环境准备-1\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h3><ul>\n<li>可以选择在部署主机编译源代码，将编译好的包传入容器</li>\n<li>也可以在容器内编译，省去宿主机的环境搭建</li>\n</ul>\n<h3 id=\"执行脚本准备-1\"><a href=\"#执行脚本准备-1\" class=\"headerlink\" title=\"执行脚本准备\"></a>执行脚本准备</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\">WORKSPACE=/home/tdops/jenkins_home/workspace</span><br><span class=\"line\">ENV=<span class=\"variable\">$1</span> <span class=\"comment\"># 可以指定对应环境的配置文件</span></span><br><span class=\"line\">APP_NAME=web</span><br><span class=\"line\">CODE_DIR=/home/user/jenkins/<span class=\"variable\">$&#123;APP_NAME&#125;</span></span><br><span class=\"line\">DOCKER_BUILD_DIR=<span class=\"variable\">$&#123;CODE_DIR&#125;</span>/web</span><br><span class=\"line\">CORE_DIR=<span class=\"variable\">$&#123;DOCKER_BUILD_DIR&#125;</span>/core</span><br><span class=\"line\">WORK_DIR=/home/tdops/deploy/<span class=\"variable\">$&#123;APP_NAME&#125;</span></span><br><span class=\"line\">IMAGE_NAME=registry.xx.me/<span class=\"variable\">$&#123;APP_NAME&#125;</span></span><br><span class=\"line\">LATEST_IMAGE=<span class=\"variable\">$&#123;IMAGE_NAME&#125;</span>:latest</span><br><span class=\"line\">DATE_TAG=`date +%Y%m%d`</span><br><span class=\"line\">EXPOSE_PORT=8089</span><br><span class=\"line\">EXPOSE_PORT_GRPC=5555</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">build_image_and_push</span></span>() &#123;</span><br><span class=\"line\">  <span class=\"comment\"># make package</span></span><br><span class=\"line\">  <span class=\"built_in\">cd</span> <span class=\"variable\">$&#123;CORE_DIR&#125;</span> &amp;&amp; mvn clean install -U</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ $? -ne 0 ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"built_in\">echo</span> <span class=\"string\">\"maven打包失败\"</span> &amp;&amp; <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># build docker image</span></span><br><span class=\"line\">  <span class=\"built_in\">cd</span> <span class=\"variable\">$&#123;DOCKER_BUILD_DIR&#125;</span> &amp;&amp; docker build -t <span class=\"variable\">$&#123;LATEST_IMAGE&#125;</span> .</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">'----build image----'</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># docker tag</span></span><br><span class=\"line\">  docker tag <span class=\"variable\">$&#123;LATEST_IMAGE&#125;</span> <span class=\"variable\">$&#123;IMAGE_NAME&#125;</span>:<span class=\"variable\">$&#123;DATE_TAG&#125;</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">'----tag image----'</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># docker push</span></span><br><span class=\"line\">  docker push <span class=\"variable\">$&#123;LATEST_IMAGE&#125;</span></span><br><span class=\"line\">  docker push <span class=\"variable\">$&#123;IMAGE_NAME&#125;</span>:<span class=\"variable\">$&#123;DATE_TAG&#125;</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">'----push image----'</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">pull_image</span></span>() &#123;</span><br><span class=\"line\">  docker pull <span class=\"variable\">$&#123;LATEST_IMAGE&#125;</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">'----pull image----'</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">restart_server</span></span>() &#123;</span><br><span class=\"line\">  <span class=\"comment\"># docker stop</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">'----stop container----'</span></span><br><span class=\"line\">  docker stop <span class=\"variable\">$&#123;APP_NAME&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># docker rm</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">'----rm container----'</span></span><br><span class=\"line\">  docker rm <span class=\"variable\">$&#123;APP_NAME&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># docker run</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">'----start container----'</span></span><br><span class=\"line\">  docker run -d -it -p <span class=\"variable\">$&#123;EXPOSE_PORT&#125;</span>:8089 -p <span class=\"variable\">$&#123;EXPOSE_PORT_GRPC&#125;</span>:5555 -e DEPLOY_ENV=<span class=\"variable\">$&#123;ENV&#125;</span> -v <span class=\"variable\">$&#123;WORK_DIR&#125;</span>:/home/admin/<span class=\"variable\">$&#123;APP_NAME&#125;</span>/<span class=\"built_in\">log</span> --name <span class=\"variable\">$&#123;APP_NAME&#125;</span> <span class=\"variable\">$&#123;LATEST_IMAGE&#125;</span> bash</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ ! <span class=\"variable\">$&#123;ENV&#125;</span> ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  build_image_and_push</span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">  pull_image</span><br><span class=\"line\">  restart_server</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"在Jenkins中创建执行任务-1\"><a href=\"#在Jenkins中创建执行任务-1\" class=\"headerlink\" title=\"在Jenkins中创建执行任务\"></a>在Jenkins中创建执行任务</h3><ul>\n<li>任务的设置和前端的部署任务类似</li>\n</ul>\n<h2 id=\"网关\"><a href=\"#网关\" class=\"headerlink\" title=\"网关\"></a>网关</h2><ul>\n<li>一般前后端分离项目会使用nginx做静态资源的服务方，并对后端服务做反向代理</li>\n<li>简单的提供个配置文件做为例子：</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">user admin;</span><br><span class=\"line\">worker_processes auto;</span><br><span class=\"line\">error_log /var/log/nginx/error.log;</span><br><span class=\"line\">pid /run/nginx.pid;</span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">    worker_connections 1024;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class=\"line\">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class=\"line\">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class=\"line\"></span><br><span class=\"line\">    access_log  /var/log/nginx/access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">    sendfile            on;</span><br><span class=\"line\">    tcp_nopush          on;</span><br><span class=\"line\">    tcp_nodelay         on;</span><br><span class=\"line\">    keepalive_timeout   65;</span><br><span class=\"line\">    types_hash_max_size 2048;</span><br><span class=\"line\">    client_max_body_size 2g;</span><br><span class=\"line\"></span><br><span class=\"line\">    include               /etc/nginx/mime.types;</span><br><span class=\"line\">    default_type          application/octet-stream;</span><br><span class=\"line\">    client_body_temp_path /usr/share/nginx/html/nginx_file;</span><br><span class=\"line\"></span><br><span class=\"line\">    server &#123;</span><br><span class=\"line\">        listen 8080;</span><br><span class=\"line\">        server_name mydomain.com;</span><br><span class=\"line\">        root /usr/share/nginx/html; </span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">            try_files $uri /index.html;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        location ^~ /api &#123;</span><br><span class=\"line\">            proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class=\"line\">            proxy_pass http://web-server:8089/api;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>docker 运行命令为：</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run \\</span><br><span class=\"line\">  --name nginx \\</span><br><span class=\"line\">  -it -d -p 8080:8080 \\</span><br><span class=\"line\">  -v /home/user/deploy/web-front/dist:/usr/share/nginx/html \\</span><br><span class=\"line\">  -v /home/user/deploy/nginx/nginx.conf:/etc/nginx/nginx.conf \\</span><br><span class=\"line\">  -v /home/user/deploy/nginx/conf.d:/etc/nginx/conf.d \\</span><br><span class=\"line\">  -v /home/user/deploy/nginx/log:/var/log/nginx \\</span><br><span class=\"line\">  --link web-server \\</span><br><span class=\"line\">  nginx:latest</span><br></pre></td></tr></table></figure>\n<h2 id=\"问题记录\"><a href=\"#问题记录\" class=\"headerlink\" title=\"问题记录\"></a>问题记录</h2><ol>\n<li>No valid crumb was included in the request<br><em>解决方案</em>：<ul>\n<li>在jenkins 的Configure Global Security下 , 取消“防止跨站点请求伪造（Prevent Cross Site Request Forgery exploits）”的勾选</li>\n</ul>\n</li>\n<li><p>插件下载过慢，失败<br><em>解决方案</em>：</p>\n<ul>\n<li>修改下载源,jenkins_home/updates/default.json<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sed -i &apos;s/http:\\/\\/updates.jenkins-ci.org\\/download/https:\\/\\/mirrors.tuna.tsinghua.edu.cn\\/jenkins/g&apos; default.json &amp;&amp; sed -i &apos;s/http:\\/\\/www.google.com/https:\\/\\/www.baidu.com/g&apos; default.json</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li><p>mvn 未找到命令<br><em>解决方案</em>：</p>\n<ul>\n<li><p>设置环境变量：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">source /etc/profile</span><br><span class=\"line\">source ~/.bash_profile</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>或者 在/usr/bin下创建软链接</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ln –s /opt/maven/bin/mvn /usr/bin/mvn</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"<div class=\"note info\"><p>解放手动挡部署，丰衣足食。</p></div>","more":"<h2 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h2><ul>\n<li>大名鼎鼎jenkins，CI/CD的概念咱就不赘述了，打舌。</li>\n</ul>\n<h2 id=\"Jenkins的安装及配置\"><a href=\"#Jenkins的安装及配置\" class=\"headerlink\" title=\"Jenkins的安装及配置\"></a>Jenkins的安装及配置</h2><h3 id=\"Docker环境下的安装\"><a href=\"#Docker环境下的安装\" class=\"headerlink\" title=\"Docker环境下的安装\"></a>Docker环境下的安装</h3><ul>\n<li>下载Jenkins的Docker镜像：</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull jenkins/jenkins:lts</span><br></pre></td></tr></table></figure>\n<ul>\n<li>在Docker容器中运行Jenkins：</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -p 8080:8080 -p 50000:5000 --name jenkins \\</span><br><span class=\"line\">-u root \\</span><br><span class=\"line\">-v /var/jenkins_home:/var/jenkins_home \\</span><br><span class=\"line\">-d jenkins/jenkins:lts</span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>这点很重要</code>，配置都在jenkins_home,若需重新挂载,拷贝jenkins_home即可</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 重新封装镜像</span><br><span class=\"line\">docker commit 8ba98fd637f6 registry.xx.me/jenkins:latest</span><br></pre></td></tr></table></figure>\n<h3 id=\"Jenkins的配置\"><a href=\"#Jenkins的配置\" class=\"headerlink\" title=\"Jenkins的配置\"></a>Jenkins的配置</h3><p>运行成功后访问该地址登录Jenkins，第一次登录需要输入管理员密码：<a href=\"http://x.x.x.x:8080/\" target=\"_blank\" rel=\"noopener\">http://x.x.x.x:8080/</a><br><img src=\"https://i.loli.net/2020/04/10/1XdODQlbnmyTvzr.jpg\" alt=\"第一次登陆jenkins.jpg\"></p>\n<ul>\n<li>使用管理员密码进行登录，可以使用以下命令从容器启动日志中获取管理密码：</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker logs jenkins</span><br></pre></td></tr></table></figure>\n<ul>\n<li>选择安装插件方式，这里我们直接安装推荐的插件：<br>选择<code>安装推荐插件</code>即可</li>\n<li>根据引导提示进行配置，确保插件<code>Publish Over SSH</code>，<code>git</code>已被安装</li>\n<li>在系统管理-&gt;系统配置中添加全局ssh的配置，这样Jenkins使用ssh就可以执行远程的linux脚本了：<br><img src=\"https://i.loli.net/2020/04/10/B4KIDoxwch5zpr9.jpg\" alt=\"系统全局ssh配置.jpg\"><br><code>Homename</code>为ip<br>可以通过ssh公钥的方式在<code>Key</code>中填写<br>也可以使用账号密码，在<code>高级</code>中填写<br>注意这里的<code>Remote Directory</code>会成功后续job中指定脚本环境的初始目录</li>\n</ul>\n<h2 id=\"前端部署\"><a href=\"#前端部署\" class=\"headerlink\" title=\"前端部署\"></a>前端部署</h2><h3 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h3><ul>\n<li>部署主机需要安装npm，nodejs</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install nodejs npm</span><br></pre></td></tr></table></figure>\n<h3 id=\"执行脚本准备\"><a href=\"#执行脚本准备\" class=\"headerlink\" title=\"执行脚本准备\"></a>执行脚本准备</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /home/user/deploy/web-front</span><br><span class=\"line\">npm run build</span><br></pre></td></tr></table></figure>\n<h3 id=\"在Jenkins中创建执行任务\"><a href=\"#在Jenkins中创建执行任务\" class=\"headerlink\" title=\"在Jenkins中创建执行任务\"></a>在Jenkins中创建执行任务</h3><ul>\n<li>首先我们需要新建一个任务：<br><img src=\"https://i.loli.net/2020/04/10/y2tqSXwnorHRsBf.jpg\" alt=\"新建任务.jpg\"></li>\n<li>指定<code>自由风格软件</code><br><img src=\"https://i.loli.net/2020/04/10/B9YsoD6AbOqckiM.jpg\" alt=\"自由风格软件.jpg\"></li>\n<li>设置源代码管理<br><img src=\"https://i.loli.net/2020/04/10/v1proYaW8VUSTlq.jpg\" alt=\"添加源代码管理.jpg\"></li>\n<li>之后添加一个执行远程shell脚本的构建，用于编译前端代码<br><img src=\"https://i.loli.net/2020/04/10/pmdsiUYu2teTBG8.png\" alt=\"设置构建脚本.png\"></li>\n</ul>\n<h2 id=\"后端部署\"><a href=\"#后端部署\" class=\"headerlink\" title=\"后端部署\"></a>后端部署</h2><h3 id=\"环境准备-1\"><a href=\"#环境准备-1\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h3><ul>\n<li>可以选择在部署主机编译源代码，将编译好的包传入容器</li>\n<li>也可以在容器内编译，省去宿主机的环境搭建</li>\n</ul>\n<h3 id=\"执行脚本准备-1\"><a href=\"#执行脚本准备-1\" class=\"headerlink\" title=\"执行脚本准备\"></a>执行脚本准备</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\">WORKSPACE=/home/tdops/jenkins_home/workspace</span><br><span class=\"line\">ENV=<span class=\"variable\">$1</span> <span class=\"comment\"># 可以指定对应环境的配置文件</span></span><br><span class=\"line\">APP_NAME=web</span><br><span class=\"line\">CODE_DIR=/home/user/jenkins/<span class=\"variable\">$&#123;APP_NAME&#125;</span></span><br><span class=\"line\">DOCKER_BUILD_DIR=<span class=\"variable\">$&#123;CODE_DIR&#125;</span>/web</span><br><span class=\"line\">CORE_DIR=<span class=\"variable\">$&#123;DOCKER_BUILD_DIR&#125;</span>/core</span><br><span class=\"line\">WORK_DIR=/home/tdops/deploy/<span class=\"variable\">$&#123;APP_NAME&#125;</span></span><br><span class=\"line\">IMAGE_NAME=registry.xx.me/<span class=\"variable\">$&#123;APP_NAME&#125;</span></span><br><span class=\"line\">LATEST_IMAGE=<span class=\"variable\">$&#123;IMAGE_NAME&#125;</span>:latest</span><br><span class=\"line\">DATE_TAG=`date +%Y%m%d`</span><br><span class=\"line\">EXPOSE_PORT=8089</span><br><span class=\"line\">EXPOSE_PORT_GRPC=5555</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">build_image_and_push</span></span>() &#123;</span><br><span class=\"line\">  <span class=\"comment\"># make package</span></span><br><span class=\"line\">  <span class=\"built_in\">cd</span> <span class=\"variable\">$&#123;CORE_DIR&#125;</span> &amp;&amp; mvn clean install -U</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ $? -ne 0 ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"built_in\">echo</span> <span class=\"string\">\"maven打包失败\"</span> &amp;&amp; <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># build docker image</span></span><br><span class=\"line\">  <span class=\"built_in\">cd</span> <span class=\"variable\">$&#123;DOCKER_BUILD_DIR&#125;</span> &amp;&amp; docker build -t <span class=\"variable\">$&#123;LATEST_IMAGE&#125;</span> .</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">'----build image----'</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># docker tag</span></span><br><span class=\"line\">  docker tag <span class=\"variable\">$&#123;LATEST_IMAGE&#125;</span> <span class=\"variable\">$&#123;IMAGE_NAME&#125;</span>:<span class=\"variable\">$&#123;DATE_TAG&#125;</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">'----tag image----'</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># docker push</span></span><br><span class=\"line\">  docker push <span class=\"variable\">$&#123;LATEST_IMAGE&#125;</span></span><br><span class=\"line\">  docker push <span class=\"variable\">$&#123;IMAGE_NAME&#125;</span>:<span class=\"variable\">$&#123;DATE_TAG&#125;</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">'----push image----'</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">pull_image</span></span>() &#123;</span><br><span class=\"line\">  docker pull <span class=\"variable\">$&#123;LATEST_IMAGE&#125;</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">'----pull image----'</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">restart_server</span></span>() &#123;</span><br><span class=\"line\">  <span class=\"comment\"># docker stop</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">'----stop container----'</span></span><br><span class=\"line\">  docker stop <span class=\"variable\">$&#123;APP_NAME&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># docker rm</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">'----rm container----'</span></span><br><span class=\"line\">  docker rm <span class=\"variable\">$&#123;APP_NAME&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># docker run</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">'----start container----'</span></span><br><span class=\"line\">  docker run -d -it -p <span class=\"variable\">$&#123;EXPOSE_PORT&#125;</span>:8089 -p <span class=\"variable\">$&#123;EXPOSE_PORT_GRPC&#125;</span>:5555 -e DEPLOY_ENV=<span class=\"variable\">$&#123;ENV&#125;</span> -v <span class=\"variable\">$&#123;WORK_DIR&#125;</span>:/home/admin/<span class=\"variable\">$&#123;APP_NAME&#125;</span>/<span class=\"built_in\">log</span> --name <span class=\"variable\">$&#123;APP_NAME&#125;</span> <span class=\"variable\">$&#123;LATEST_IMAGE&#125;</span> bash</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ ! <span class=\"variable\">$&#123;ENV&#125;</span> ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  build_image_and_push</span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">  pull_image</span><br><span class=\"line\">  restart_server</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"在Jenkins中创建执行任务-1\"><a href=\"#在Jenkins中创建执行任务-1\" class=\"headerlink\" title=\"在Jenkins中创建执行任务\"></a>在Jenkins中创建执行任务</h3><ul>\n<li>任务的设置和前端的部署任务类似</li>\n</ul>\n<h2 id=\"网关\"><a href=\"#网关\" class=\"headerlink\" title=\"网关\"></a>网关</h2><ul>\n<li>一般前后端分离项目会使用nginx做静态资源的服务方，并对后端服务做反向代理</li>\n<li>简单的提供个配置文件做为例子：</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">user admin;</span><br><span class=\"line\">worker_processes auto;</span><br><span class=\"line\">error_log /var/log/nginx/error.log;</span><br><span class=\"line\">pid /run/nginx.pid;</span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">    worker_connections 1024;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class=\"line\">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class=\"line\">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class=\"line\"></span><br><span class=\"line\">    access_log  /var/log/nginx/access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">    sendfile            on;</span><br><span class=\"line\">    tcp_nopush          on;</span><br><span class=\"line\">    tcp_nodelay         on;</span><br><span class=\"line\">    keepalive_timeout   65;</span><br><span class=\"line\">    types_hash_max_size 2048;</span><br><span class=\"line\">    client_max_body_size 2g;</span><br><span class=\"line\"></span><br><span class=\"line\">    include               /etc/nginx/mime.types;</span><br><span class=\"line\">    default_type          application/octet-stream;</span><br><span class=\"line\">    client_body_temp_path /usr/share/nginx/html/nginx_file;</span><br><span class=\"line\"></span><br><span class=\"line\">    server &#123;</span><br><span class=\"line\">        listen 8080;</span><br><span class=\"line\">        server_name mydomain.com;</span><br><span class=\"line\">        root /usr/share/nginx/html; </span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">            try_files $uri /index.html;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        location ^~ /api &#123;</span><br><span class=\"line\">            proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class=\"line\">            proxy_pass http://web-server:8089/api;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>docker 运行命令为：</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run \\</span><br><span class=\"line\">  --name nginx \\</span><br><span class=\"line\">  -it -d -p 8080:8080 \\</span><br><span class=\"line\">  -v /home/user/deploy/web-front/dist:/usr/share/nginx/html \\</span><br><span class=\"line\">  -v /home/user/deploy/nginx/nginx.conf:/etc/nginx/nginx.conf \\</span><br><span class=\"line\">  -v /home/user/deploy/nginx/conf.d:/etc/nginx/conf.d \\</span><br><span class=\"line\">  -v /home/user/deploy/nginx/log:/var/log/nginx \\</span><br><span class=\"line\">  --link web-server \\</span><br><span class=\"line\">  nginx:latest</span><br></pre></td></tr></table></figure>\n<h2 id=\"问题记录\"><a href=\"#问题记录\" class=\"headerlink\" title=\"问题记录\"></a>问题记录</h2><ol>\n<li>No valid crumb was included in the request<br><em>解决方案</em>：<ul>\n<li>在jenkins 的Configure Global Security下 , 取消“防止跨站点请求伪造（Prevent Cross Site Request Forgery exploits）”的勾选</li>\n</ul>\n</li>\n<li><p>插件下载过慢，失败<br><em>解决方案</em>：</p>\n<ul>\n<li>修改下载源,jenkins_home/updates/default.json<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sed -i &apos;s/http:\\/\\/updates.jenkins-ci.org\\/download/https:\\/\\/mirrors.tuna.tsinghua.edu.cn\\/jenkins/g&apos; default.json &amp;&amp; sed -i &apos;s/http:\\/\\/www.google.com/https:\\/\\/www.baidu.com/g&apos; default.json</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li><p>mvn 未找到命令<br><em>解决方案</em>：</p>\n<ul>\n<li><p>设置环境变量：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">source /etc/profile</span><br><span class=\"line\">source ~/.bash_profile</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>或者 在/usr/bin下创建软链接</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ln –s /opt/maven/bin/mvn /usr/bin/mvn</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ol>"},{"title":"记一次spring事务问题排查","date":"2020-08-14T14:23:36.000Z","_content":"\n{%note info%}\n\nspring事务@Transactional失效问题排查。\n\n{%endnote%}\n<!--more-->\n\n#### 问题现象\n\n- 简述下问题\n  - 实际业务编码中遇到的问题，代码敏感，替换为类似结构的栗子\n  - 通过工厂类AnimalFactory获取动物实例，调用Animal.action()方法，该方法中存在对数据库的CURD\n  - 针对方法action()打上Transactional注解，然而在抛出异常时却没有事务回滚作用\n\n```java\npublic abstract class Animal implements InitializingBean{\n    public abstract void action();\n}\n```\n\n```java\n@Component\npublic class Dog extends Animal{\n    @Autowired\n    AnimalFactory animalFactory;\n\n  \t@Override\n    @Transactional(rollbackFor = Exception.class)\n  \tpublic String action(){\n      // insert\n      throw new RuntimeExection(\"\");\n\t    // update\n      return \"wangwang\";\n    }\n    @Override\n    public void afterPropertiesSet() {\n        animalFactory.register(Animal.TypeEnum.Dog.getValue(), this);\n    }\n}\n```\n\n```java\n@Component\npublic class AnimalFactory{\n    private Map<String, Animal> cachedAnimals = new ConcurrentHashMap<>();\n    \n  \tpublic void register(String animalType, Animal animal){\n        cachedAnimals.put(animalType, animal);\n    }\n  \t\n    public Animal loadAnimal(String animalType) {\n      if (!cachedAnimals.containsKey(animalType)) {\n        throw new IllegalArgumentException(\"未找到类型为【\" + animalType + \"】的动物\");\n      }\n      return cachedAnimals.get(msgType.toLowerCase());\n    }\n}\n```\n\n```java\n@Component\npublic class Zoo {\n  public Animal showDog(){\n    Animal animal = AnimalFactory.\n    animal.action();\n  }\n}\n```\n\n\n\n#### 问题环境\n\n- 事务配置\n\n```java\nimport org.aspectj.lang.annotation.Aspect;\nimport org.springframework.aop.Advisor;\nimport org.springframework.aop.aspectj.AspectJExpressionPointcut;\nimport org.springframework.aop.support.DefaultPointcutAdvisor;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.jdbc.datasource.DataSourceTransactionManager;\nimport org.springframework.transaction.PlatformTransactionManager;\nimport org.springframework.transaction.TransactionDefinition;\nimport org.springframework.transaction.interceptor.*;\n\nimport javax.sql.DataSource;\nimport java.util.Collections;\nimport java.util.HashMap;\nimport java.util.Map;\n\n@Aspect\n@Configuration\npublic class TxConfig {\n\n    /**\n     * 切面 Service\n     */\n    private static final String AOP_POINTCUT_EXPRESSION = \"execution(* cn.tongdun.bond..service..*.*(..))\";\n\n    @Autowired\n    private PlatformTransactionManager transactionManager;\n\n    @Bean\n    public PlatformTransactionManager txManager(DataSource dataSource) {\n        return new DataSourceTransactionManager(dataSource);\n    }\n\n    /**\n     * 事务拦截器\n     */\n    @Bean\n    public TransactionInterceptor txAdvice() {\n        NameMatchTransactionAttributeSource source = new NameMatchTransactionAttributeSource();\n\n        /*只读事务，不做更新操作*/\n        RuleBasedTransactionAttribute readOnlyTx = new RuleBasedTransactionAttribute();\n        readOnlyTx.setReadOnly(true);\n        readOnlyTx.setPropagationBehavior(TransactionDefinition.PROPAGATION_NOT_SUPPORTED);\n\n        /*当前存在事务就使用当前事务，当前不存在事务就创建一个新的事务*/\n        RuleBasedTransactionAttribute requiredTx = new RuleBasedTransactionAttribute();\n        requiredTx.setRollbackRules(Collections.singletonList(new RollbackRuleAttribute(Exception.class)));\n        requiredTx.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);\n\n        Map<String, TransactionAttribute> txMap = new HashMap<>(16);\n\n        /*配置事务方法的前缀*/\n        txMap.put(\"add*\", requiredTx);\n        txMap.put(\"save*\", requiredTx);\n        txMap.put(\"insert*\", requiredTx);\n        txMap.put(\"create*\", requiredTx);\n        txMap.put(\"batch*\", requiredTx);\n        txMap.put(\"update*\", requiredTx);\n        txMap.put(\"modify*\", requiredTx);\n        txMap.put(\"delete*\", requiredTx);\n        /*配置只读事务方法的前缀*/\n        txMap.put(\"get*\", readOnlyTx);\n        txMap.put(\"query*\", readOnlyTx);\n        txMap.put(\"count*\", readOnlyTx);\n        txMap.put(\"select*\", readOnlyTx);\n        source.setNameMap(txMap);\n\n        return new TransactionInterceptor(transactionManager, source);\n    }\n\n    /**\n     * 注册事务\n     */\n    @Bean\n    public Advisor txAdviceAdvisor(TransactionInterceptor txAdvice) {\n        AspectJExpressionPointcut pointcut = new AspectJExpressionPointcut();\n        pointcut.setExpression(AOP_POINTCUT_EXPRESSION);\n        return new DefaultPointcutAdvisor(pointcut, txAdvice);\n    }\n\n}\n```\n\n- `action命令未AOP事务的规则，故次配置不会在action()中生效，正因如此才加上了`\n- Spring默认propagation属性为Propagation.REQUIRED\n\n#### 排查思路\n\n- @Transactional失效场景\n  1. @Transactional 应用在非 public 修饰的方法上\n  2. @Transactional 注解属性 propagation 设置错误\n  3. @Transactional  注解属性 rollbackFor 设置错误\n  4. 同一个类中方法调用，导致 @Transactional 失效\n  5. 异常被 catch“吃了”导致 @Transactional 失效\n  6. 数据库引擎不支持事务\n- 然而网上常见的几种@Transactional失效场景均无法匹配当前问题场景\n- 即使把问题函数名`aciton`改为`addaction`也仍然没有事务回滚\n\n- 通过在代码中加入工具类`TransactionTestUtils.transactionRequired`，直观看出当前函数内是否存在事务\n\n```java\nTransactionTestUtils.transactionRequired(\"action\");\n```\n\n```java\nimport java.lang.reflect.InvocationTargetException;\n\npublic class TransactionTestUtils {\n    private static final boolean transactionDebugging = true;\n    private static final boolean verboseTransactionDebugging = true;\n\n    public static void showTransactionStatus(String message) {\n        System.out.println(((transactionActive()) ? \"[+] \" : \"[-] \") + message);\n    }\n\n    public static boolean transactionActive() {\n        try {\n            ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();\n            Class tsmClass = contextClassLoader.loadClass(\"org.springframework.transaction.support.TransactionSynchronizationManager\");\n            Boolean isActive = (Boolean) tsmClass.getMethod(\"isActualTransactionActive\", null).invoke(null, null);\n\n            return isActive;\n        } catch (ClassNotFoundException e) {\n            e.printStackTrace();\n        } catch (IllegalArgumentException e) {\n            e.printStackTrace();\n        } catch (SecurityException e) {\n            e.printStackTrace();\n        } catch (IllegalAccessException e) {\n            e.printStackTrace();\n        } catch (InvocationTargetException e) {\n            e.printStackTrace();\n        } catch (NoSuchMethodException e) {\n            e.printStackTrace();\n        }\n\n        throw new IllegalStateException(\"ServerUtils.transactionActive was unable to complete properly\");\n    }\n\n    public static void transactionRequired(String message) {\n        if (!transactionDebugging) {\n            return;\n        }\n\n        if (verboseTransactionDebugging) {\n            showTransactionStatus(message);\n        }\n    }\n}\n```\n\n- 通过观察发现，问题函数内的事务确实没有生效\n- 仔细思考，@Transactional事务，依赖SpringAOP实现，那么不如在AOP事务源码处加上断点，看看到底进入什么逻辑导致事物没生效\n- 结果发现，连AOP外层逻辑都没进去\n- 再想想，AOP实际通过动态代理实现，而动态代理实际通过spring容器实现，也就是函数对应的类实例可能未被容器所管理\n- 想到这里，问题点很容器就找到了，AnimalFactory工厂中register()加注册逻辑反转给具体的工厂中的类，而Dog实际通过put的方式将自己存入了`cachedHandlers`中，脱离了容器的管控\n- 对于上面一点，有必要解释下，spring实现动态代理是通过代理类+被代理类 两个实例的方式实现的，而不是只有一个代理类，故注册进工厂的是原始Dog实例，而不是被代理类\n\n#### 解决方案\n\n- 既然没有通过spring容器注册实例导致了当前问题，那么咱通过spring容器拿就是了\n- register不注册实例，改为注册beanName\n\n```java\n@Component(\"Dog\")\npublic class Dog extends Animal{\n    @Autowired\n    AnimalFactory animalFactory;\n\n  \t@Override\n    @Transactional(rollbackFor = Exception.class)\n  \tpublic String action(){\n      // insert\n      throw new RuntimeExection(\"\");\n\t    // update\n      return \"wangwang\";\n    }\n    @Override\n    public void afterPropertiesSet() {\n        animalFactory.register(Animal.TypeEnum.Dog.getValue(), \"Dog\");\n    }\n}\n```\n\n- 工厂类load时通过容器获取对应的实例\n\n```java\n@Component\npublic class AnimalFactory{\n    private Map<String, String> cachedAnimals = new ConcurrentHashMap<>();\n    \n  \tpublic void register(String animalType, String beanName){\n        cachedAnimals.put(animalType, beanName);\n    }\n  \t\n    public Animal loadAnimal(String animalType) {\n      if (!cachedAnimals.containsKey(animalType)) {\n        throw new IllegalArgumentException(\"未找到类型为【\" + animalType + \"】的动物\");\n      }\n      String beanName = cachedAnimals.get(msgType.toLowerCase());\n      return (Animal)applicationContext.getBean(beanName);\n    }\n}\n```\n\n#### 总结\n\n- 问题在复盘时，顺着捋总是会显得`easy and stupid`，希望能通过不断的总结优化既有的问题思考方法论，以至于以后能少走点弯路\n\n","source":"_posts/2020-08-14-记一次spring事务问题排查.md","raw":"---\ntitle: 记一次spring事务问题排查\ndate: 2020-08-14 22:23:36\ntags: 事务\ncategories: spring\n---\n\n{%note info%}\n\nspring事务@Transactional失效问题排查。\n\n{%endnote%}\n<!--more-->\n\n#### 问题现象\n\n- 简述下问题\n  - 实际业务编码中遇到的问题，代码敏感，替换为类似结构的栗子\n  - 通过工厂类AnimalFactory获取动物实例，调用Animal.action()方法，该方法中存在对数据库的CURD\n  - 针对方法action()打上Transactional注解，然而在抛出异常时却没有事务回滚作用\n\n```java\npublic abstract class Animal implements InitializingBean{\n    public abstract void action();\n}\n```\n\n```java\n@Component\npublic class Dog extends Animal{\n    @Autowired\n    AnimalFactory animalFactory;\n\n  \t@Override\n    @Transactional(rollbackFor = Exception.class)\n  \tpublic String action(){\n      // insert\n      throw new RuntimeExection(\"\");\n\t    // update\n      return \"wangwang\";\n    }\n    @Override\n    public void afterPropertiesSet() {\n        animalFactory.register(Animal.TypeEnum.Dog.getValue(), this);\n    }\n}\n```\n\n```java\n@Component\npublic class AnimalFactory{\n    private Map<String, Animal> cachedAnimals = new ConcurrentHashMap<>();\n    \n  \tpublic void register(String animalType, Animal animal){\n        cachedAnimals.put(animalType, animal);\n    }\n  \t\n    public Animal loadAnimal(String animalType) {\n      if (!cachedAnimals.containsKey(animalType)) {\n        throw new IllegalArgumentException(\"未找到类型为【\" + animalType + \"】的动物\");\n      }\n      return cachedAnimals.get(msgType.toLowerCase());\n    }\n}\n```\n\n```java\n@Component\npublic class Zoo {\n  public Animal showDog(){\n    Animal animal = AnimalFactory.\n    animal.action();\n  }\n}\n```\n\n\n\n#### 问题环境\n\n- 事务配置\n\n```java\nimport org.aspectj.lang.annotation.Aspect;\nimport org.springframework.aop.Advisor;\nimport org.springframework.aop.aspectj.AspectJExpressionPointcut;\nimport org.springframework.aop.support.DefaultPointcutAdvisor;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.jdbc.datasource.DataSourceTransactionManager;\nimport org.springframework.transaction.PlatformTransactionManager;\nimport org.springframework.transaction.TransactionDefinition;\nimport org.springframework.transaction.interceptor.*;\n\nimport javax.sql.DataSource;\nimport java.util.Collections;\nimport java.util.HashMap;\nimport java.util.Map;\n\n@Aspect\n@Configuration\npublic class TxConfig {\n\n    /**\n     * 切面 Service\n     */\n    private static final String AOP_POINTCUT_EXPRESSION = \"execution(* cn.tongdun.bond..service..*.*(..))\";\n\n    @Autowired\n    private PlatformTransactionManager transactionManager;\n\n    @Bean\n    public PlatformTransactionManager txManager(DataSource dataSource) {\n        return new DataSourceTransactionManager(dataSource);\n    }\n\n    /**\n     * 事务拦截器\n     */\n    @Bean\n    public TransactionInterceptor txAdvice() {\n        NameMatchTransactionAttributeSource source = new NameMatchTransactionAttributeSource();\n\n        /*只读事务，不做更新操作*/\n        RuleBasedTransactionAttribute readOnlyTx = new RuleBasedTransactionAttribute();\n        readOnlyTx.setReadOnly(true);\n        readOnlyTx.setPropagationBehavior(TransactionDefinition.PROPAGATION_NOT_SUPPORTED);\n\n        /*当前存在事务就使用当前事务，当前不存在事务就创建一个新的事务*/\n        RuleBasedTransactionAttribute requiredTx = new RuleBasedTransactionAttribute();\n        requiredTx.setRollbackRules(Collections.singletonList(new RollbackRuleAttribute(Exception.class)));\n        requiredTx.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);\n\n        Map<String, TransactionAttribute> txMap = new HashMap<>(16);\n\n        /*配置事务方法的前缀*/\n        txMap.put(\"add*\", requiredTx);\n        txMap.put(\"save*\", requiredTx);\n        txMap.put(\"insert*\", requiredTx);\n        txMap.put(\"create*\", requiredTx);\n        txMap.put(\"batch*\", requiredTx);\n        txMap.put(\"update*\", requiredTx);\n        txMap.put(\"modify*\", requiredTx);\n        txMap.put(\"delete*\", requiredTx);\n        /*配置只读事务方法的前缀*/\n        txMap.put(\"get*\", readOnlyTx);\n        txMap.put(\"query*\", readOnlyTx);\n        txMap.put(\"count*\", readOnlyTx);\n        txMap.put(\"select*\", readOnlyTx);\n        source.setNameMap(txMap);\n\n        return new TransactionInterceptor(transactionManager, source);\n    }\n\n    /**\n     * 注册事务\n     */\n    @Bean\n    public Advisor txAdviceAdvisor(TransactionInterceptor txAdvice) {\n        AspectJExpressionPointcut pointcut = new AspectJExpressionPointcut();\n        pointcut.setExpression(AOP_POINTCUT_EXPRESSION);\n        return new DefaultPointcutAdvisor(pointcut, txAdvice);\n    }\n\n}\n```\n\n- `action命令未AOP事务的规则，故次配置不会在action()中生效，正因如此才加上了`\n- Spring默认propagation属性为Propagation.REQUIRED\n\n#### 排查思路\n\n- @Transactional失效场景\n  1. @Transactional 应用在非 public 修饰的方法上\n  2. @Transactional 注解属性 propagation 设置错误\n  3. @Transactional  注解属性 rollbackFor 设置错误\n  4. 同一个类中方法调用，导致 @Transactional 失效\n  5. 异常被 catch“吃了”导致 @Transactional 失效\n  6. 数据库引擎不支持事务\n- 然而网上常见的几种@Transactional失效场景均无法匹配当前问题场景\n- 即使把问题函数名`aciton`改为`addaction`也仍然没有事务回滚\n\n- 通过在代码中加入工具类`TransactionTestUtils.transactionRequired`，直观看出当前函数内是否存在事务\n\n```java\nTransactionTestUtils.transactionRequired(\"action\");\n```\n\n```java\nimport java.lang.reflect.InvocationTargetException;\n\npublic class TransactionTestUtils {\n    private static final boolean transactionDebugging = true;\n    private static final boolean verboseTransactionDebugging = true;\n\n    public static void showTransactionStatus(String message) {\n        System.out.println(((transactionActive()) ? \"[+] \" : \"[-] \") + message);\n    }\n\n    public static boolean transactionActive() {\n        try {\n            ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();\n            Class tsmClass = contextClassLoader.loadClass(\"org.springframework.transaction.support.TransactionSynchronizationManager\");\n            Boolean isActive = (Boolean) tsmClass.getMethod(\"isActualTransactionActive\", null).invoke(null, null);\n\n            return isActive;\n        } catch (ClassNotFoundException e) {\n            e.printStackTrace();\n        } catch (IllegalArgumentException e) {\n            e.printStackTrace();\n        } catch (SecurityException e) {\n            e.printStackTrace();\n        } catch (IllegalAccessException e) {\n            e.printStackTrace();\n        } catch (InvocationTargetException e) {\n            e.printStackTrace();\n        } catch (NoSuchMethodException e) {\n            e.printStackTrace();\n        }\n\n        throw new IllegalStateException(\"ServerUtils.transactionActive was unable to complete properly\");\n    }\n\n    public static void transactionRequired(String message) {\n        if (!transactionDebugging) {\n            return;\n        }\n\n        if (verboseTransactionDebugging) {\n            showTransactionStatus(message);\n        }\n    }\n}\n```\n\n- 通过观察发现，问题函数内的事务确实没有生效\n- 仔细思考，@Transactional事务，依赖SpringAOP实现，那么不如在AOP事务源码处加上断点，看看到底进入什么逻辑导致事物没生效\n- 结果发现，连AOP外层逻辑都没进去\n- 再想想，AOP实际通过动态代理实现，而动态代理实际通过spring容器实现，也就是函数对应的类实例可能未被容器所管理\n- 想到这里，问题点很容器就找到了，AnimalFactory工厂中register()加注册逻辑反转给具体的工厂中的类，而Dog实际通过put的方式将自己存入了`cachedHandlers`中，脱离了容器的管控\n- 对于上面一点，有必要解释下，spring实现动态代理是通过代理类+被代理类 两个实例的方式实现的，而不是只有一个代理类，故注册进工厂的是原始Dog实例，而不是被代理类\n\n#### 解决方案\n\n- 既然没有通过spring容器注册实例导致了当前问题，那么咱通过spring容器拿就是了\n- register不注册实例，改为注册beanName\n\n```java\n@Component(\"Dog\")\npublic class Dog extends Animal{\n    @Autowired\n    AnimalFactory animalFactory;\n\n  \t@Override\n    @Transactional(rollbackFor = Exception.class)\n  \tpublic String action(){\n      // insert\n      throw new RuntimeExection(\"\");\n\t    // update\n      return \"wangwang\";\n    }\n    @Override\n    public void afterPropertiesSet() {\n        animalFactory.register(Animal.TypeEnum.Dog.getValue(), \"Dog\");\n    }\n}\n```\n\n- 工厂类load时通过容器获取对应的实例\n\n```java\n@Component\npublic class AnimalFactory{\n    private Map<String, String> cachedAnimals = new ConcurrentHashMap<>();\n    \n  \tpublic void register(String animalType, String beanName){\n        cachedAnimals.put(animalType, beanName);\n    }\n  \t\n    public Animal loadAnimal(String animalType) {\n      if (!cachedAnimals.containsKey(animalType)) {\n        throw new IllegalArgumentException(\"未找到类型为【\" + animalType + \"】的动物\");\n      }\n      String beanName = cachedAnimals.get(msgType.toLowerCase());\n      return (Animal)applicationContext.getBean(beanName);\n    }\n}\n```\n\n#### 总结\n\n- 问题在复盘时，顺着捋总是会显得`easy and stupid`，希望能通过不断的总结优化既有的问题思考方法论，以至于以后能少走点弯路\n\n","slug":"记一次spring事务问题排查","published":1,"updated":"2020-09-12T10:09:00.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckeziglqr00321gp717jp1aim","content":"<div class=\"note info\"><p>spring事务@Transactional失效问题排查。</p></div>\n<a id=\"more\"></a>\n<h4 id=\"问题现象\"><a href=\"#问题现象\" class=\"headerlink\" title=\"问题现象\"></a>问题现象</h4><ul>\n<li>简述下问题<ul>\n<li>实际业务编码中遇到的问题，代码敏感，替换为类似结构的栗子</li>\n<li>通过工厂类AnimalFactory获取动物实例，调用Animal.action()方法，该方法中存在对数据库的CURD</li>\n<li>针对方法action()打上Transactional注解，然而在抛出异常时却没有事务回滚作用</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Animal</span> <span class=\"keyword\">implements</span> <span class=\"title\">InitializingBean</span></span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">void</span> <span class=\"title\">action</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Dog</span> <span class=\"keyword\">extends</span> <span class=\"title\">Animal</span></span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    AnimalFactory animalFactory;</span><br><span class=\"line\"></span><br><span class=\"line\">  \t<span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"meta\">@Transactional</span>(rollbackFor = Exception.class)</span><br><span class=\"line\">  \t<span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">action</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// insert</span></span><br><span class=\"line\">      <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeExection(<span class=\"string\">\"\"</span>);</span><br><span class=\"line\">\t    <span class=\"comment\">// update</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"string\">\"wangwang\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">afterPropertiesSet</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        animalFactory.register(Animal.TypeEnum.Dog.getValue(), <span class=\"keyword\">this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AnimalFactory</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Map&lt;String, Animal&gt; cachedAnimals = <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class=\"line\">    </span><br><span class=\"line\">  \t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">register</span><span class=\"params\">(String animalType, Animal animal)</span></span>&#123;</span><br><span class=\"line\">        cachedAnimals.put(animalType, animal);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  \t</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Animal <span class=\"title\">loadAnimal</span><span class=\"params\">(String animalType)</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!cachedAnimals.containsKey(animalType)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">\"未找到类型为【\"</span> + animalType + <span class=\"string\">\"】的动物\"</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> cachedAnimals.get(msgType.toLowerCase());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Zoo</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> Animal <span class=\"title\">showDog</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    Animal animal = AnimalFactory.</span><br><span class=\"line\">    animal.action();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"问题环境\"><a href=\"#问题环境\" class=\"headerlink\" title=\"问题环境\"></a>问题环境</h4><ul>\n<li>事务配置</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.aop.Advisor;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.aop.aspectj.AspectJExpressionPointcut;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.aop.support.DefaultPointcutAdvisor;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.jdbc.datasource.DataSourceTransactionManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.transaction.TransactionDefinition;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.transaction.interceptor.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.sql.DataSource;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Collections;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Aspect</span></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TxConfig</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 切面 Service</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String AOP_POINTCUT_EXPRESSION = <span class=\"string\">\"execution(* cn.tongdun.bond..service..*.*(..))\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> PlatformTransactionManager transactionManager;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> PlatformTransactionManager <span class=\"title\">txManager</span><span class=\"params\">(DataSource dataSource)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> DataSourceTransactionManager(dataSource);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 事务拦截器</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> TransactionInterceptor <span class=\"title\">txAdvice</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        NameMatchTransactionAttributeSource source = <span class=\"keyword\">new</span> NameMatchTransactionAttributeSource();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/*只读事务，不做更新操作*/</span></span><br><span class=\"line\">        RuleBasedTransactionAttribute readOnlyTx = <span class=\"keyword\">new</span> RuleBasedTransactionAttribute();</span><br><span class=\"line\">        readOnlyTx.setReadOnly(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">        readOnlyTx.setPropagationBehavior(TransactionDefinition.PROPAGATION_NOT_SUPPORTED);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/*当前存在事务就使用当前事务，当前不存在事务就创建一个新的事务*/</span></span><br><span class=\"line\">        RuleBasedTransactionAttribute requiredTx = <span class=\"keyword\">new</span> RuleBasedTransactionAttribute();</span><br><span class=\"line\">        requiredTx.setRollbackRules(Collections.singletonList(<span class=\"keyword\">new</span> RollbackRuleAttribute(Exception.class)));</span><br><span class=\"line\">        requiredTx.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);</span><br><span class=\"line\"></span><br><span class=\"line\">        Map&lt;String, TransactionAttribute&gt; txMap = <span class=\"keyword\">new</span> HashMap&lt;&gt;(<span class=\"number\">16</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/*配置事务方法的前缀*/</span></span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"add*\"</span>, requiredTx);</span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"save*\"</span>, requiredTx);</span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"insert*\"</span>, requiredTx);</span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"create*\"</span>, requiredTx);</span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"batch*\"</span>, requiredTx);</span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"update*\"</span>, requiredTx);</span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"modify*\"</span>, requiredTx);</span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"delete*\"</span>, requiredTx);</span><br><span class=\"line\">        <span class=\"comment\">/*配置只读事务方法的前缀*/</span></span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"get*\"</span>, readOnlyTx);</span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"query*\"</span>, readOnlyTx);</span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"count*\"</span>, readOnlyTx);</span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"select*\"</span>, readOnlyTx);</span><br><span class=\"line\">        source.setNameMap(txMap);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> TransactionInterceptor(transactionManager, source);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 注册事务</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Advisor <span class=\"title\">txAdviceAdvisor</span><span class=\"params\">(TransactionInterceptor txAdvice)</span> </span>&#123;</span><br><span class=\"line\">        AspectJExpressionPointcut pointcut = <span class=\"keyword\">new</span> AspectJExpressionPointcut();</span><br><span class=\"line\">        pointcut.setExpression(AOP_POINTCUT_EXPRESSION);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> DefaultPointcutAdvisor(pointcut, txAdvice);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>action命令未AOP事务的规则，故次配置不会在action()中生效，正因如此才加上了</code></li>\n<li>Spring默认propagation属性为Propagation.REQUIRED</li>\n</ul>\n<h4 id=\"排查思路\"><a href=\"#排查思路\" class=\"headerlink\" title=\"排查思路\"></a>排查思路</h4><ul>\n<li>@Transactional失效场景<ol>\n<li>@Transactional 应用在非 public 修饰的方法上</li>\n<li>@Transactional 注解属性 propagation 设置错误</li>\n<li>@Transactional  注解属性 rollbackFor 设置错误</li>\n<li>同一个类中方法调用，导致 @Transactional 失效</li>\n<li>异常被 catch“吃了”导致 @Transactional 失效</li>\n<li>数据库引擎不支持事务</li>\n</ol>\n</li>\n<li>然而网上常见的几种@Transactional失效场景均无法匹配当前问题场景</li>\n<li><p>即使把问题函数名<code>aciton</code>改为<code>addaction</code>也仍然没有事务回滚</p>\n</li>\n<li><p>通过在代码中加入工具类<code>TransactionTestUtils.transactionRequired</code>，直观看出当前函数内是否存在事务</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TransactionTestUtils.transactionRequired(<span class=\"string\">\"action\"</span>);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TransactionTestUtils</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> transactionDebugging = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> verboseTransactionDebugging = <span class=\"keyword\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">showTransactionStatus</span><span class=\"params\">(String message)</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(((transactionActive()) ? <span class=\"string\">\"[+] \"</span> : <span class=\"string\">\"[-] \"</span>) + message);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">boolean</span> <span class=\"title\">transactionActive</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();</span><br><span class=\"line\">            Class tsmClass = contextClassLoader.loadClass(<span class=\"string\">\"org.springframework.transaction.support.TransactionSynchronizationManager\"</span>);</span><br><span class=\"line\">            Boolean isActive = (Boolean) tsmClass.getMethod(<span class=\"string\">\"isActualTransactionActive\"</span>, <span class=\"keyword\">null</span>).invoke(<span class=\"keyword\">null</span>, <span class=\"keyword\">null</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> isActive;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (ClassNotFoundException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IllegalArgumentException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (SecurityException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IllegalAccessException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (InvocationTargetException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (NoSuchMethodException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException(<span class=\"string\">\"ServerUtils.transactionActive was unable to complete properly\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">transactionRequired</span><span class=\"params\">(String message)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!transactionDebugging) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (verboseTransactionDebugging) &#123;</span><br><span class=\"line\">            showTransactionStatus(message);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>通过观察发现，问题函数内的事务确实没有生效</li>\n<li>仔细思考，@Transactional事务，依赖SpringAOP实现，那么不如在AOP事务源码处加上断点，看看到底进入什么逻辑导致事物没生效</li>\n<li>结果发现，连AOP外层逻辑都没进去</li>\n<li>再想想，AOP实际通过动态代理实现，而动态代理实际通过spring容器实现，也就是函数对应的类实例可能未被容器所管理</li>\n<li>想到这里，问题点很容器就找到了，AnimalFactory工厂中register()加注册逻辑反转给具体的工厂中的类，而Dog实际通过put的方式将自己存入了<code>cachedHandlers</code>中，脱离了容器的管控</li>\n<li>对于上面一点，有必要解释下，spring实现动态代理是通过代理类+被代理类 两个实例的方式实现的，而不是只有一个代理类，故注册进工厂的是原始Dog实例，而不是被代理类</li>\n</ul>\n<h4 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h4><ul>\n<li>既然没有通过spring容器注册实例导致了当前问题，那么咱通过spring容器拿就是了</li>\n<li>register不注册实例，改为注册beanName</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Component</span>(<span class=\"string\">\"Dog\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Dog</span> <span class=\"keyword\">extends</span> <span class=\"title\">Animal</span></span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    AnimalFactory animalFactory;</span><br><span class=\"line\"></span><br><span class=\"line\">  \t<span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"meta\">@Transactional</span>(rollbackFor = Exception.class)</span><br><span class=\"line\">  \t<span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">action</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// insert</span></span><br><span class=\"line\">      <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeExection(<span class=\"string\">\"\"</span>);</span><br><span class=\"line\">\t    <span class=\"comment\">// update</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"string\">\"wangwang\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">afterPropertiesSet</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        animalFactory.register(Animal.TypeEnum.Dog.getValue(), <span class=\"string\">\"Dog\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>工厂类load时通过容器获取对应的实例</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AnimalFactory</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Map&lt;String, String&gt; cachedAnimals = <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class=\"line\">    </span><br><span class=\"line\">  \t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">register</span><span class=\"params\">(String animalType, String beanName)</span></span>&#123;</span><br><span class=\"line\">        cachedAnimals.put(animalType, beanName);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  \t</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Animal <span class=\"title\">loadAnimal</span><span class=\"params\">(String animalType)</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!cachedAnimals.containsKey(animalType)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">\"未找到类型为【\"</span> + animalType + <span class=\"string\">\"】的动物\"</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      String beanName = cachedAnimals.get(msgType.toLowerCase());</span><br><span class=\"line\">      <span class=\"keyword\">return</span> (Animal)applicationContext.getBean(beanName);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h4><ul>\n<li>问题在复盘时，顺着捋总是会显得<code>easy and stupid</code>，希望能通过不断的总结优化既有的问题思考方法论，以至于以后能少走点弯路</li>\n</ul>\n","site":{"data":{}},"excerpt":"<div class=\"note info\"><p>spring事务@Transactional失效问题排查。</p></div>","more":"<h4 id=\"问题现象\"><a href=\"#问题现象\" class=\"headerlink\" title=\"问题现象\"></a>问题现象</h4><ul>\n<li>简述下问题<ul>\n<li>实际业务编码中遇到的问题，代码敏感，替换为类似结构的栗子</li>\n<li>通过工厂类AnimalFactory获取动物实例，调用Animal.action()方法，该方法中存在对数据库的CURD</li>\n<li>针对方法action()打上Transactional注解，然而在抛出异常时却没有事务回滚作用</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Animal</span> <span class=\"keyword\">implements</span> <span class=\"title\">InitializingBean</span></span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">void</span> <span class=\"title\">action</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Dog</span> <span class=\"keyword\">extends</span> <span class=\"title\">Animal</span></span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    AnimalFactory animalFactory;</span><br><span class=\"line\"></span><br><span class=\"line\">  \t<span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"meta\">@Transactional</span>(rollbackFor = Exception.class)</span><br><span class=\"line\">  \t<span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">action</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// insert</span></span><br><span class=\"line\">      <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeExection(<span class=\"string\">\"\"</span>);</span><br><span class=\"line\">\t    <span class=\"comment\">// update</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"string\">\"wangwang\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">afterPropertiesSet</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        animalFactory.register(Animal.TypeEnum.Dog.getValue(), <span class=\"keyword\">this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AnimalFactory</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Map&lt;String, Animal&gt; cachedAnimals = <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class=\"line\">    </span><br><span class=\"line\">  \t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">register</span><span class=\"params\">(String animalType, Animal animal)</span></span>&#123;</span><br><span class=\"line\">        cachedAnimals.put(animalType, animal);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  \t</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Animal <span class=\"title\">loadAnimal</span><span class=\"params\">(String animalType)</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!cachedAnimals.containsKey(animalType)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">\"未找到类型为【\"</span> + animalType + <span class=\"string\">\"】的动物\"</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> cachedAnimals.get(msgType.toLowerCase());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Zoo</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> Animal <span class=\"title\">showDog</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    Animal animal = AnimalFactory.</span><br><span class=\"line\">    animal.action();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"问题环境\"><a href=\"#问题环境\" class=\"headerlink\" title=\"问题环境\"></a>问题环境</h4><ul>\n<li>事务配置</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.aop.Advisor;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.aop.aspectj.AspectJExpressionPointcut;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.aop.support.DefaultPointcutAdvisor;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.jdbc.datasource.DataSourceTransactionManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.transaction.TransactionDefinition;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.transaction.interceptor.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.sql.DataSource;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Collections;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Aspect</span></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TxConfig</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 切面 Service</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String AOP_POINTCUT_EXPRESSION = <span class=\"string\">\"execution(* cn.tongdun.bond..service..*.*(..))\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> PlatformTransactionManager transactionManager;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> PlatformTransactionManager <span class=\"title\">txManager</span><span class=\"params\">(DataSource dataSource)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> DataSourceTransactionManager(dataSource);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 事务拦截器</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> TransactionInterceptor <span class=\"title\">txAdvice</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        NameMatchTransactionAttributeSource source = <span class=\"keyword\">new</span> NameMatchTransactionAttributeSource();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/*只读事务，不做更新操作*/</span></span><br><span class=\"line\">        RuleBasedTransactionAttribute readOnlyTx = <span class=\"keyword\">new</span> RuleBasedTransactionAttribute();</span><br><span class=\"line\">        readOnlyTx.setReadOnly(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">        readOnlyTx.setPropagationBehavior(TransactionDefinition.PROPAGATION_NOT_SUPPORTED);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/*当前存在事务就使用当前事务，当前不存在事务就创建一个新的事务*/</span></span><br><span class=\"line\">        RuleBasedTransactionAttribute requiredTx = <span class=\"keyword\">new</span> RuleBasedTransactionAttribute();</span><br><span class=\"line\">        requiredTx.setRollbackRules(Collections.singletonList(<span class=\"keyword\">new</span> RollbackRuleAttribute(Exception.class)));</span><br><span class=\"line\">        requiredTx.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);</span><br><span class=\"line\"></span><br><span class=\"line\">        Map&lt;String, TransactionAttribute&gt; txMap = <span class=\"keyword\">new</span> HashMap&lt;&gt;(<span class=\"number\">16</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/*配置事务方法的前缀*/</span></span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"add*\"</span>, requiredTx);</span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"save*\"</span>, requiredTx);</span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"insert*\"</span>, requiredTx);</span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"create*\"</span>, requiredTx);</span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"batch*\"</span>, requiredTx);</span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"update*\"</span>, requiredTx);</span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"modify*\"</span>, requiredTx);</span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"delete*\"</span>, requiredTx);</span><br><span class=\"line\">        <span class=\"comment\">/*配置只读事务方法的前缀*/</span></span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"get*\"</span>, readOnlyTx);</span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"query*\"</span>, readOnlyTx);</span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"count*\"</span>, readOnlyTx);</span><br><span class=\"line\">        txMap.put(<span class=\"string\">\"select*\"</span>, readOnlyTx);</span><br><span class=\"line\">        source.setNameMap(txMap);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> TransactionInterceptor(transactionManager, source);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 注册事务</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Advisor <span class=\"title\">txAdviceAdvisor</span><span class=\"params\">(TransactionInterceptor txAdvice)</span> </span>&#123;</span><br><span class=\"line\">        AspectJExpressionPointcut pointcut = <span class=\"keyword\">new</span> AspectJExpressionPointcut();</span><br><span class=\"line\">        pointcut.setExpression(AOP_POINTCUT_EXPRESSION);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> DefaultPointcutAdvisor(pointcut, txAdvice);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>action命令未AOP事务的规则，故次配置不会在action()中生效，正因如此才加上了</code></li>\n<li>Spring默认propagation属性为Propagation.REQUIRED</li>\n</ul>\n<h4 id=\"排查思路\"><a href=\"#排查思路\" class=\"headerlink\" title=\"排查思路\"></a>排查思路</h4><ul>\n<li>@Transactional失效场景<ol>\n<li>@Transactional 应用在非 public 修饰的方法上</li>\n<li>@Transactional 注解属性 propagation 设置错误</li>\n<li>@Transactional  注解属性 rollbackFor 设置错误</li>\n<li>同一个类中方法调用，导致 @Transactional 失效</li>\n<li>异常被 catch“吃了”导致 @Transactional 失效</li>\n<li>数据库引擎不支持事务</li>\n</ol>\n</li>\n<li>然而网上常见的几种@Transactional失效场景均无法匹配当前问题场景</li>\n<li><p>即使把问题函数名<code>aciton</code>改为<code>addaction</code>也仍然没有事务回滚</p>\n</li>\n<li><p>通过在代码中加入工具类<code>TransactionTestUtils.transactionRequired</code>，直观看出当前函数内是否存在事务</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TransactionTestUtils.transactionRequired(<span class=\"string\">\"action\"</span>);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TransactionTestUtils</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> transactionDebugging = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> verboseTransactionDebugging = <span class=\"keyword\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">showTransactionStatus</span><span class=\"params\">(String message)</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(((transactionActive()) ? <span class=\"string\">\"[+] \"</span> : <span class=\"string\">\"[-] \"</span>) + message);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">boolean</span> <span class=\"title\">transactionActive</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();</span><br><span class=\"line\">            Class tsmClass = contextClassLoader.loadClass(<span class=\"string\">\"org.springframework.transaction.support.TransactionSynchronizationManager\"</span>);</span><br><span class=\"line\">            Boolean isActive = (Boolean) tsmClass.getMethod(<span class=\"string\">\"isActualTransactionActive\"</span>, <span class=\"keyword\">null</span>).invoke(<span class=\"keyword\">null</span>, <span class=\"keyword\">null</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> isActive;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (ClassNotFoundException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IllegalArgumentException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (SecurityException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IllegalAccessException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (InvocationTargetException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (NoSuchMethodException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException(<span class=\"string\">\"ServerUtils.transactionActive was unable to complete properly\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">transactionRequired</span><span class=\"params\">(String message)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!transactionDebugging) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (verboseTransactionDebugging) &#123;</span><br><span class=\"line\">            showTransactionStatus(message);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>通过观察发现，问题函数内的事务确实没有生效</li>\n<li>仔细思考，@Transactional事务，依赖SpringAOP实现，那么不如在AOP事务源码处加上断点，看看到底进入什么逻辑导致事物没生效</li>\n<li>结果发现，连AOP外层逻辑都没进去</li>\n<li>再想想，AOP实际通过动态代理实现，而动态代理实际通过spring容器实现，也就是函数对应的类实例可能未被容器所管理</li>\n<li>想到这里，问题点很容器就找到了，AnimalFactory工厂中register()加注册逻辑反转给具体的工厂中的类，而Dog实际通过put的方式将自己存入了<code>cachedHandlers</code>中，脱离了容器的管控</li>\n<li>对于上面一点，有必要解释下，spring实现动态代理是通过代理类+被代理类 两个实例的方式实现的，而不是只有一个代理类，故注册进工厂的是原始Dog实例，而不是被代理类</li>\n</ul>\n<h4 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h4><ul>\n<li>既然没有通过spring容器注册实例导致了当前问题，那么咱通过spring容器拿就是了</li>\n<li>register不注册实例，改为注册beanName</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Component</span>(<span class=\"string\">\"Dog\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Dog</span> <span class=\"keyword\">extends</span> <span class=\"title\">Animal</span></span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    AnimalFactory animalFactory;</span><br><span class=\"line\"></span><br><span class=\"line\">  \t<span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"meta\">@Transactional</span>(rollbackFor = Exception.class)</span><br><span class=\"line\">  \t<span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">action</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// insert</span></span><br><span class=\"line\">      <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeExection(<span class=\"string\">\"\"</span>);</span><br><span class=\"line\">\t    <span class=\"comment\">// update</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"string\">\"wangwang\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">afterPropertiesSet</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        animalFactory.register(Animal.TypeEnum.Dog.getValue(), <span class=\"string\">\"Dog\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>工厂类load时通过容器获取对应的实例</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AnimalFactory</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Map&lt;String, String&gt; cachedAnimals = <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class=\"line\">    </span><br><span class=\"line\">  \t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">register</span><span class=\"params\">(String animalType, String beanName)</span></span>&#123;</span><br><span class=\"line\">        cachedAnimals.put(animalType, beanName);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  \t</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Animal <span class=\"title\">loadAnimal</span><span class=\"params\">(String animalType)</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!cachedAnimals.containsKey(animalType)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">\"未找到类型为【\"</span> + animalType + <span class=\"string\">\"】的动物\"</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      String beanName = cachedAnimals.get(msgType.toLowerCase());</span><br><span class=\"line\">      <span class=\"keyword\">return</span> (Animal)applicationContext.getBean(beanName);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h4><ul>\n<li>问题在复盘时，顺着捋总是会显得<code>easy and stupid</code>，希望能通过不断的总结优化既有的问题思考方法论，以至于以后能少走点弯路</li>\n</ul>"}],"PostAsset":[],"PostCategory":[{"post_id":"ckezigl4l00021gp7gnjnp59o","category_id":"ckezigl4w00051gp7gk6a5p9t","_id":"ckezigl5x000f1gp77ea4wov1"},{"post_id":"ckezigl5d000a1gp79zptwpo4","category_id":"ckezigl4w00051gp7gk6a5p9t","_id":"ckezigl60000j1gp7kuuc7ykh"},{"post_id":"ckezigl4p00041gp7w2693uok","category_id":"ckezigl5h000b1gp72w6c73gy","_id":"ckezigl6h000n1gp76dkujjm8"},{"post_id":"ckezigl5v000e1gp76815mgqy","category_id":"ckezigl5h000b1gp72w6c73gy","_id":"ckezigl6r000r1gp7u30lkoz0"},{"post_id":"ckezigl5100081gp7ntyr4rgr","category_id":"ckezigl5x000g1gp7p0f296ay","_id":"ckezigl6t000t1gp7jxcq164e"},{"post_id":"ckezigl5300091gp7zep618in","category_id":"ckezigl6h000o1gp72iho6jmu","_id":"ckezigl7200101gp704whqkye"},{"post_id":"ckezigl6u000w1gp7roo6l0vi","category_id":"ckezigl5x000g1gp7p0f296ay","_id":"ckezigl7c00161gp7ln39w4og"},{"post_id":"ckezigl5j000d1gp7gl9jyohe","category_id":"ckezigl6u000u1gp7r7jz79yr","_id":"ckezigl7m00181gp7xyti5h2u"},{"post_id":"ckezigl7a00151gp7zph2vlt5","category_id":"ckezigl5x000g1gp7p0f296ay","_id":"ckezigl83001d1gp7vahaitty"},{"post_id":"ckezigl6r000s1gp7wy4yoxh4","category_id":"ckezigl7900121gp7hfiadlyk","_id":"ckezigl88001h1gp7fo43l9l4"},{"post_id":"ckezigl7600111gp7ld6u6kfy","category_id":"ckezigl7n00191gp792eksav7","_id":"ckezigl8b001k1gp782i8gnu9"},{"post_id":"ckezigl7d00171gp79twqcr62","category_id":"ckezigl85001e1gp71n6lmmfv","_id":"ckezigl8d001n1gp7gerd8iyy"},{"post_id":"ckezigl7p001b1gp7x24h7piu","category_id":"ckezigl8b001l1gp7u7hkqduy","_id":"ckezigl8p001s1gp70cdykv2e"},{"post_id":"ckezigl7t001c1gp7odokm3ob","category_id":"ckezigl8d001o1gp71xqiq3m4","_id":"ckezigl8r001w1gp73me74quu"},{"post_id":"ckezigl86001g1gp7rxet6n2s","category_id":"ckezigl8p001u1gp7cx1assaw","_id":"ckezigl8u00211gp74yb9bja3"},{"post_id":"ckeziglqr00321gp717jp1aim","category_id":"ckeziglqv00331gp7yxjzyn63","_id":"ckeziglr400361gp79s7nbf5z"}],"PostTag":[{"post_id":"ckezigl4l00021gp7gnjnp59o","tag_id":"ckezigl4z00061gp7ejmcuhaz","_id":"ckezigl61000k1gp76a1yecuw"},{"post_id":"ckezigl4l00021gp7gnjnp59o","tag_id":"ckezigl5h000c1gp7nsj81spd","_id":"ckezigl6h000m1gp7dl17tpti"},{"post_id":"ckezigl4p00041gp7w2693uok","tag_id":"ckezigl5x000h1gp7v7xva6cp","_id":"ckezigl6w000x1gp7m9wufhmk"},{"post_id":"ckezigl4p00041gp7w2693uok","tag_id":"ckezigl6h000p1gp7niv3qil1","_id":"ckezigl70000z1gp7lm76elp8"},{"post_id":"ckezigl5100081gp7ntyr4rgr","tag_id":"ckezigl6u000v1gp7bpigbjzy","_id":"ckezigl7a00141gp7428t1wzn"},{"post_id":"ckezigl5300091gp7zep618in","tag_id":"ckezigl7900131gp7es1tnzei","_id":"ckezigl89001i1gp75zbenj8k"},{"post_id":"ckezigl5300091gp7zep618in","tag_id":"ckezigl7o001a1gp7d71ieo93","_id":"ckezigl8a001j1gp7ucgh4qpd"},{"post_id":"ckezigl5d000a1gp79zptwpo4","tag_id":"ckezigl4z00061gp7ejmcuhaz","_id":"ckezigl8o001q1gp77zf7bmxf"},{"post_id":"ckezigl5d000a1gp79zptwpo4","tag_id":"ckezigl85001f1gp7uqhri8aj","_id":"ckezigl8o001r1gp7x5jnfmcl"},{"post_id":"ckezigl5d000a1gp79zptwpo4","tag_id":"ckezigl8b001m1gp7siz84t6r","_id":"ckezigl8q001v1gp7dui2varh"},{"post_id":"ckezigl5j000d1gp7gl9jyohe","tag_id":"ckezigl6u000v1gp7bpigbjzy","_id":"ckezigl8s001y1gp7f1n203q5"},{"post_id":"ckezigl5j000d1gp7gl9jyohe","tag_id":"ckezigl8p001t1gp7lmrzi3fh","_id":"ckezigl8s001z1gp7d0ri04qf"},{"post_id":"ckezigl5v000e1gp76815mgqy","tag_id":"ckezigl4z00061gp7ejmcuhaz","_id":"ckezigl9500231gp75mxjae8i"},{"post_id":"ckezigl5v000e1gp76815mgqy","tag_id":"ckezigl6h000p1gp7niv3qil1","_id":"ckezigl9600241gp7s7theu9u"},{"post_id":"ckezigl5v000e1gp76815mgqy","tag_id":"ckezigl8t00201gp7djpkq543","_id":"ckezigl9800261gp708uowl0o"},{"post_id":"ckezigl5y000i1gp73uapahiv","tag_id":"ckezigl6u000v1gp7bpigbjzy","_id":"ckezigl9900271gp7eox3uo4f"},{"post_id":"ckezigl6d000l1gp7jr7loy55","tag_id":"ckezigl4z00061gp7ejmcuhaz","_id":"ckezigl9k002a1gp73t08sek3"},{"post_id":"ckezigl6d000l1gp7jr7loy55","tag_id":"ckezigl6u000v1gp7bpigbjzy","_id":"ckezigl9l002b1gp79kn53rrg"},{"post_id":"ckezigl6d000l1gp7jr7loy55","tag_id":"ckezigl9900281gp745c848ud","_id":"ckezigl9l002d1gp7c783h75k"},{"post_id":"ckezigl6i000q1gp7mgkaaeps","tag_id":"ckezigl9g00291gp7ty2sdf95","_id":"ckezigl9n002e1gp7beac72m4"},{"post_id":"ckezigl6r000s1gp7wy4yoxh4","tag_id":"ckezigl9l002c1gp766b8gbgg","_id":"ckezigl9q002h1gp7f5gffczb"},{"post_id":"ckezigl6r000s1gp7wy4yoxh4","tag_id":"ckezigl9o002f1gp7orziw1q7","_id":"ckezigl9q002i1gp7b6kyp1ir"},{"post_id":"ckezigl6u000w1gp7roo6l0vi","tag_id":"ckezigl9p002g1gp7ord5y13v","_id":"ckezigl9z002l1gp7pgfbxc3h"},{"post_id":"ckezigl6u000w1gp7roo6l0vi","tag_id":"ckezigl9r002j1gp739ae2iv4","_id":"ckezigl9z002m1gp7wf3xyxl6"},{"post_id":"ckezigl6x000y1gp7zx4l86s5","tag_id":"ckezigl9w002k1gp7rdjnhmq4","_id":"ckezigla0002o1gp7a0tusfwt"},{"post_id":"ckezigl7600111gp7ld6u6kfy","tag_id":"ckezigl9z002n1gp7ikzp9lzo","_id":"ckezigla1002q1gp7kadqxsns"},{"post_id":"ckezigl7a00151gp7zph2vlt5","tag_id":"ckezigl9r002j1gp739ae2iv4","_id":"ckezigla2002s1gp7c4xl6o63"},{"post_id":"ckezigl7p001b1gp7x24h7piu","tag_id":"ckezigla2002r1gp75yhobvg4","_id":"ckezigla3002u1gp7zvezevoi"},{"post_id":"ckezigl7t001c1gp7odokm3ob","tag_id":"ckezigla2002t1gp75btinpqr","_id":"ckezigla4002y1gp72a6ekq9x"},{"post_id":"ckezigl7t001c1gp7odokm3ob","tag_id":"ckezigl9w002k1gp7rdjnhmq4","_id":"ckezigla4002z1gp7zj2l7437"},{"post_id":"ckezigl7t001c1gp7odokm3ob","tag_id":"ckezigla3002w1gp7jxu8lm2p","_id":"ckezigla400301gp7jsv1wpan"},{"post_id":"ckezigl86001g1gp7rxet6n2s","tag_id":"ckezigla4002x1gp71l7mm9e0","_id":"ckezigla400311gp72o6i4s85"},{"post_id":"ckeziglqr00321gp717jp1aim","tag_id":"ckeziglqw00341gp7s128ilpc","_id":"ckeziglr100351gp7h52qpk9h"}],"Tag":[{"name":"flask","_id":"ckezigl4z00061gp7ejmcuhaz"},{"name":"sse","_id":"ckezigl5h000c1gp7nsj81spd"},{"name":"mysql","_id":"ckezigl5x000h1gp7v7xva6cp"},{"name":"问题分析","_id":"ckezigl6h000p1gp7niv3qil1"},{"name":"python","_id":"ckezigl6u000v1gp7bpigbjzy"},{"name":"docker","_id":"ckezigl7900131gp7es1tnzei"},{"name":"wins10","_id":"ckezigl7o001a1gp7d71ieo93"},{"name":"session","_id":"ckezigl85001f1gp7uqhri8aj"},{"name":"分布式","_id":"ckezigl8b001m1gp7siz84t6r"},{"name":"coding-tools","_id":"ckezigl8p001t1gp7lmrzi3fh"},{"name":"linux","_id":"ckezigl8t00201gp7djpkq543"},{"name":"源码浅析","_id":"ckezigl9900281gp745c848ud"},{"name":"hexo","_id":"ckezigl9g00291gp7ty2sdf95"},{"name":"algorithm","_id":"ckezigl9l002c1gp766b8gbgg"},{"name":"datastructure","_id":"ckezigl9o002f1gp7orziw1q7"},{"name":"pysqark","_id":"ckezigl9p002g1gp7ord5y13v"},{"name":"pandas","_id":"ckezigl9r002j1gp739ae2iv4"},{"name":"部署","_id":"ckezigl9w002k1gp7rdjnhmq4"},{"name":"兼职运维","_id":"ckezigl9z002n1gp7ikzp9lzo"},{"name":"nfc","_id":"ckezigla2002r1gp75yhobvg4"},{"name":"shell","_id":"ckezigla2002t1gp75btinpqr"},{"name":"运维","_id":"ckezigla3002w1gp7jxu8lm2p"},{"name":"jenkins","_id":"ckezigla4002x1gp71l7mm9e0"},{"name":"事务","_id":"ckeziglqw00341gp7s128ilpc"}]}}